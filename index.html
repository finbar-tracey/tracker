<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Gym Tracker</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,300&family=DM+Mono:wght@400;500&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #141414;
            --primary-dark: #000000;
            --accent: #C8F55A;
            --accent-dark: #b3e04a;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --background: #F7F7F5;
            --surface: #FFFFFF;
            --surface2: #F0F0ED;
            --text-primary: #141414;
            --text-secondary: #8C8C8A;
            --text-tertiary: #BBBBB8;
            --border: #E8E8E5;
            --border-strong: #D0D0CC;
            --shadow: rgba(0, 0, 0, 0.06);
            --shadow-lg: rgba(0, 0, 0, 0.12);
            --gradient: linear-gradient(135deg, #141414 0%, #2a2a2a 100%);
            --chart-bg: #F0F0ED;
            --mono: 'DM Mono', monospace;
        }

        [data-theme="dark"] {
            --primary: #F7F7F5;
            --primary-dark: #FFFFFF;
            --accent: #10b981;
            --accent-dark: #059669;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
            --background: #0E0E0C;
            --surface: #1A1A18;
            --surface2: #222220;
            --text-primary: #F7F7F5;
            --text-secondary: #A0A09E;
            --text-tertiary: #6A6A68;
            --border: #2A2A28;
            --border-strong: #3A3A38;
            --shadow: rgba(0, 0, 0, 0.4);
            --shadow-lg: rgba(0, 0, 0, 0.6);
            --gradient: linear-gradient(135deg, #F7F7F5 0%, #d0d0ce 100%);
            --chart-bg: #1E1E1C;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            overflow-x: hidden;
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-font-smoothing: antialiased;
            letter-spacing: -0.01em;
        }

        .app-container {
            max-width: 428px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--background);
            position: relative;
        }

        /* Header */
        .header {
            background: var(--background);
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.03em;
            color: var(--text-primary);
        }

        .header-btn {
            background: var(--text-primary);
            color: var(--background);
            border: none;
            padding: 9px 18px;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            letter-spacing: -0.01em;
            font-family: 'DM Sans', sans-serif;
        }

        .header-btn:active {
            transform: scale(0.96);
            opacity: 0.85;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .search-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .search-btn:active {
            background: var(--surface2);
        }

        /* Cardio */
        .cardio-stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .cardio-stat {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            text-align: center;
        }

        .cardio-stat-value {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.04em;
            color: var(--text-primary);
            font-family: 'DM Mono', monospace;
            line-height: 1;
            margin-bottom: 4px;
        }

        .cardio-stat-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .cardio-map {
            width: 100%;
            height: 240px;
            background: var(--surface2);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            position: relative;
            margin-bottom: 12px;
        }

        .cardio-map canvas {
            width: 100%;
            height: 100%;
        }

        .cardio-map-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-tertiary);
            font-size: 13px;
            gap: 8px;
        }

        .cardio-type-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .cardio-type-btn {
            flex: 1;
            padding: 10px 6px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--surface2);
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.15s;
        }

        .cardio-type-btn.active {
            background: var(--text-primary);
            color: var(--background);
            border-color: var(--text-primary);
        }

        .cardio-start-btn {
            width: 100%;
            padding: 18px;
            border-radius: 16px;
            border: none;
            background: var(--text-primary);
            color: var(--background);
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            letter-spacing: -0.02em;
            transition: all 0.15s;
        }

        .cardio-start-btn.running {
            background: var(--danger);
            color: white;
        }

        .cardio-start-btn:active { opacity: 0.85; transform: scale(0.98); }

        .splits-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .split-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 13px;
        }

        .split-km { font-weight: 700; color: var(--text-primary); font-family: 'DM Mono', monospace; }
        .split-pace { color: var(--text-secondary); font-family: 'DM Mono', monospace; }
        .split-bar { height: 3px; background: var(--text-primary); border-radius: 2px; margin-top: 4px; }

        .cardio-history-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 8px;
        }

        /* Tab Bar */
        .tab-bar {
            display: flex;
            background: var(--surface);
            border-top: 1px solid var(--border);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 428px;
            margin: 0 auto;
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .tab {
            flex: 1;
            padding: 10px 0 8px;
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            transition: color 0.15s;
            font-family: 'DM Sans', sans-serif;
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }

        .tab.active {
            color: var(--text-primary);
        }

        .tab-icon {
            font-size: 18px;
            line-height: 1;
        }

        /* Content */
        .content {
            padding: 16px 20px 80px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .card-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Exercise List */
        .exercise-category {
            margin-bottom: 24px;
        }

        .category-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .exercise-item {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid var(--border);
        }

        .exercise-item:active {
            background: var(--surface2);
        }

        .exercise-name {
            font-size: 15px;
            font-weight: 500;
            letter-spacing: -0.01em;
        }

        .exercise-muscle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .chevron {
            color: var(--text-secondary);
            font-size: 20px;
        }

        /* Workout Tracking */
        .exercise-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .exercise-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .last-workout {
            background: var(--surface2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .last-workout-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .last-workout-data {
            font-size: 15px;
            color: var(--text-primary);
        }

        .set-list {
            margin-bottom: 16px;
        }

        .set-item {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }

        .set-number {
            width: 40px;
            font-size: 17px;
            font-weight: 600;
            color: var(--text-tertiary);
            font-size: 13px;
        }

        .set-input {
            flex: 1;
            display: flex;
            gap: 8px;
        }

        .input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .input-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 17px;
            background: var(--surface2);
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--text-primary);
            background: var(--surface);
        }

        .delete-set {
            background: var(--danger);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .delete-set:active {
            transform: scale(0.9);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: var(--accent); color: #141414;
            color: white;
        }

        .btn-primary:active {
            background: var(--primary-dark);
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--background);
            color: var(--primary);
        }

        .btn-secondary:active {
            transform: scale(0.98);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:active {
            transform: scale(0.98);
        }

        /* History */
        .history-item {
            margin-bottom: 12px;
        }

        .history-date {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .history-sets {
            font-size: 15px;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-text {
            font-size: 17px;
            color: var(--text-secondary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: flex-end;
        }

        .modal.active {
            display: flex;
        }

        /* Higher z-index for modals that appear on top of other modals */
        #exerciseModal.active,
        #addCustomExerciseModal.active {
            z-index: 2000;
            background: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background: var(--surface);
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 428px;
            margin: 0 auto;
            padding: 24px 20px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.25s cubic-bezier(0.32, 0.72, 0, 1);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.3); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .close-btn {
            background: var(--surface2);
            border: 1px solid var(--border);
            font-size: 16px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-box {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            margin-bottom: 16px;
            background: var(--surface2);
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--text-primary);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stat-change {
            font-size: 12px;
            margin-top: 4px;
            font-weight: 600;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        /* Progress Indicators */
        .pr-badge {
            display: inline-block;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 8px;
            letter-spacing: 0.5px;
        }

        .improvement-badge {
            display: inline-block;
            background: var(--success);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Rest Timer */
        .rest-timer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            z-index: 2000;
            min-width: 280px;
            display: none;
        }

        .rest-timer.active {
            display: block;
        }

        .timer-display {
            font-size: 72px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            margin-bottom: 20px;
        }

        .timer-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .timer-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Charts */
        .chart-container {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            height: 200px;
            position: relative;
        }

        .chart-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .simple-chart {
            display: flex;
            align-items: flex-end;
            height: 140px;
            gap: 8px;
            padding: 0 8px;
        }

        .chart-bar {
            flex: 1;
            background: var(--accent); color: #141414;
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            position: relative;
            transition: all 0.3s;
        }

        .chart-bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .chart-bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Templates */
        .template-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .template-card:active {
            transform: scale(0.98);
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .template-name {
            font-size: 20px;
            font-weight: 600;
        }

        .template-exercises {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .template-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .icon-btn {
            background: var(--background);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            color: var(--primary);
        }

        .icon-btn:active {
            transform: scale(0.95);
        }

        .icon-btn.danger {
            color: var(--danger);
        }

        /* Body Metrics */
        .metric-input-group {
            margin-bottom: 16px;
        }

        .metric-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 8px;
            display: block;
        }

        .metric-input {
            width: 100%;
            padding: 13px 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            background: var(--surface2);
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
            -webkit-appearance: none;
        }

        .metric-input:focus {
            outline: none;
            border-color: var(--text-primary);
            background: var(--surface);
        }

        .metric-history {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Swipe Actions */
        .swipeable {
            position: relative;
            overflow: hidden;
        }

        .swipe-actions {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-right: 16px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .swipe-actions.visible {
            opacity: 1;
        }

        .swipe-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            color: white;
        }

        .swipe-btn.edit {
            background: var(--warning);
        }

        .swipe-btn.delete {
            background: var(--danger);
        }

        /* Weight Adjustment Buttons */
        .weight-adjust {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .adjust-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            background: var(--surface);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
        }

        .adjust-btn:active {
            background: var(--background);
        }

        /* Exercise Info */
        .exercise-info {
            background: var(--surface2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .info-section {
            margin-bottom: 12px;
        }

        .info-section:last-child {
            margin-bottom: 0;
        }

        .info-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .info-text {
            font-size: 14px;
            line-height: 1.5;
        }

        /* Streak Badge */
        .streak-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            padding: 12px 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .streak-icon {
            font-size: 32px;
        }

        .streak-text {
            flex: 1;
        }

        .streak-number {
            font-size: 24px;
            font-weight: 700;
            color: #ffffff;
        }

        .streak-label {
            font-size: 13px;
            opacity: 0.95;
            color: #ffffff;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
        }

        .section-action {
            padding: 8px 14px;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .section-action:hover {
            background: var(--text-primary);
            color: var(--background);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .quick-action-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action-btn:active {
            transform: scale(0.98);
            background: var(--background);
        }

        .quick-action-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .quick-action-label {
            font-size: 14px;
            font-weight: 600;
        }

        /* Export Modal */
        .export-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .export-btn {
            padding: 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-btn:active {
            background: var(--background);
        }

        .export-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .export-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Time Range Selector */
        .time-range-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background: var(--background);
            padding: 4px;
            border-radius: 10px;
        }

        .time-range-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-range-btn.active {
            background: var(--surface);
            color: var(--primary);
            box-shadow: 0 2px 4px var(--shadow);
        }

        /* Percentage Badge */
        .percentage {
            font-size: 12px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
        }

        .percentage.up {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success);
        }

        .percentage.down {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger);
        }

        /* Achievement Animations */
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            to {
                transform: translateX(-50%) translateY(-100px);
                opacity: 0;
            }
        }

        /* Whoop-Style Data Visualization */
        .readiness-ring {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }

        .readiness-ring svg {
            transform: rotate(-90deg);
        }

        .readiness-ring-bg {
            fill: none;
            stroke: var(--border);
            stroke-width: 12;
        }

        .readiness-ring-progress {
            fill: none;
            stroke: var(--primary);
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease;
        }

        .readiness-score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .readiness-score-number {
            font-size: 56px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            letter-spacing: -2px;
        }

        .readiness-score-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            margin-top: 4px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label-small {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .metric-value-large {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .metric-value-small {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .metric-change {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            margin-left: 8px;
        }

        .metric-change.positive {
            background: rgba(0, 212, 170, 0.1);
            color: var(--success);
        }

        .metric-change.negative {
            background: rgba(255, 59, 71, 0.1);
            color: var(--danger);
        }

        .mini-chart {
            height: 40px;
            display: flex;
            align-items: flex-end;
            gap: 2px;
        }

        .mini-chart-bar {
            flex: 1;
            background: var(--border);
            border-radius: 2px;
            min-height: 4px;
            transition: all 0.3s;
        }

        .mini-chart-bar.active {
            background: var(--accent); color: #141414;
        }

        .section-divider {
            height: 1px;
            background: var(--border);
            margin: 24px 0;
        }

        .premium-stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
        }

        .premium-stat-header {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .premium-stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            letter-spacing: -1px;
            margin-bottom: 8px;
        }

        .premium-stat-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        /* Muscle Heatmap */
        .muscle-heatmap {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 16px 0;
        }

        .muscle-body {
            position: relative;
            width: 100%;
        }

        .muscle-body svg {
            width: 100%;
            height: auto;
        }

        .muscle-group-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .muscle-group-bar:last-child {
            border-bottom: none;
        }

        .muscle-bar-label {
            font-size: 13px;
            color: var(--text-secondary);
            width: 80px;
            flex-shrink: 0;
        }

        .muscle-bar-track {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .muscle-bar-fill {
            height: 100%;
            border-radius: 3px;
            background: var(--accent); color: #141414;
            transition: width 0.6s ease;
        }

        .muscle-bar-fill.high { background: var(--accent); color: #141414; }
        .muscle-bar-fill.medium { background: var(--warning); }
        .muscle-bar-fill.low { background: var(--border); }

        .muscle-bar-value {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            width: 40px;
            text-align: right;
        }

        /* Plate Calculator */
        .plate-calculator {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .plate-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin: 20px 0;
            min-height: 60px;
            flex-wrap: wrap;
        }

        .plate {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-weight: 700;
            font-size: 11px;
            color: white;
            flex-shrink: 0;
        }

        .plate-25 { width: 20px; height: 56px; background: #FF3B47; }
        .plate-20 { width: 18px; height: 50px; background: #0080FF; }
        .plate-15 { width: 16px; height: 44px; background: #FFB800; }
        .plate-10 { width: 14px; height: 38px; background: #2ecc71; }
        .plate-5  { width: 12px; height: 32px; background: #fff; color: #333; border: 1px solid #ccc; }
        .plate-2  { width: 10px; height: 26px; background: #888; }
        .plate-1  { width: 8px; height: 20px; background: #aaa; }
        .barbell  { width: 40px; height: 8px; background: var(--text-secondary); border-radius: 2px; }
        .collar   { width: 6px; height: 16px; background: var(--text-secondary); border-radius: 2px; }

        /* Calendar */
        .workout-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin: 12px 0;
        }

        .cal-header {
            text-align: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 4px 0;
            text-transform: uppercase;
        }

        .cal-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .cal-day.worked-out {
            background: var(--accent); color: #141414;
            color: white;
            font-weight: 700;
        }

        .cal-day.today {
            border: 2px solid var(--primary);
            color: var(--primary);
            font-weight: 700;
        }

        .cal-day.today.worked-out {
            border: none;
            background: var(--accent); color: #141414;
            color: white;
        }

        .cal-day.empty {
            opacity: 0;
            pointer-events: none;
        }

        /* PR Cards */
        .pr-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
        }

        .pr-card:last-child {
            border-bottom: none;
        }

        .pr-exercise {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .pr-date {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .pr-weight {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
            letter-spacing: -0.5px;
        }

        .pr-unit {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* Active Workout Improvements */
        .active-exercise-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .active-exercise-header {
            padding: 14px 16px;
            background: var(--chart-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .active-exercise-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .active-exercise-muscle {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .set-row {
            display: grid;
            grid-template-columns: 32px 1fr 1fr 1fr 32px;
            gap: 8px;
            align-items: center;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
        }

        .set-row:last-child {
            border-bottom: none;
        }

        .set-number {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
        }

        .set-input {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            color: var(--text-primary);
            width: 100%;
        }

        .set-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .set-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .set-delete {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            opacity: 0.6;
        }

        /* Nutrition Progress Bars */
        .macro-ring-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 16px 0;
        }

        .macro-ring {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .macro-ring svg {
            transform: rotate(-90deg);
        }

        .macro-ring-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .macro-ring-value {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .nutrition-bar-row {
            margin-bottom: 14px;
        }

        .nutrition-bar-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .nutrition-bar-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .nutrition-bar-amounts {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .nutrition-bar-track {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .nutrition-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease;
        }

        /* Warmup Sets */
        .warmup-card {
            background: linear-gradient(135deg, rgba(0,212,170,0.1), rgba(0,184,148,0.05));
            border: 1px solid rgba(0,212,170,0.3);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 12px;
        }

        .warmup-header {
            font-size: 12px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .warmup-set-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0,212,170,0.15);
            font-size: 14px;
        }

        .warmup-set-row:last-child {
            border-bottom: none;
        }

        .warmup-pct {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .warmup-weight {
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Weekly Report */
        .report-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
        }

        .report-stat:last-child {
            border-bottom: none;
        }

        .report-stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .report-stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .report-grade {
            font-size: 48px;
            font-weight: 800;
            text-align: center;
            margin: 16px 0 8px;
            letter-spacing: -2px;
        }

        .report-grade-label {
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        /* Achievement badges */
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .achievement-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 8px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            text-align: center;
            transition: all 0.2s;
        }

        .achievement-badge.unlocked {
            border-color: var(--primary);
            background: rgba(0,212,170,0.05);
        }

        .achievement-badge.locked {
            opacity: 0.4;
        }

        .achievement-icon {
            font-size: 28px;
        }

        .achievement-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .achievement-desc {
            font-size: 10px;
            color: var(--text-secondary);
            line-height: 1.3;
        }

        /* Rest Timer improvements */
        .rest-timer-overlay {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 500;
            min-width: 240px;
        }

        .rest-timer-time {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            letter-spacing: -1px;
            font-variant-numeric: tabular-nums;
        }

        .rest-timer-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1>LIFT</h1>
            <div class="header-actions">
                <button class="search-btn" onclick="app.showSearch()" id="searchBtn"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></button>
                <button class="header-btn" onclick="app.startWorkoutSession()" id="startWorkoutBtn">Start Workout</button>
            </div>
        </div>

        <!-- Search Modal -->
        <div id="searchModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Search Workouts</h2>
                    <button class="close-btn" onclick="app.closeSearch()">Ã—</button>
                </div>
                <input type="text" class="search-box" id="globalSearch" placeholder="Search exercises, dates, notes..." oninput="app.performSearch()">
                <div id="searchResults"></div>
            </div>
        </div>

        <!-- Today View -->
        <div id="today" class="content view active">
            <div id="todayWorkouts"></div>
        </div>

        <!-- Library View -->
        <div id="library" class="content view">
            <div id="exerciseLibrary"></div>
        </div>

        <!-- Analytics View -->
        <div id="analytics" class="content view">
            <div id="analyticsContent"></div>
        </div>

        <!-- Templates View -->
        <div id="templates" class="content view">
            <div id="templatesContent"></div>
        </div>

        <!-- History View -->
        <div id="history" class="content view">
            <div id="historyContent"></div>
        </div>

        <!-- Health View -->
        <div id="health" class="content view">
            <div id="healthContent"></div>
        </div>

        <!-- Cardio View -->
        <div id="cardio" class="content view">
            <div id="cardioContent"></div>
        </div>

        <!-- Social View -->
        <div id="social" class="content view">
            <div id="socialContent"></div>
        </div>

        <!-- More View -->
        <div id="more" class="content view">
            <div id="moreContent"></div>
        </div>

        <!-- Templates View (accessed from More) -->
        <div id="templates" class="content view">
            <div id="templatesContent"></div>
        </div>

        <!-- Library View (accessed from More) -->
        <div id="library" class="content view">
            <div id="libraryContent"></div>
        </div>

        <!-- Tab Bar -->
        <div class="tab-bar">
            <button class="tab active" onclick="app.switchTab('today')">
                <span class="tab-icon">â—ˆ</span>
                <span>Today</span>
            </button>
            <button class="tab" onclick="app.switchTab('health')">
                <span class="tab-icon">â—Ž</span>
                <span>Health</span>
            </button>
            <button class="tab" onclick="app.switchTab('social')">
                <span class="tab-icon">â—ˆ</span>
                <span>Social</span>
            </button>
            <button class="tab" onclick="app.switchTab('history')">
                <span class="tab-icon">â–¤</span>
                <span>History</span>
            </button>
            <button class="tab" onclick="app.switchTab('more')">
                <span class="tab-icon">âŠ¹</span>
                <span>More</span>
            </button>
        </div>

        <!-- Exercise Selection Modal -->
        <div id="exerciseModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Select Exercise</h2>
                    <button class="close-btn" onclick="app.closeExerciseModal()">Ã—</button>
                </div>
                <input type="text" class="search-box" id="exerciseSearch" placeholder="Search exercises..." oninput="app.filterExercises()">
                <div id="modalExerciseList"></div>
            </div>
        </div>

        <!-- Workout Tracking Modal -->
        <div id="workoutModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="workoutExerciseName"></h2>
                    <button class="close-btn" onclick="app.closeWorkoutModal()">Ã—</button>
                </div>
                <div id="workoutContent"></div>
            </div>
        </div>

        <!-- Rest Timer -->
        <div id="restTimer" class="rest-timer">
            <div class="timer-display" id="timerDisplay">0:00</div>
            <div style="font-size: 17px; margin-bottom: 20px;">Rest Timer</div>
            <div class="timer-buttons">
                <button class="timer-btn" style="background: var(--warning); color: white;" onclick="app.skipRest()">Skip</button>
                <button class="timer-btn" style="background: var(--success); color: white;" onclick="app.addRestTime(30)">+30s</button>
            </div>
        </div>

        <!-- Exercise Details Modal -->
        <div id="exerciseDetailsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="detailsExerciseName"></h2>
                    <button class="close-btn" onclick="app.closeExerciseDetails()">Ã—</button>
                </div>
                <div id="exerciseDetailsContent"></div>
            </div>
        </div>

        <!-- Create Template Modal -->
        <div id="createTemplateModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Create Template</h2>
                    <button class="close-btn" onclick="app.closeCreateTemplate()">Ã—</button>
                </div>
                <div id="createTemplateContent"></div>
            </div>
        </div>

        <!-- Export Modal -->
        <div id="exportModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Export & Import</h2>
                    <button class="close-btn" onclick="app.closeExportModal()">Ã—</button>
                </div>
                <div class="export-options">
                    <button class="export-btn" onclick="app.showImportModal(); app.closeExportModal();">
                        <div class="export-title">Import Backup</div>
                        <div class="export-desc">Restore data from a backup file</div>
                    </button>
                    <button class="export-btn" onclick="app.exportToCSV()">
                        <div class="export-title">Export to CSV</div>
                        <div class="export-desc">Download all workout data as spreadsheet</div>
                    </button>
                    <button class="export-btn" onclick="app.shareWorkoutSummary()">
                        <div class="export-title">Share Summary</div>
                        <div class="export-desc">Share this week's workout summary</div>
                    </button>
                    <button class="export-btn" onclick="app.exportJSON()">
                        <div class="export-title">Backup (JSON)</div>
                        <div class="export-desc">Download complete backup file</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Metric Modal -->
        <div id="addMetricModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Log Body Metrics</h2>
                    <button class="close-btn" onclick="app.closeAddMetric()">Ã—</button>
                </div>
                <div id="addMetricContent"></div>
            </div>
        </div>

        <!-- Import Data Modal -->
        <div id="importModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Import Data</h2>
                    <button class="close-btn" onclick="app.closeImportModal()">Ã—</button>
                </div>
                <div style="margin-bottom: 16px;">
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        Import a backup file to restore your workouts, templates, and metrics.
                    </p>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="app.handleImportFile(event)">
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">
                        Choose Backup File
                    </button>
                </div>
                <div id="importStatus"></div>
            </div>
        </div>

        <!-- Add Photo Modal -->
        <div id="addPhotoModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Add Progress Photo</h2>
                    <button class="close-btn" onclick="app.closeAddPhoto()">Ã—</button>
                </div>
                <div style="margin-bottom: 16px;">
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        Take or upload a photo to track your visual progress over time.
                    </p>
                    <input type="file" id="photoFile" accept="image/*" capture="environment" style="display: none;" onchange="app.handlePhotoUpload(event)">
                    <button class="btn btn-primary" onclick="document.getElementById('photoFile').click()">
                        Take / Upload Photo
                    </button>
                </div>
                <div id="photoPreview"></div>
            </div>
        </div>

        <!-- Photo Comparison Modal -->
        <div id="photoCompareModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Progress Comparison</h2>
                    <button class="close-btn" onclick="app.closePhotoComparison()">Ã—</button>
                </div>
                <div id="photoCompareContent"></div>
            </div>
        </div>

        <!-- Active Workout Session Modal -->
        <div id="activeWorkoutModal" class="modal">
            <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2 class="modal-title">Active Workout</h2>
                    <button class="close-btn" onclick="app.cancelWorkoutSession()">Ã—</button>
                </div>
                <div id="activeWorkoutContent"></div>
            </div>
        </div>

        <!-- Add Custom Exercise Modal -->
        <div id="addCustomExerciseModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Create Custom Exercise</h2>
                    <button class="close-btn" onclick="app.closeAddCustomExercise()">Ã—</button>
                </div>
                <div id="addCustomExerciseContent"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://jcsviqflqfltyvgrrykx.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_tQoKPW_bZx5p7-4kRaYXfA_GgW5Lmom';
        
        // Use window.db to avoid conflict with supabase library on window.supabase
        window.db = null;
        
        function initSupabase(url, key) {
            try {
                // The CDN exposes createClient directly
                const { createClient } = window.supabase;
                window.db = createClient(url, key);

                return true;
            } catch (error) {
                console.error('âŒ Supabase init failed:', error);
                return false;
            }
        }
        
        // Always connect - credentials are baked in
        initSupabase(SUPABASE_URL, SUPABASE_KEY);
        localStorage.setItem('supabaseUrl', SUPABASE_URL);
        localStorage.setItem('supabaseKey', SUPABASE_KEY);
    </script>
    <script>
        const app = {
            userId: null, // Set during init
            currentTab: 'today',
            currentExercise: null,
            currentWorkout: {
                sets: []
            },
            restTimer: null,
            restTimeRemaining: 0,
            defaultRestTime: 90, // seconds
            timeRange: '7days',
            progressPhotos: [],
            currentSuperset: null,
            settings: {
                restTimerDuration: 90,
                weightIncrement: 2.5,
                units: 'kg',
                notificationsEnabled: true,
                monthlyCardioGoal: 50 // km per month
            },
            goals: [],
            cardioSessions: [],
            programs: [
                {
                    id: 'push_pull_legs',
                    name: 'Push Pull Legs',
                    description: '3-day split focused on compound movements',
                    schedule: '3x per week',
                    workouts: [
                        {
                            name: 'Push Day',
                            exercises: [
                                { name: 'Bench Press', sets: 4, reps: '8-10' },
                                { name: 'Overhead Press', sets: 3, reps: '8-10' },
                                { name: 'Incline Dumbbell Press', sets: 3, reps: '10-12' },
                                { name: 'Tricep Dips', sets: 3, reps: '10-12' },
                                { name: 'Lateral Raises', sets: 3, reps: '12-15' }
                            ]
                        },
                        {
                            name: 'Pull Day',
                            exercises: [
                                { name: 'Deadlift', sets: 4, reps: '6-8' },
                                { name: 'Pull-ups', sets: 3, reps: '8-10' },
                                { name: 'Barbell Row', sets: 3, reps: '8-10' },
                                { name: 'Face Pulls', sets: 3, reps: '12-15' },
                                { name: 'Bicep Curls', sets: 3, reps: '10-12' }
                            ]
                        },
                        {
                            name: 'Leg Day',
                            exercises: [
                                { name: 'Squat', sets: 4, reps: '8-10' },
                                { name: 'Romanian Deadlift', sets: 3, reps: '10-12' },
                                { name: 'Leg Press', sets: 3, reps: '12-15' },
                                { name: 'Leg Curls', sets: 3, reps: '12-15' },
                                { name: 'Calf Raises', sets: 4, reps: '15-20' }
                            ]
                        }
                    ]
                },
                {
                    id: 'upper_lower',
                    name: 'Upper/Lower Split',
                    description: '4-day split alternating upper and lower body',
                    schedule: '4x per week',
                    workouts: [
                        {
                            name: 'Upper A',
                            exercises: [
                                { name: 'Bench Press', sets: 4, reps: '6-8' },
                                { name: 'Barbell Row', sets: 4, reps: '6-8' },
                                { name: 'Overhead Press', sets: 3, reps: '8-10' },
                                { name: 'Lat Pulldown', sets: 3, reps: '10-12' },
                                { name: 'Dumbbell Curls', sets: 3, reps: '10-12' }
                            ]
                        },
                        {
                            name: 'Lower A',
                            exercises: [
                                { name: 'Squat', sets: 4, reps: '6-8' },
                                { name: 'Romanian Deadlift', sets: 3, reps: '8-10' },
                                { name: 'Leg Press', sets: 3, reps: '10-12' },
                                { name: 'Leg Curls', sets: 3, reps: '12-15' },
                                { name: 'Calf Raises', sets: 4, reps: '15-20' }
                            ]
                        }
                    ]
                },
                {
                    id: 'full_body',
                    name: 'Full Body 3x',
                    description: 'Total body training 3 days per week',
                    schedule: '3x per week (Mon/Wed/Fri)',
                    workouts: [
                        {
                            name: 'Full Body',
                            exercises: [
                                { name: 'Squat', sets: 3, reps: '8-10' },
                                { name: 'Bench Press', sets: 3, reps: '8-10' },
                                { name: 'Barbell Row', sets: 3, reps: '8-10' },
                                { name: 'Overhead Press', sets: 3, reps: '8-10' },
                                { name: 'Romanian Deadlift', sets: 3, reps: '10-12' },
                                { name: 'Pull-ups', sets: 3, reps: 'AMRAP' }
                            ]
                        }
                    ]
                }
            ],
            // Live cardio tracking state
            _cardioActive: false,
            _cardioType: 'Run',
            _cardioStart: null,
            _cardioCoords: [],
            _cardioDistance: 0,
            _cardioPausedMs: 0,
            _cardioPauseStart: null,
            _cardioWatchId: null,
            _cardioTimerInterval: null,
            _cardioSplits: [],
            _cardioLastSplitDist: 0,
            achievements: [],
            workoutNotes: {},
            customExercises: [],
            workoutSessions: [],
            currentSession: null,
            sessionStartTime: null,
            workoutPaused: false,
            workoutPauseTime: null,
            injuries: [],
            deloadWeeks: [],
            workouts: [],
            bodyMetrics: [],
            personalRecords: {},
            dailyLogs: {},
            healthMetrics: [],
            templates: [],
            theme: 'light',
            garminConnected: false,
            garminAccessToken: null,
            garminAccessSecret: null,
            garminData: {},

            // Universal save helper - Supabase first, localStorage fallback
            save(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (error) {
                    console.error(`âŒ Failed to save ${key}:`, error);
                }
            },

            // Supabase Database Operations
            async dbSave(table, data, conflict = null) {
                if (!window.db) {
                    this.save(table, data);
                    return;
                }
                try {
                    const { error } = conflict
                        ? await window.db.from(table).upsert(data, { onConflict: conflict })
                        : await window.db.from(table).upsert(data);
                    if (error) throw error;

                } catch (error) {
                    console.error(`âŒ Supabase save failed for ${table}:`, error);
                    this.save(table, data);
                }
            },

            async dbLoad(table, filters = {}) {
                if (!window.db) return null;
                try {
                    let query = window.db.from(table).select('*');
                    Object.entries(filters).forEach(([key, val]) => {
                        query = query.eq(key, val);
                    });
                    const { data, error } = await query;
                    if (error) {
                        console.error(`âŒ Supabase load failed for ${table}:`, error.message || error.hint || JSON.stringify(error));
                        return null;
                    }
                    return data;
                } catch (error) {
                    console.error(`âŒ Supabase load failed for ${table}:`, error.message || error.hint || JSON.stringify(error));
                    return null;
                }
            },

            exerciseDetails: {
                'Barbell Bench Press': {
                    instructions: 'Lie flat on bench, grip bar slightly wider than shoulders. Lower to chest, press up explosively.',
                    tips: 'Keep feet flat on floor, arch lower back slightly, retract shoulder blades',
                    alternatives: ['Dumbbell Bench Press', 'Push-ups'],
                    primaryMuscle: 'Chest',
                    secondaryMuscles: ['Triceps', 'Shoulders']
                },
                'Barbell Squat': {
                    instructions: 'Bar on upper back, feet shoulder-width. Descend until thighs parallel, drive through heels.',
                    tips: 'Keep chest up, knees track over toes, core tight',
                    alternatives: ['Leg Press', 'Goblet Squat'],
                    primaryMuscle: 'Quads',
                    secondaryMuscles: ['Glutes', 'Hamstrings']
                },
                'Deadlift': {
                    instructions: 'Feet hip-width, grip bar outside legs. Keep back straight, lift by extending hips and knees.',
                    tips: 'Bar stays close to body, neutral spine throughout, engage lats',
                    alternatives: ['Romanian Deadlift', 'Trap Bar Deadlift'],
                    primaryMuscle: 'Back',
                    secondaryMuscles: ['Hamstrings', 'Glutes']
                }
            },

            // Muscle group mapping for all exercises
            muscleGroupMap: {
                'Barbell Bench Press': ['Chest', 'Triceps'],
                'Dumbbell Bench Press': ['Chest', 'Triceps'],
                'Incline Bench Press': ['Chest', 'Triceps'],
                'Push-ups': ['Chest', 'Triceps'],
                'Cable Flyes': ['Chest'],
                'Deadlift': ['Back', 'Hamstrings', 'Glutes'],
                'Pull-ups': ['Back', 'Biceps'],
                'Barbell Row': ['Back'],
                'Lat Pulldown': ['Back'],
                'Seated Cable Row': ['Back'],
                'Barbell Squat': ['Quads', 'Glutes'],
                'Leg Press': ['Quads', 'Glutes'],
                'Romanian Deadlift': ['Hamstrings', 'Glutes'],
                'Leg Curl': ['Hamstrings'],
                'Leg Extension': ['Quads'],
                'Calf Raise': ['Calves'],
                'Overhead Press': ['Shoulders', 'Triceps'],
                'Lateral Raise': ['Shoulders'],
                'Face Pull': ['Shoulders'],
                'Arnold Press': ['Shoulders'],
                'Barbell Curl': ['Biceps'],
                'Hammer Curl': ['Biceps'],
                'Tricep Pushdown': ['Triceps'],
                'Skull Crushers': ['Triceps'],
                'Dips': ['Triceps', 'Chest'],
                'Plank': ['Core'],
                'Cable Crunch': ['Core'],
                'Hanging Leg Raise': ['Core']
            },

            // Pre-built workout programs
            programs: [
                {
                    id: 'stronglifts',
                    name: 'StrongLifts 5x5',
                    description: 'Classic beginner strength program. 3x per week, compound lifts, linear progression.',
                    schedule: 'A/B split, 3 days per week',
                    workouts: [
                        {
                            name: 'Workout A',
                            exercises: [
                                { name: 'Barbell Squat', sets: 5, reps: 5 },
                                { name: 'Barbell Bench Press', sets: 5, reps: 5 },
                                { name: 'Barbell Row', sets: 5, reps: 5 }
                            ]
                        },
                        {
                            name: 'Workout B',
                            exercises: [
                                { name: 'Barbell Squat', sets: 5, reps: 5 },
                                { name: 'Overhead Press', sets: 5, reps: 5 },
                                { name: 'Deadlift', sets: 1, reps: 5 }
                            ]
                        }
                    ]
                },
                {
                    id: 'ppl',
                    name: 'Push/Pull/Legs',
                    description: 'Popular 6-day split focusing on movement patterns. Great for hypertrophy.',
                    schedule: '6 days per week, 2x frequency per muscle',
                    workouts: [
                        {
                            name: 'Push Day',
                            exercises: [
                                { name: 'Barbell Bench Press', sets: 4, reps: 8 },
                                { name: 'Overhead Press', sets: 4, reps: 8 },
                                { name: 'Incline Bench Press', sets: 3, reps: 10 },
                                { name: 'Lateral Raise', sets: 3, reps: 12 },
                                { name: 'Tricep Pushdown', sets: 3, reps: 12 }
                            ]
                        },
                        {
                            name: 'Pull Day',
                            exercises: [
                                { name: 'Deadlift', sets: 4, reps: 6 },
                                { name: 'Pull-ups', sets: 4, reps: 8 },
                                { name: 'Barbell Row', sets: 4, reps: 8 },
                                { name: 'Face Pull', sets: 3, reps: 12 },
                                { name: 'Barbell Curl', sets: 3, reps: 10 }
                            ]
                        },
                        {
                            name: 'Leg Day',
                            exercises: [
                                { name: 'Barbell Squat', sets: 4, reps: 8 },
                                { name: 'Romanian Deadlift', sets: 4, reps: 10 },
                                { name: 'Leg Press', sets: 3, reps: 12 },
                                { name: 'Leg Curl', sets: 3, reps: 12 },
                                { name: 'Calf Raise', sets: 4, reps: 15 }
                            ]
                        }
                    ]
                },
                {
                    id: 'upper_lower',
                    name: 'Upper/Lower Split',
                    description: '4-day split perfect for balanced development and recovery.',
                    schedule: '4 days per week (ULUL)',
                    workouts: [
                        {
                            name: 'Upper A',
                            exercises: [
                                { name: 'Barbell Bench Press', sets: 4, reps: 6 },
                                { name: 'Barbell Row', sets: 4, reps: 6 },
                                { name: 'Overhead Press', sets: 3, reps: 8 },
                                { name: 'Pull-ups', sets: 3, reps: 8 },
                                { name: 'Barbell Curl', sets: 3, reps: 10 }
                            ]
                        },
                        {
                            name: 'Lower A',
                            exercises: [
                                { name: 'Barbell Squat', sets: 4, reps: 6 },
                                { name: 'Romanian Deadlift', sets: 4, reps: 8 },
                                { name: 'Leg Press', sets: 3, reps: 10 },
                                { name: 'Leg Curl', sets: 3, reps: 10 },
                                { name: 'Calf Raise', sets: 4, reps: 12 }
                            ]
                        },
                        {
                            name: 'Upper B',
                            exercises: [
                                { name: 'Overhead Press', sets: 4, reps: 6 },
                                { name: 'Deadlift', sets: 4, reps: 5 },
                                { name: 'Dumbbell Bench Press', sets: 3, reps: 10 },
                                { name: 'Lat Pulldown', sets: 3, reps: 10 },
                                { name: 'Lateral Raise', sets: 3, reps: 12 }
                            ]
                        },
                        {
                            name: 'Lower B',
                            exercises: [
                                { name: 'Deadlift', sets: 3, reps: 6 },
                                { name: 'Barbell Squat', sets: 3, reps: 8 },
                                { name: 'Leg Extension', sets: 3, reps: 12 },
                                { name: 'Leg Curl', sets: 3, reps: 12 },
                                { name: 'Calf Raise', sets: 4, reps: 15 }
                            ]
                        }
                    ]
                },
                {
                    id: 'fullbody',
                    name: 'Full Body 3x',
                    description: 'Train your whole body 3 times per week. Great for beginners and time efficiency.',
                    schedule: '3 days per week (e.g., Mon/Wed/Fri)',
                    workouts: [
                        {
                            name: 'Full Body A',
                            exercises: [
                                { name: 'Barbell Squat', sets: 3, reps: 8 },
                                { name: 'Barbell Bench Press', sets: 3, reps: 8 },
                                { name: 'Barbell Row', sets: 3, reps: 8 },
                                { name: 'Overhead Press', sets: 3, reps: 10 },
                                { name: 'Plank', sets: 3, reps: 60 }
                            ]
                        },
                        {
                            name: 'Full Body B',
                            exercises: [
                                { name: 'Deadlift', sets: 3, reps: 6 },
                                { name: 'Dumbbell Bench Press', sets: 3, reps: 10 },
                                { name: 'Pull-ups', sets: 3, reps: 8 },
                                { name: 'Romanian Deadlift', sets: 3, reps: 10 },
                                { name: 'Lateral Raise', sets: 3, reps: 12 }
                            ]
                        },
                        {
                            name: 'Full Body C',
                            exercises: [
                                { name: 'Barbell Squat', sets: 4, reps: 6 },
                                { name: 'Overhead Press', sets: 3, reps: 8 },
                                { name: 'Lat Pulldown', sets: 3, reps: 10 },
                                { name: 'Leg Curl', sets: 3, reps: 12 },
                                { name: 'Barbell Curl', sets: 3, reps: 10 }
                            ]
                        }
                    ]
                }
            ],

            exercises: [
                // Chest
                { name: 'Barbell Bench Press', category: 'Chest', muscle: 'Chest, Triceps' },
                { name: 'Dumbbell Bench Press', category: 'Chest', muscle: 'Chest, Triceps' },
                { name: 'Incline Bench Press', category: 'Chest', muscle: 'Upper Chest' },
                { name: 'Push-ups', category: 'Chest', muscle: 'Chest, Triceps' },
                { name: 'Cable Flyes', category: 'Chest', muscle: 'Chest' },
                
                // Back
                { name: 'Deadlift', category: 'Back', muscle: 'Full Back, Legs' },
                { name: 'Pull-ups', category: 'Back', muscle: 'Lats, Biceps' },
                { name: 'Barbell Row', category: 'Back', muscle: 'Mid Back' },
                { name: 'Lat Pulldown', category: 'Back', muscle: 'Lats' },
                { name: 'Seated Cable Row', category: 'Back', muscle: 'Mid Back' },
                
                // Legs
                { name: 'Barbell Squat', category: 'Legs', muscle: 'Quads, Glutes' },
                { name: 'Leg Press', category: 'Legs', muscle: 'Quads, Glutes' },
                { name: 'Romanian Deadlift', category: 'Legs', muscle: 'Hamstrings, Glutes' },
                { name: 'Leg Curl', category: 'Legs', muscle: 'Hamstrings' },
                { name: 'Leg Extension', category: 'Legs', muscle: 'Quads' },
                { name: 'Calf Raise', category: 'Legs', muscle: 'Calves' },
                
                // Shoulders
                { name: 'Overhead Press', category: 'Shoulders', muscle: 'Shoulders, Triceps' },
                { name: 'Lateral Raise', category: 'Shoulders', muscle: 'Side Delts' },
                { name: 'Face Pull', category: 'Shoulders', muscle: 'Rear Delts' },
                { name: 'Arnold Press', category: 'Shoulders', muscle: 'Shoulders' },
                
                // Arms
                { name: 'Barbell Curl', category: 'Arms', muscle: 'Biceps' },
                { name: 'Hammer Curl', category: 'Arms', muscle: 'Biceps, Forearms' },
                { name: 'Tricep Pushdown', category: 'Arms', muscle: 'Triceps' },
                { name: 'Skull Crushers', category: 'Arms', muscle: 'Triceps' },
                { name: 'Dips', category: 'Arms', muscle: 'Triceps, Chest' },
                
                // Core
                { name: 'Plank', category: 'Core', muscle: 'Abs, Core' },
                { name: 'Cable Crunch', category: 'Core', muscle: 'Abs' },
                { name: 'Hanging Leg Raise', category: 'Core', muscle: 'Lower Abs' },
            ],

            async init() {
                // Check if user has set their ID (simple multi-user without auth)
                let userId = localStorage.getItem('userId');
                if (!userId) {
                    userId = prompt('Enter your name (this keeps your data separate from others):');
                    if (!userId) userId = 'user_' + Date.now(); // fallback
                    localStorage.setItem('userId', userId.toLowerCase().replace(/\s+/g, '_'));
                }
                this.userId = localStorage.getItem('userId');

                // Register service worker for offline + state persistence
                if ('serviceWorker' in navigator) {
                    try {
                        await navigator.serviceWorker.register('/sw.js');

                    } catch (e) {
                        console.warn('Service worker failed:', e);
                    }
                }

                // Always load data from Supabase/localStorage
                await this.loadData();
                
                // Load social data
                this.friends = JSON.parse(localStorage.getItem('friends') || '[]');
                this.challenges = JSON.parse(localStorage.getItem('challenges') || '[]');
                this.workoutFeed = JSON.parse(localStorage.getItem('workoutFeed') || '[]');
                
                // Request notification permission for rest timer (10)
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
                
                // Show onboarding for new users (1)
                const hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding');
                if (!hasSeenOnboarding && this.workoutSessions.length === 0) {
                    setTimeout(() => this.showOnboarding(), 500);
                }
                
                // Update sync status indicator (1 & 2)
                this.updateSyncStatus();
                setInterval(() => this.updateSyncStatus(), 5000); // Check every 5s
                
                // Load theme preference
                this.loadTheme();
                
                this.renderToday();
                this.renderAnalytics();
                this.renderHistory();
                this.renderHealth();

                // Initialize pull-to-refresh on Today tab
                this.initPullToRefresh();

                // Auto-save state every 10s to survive backgrounding
                setInterval(() => this.saveAppState(), 10000);
                
                // Save state immediately when app goes to background
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.saveAppState();

                    }
                });

                // iOS-specific: save before pagehide/beforeunload
                window.addEventListener('pagehide', () => this.saveAppState());
                window.addEventListener('beforeunload', () => this.saveAppState());
                
                // Restore active cardio if it was running
                this.restoreCardioState();
            },

            async loadData() {

                if (window.db) {
                    try {
                        // Test connection first with a simple query
                        const testResult = await window.db.from('workout_sessions').select('count').limit(1);

                        // If we hit iframe/CORS issues, fall back to localStorage
                        if (testResult.error && testResult.error.message?.includes('postMessage')) {
                            console.warn('âš ï¸ Supabase blocked by browser security (likely iframe). Using localStorage only.');
                            window.db = null; // Disable Supabase for this session
                            this.loadFromLocalStorage();
                            return;
                        }

                        // Load from Supabase
                        const [sessions, workouts, prs, logs, metrics, settings, achievements, goals] = await Promise.all([
                            this.dbLoad('workout_sessions', { user_id: this.userId }),
                            this.dbLoad('workouts', { user_id: this.userId }),
                            this.dbLoad('personal_records', { user_id: this.userId }),
                            this.dbLoad('daily_logs', { user_id: this.userId }),
                            this.dbLoad('body_metrics', { user_id: this.userId }),
                            this.dbLoad('settings', { user_id: this.userId }),
                            this.dbLoad('achievements', { user_id: this.userId }),
                            this.dbLoad('goals', { user_id: this.userId }),
                        ]);

                        console.log('ðŸ“¦ Sessions raw:', JSON.stringify(sessions?.slice(0,2)));
                        console.log('ðŸ“¦ Workouts raw:', JSON.stringify(workouts?.slice(0,2)));

                        this.workoutSessions = (sessions || []).map(s => ({
                            id: s.id, date: s.date, startTime: s.start_time,
                            endTime: s.end_time, duration: s.duration,
                            notes: s.notes, exercises: s.exercises || []
                        }));

                        this.workouts = (workouts || []).map(w => ({
                            id: w.id, exercise: w.exercise, date: w.date,
                            sets: w.sets || [], notes: w.notes
                        }));

                        this.personalRecords = {};
                        (prs || []).forEach(pr => {
                            this.personalRecords[pr.exercise] = {
                                weight: pr.weight, reps: pr.reps, date: pr.date
                            };
                        });

                        this.dailyLogs = {};
                        (logs || []).forEach(log => {
                            this.dailyLogs[log.date] = {
                                sleep: log.sleep, sleepQuality: log.sleep_quality,
                                rhr: log.rhr, hrv: log.hrv, energy: log.energy,
                                stress: log.stress, soreness: log.soreness,
                                steps: log.steps, calories: log.calories_burned,
                                water: log.water, caloriesIn: log.calories_in,
                                protein: log.protein, carbs: log.carbs,
                                fats: log.fats, eatingQuality: log.eating_quality,
                                notes: log.notes
                            };
                        });

                        this.bodyMetrics = (metrics || []).map(m => ({
                            date: m.date, weight: m.weight,
                            bodyFat: m.body_fat, muscleMass: m.muscle_mass, notes: m.notes
                        }));

                        const s = settings?.[0];
                        this.settings = s ? {
                            restTimerDuration: s.rest_timer_duration || 90,
                            weightIncrement: s.weight_increment || 2.5,
                            units: s.units || 'kg',
                            calTarget: s.cal_target || 2500,
                            proteinTarget: s.protein_target || 160,
                            carbTarget: s.carb_target || 250,
                            fatTarget: s.fat_target || 80,
                            theme: s.theme || 'light'
                        } : this.settings;

                        this.achievements = (achievements || []).map(a => a.achievement_id);
                        this.goals = (goals || []);
                        this.theme = this.settings.theme || 'light';

                    } catch (error) {
                        console.error('âŒ Supabase load failed, using localStorage:', error);
                        this.loadFromLocalStorage();
                    }
                } else {
                    this.loadFromLocalStorage();
                }

                this.cardioSessions = JSON.parse(localStorage.getItem('cardioSessions') || '[]');
                this.templates = JSON.parse(localStorage.getItem('templates') || '[]');
                this.customExercises = JSON.parse(localStorage.getItem('customExercises') || '[]');
                this.progressPhotos = JSON.parse(localStorage.getItem('progressPhotos') || '[]');
                this.allExercises = [...this.exercises, ...this.customExercises];
            },

            loadFromLocalStorage() {

                this.workouts = JSON.parse(localStorage.getItem('workouts') || '[]');
                this.workoutSessions = JSON.parse(localStorage.getItem('workoutSessions') || '[]');
                this.personalRecords = JSON.parse(localStorage.getItem('personalRecords') || '{}');
                this.bodyMetrics = JSON.parse(localStorage.getItem('bodyMetrics') || '[]');
                this.settings = JSON.parse(localStorage.getItem('settings') || '{"restTimerDuration":90,"weightIncrement":2.5,"units":"kg","calTarget":2500,"proteinTarget":160,"carbTarget":250,"fatTarget":80}');
                this.goals = JSON.parse(localStorage.getItem('goals') || '[]');
                this.achievements = JSON.parse(localStorage.getItem('achievements') || '[]');
                this.workoutNotes = JSON.parse(localStorage.getItem('workoutNotes') || '{}');
                this.dailyLogs = JSON.parse(localStorage.getItem('dailyLogs') || '{}');
                this.healthMetrics = JSON.parse(localStorage.getItem('healthMetrics') || '[]');
                this.theme = localStorage.getItem('theme') || 'light';

            },

            async saveWorkouts() {
                localStorage.setItem('workouts', JSON.stringify(this.workouts));
                if (!window.db) return;
                try {
                    const rows = this.workouts.map(w => ({
                        id: w.id || w.exercise + '_' + w.date,
                        user_id: this.userId,
                        exercise: w.exercise, date: w.date,
                        sets: w.sets, notes: w.notes || null
                    }));
                    if (rows.length > 0) await window.db.from('workouts').upsert(rows);
                } catch(e) { console.error('saveWorkouts:', e); }
            },

            async saveTemplates() {
                localStorage.setItem('templates', JSON.stringify(this.templates));
            },

            async saveBodyMetrics() {
                localStorage.setItem('bodyMetrics', JSON.stringify(this.bodyMetrics));
                if (!window.db) return;
                try {
                    const rows = this.bodyMetrics.map(m => ({
                        user_id: this.userId, date: m.date,
                        weight: m.weight, body_fat: m.bodyFat,
                        muscle_mass: m.muscleMass, notes: m.notes || null
                    }));
                    if (rows.length > 0) await window.db.from('body_metrics').upsert(rows);
                } catch(e) { console.error('saveBodyMetrics:', e); }
            },

            async savePersonalRecords() {
                localStorage.setItem('personalRecords', JSON.stringify(this.personalRecords));
                if (!window.db) return;
                try {
                    const rows = Object.entries(this.personalRecords).map(([exercise, pr]) => ({
                        user_id: this.userId, exercise,
                        weight: pr.weight, reps: pr.reps, date: pr.date
                    }));
                    if (rows.length > 0) {
                        const exercises = rows.map(r => r.exercise);
                        await window.db.from('personal_records')
                            .delete()
                            .eq('user_id', this.userId)
                            .in('exercise', exercises);
                        const { error } = await window.db.from('personal_records').insert(rows);
                        if (error) throw error;

                    }
                } catch(e) { console.error('âŒ savePersonalRecords failed:', e); }
            },

            async saveProgressPhotos() {
                localStorage.setItem('progressPhotos', JSON.stringify(this.progressPhotos));
            },

            async saveTheme() {
                localStorage.setItem('theme', this.theme);
            },

            async saveSettings() {
                localStorage.setItem('settings', JSON.stringify(this.settings));
                if (!window.db) return;
                try {
                    await window.db.from('settings').upsert({
                        user_id: this.userId,
                        rest_timer_duration: this.settings.restTimerDuration,
                        weight_increment: this.settings.weightIncrement,
                        units: this.settings.units,
                        cal_target: this.settings.calTarget,
                        protein_target: this.settings.proteinTarget,
                        carb_target: this.settings.carbTarget,
                        fat_target: this.settings.fatTarget,
                        theme: this.theme
                    });
                } catch(e) { console.error('saveSettings:', e); }
            },

            async saveGoals() {
                localStorage.setItem('goals', JSON.stringify(this.goals));
            },

            async saveAchievements() {
                localStorage.setItem('achievements', JSON.stringify(this.achievements));
                if (!window.db) return;
                try {
                    const rows = this.achievements.map(id => ({ user_id: this.userId, achievement_id: id }));
                    if (rows.length > 0) await window.db.from('achievements').upsert(rows, { onConflict: 'user_id,achievement_id' });
                } catch(e) { console.error('saveAchievements:', e); }
            },

            async saveWorkoutNotes() {
                localStorage.setItem('workoutNotes', JSON.stringify(this.workoutNotes));
            },

            async saveCustomExercises() {
                localStorage.setItem('customExercises', JSON.stringify(this.customExercises));
            },

            async saveWorkoutSessions() {
                localStorage.setItem('workoutSessions', JSON.stringify(this.workoutSessions));

                if (!window.db) { 
                    this.lastSyncStatus = 'offline';
                    this.updateSyncStatus();
                    return; 
                }
                try {
                    const rows = this.workoutSessions.map(s => ({
                        id: s.id?.toString(),
                        user_id: this.userId,
                        date: s.date, start_time: s.startTime,
                        end_time: s.endTime, duration: s.duration,
                        notes: s.notes || null, exercises: s.exercises
                    }));
                    if (rows.length > 0) {
                        const { data, error } = await window.db.from('workout_sessions').upsert(rows).select();
                        if (error) throw error;
                        this.lastSyncTime = Date.now();
                        this.lastSyncStatus = 'success';
                    }
                } catch(e) { 
                    console.error('âŒ saveWorkoutSessions failed:', e); 
                    this.lastSyncStatus = 'error';
                }
                this.updateSyncStatus();
            },

            updateSyncStatus() {
                const isOnline = navigator.onLine;
                const isConnected = !!window.db;
                this.syncStatus = { 
                    isOnline, 
                    isConnected,
                    lastSync: this.lastSyncTime,
                    status: this.lastSyncStatus || (isConnected ? 'synced' : 'offline')
                };
            },

            async saveHealthMetrics() {
                localStorage.setItem('healthMetrics', JSON.stringify(this.healthMetrics));
            },

            async saveDailyLogs() {
                localStorage.setItem('dailyLogs', JSON.stringify(this.dailyLogs));
                if (!window.db) return;
                try {
                    const rows = Object.entries(this.dailyLogs).map(([date, log]) => ({
                        user_id: this.userId, date,
                        sleep: log.sleep, sleep_quality: log.sleepQuality,
                        rhr: log.rhr, hrv: log.hrv, energy: log.energy,
                        stress: log.stress, soreness: log.soreness,
                        steps: log.steps, calories_burned: log.calories,
                        water: log.water, calories_in: log.caloriesIn,
                        protein: log.protein, carbs: log.carbs,
                        fats: log.fats, eating_quality: log.eatingQuality,
                        notes: log.notes || null
                    }));
                    if (rows.length > 0) {
                        // Delete existing rows for these dates, then insert fresh
                        const dates = rows.map(r => r.date);
                        await window.db.from('daily_logs')
                            .delete()
                            .eq('user_id', this.userId)
                            .in('date', dates);
                        const { error } = await window.db.from('daily_logs').insert(rows);
                        if (error) throw error;

                    }
                } catch(e) { console.error('âŒ saveDailyLogs failed:', e); }
            },

            switchTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.getElementById(tab).classList.add('active');
                
                // Only highlight tab if it's in the bottom nav
                const tabBtn = document.querySelector(`[onclick="app.switchTab('${tab}')"]`);
                if (tabBtn && tabBtn.closest('.tab-bar')) {
                    tabBtn.classList.add('active');
                }
                
                if (tab === 'today') this.renderToday();
                if (tab === 'health') this.renderHealth();
                if (tab === 'social') this.renderSocial();
                if (tab === 'history') this.renderHistory();
                if (tab === 'analytics') this.renderAnalytics();
                if (tab === 'cardio') this.renderCardio();
                if (tab === 'templates') this.renderTemplates();
                if (tab === 'library') this.renderLibrary();
                if (tab === 'more') this.renderMore();
            },

            renderSocial() {
                if (!this.friends) this.friends = [];
                if (!this.workoutFeed) this.workoutFeed = [];
                if (!this.challenges) this.challenges = [];
                
                let html = `
                    <div class="section-header">
                        <div class="section-title">Social</div>
                        <button class="btn btn-primary" onclick="app.showAddFriend()" style="padding: 6px 12px; font-size: 13px;">+ Add Friend</button>
                    </div>
                    
                    <!-- My Profile Card -->
                    <div class="premium-stat-card" style="margin-bottom: 16px; background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%); color: white;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 700;">
                                ${this.userId.charAt(0).toUpperCase()}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 20px; font-weight: 700;">${this.userId}</div>
                                <div style="font-size: 13px; opacity: 0.9;">${this.workoutSessions.length} workouts â€¢ ${this.friends.length} friends</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabs -->
                    <div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid var(--border);">
                        <button class="btn btn-secondary" onclick="app.showSocialTab('feed')" id="socialTabFeed" style="flex: 1; border-radius: 8px 8px 0 0;">
                            Feed
                        </button>
                        <button class="btn btn-secondary" onclick="app.showSocialTab('friends')" id="socialTabFriends" style="flex: 1; border-radius: 8px 8px 0 0;">
                            Friends
                        </button>
                        <button class="btn btn-secondary" onclick="app.showSocialTab('challenges')" id="socialTabChallenges" style="flex: 1; border-radius: 8px 8px 0 0;">
                            Challenges
                        </button>
                    </div>
                    
                    <div id="socialTabContent"></div>
                `;
                
                document.getElementById('socialContent').innerHTML = html;
                this.showSocialTab(this.currentSocialTab || 'feed');
            },

            showSocialTab(tab) {
                this.currentSocialTab = tab;
                
                // Update button styles
                ['feed', 'friends', 'challenges'].forEach(t => {
                    const btn = document.getElementById(`socialTab${t.charAt(0).toUpperCase() + t.slice(1)}`);
                    if (btn) {
                        if (t === tab) {
                            btn.style.background = 'var(--primary)';
                            btn.style.color = 'white';
                        } else {
                            btn.style.background = 'var(--surface2)';
                            btn.style.color = 'var(--text-primary)';
                        }
                    }
                });
                
                if (tab === 'feed') this.renderWorkoutFeed();
                if (tab === 'friends') this.renderFriends();
                if (tab === 'challenges') this.renderChallenges();
            },

            renderWorkoutFeed() {
                // Combine own workouts + friends' workouts
                const myWorkouts = this.workoutSessions.map(s => ({
                    ...s,
                    userId: this.userId,
                    userName: this.userId
                }));
                
                const allWorkouts = [...myWorkouts, ...this.workoutFeed]
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 20);
                
                let html = '';
                
                if (allWorkouts.length === 0) {
                    html = `
                        <div class="empty-state">
                            <div style="font-size: 48px; margin-bottom: 16px;">ðŸ‘¥</div>
                            <div class="empty-text">No workouts yet<br>Add friends to see their activity!</div>
                        </div>
                    `;
                } else {
                    html = allWorkouts.map(workout => {
                        const totalVolume = workout.exercises?.reduce((sum, ex) => 
                            sum + ex.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                        ) || 0;
                        const totalSets = workout.exercises?.reduce((sum, ex) => sum + ex.sets.length, 0) || 0;
                        const duration = workout.duration ? this.formatDuration(workout.duration) : 'N/A';
                        const isMe = workout.userId === this.userId;
                        
                        return `
                            <div class="premium-stat-card" style="margin-bottom: 16px;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: ${isMe ? 'var(--accent)' : 'var(--primary)'}; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; color: white;">
                                        ${workout.userName.charAt(0).toUpperCase()}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600;">${workout.userName} ${isMe ? '(You)' : ''}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">${new Date(workout.date).toLocaleDateString()}</div>
                                    </div>
                                    ${!isMe ? `<button onclick="app.likeWorkout('${workout.id}')" style="background: none; border: none; font-size: 20px; cursor: pointer;">â¤ï¸</button>` : ''}
                                </div>
                                
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 14px; color: var(--text-secondary);">
                                        ${workout.exercises?.map(e => e.name).slice(0, 3).join(', ')}${workout.exercises?.length > 3 ? '...' : ''}
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 16px; padding-top: 12px; border-top: 1px solid var(--border);">
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Volume</div>
                                        <div style="font-size: 16px; font-weight: 700;">${this.formatNumber(totalVolume)}kg</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Sets</div>
                                        <div style="font-size: 16px; font-weight: 700;">${totalSets}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Duration</div>
                                        <div style="font-size: 16px; font-weight: 700;">${duration}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                document.getElementById('socialTabContent').innerHTML = html;
            },

            renderFriends() {
                let html = '';
                
                if (this.friends.length === 0) {
                    html = `
                        <div class="empty-state">
                            <div style="font-size: 48px; margin-bottom: 16px;">ðŸ‘¤</div>
                            <div class="empty-text">No friends yet<br>Add friends to compare workouts!</div>
                            <button class="btn btn-primary" onclick="app.showAddFriend()" style="margin-top: 16px;">Add Friend</button>
                        </div>
                    `;
                } else {
                    html = this.friends.map(friend => `
                        <div class="premium-stat-card" style="margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; color: white;">
                                    ${friend.name.charAt(0).toUpperCase()}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px;">${friend.name}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${friend.workouts || 0} workouts this month</div>
                                </div>
                                <button onclick="app.removeFriend('${friend.id}')" style="background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px;">Remove</button>
                            </div>
                        </div>
                    `).join('');
                }
                
                document.getElementById('socialTabContent').innerHTML = html;
            },

            renderChallenges() {
                let html = `
                    <button class="btn btn-primary" onclick="app.createChallenge()" style="width: 100%; margin-bottom: 16px;">
                        + Create Challenge
                    </button>
                `;
                
                if (this.challenges.length === 0) {
                    html += `
                        <div class="empty-state">
                            <div style="font-size: 48px; margin-bottom: 16px;">ðŸ†</div>
                            <div class="empty-text">No active challenges<br>Create one to compete with friends!</div>
                        </div>
                    `;
                } else {
                    html += this.challenges.map(challenge => {
                        const progress = challenge.type === 'volume' 
                            ? this.getWeeklyVolume() 
                            : this.workoutSessions.filter(s => {
                                const weekAgo = new Date();
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                return new Date(s.date) >= weekAgo;
                            }).length;
                        
                        const pct = Math.min(100, (progress / challenge.goal) * 100);
                        
                        return `
                            <div class="premium-stat-card" style="margin-bottom: 16px;">
                                <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">${challenge.name}</div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">${challenge.description}</div>
                                
                                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">
                                    <span>Progress</span>
                                    <span>${Math.round(progress)} / ${challenge.goal}</span>
                                </div>
                                
                                <div style="height: 8px; background: var(--border); border-radius: 10px; overflow: hidden; margin-bottom: 12px;">
                                    <div style="height: 100%; width: ${pct}%; background: ${pct >= 100 ? 'var(--success)' : 'var(--accent)'}; transition: width 0.3s;"></div>
                                </div>
                                
                                <div style="display: flex; gap: 8px;">
                                    ${pct >= 100 ? `
                                        <div style="padding: 8px; background: var(--success); color: white; border-radius: 8px; text-align: center; flex: 1; font-weight: 600;">
                                            âœ… Completed!
                                        </div>
                                    ` : `
                                        <div style="padding: 8px; background: var(--surface2); border-radius: 8px; text-align: center; flex: 1; font-size: 12px; color: var(--text-secondary);">
                                            ${Math.round(challenge.goal - progress)} to go
                                        </div>
                                    `}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                document.getElementById('socialTabContent').innerHTML = html;
            },

            showAddFriend() {
                const username = prompt('Enter friend\'s username:');
                if (!username) return;
                
                // Simulate friend lookup
                this.friends.push({
                    id: Date.now().toString(),
                    name: username,
                    workouts: Math.floor(Math.random() * 20)
                });
                
                localStorage.setItem('friends', JSON.stringify(this.friends));
                this.showNotification(`âœ… Added ${username}!`);
                this.renderFriends();
            },

            removeFriend(friendId) {
                if (!confirm('Remove this friend?')) return;
                
                this.friends = this.friends.filter(f => f.id !== friendId);
                localStorage.setItem('friends', JSON.stringify(this.friends));
                this.showNotification('Friend removed');
                this.renderFriends();
            },

            createChallenge() {
                const name = prompt('Challenge name:', '100K Volume This Week');
                if (!name) return;
                
                const type = prompt('Type: volume or workouts', 'volume');
                const goal = prompt('Goal amount:', type === 'volume' ? '100000' : '5');
                
                this.challenges.push({
                    id: Date.now().toString(),
                    name,
                    description: `Reach ${goal}${type === 'volume' ? 'kg' : ' workouts'} this week`,
                    type,
                    goal: parseInt(goal),
                    startDate: new Date().toISOString()
                });
                
                localStorage.setItem('challenges', JSON.stringify(this.challenges));
                this.showNotification('ðŸ† Challenge created!');
                this.renderChallenges();
            },

            getWeeklyVolume() {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                return this.workoutSessions
                    .filter(s => new Date(s.date) >= weekAgo)
                    .reduce((sum, s) => sum + s.exercises.reduce((esum, ex) => 
                        esum + ex.sets.reduce((ssum, set) => ssum + (set.weight * set.reps), 0), 0
                    ), 0);
            },

            likeWorkout(workoutId) {
                this.showNotification('â¤ï¸ Liked!');
            },

            renderLibrary() {
                const searchTerm = this.librarySearch || '';
                const categories = [...new Set(this.exercises.map(e => e.category))];
                
                let html = `
                    <input type="text" 
                        class="search-box" 
                        placeholder="Search exercises..." 
                        value="${searchTerm}"
                        oninput="app.searchLibrary(this.value)"
                        style="margin-bottom: 16px;">
                `;
                
                const filteredExercises = searchTerm 
                    ? this.exercises.filter(e => 
                        e.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        e.muscle.toLowerCase().includes(searchTerm.toLowerCase())
                      )
                    : this.exercises;
                
                if (filteredExercises.length === 0) {
                    html += `
                        <div class="empty-state">
                            <div class="empty-icon">ðŸ”</div>
                            <div class="empty-text">No exercises found</div>
                        </div>
                    `;
                } else if (searchTerm) {
                    // Show flat list when searching
                    html += filteredExercises.map(ex => `
                        <div class="exercise-item" onclick="app.showExerciseDetails('${ex.name.replace(/'/g, "\\'")}')">
                            <div>
                                <div class="exercise-name">${ex.name}</div>
                                <div class="exercise-muscle">${ex.muscle} â€¢ ${ex.category}</div>
                            </div>
                            <div class="chevron">â€º</div>
                        </div>
                    `).join('');
                } else {
                    // Show categories (3. collapsed by default)
                    html += categories.map(cat => {
                        const isExpanded = this.expandedCategories?.[cat];
                        const catExercises = this.exercises.filter(e => e.category === cat);
                        
                        return `
                            <div class="exercise-category">
                                <div class="category-title" onclick="app.toggleCategory('${cat}')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                    <span>${cat} (${catExercises.length})</span>
                                    <span style="font-size: 20px;">${isExpanded ? 'âˆ’' : '+'}</span>
                                </div>
                                ${isExpanded ? catExercises.map(ex => `
                                    <div class="exercise-item" onclick="app.showExerciseDetails('${ex.name.replace(/'/g, "\\'")}')">
                                        <div>
                                            <div class="exercise-name">${ex.name}</div>
                                            <div class="exercise-muscle">${ex.muscle}</div>
                                        </div>
                                        <div class="chevron">â€º</div>
                                    </div>
                                `).join('') : ''}
                            </div>
                        `;
                    }).join('');
                }
                
                document.getElementById('exerciseLibrary').innerHTML = html;
            },

            searchLibrary(term) {
                this.librarySearch = term;
                clearTimeout(this._searchTimeout); // 13. debounce
                this._searchTimeout = setTimeout(() => this.renderLibrary(), 300);
            },

            toggleCategory(category) {
                if (!this.expandedCategories) this.expandedCategories = {};
                this.expandedCategories[category] = !this.expandedCategories[category];
                this.renderLibrary();
            },

            renderToday() {
                const today = new Date().toISOString().split('T')[0];
                const todayWorkouts = this.workouts.filter(w => w.date === today);
                
                // Calculate days since last workout (5: rest day indicator)
                const allDates = [...new Set([...this.workouts.map(w => w.date), ...this.workoutSessions.map(s => s.date)])].sort();
                const lastWorkoutDate = allDates[allDates.length - 1];
                const daysSinceWorkout = lastWorkoutDate ? Math.floor((new Date(today) - new Date(lastWorkoutDate)) / (1000 * 60 * 60 * 24)) : 0;
                
                // Calculate streak
                const streak = this.calculateStreak();
                
                // Calculate today's stats
                const totalSets = todayWorkouts.reduce((sum, w) => sum + w.sets.length, 0);
                const totalVolume = todayWorkouts.reduce((sum, w) => 
                    sum + w.sets.reduce((s, set) => s + ((set.weight || 0) * (set.reps || 0)), 0), 0
                );
                
                let html = '';
                
                // Rest day indicator (5)
                if (todayWorkouts.length === 0 && daysSinceWorkout >= 1 && this.workouts.length > 0) {
                    let message = '';
                    let bgColor = '';
                    if (daysSinceWorkout === 1) {
                        message = 'ðŸ’ª Back to training today?';
                        bgColor = 'var(--accent)';
                    } else if (daysSinceWorkout === 2) {
                        message = 'ðŸ’¤ Rest day - last workout 2 days ago';
                        bgColor = 'var(--surface2)';
                    } else if (daysSinceWorkout >= 3) {
                        message = `âš ï¸ ${daysSinceWorkout} days since last workout`;
                        bgColor = 'var(--warning)';
                    }
                    
                    html += `
                        <div class="card" style="background: ${bgColor}; border: none; margin-bottom: 16px; padding: 16px;">
                            <div style="font-size: 15px; font-weight: 600; color: ${daysSinceWorkout >= 3 ? '#141414' : 'var(--text-primary)'}; text-align: center;">
                                ${message}
                            </div>
                        </div>
                    `;
                }
                
                // Volume landmarks (15)
                const weekVolume = this.getWorkoutsInDays(7).reduce((sum, w) => 
                    sum + w.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                );
                const allWeekVolumes = [];
                for (let i = 0; i < 52; i++) {
                    const weekStart = new Date();
                    weekStart.setDate(weekStart.getDate() - (i * 7 + 7));
                    const weekEnd = new Date();
                    weekEnd.setDate(weekEnd.getDate() - (i * 7));
                    
                    const weekWorkouts = this.workouts.filter(w => {
                        const d = new Date(w.date);
                        return d >= weekStart && d <= weekEnd;
                    });
                    
                    const vol = weekWorkouts.reduce((sum, w) =>
                        sum + w.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                    );
                    allWeekVolumes.push(vol);
                }
                
                const maxWeekVolume = Math.max(...allWeekVolumes);
                const avgWeekVolume = allWeekVolumes.reduce((a, b) => a + b, 0) / allWeekVolumes.length;
                
                if (weekVolume > maxWeekVolume && weekVolume > 1000) {
                    html += `
                        <div class="card" style="background: var(--success); border: none; margin-bottom: 16px; padding: 16px;">
                            <div style="font-size: 15px; font-weight: 600; color: #ffffff; text-align: center;">
                                ðŸ† NEW RECORD: Highest volume week ever! (${this.formatNumber(weekVolume)}kg)
                            </div>
                        </div>
                    `;
                } else if (weekVolume > avgWeekVolume * 1.5 && weekVolume > 1000) {
                    html += `
                        <div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; margin-bottom: 16px; padding: 16px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                            <div style="font-size: 15px; font-weight: 600; color: #ffffff; text-align: center;">
                                ðŸ’ª Strong week! ${((weekVolume / avgWeekVolume - 1) * 100).toFixed(0)}% above your average
                            </div>
                        </div>
                    `;
                }
                
                // Smart Recommendations
                const recommendations = this.getSmartRecommendations();
                if (recommendations.length > 0 && todayWorkouts.length === 0) {
                    html += `
                        <div class="card" style="background: var(--surface); border: 1px solid var(--border); margin-bottom: 16px;">
                            <div style="font-size: 13px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.06em;">Suggestions</div>
                            ${recommendations.slice(0, 3).map(rec => `
                                <div style="padding: 10px 0; border-bottom: 1px solid var(--border); last-child:border: none;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 3px;">${rec.icon} ${rec.title}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.4;">${rec.reason}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Streak badge + calendar heatmap (6)
                if (streak > 0 || this.workoutSessions.length > 0) {
                    const last12Weeks = [];
                    for (let i = 83; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().split('T')[0];
                        const hasWorkout = this.workoutSessions.some(s => s.date === dateStr);
                        last12Weeks.push({ date: dateStr, hasWorkout });
                    }
                    
                    html += `
                        <div class="streak-badge">
                            <div class="streak-icon">â†‘</div>
                            <div class="streak-text">
                                <div class="streak-number">${streak} Day${streak > 1 ? 's' : ''}</div>
                                <div class="streak-label">Workout Streak</div>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-bottom: 16px;">
                            <div class="card-title" style="margin-bottom: 12px;">Training Calendar</div>
                            <div style="display: grid; grid-template-columns: repeat(14, 1fr); gap: 3px;">
                                ${last12Weeks.map(day => `
                                    <div style="aspect-ratio: 1; background: ${day.hasWorkout ? 'var(--success)' : 'rgba(255, 255, 255, 0.1)'}; border-radius: 3px; ${day.hasWorkout ? 'box-shadow: 0 0 8px rgba(74, 222, 128, 0.3);' : ''}" title="${day.date}"></div>
                                `).join('')}
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); margin-top: 8px;">
                                <span>12 weeks ago</span>
                                <span>Today</span>
                            </div>
                        </div>
                    `;
                }
                
                // Quick actions
                html += `
                    <div class="quick-actions">
                        <div class="quick-action-btn" onclick="app.quickStartWorkout()">
                            <div class="quick-action-icon">âš¡</div>
                            <div class="quick-action-label">Quick Start</div>
                        </div>
                        <div class="quick-action-btn" onclick="app.switchTab('cardio')">
                            <div class="quick-action-icon">ðŸƒ</div>
                            <div class="quick-action-label">Cardio</div>
                        </div>
                        <div class="quick-action-btn" onclick="app.switchTab('templates')">
                            <div class="quick-action-icon">â‰¡</div>
                            <div class="quick-action-label">Programs</div>
                        </div>
                        <div class="quick-action-btn" onclick="app.duplicateLastWorkout()">
                            <div class="quick-action-icon">â†º</div>
                            <div class="quick-action-label">Repeat Last</div>
                        </div>
                    </div>
                `;

                // Show program shortcuts (5)
                if (this.programs.length > 0) {
                    html += `
                        <div class="card" style="margin-bottom: 16px; background: var(--surface);">
                            <div class="card-title" style="margin-bottom: 12px;">Quick Programs</div>
                            ${this.programs.slice(0, 3).map(program => `
                                <div style="padding: 10px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="app.showProgramDetails('${program.id}')">
                                    <div style="font-weight: 600; margin-bottom: 2px; color: var(--text-primary);">${program.name}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${program.schedule}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // Quick Stats Dashboard
                if (this.workouts.length > 0 || this.workoutSessions.length > 0) {
                    const weekWorkouts = this.getWorkoutsInDays(7);
                    const weekVolume = weekWorkouts.reduce((sum, w) => 
                        sum + w.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                    );
                    const recentPRs = this.getRecentPRs(7);
                    const totalWorkouts = this.workoutSessions.length || this.workouts.length;

                    html += `
                        <div class="premium-stat-card" style="margin-bottom: 16px;">
                            <div class="premium-stat-header">This Week</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                <div>
                                    <div class="metric-label-small">Workouts</div>
                                    <div class="metric-value-large">${[...new Set(weekWorkouts.map(w => w.date))].length}</div>
                                </div>
                                <div>
                                    <div class="metric-label-small">Volume</div>
                                    <div class="metric-value-large">${this.formatNumber(weekVolume)}kg</div>
                                </div>
                            </div>
                            ${recentPRs.length > 0 ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                    <div class="metric-label-small">Recent PRs</div>
                                    <div style="font-size: 14px; font-weight: 600; color: var(--primary); margin-top: 4px;">
                                        ${recentPRs.length} new ${recentPRs.length === 1 ? 'record' : 'records'}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // Today's stats
                if (todayWorkouts.length > 0) {
                    html += `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${todayWorkouts.length}</div>
                                <div class="stat-label">Exercises</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${totalSets}</div>
                                <div class="stat-label">Total Sets</div>
                            </div>
                        </div>
                        <div class="stat-card" style="margin-bottom: 16px;">
                            <div class="stat-value">${this.formatNumber(totalVolume)}kg</div>
                            <div class="stat-label">Total Volume</div>
                        </div>
                    `;
                }
                
                if (todayWorkouts.length === 0) {
                    html += `
                        <div class="empty-state">
                            <div class="empty-icon">+</div>
                            <div class="empty-text">No workouts logged today<br>Tap "Start Workout" to begin!</div>
                        </div>
                    `;
                } else {
                    // Group workouts by session
                    const todaySessions = this.workoutSessions.filter(s => s.date === today);
                    
                    if (todaySessions.length > 0) {
                        // Show full sessions
                        html += todaySessions.map(session => {
                            const duration = session.duration ? this.formatDuration(session.duration) : 'N/A';
                            const totalVolume = session.exercises.reduce((sum, ex) => 
                                sum + ex.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                            );
                            const totalSets = session.exercises.reduce((sum, ex) => sum + ex.sets.length, 0);
                            
                            return `
                                <div class="card" style="margin-bottom: 16px;">
                                    <div class="card-header">
                                        <div>
                                            <div class="card-title">Workout Session</div>
                                            <div class="card-subtitle">
                                                ${session.exercises.length} exercises â€¢ ${totalSets} sets â€¢ ${duration}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="background: var(--background); padding: 12px; border-radius: 8px; margin: 12px 0;">
                                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Duration</div>
                                                <div style="font-size: 18px; font-weight: 600;">${duration}</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Volume</div>
                                                <div style="font-size: 18px; font-weight: 600;">${this.formatNumber(totalVolume)}kg</div>
                                            </div>
                                        </div>
                                    </div>

                                    ${session.exercises.map((exercise, i) => {
                                        const workout = todayWorkouts.find(w => w.exercise === exercise.name && w.sessionId === session.id);
                                        const isPR = workout ? this.checkIfPR(workout) : false;
                                        const improvement = workout ? this.calculateImprovement(workout) : 0;
                                        
                                        return `
                                            <div style="padding: 12px 0; border-top: 1px solid var(--border);">
                                                <div style="font-weight: 600; margin-bottom: 4px;">
                                                    ${exercise.name}
                                                    ${isPR ? '<span class="pr-badge">PR</span>' : ''}
                                                    ${improvement > 0 ? `<span class="improvement-badge">+${improvement}%</span>` : ''}
                                                </div>
                                                ${exercise.sets.map((set, j) => `
                                                    <div style="font-size: 14px; color: var(--text-secondary); padding: 2px 0;">
                                                        Set ${j + 1}: ${set.weight}kg Ã— ${set.reps} reps
                                                        ${set.rpe ? ` @ RPE ${set.rpe}` : ''}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `;
                                    }).join('')}
                                    
                                    ${session.notes ? `
                                        <div style="margin-top: 12px; padding: 12px; background: var(--background); border-radius: 8px;">
                                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Notes:</div>
                                            <div style="font-size: 14px; font-style: italic;">${session.notes}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('');
                    } else {
                        // Fallback: Show individual exercises (old format)
                        html += todayWorkouts.map(workout => {
                            const isPR = this.checkIfPR(workout);
                            const improvement = this.calculateImprovement(workout);
                            const notes = this.workoutNotes[workout.id];
                            
                            return `
                                <div class="card swipeable">
                                    <div class="card-header">
                                        <div>
                                            <div class="card-title">
                                                ${workout.exercise}
                                                ${isPR ? '<span class="pr-badge">PR</span>' : ''}
                                                ${improvement > 0 ? `<span class="improvement-badge">+${improvement}%</span>` : ''}
                                            </div>
                                            <div class="card-subtitle">
                                                ${workout.sets.length} sets â€¢ ${workout.sets.reduce((sum, s) => sum + (s.reps || 0), 0)} total reps
                                                ${workout.superset ? ` â€¢ Superset with ${workout.superset}` : ''}
                                            </div>
                                            ${notes ? `<div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px; font-style: italic;">${notes}</div>` : ''}
                                        </div>
                                    </div>
                                    ${workout.sets.map((set, i) => `
                                        <div style="padding: 4px 0;">
                                            Set ${i + 1}: ${set.weight}kg Ã— ${set.reps} reps
                                            ${set.rpe ? ` <span style="color: var(--text-secondary); font-size: 12px;">@ RPE ${set.rpe}</span>` : ''}
                                        </div>
                                    `).join('')}
                                    <div class="swipe-actions">
                                        <button class="swipe-btn delete" onclick="app.deleteWorkout('${workout.id}')">Delete</button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }

                document.getElementById('todayWorkouts').innerHTML = html;
            },

            formatDuration(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                
                if (hours > 0) {
                    return `${hours}h ${minutes}m`;
                }
                return `${minutes}m`;
            },

            getSmartRecommendations() {
                const recommendations = [];
                const now = new Date();
                
                // Get last workout date
                const lastWorkoutDate = this.workouts.length > 0 
                    ? new Date(Math.max(...this.workouts.map(w => new Date(w.date))))
                    : null;
                
                const daysSinceLastWorkout = lastWorkoutDate 
                    ? Math.floor((now - lastWorkoutDate) / (1000 * 60 * 60 * 24))
                    : 999;
                
                // Recommendation: Haven't worked out in a while
                if (daysSinceLastWorkout >= 3) {
                    recommendations.push({
                        icon: 'â°',
                        title: `${daysSinceLastWorkout} days since last workout`,
                        reason: "Time to get back in the gym! Your muscles are recovered.",
                        action: 'start_workout'
                    });
                }
                
                // Recommendation: Muscle group imbalance
                const muscleVolume = this.getMuscleVolumeLastWeek();
                const volumes = Object.values(muscleVolume);
                if (volumes.length > 0) {
                    const maxVolume = Math.max(...volumes);
                    const minVolume = Math.min(...volumes.filter(v => v > 0));
                    
                    if (maxVolume > minVolume * 2) {
                        const undertrainedMuscle = Object.entries(muscleVolume)
                            .filter(([_, vol]) => vol === minVolume)[0][0];
                        
                        recommendations.push({
                            icon: 'âš–ï¸',
                            title: `${undertrainedMuscle} needs attention`,
                            reason: `Low volume this week. Consider training ${undertrainedMuscle} today.`,
                            action: 'train_muscle',
                            muscle: undertrainedMuscle
                        });
                    }
                }
                
                // Recommendation: Approaching goal
                this.goals.forEach(goal => {
                    const progress = this.calculateGoalProgress(goal);
                    if (progress >= 90 && progress < 100) {
                        recommendations.push({
                            icon: 'ðŸŽ¯',
                            title: `You're ${Math.round(100 - progress)}% away from "${goal.title}"`,
                            reason: `Push hard today - you're almost there!`,
                            action: 'work_on_goal',
                            goal: goal
                        });
                    }
                });
                
                // Recommendation: Deload suggestion
                const recentRPE = this.getAverageRPELastWeek();
                if (recentRPE >= 8.5) {
                    recommendations.push({
                        icon: 'ðŸ˜°',
                        title: 'High fatigue detected',
                        reason: `Average RPE: ${recentRPE.toFixed(1)}/10. Consider a deload or rest day.`,
                        action: 'deload'
                    });
                }
                
                // Recommendation: Consistency boost
                const streak = this.calculateStreak();
                if (streak >= 5 && streak < 7) {
                    recommendations.push({
                        icon: 'ðŸ”¥',
                        title: `${7 - streak} more days to 7-day streak!`,
                        reason: "Keep going - achievement within reach!",
                        action: 'maintain_streak'
                    });
                }
                
                // Recommendation: No leg training
                const lastLegWorkout = this.getLastMuscleGroupWorkout('Quads');
                const daysSinceLegs = lastLegWorkout 
                    ? Math.floor((now - new Date(lastLegWorkout.date)) / (1000 * 60 * 60 * 24))
                    : 999;
                
                if (daysSinceLegs >= 5) {
                    recommendations.push({
                        icon: 'ðŸ¦µ',
                        title: "Leg day overdue",
                        reason: `${daysSinceLegs} days since last leg workout. Don't skip leg day!`,
                        action: 'train_legs'
                    });
                }
                
                return recommendations;
            },

            getMuscleVolumeLastWeek() {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                const recentWorkouts = this.workouts.filter(w => new Date(w.date) >= weekAgo);
                const muscleVolume = {};
                
                recentWorkouts.forEach(workout => {
                    const muscles = this.muscleGroupMap[workout.exercise] || ['Other'];
                    const volume = workout.sets.reduce((sum, s) => sum + (s.weight * s.reps), 0);
                    
                    muscles.forEach(muscle => {
                        muscleVolume[muscle] = (muscleVolume[muscle] || 0) + volume;
                    });
                });
                
                return muscleVolume;
            },

            getAverageRPELastWeek() {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                const recentWorkouts = this.workouts.filter(w => new Date(w.date) >= weekAgo);
                const rpeValues = [];
                
                recentWorkouts.forEach(workout => {
                    workout.sets.forEach(set => {
                        if (set.rpe) rpeValues.push(set.rpe);
                    });
                });
                
                if (rpeValues.length === 0) return 0;
                return rpeValues.reduce((sum, rpe) => sum + rpe, 0) / rpeValues.length;
            },

            getLastMuscleGroupWorkout(muscleGroup) {
                const muscleWorkouts = this.workouts.filter(w => {
                    const muscles = this.muscleGroupMap[w.exercise] || [];
                    return muscles.includes(muscleGroup);
                }).sort((a, b) => new Date(b.date) - new Date(a.date));
                
                return muscleWorkouts[0] || null;
            },

            calculateStreak() {
                if (this.workouts.length === 0) return 0;
                
                const dates = [...new Set(this.workouts.map(w => w.date))].sort((a, b) => new Date(b) - new Date(a));
                let streak = 0;
                let currentDate = new Date();
                currentDate.setHours(0, 0, 0, 0);
                
                for (let date of dates) {
                    const workoutDate = new Date(date);
                    workoutDate.setHours(0, 0, 0, 0);
                    
                    const diffDays = Math.floor((currentDate - workoutDate) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === streak) {
                        streak++;
                        currentDate = workoutDate;
                    } else if (diffDays > streak) {
                        break;
                    }
                }
                
                return streak;
            },

            checkIfPR(workout) {
                const exerciseName = workout.exercise;
                const maxWeight = Math.max(...workout.sets.map(s => s.weight || 0));
                
                if (!this.personalRecords[exerciseName] || maxWeight > this.personalRecords[exerciseName]) {
                    this.personalRecords[exerciseName] = maxWeight;
                    this.savePersonalRecords();
                    return true;
                }
                return false;
            },

            calculateImprovement(workout) {
                const previousWorkouts = this.workouts.filter(w => 
                    w.exercise === workout.exercise && w.date !== workout.date && w.id !== workout.id
                ).sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (previousWorkouts.length === 0) return 0;
                
                const lastWorkout = previousWorkouts[0];
                const currentVolume = workout.sets.reduce((sum, s) => sum + (s.weight * s.reps), 0);
                const lastVolume = lastWorkout.sets.reduce((sum, s) => sum + (s.weight * s.reps), 0);
                
                if (lastVolume === 0) return 0;
                return Math.round(((currentVolume - lastVolume) / lastVolume) * 100);
            },

            showOnboarding() {
                const html = `
                    <div class="modal active" id="onboardingModal" style="display: flex;">
                        <div class="modal-content">
                            <div style="text-align: center; padding: 20px 0;">
                                <div style="font-size: 64px; margin-bottom: 16px;">ðŸ’ª</div>
                                <h2 style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">Welcome to Gym Tracker</h2>
                                <p style="font-size: 15px; color: var(--text-secondary); margin-bottom: 24px;">Your complete fitness companion</p>
                            </div>
                            
                            <div style="display: grid; gap: 16px; margin-bottom: 24px;">
                                <div style="display: flex; gap: 12px; align-items: start;">
                                    <div style="font-size: 32px;">ðŸ‹ï¸</div>
                                    <div>
                                        <div style="font-weight: 600; margin-bottom: 4px;">Track Workouts</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">Log sets, reps, and weight with smart suggestions</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 12px; align-items: start;">
                                    <div style="font-size: 32px;">ðŸ“Š</div>
                                    <div>
                                        <div style="font-weight: 600; margin-bottom: 4px;">View Analytics</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">Track PRs, volume trends, and progress graphs</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 12px; align-items: start;">
                                    <div style="font-size: 32px;">ðŸƒ</div>
                                    <div>
                                        <div style="font-weight: 600; margin-bottom: 4px;">Log Cardio</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">GPS tracking or manual entry with PB tracking</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 12px; align-items: start;">
                                    <div style="font-size: 32px;">â¤ï¸</div>
                                    <div>
                                        <div style="font-weight: 600; margin-bottom: 4px;">Monitor Health</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">Sleep, energy, nutrition, and recovery metrics</div>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" onclick="app.completeOnboarding()" style="width: 100%; padding: 16px; font-size: 16px;">
                                Get Started ðŸš€
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', html);
            },

            quickStartWorkout() {
                // Start empty workout immediately
                this.currentSession = {
                    id: Date.now(),
                    exercises: [],
                    startTime: new Date().toISOString()
                };
                this.sessionStartTime = Date.now();
                this.switchTab('workout');
                this.renderActiveWorkout();
            },

            completeOnboarding() {
                localStorage.setItem('hasSeenOnboarding', 'true');
                document.getElementById('onboardingModal')?.remove();
                this.showNotification('ðŸ‘‹ Welcome! Tap Workout to start training');
            },

            scheduleDeload() {
                const weeks = prompt('Schedule deload in how many weeks?', '3');
                if (!weeks) return;
                
                const deloadDate = new Date();
                deloadDate.setDate(deloadDate.getDate() + (parseInt(weeks) * 7));
                
                if (!this.deloadWeeks) this.deloadWeeks = [];
                this.deloadWeeks.push({
                    date: deloadDate.toISOString().split('T')[0],
                    scheduled: new Date().toISOString().split('T')[0]
                });
                
                localStorage.setItem('deloadWeeks', JSON.stringify(this.deloadWeeks));
                this.showNotification(`ðŸ“… Deload week scheduled for ${deloadDate.toDateString()}`);
            },

            pauseWorkout() {
                if (!this.workoutPaused) {
                    this.workoutPauseTime = Date.now();
                    this.workoutPaused = true;
                } else {
                    const pauseDuration = Date.now() - this.workoutPauseTime;
                    this.sessionStartTime += pauseDuration; // Adjust start time to exclude pause
                    this.workoutPaused = false;
                }
                this.renderActiveWorkout();
            },

            // 8. Manual cardio entry
            addManualCardio() {
                const type = prompt('Type (Run/Cycle/Walk):', 'Run');
                if (!type) return;
                
                const distance = parseFloat(prompt('Distance (km):', '5'));
                if (!distance) return;
                
                const duration = parseFloat(prompt('Duration (minutes):', '30'));
                if (!duration) return;
                
                const session = {
                    type,
                    date: new Date().toISOString().split('T')[0],
                    distance: distance * 1000, // convert to meters
                    duration: duration * 60, // convert to seconds
                    splits: [],
                    route: []
                };
                
                this.cardioSessions.push(session);
                this.saveCardioSessions();
                this.renderCardio();
                this.showNotification('âœ… Cardio session added!');
            },

            // 9. Injury tracking
            logInjury() {
                const bodyPart = prompt('Body part:', 'Left Shoulder');
                if (!bodyPart) return;
                
                const severity = prompt('Severity (1-10):', '5');
                const notes = prompt('Notes:', 'Sharp pain during overhead press');
                
                if (!this.injuries) this.injuries = [];
                this.injuries.push({
                    id: Date.now(),
                    bodyPart: bodyPart.toLowerCase(),
                    severity: parseInt(severity),
                    notes,
                    date: new Date().toISOString().split('T')[0],
                    resolved: false
                });
                
                localStorage.setItem('injuries', JSON.stringify(this.injuries));
                this.showNotification('âš ï¸ Injury logged');
                
                // Show recovery suggestions (14)
                setTimeout(() => this.showInjuryRecoverySuggestions(bodyPart.toLowerCase()), 500);
            },

            showInjuryRecoverySuggestions(bodyPart) {
                // Exercise substitutions based on injury
                const suggestions = {
                    'shoulder': {
                        avoid: ['Overhead Press', 'Military Press', 'Behind Neck Press', 'Upright Rows'],
                        substitute: ['Floor Press', 'Neutral Grip Press', 'Cable Flyes (low)', 'Landmine Press'],
                        mobility: ['Band Pull-Aparts', 'Face Pulls', 'Wall Slides', 'Sleeper Stretch']
                    },
                    'elbow': {
                        avoid: ['Skull Crushers', 'Overhead Extensions', 'Close Grip Bench'],
                        substitute: ['Rope Pushdowns', 'Diamond Pushups', 'JM Press'],
                        mobility: ['Wrist Flexor Stretch', 'Forearm Massage', 'Pronation/Supination']
                    },
                    'knee': {
                        avoid: ['Deep Squats', 'Leg Extensions', 'Lunges'],
                        substitute: ['Box Squats (parallel)', 'Leg Press', 'Goblet Squats', 'Step-Ups'],
                        mobility: ['Quad Stretch', 'IT Band Roll', 'Hamstring Stretch']
                    },
                    'lower back': {
                        avoid: ['Deadlifts', 'Good Mornings', 'Hyperextensions'],
                        substitute: ['Trap Bar Deadlifts', 'Bulgarian Split Squats', 'Belt Squats', 'Reverse Hypers'],
                        mobility: ['Cat-Cow Stretch', 'Child Pose', 'Dead Bug', 'Bird Dog']
                    },
                    'wrist': {
                        avoid: ['Barbell Curls', 'Front Squats', 'Wrist Curls'],
                        substitute: ['Cable Curls', 'Hammer Curls', 'Safety Bar Squats'],
                        mobility: ['Wrist Circles', 'Prayer Stretch', 'Finger Extensions']
                    }
                };
                
                let match = null;
                for (const key in suggestions) {
                    if (bodyPart.includes(key)) {
                        match = suggestions[key];
                        break;
                    }
                }
                
                if (match) {
                    const msg = `Recovery for ${bodyPart}:\n\nâŒ AVOID:\n${match.avoid.join(', ')}\n\nâœ… SUBSTITUTE:\n${match.substitute.join(', ')}\n\nðŸ§˜ MOBILITY:\n${match.mobility.join(', ')}\n\nRest 5-7 days, ice 3x daily, see doctor if severe.`;
                    alert(msg);
                } else {
                    alert(`General recovery for ${bodyPart}:\n\nâ€¢ Rest 5-7 days\nâ€¢ Ice 3x daily (15 min)\nâ€¢ Avoid painful exercises\nâ€¢ See doctor if severe\nâ€¢ Gradual return with reduced weight`);
                }
            },

            setAnalyticsRange(range) {
                this.analyticsRange = range;
                // TODO: Refactor calculateAdvancedStats to use range
                this.renderAnalytics();
            },

            exportData() {
                const data = {
                    workouts: this.workouts,
                    workoutSessions: this.workoutSessions,
                    cardioSessions: this.cardioSessions,
                    personalRecords: this.personalRecords,
                    bodyMetrics: this.bodyMetrics,
                    dailyLogs: this.dailyLogs,
                    templates: this.templates,
                    goals: this.goals,
                    settings: this.settings,
                    exportDate: new Date().toISOString()
                };
                
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gym-tracker-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.showNotification('âœ… Data exported!');
            },

            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (confirm('Import data? This will merge with existing data.')) {
                                this.workouts = [...this.workouts, ...data.workouts];
                                this.workoutSessions = [...this.workoutSessions, ...data.workoutSessions];
                                this.cardioSessions = [...this.cardioSessions, ...data.cardioSessions];
                                this.personalRecords = {...this.personalRecords, ...data.personalRecords};
                                this.bodyMetrics = [...this.bodyMetrics, ...data.bodyMetrics];
                                this.dailyLogs = {...this.dailyLogs, ...data.dailyLogs};
                                this.templates = [...this.templates, ...data.templates];
                                
                                this.saveWorkouts();
                                this.saveWorkoutSessions();
                                this.saveCardioSessions();
                                this.renderToday();
                                this.showNotification('âœ… Data imported!');
                            }
                        } catch (err) {
                            alert('Invalid file format');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

            calculateAdvancedStats() {
                // Get last 12 weeks of data
                const weeks = [];
                for (let i = 11; i >= 0; i--) {
                    const weekStart = new Date();
                    weekStart.setDate(weekStart.getDate() - (i * 7));
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    
                    const weekWorkouts = this.workouts.filter(w => {
                        const d = new Date(w.date);
                        return d >= weekStart && d <= weekEnd;
                    });
                    
                    const volume = weekWorkouts.reduce((sum, w) =>
                        sum + w.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                    );
                    
                    const sets = weekWorkouts.reduce((sum, w) => sum + w.sets.length, 0);
                    
                    weeks.push({ weekStart, volume, sets, workouts: weekWorkouts });
                }

                // Calculate weekly averages
                const weeklyAvgVolume = Math.round(weeks.reduce((s, w) => s + w.volume, 0) / 12);
                const weeklyAvgSets = Math.round(weeks.reduce((s, w) => s + w.sets, 0) / 12);

                // Volume trend (last 4 weeks vs previous 4 weeks)
                const recent4 = weeks.slice(-4).reduce((s, w) => s + w.volume, 0) / 4;
                const previous4 = weeks.slice(-8, -4).reduce((s, w) => s + w.volume, 0) / 4;
                const volumeTrend = previous4 > 0 ? Math.round(((recent4 - previous4) / previous4) * 100) : 0;

                // Volume spike detection (>20% increase week-over-week)
                const thisWeek = weeks[weeks.length - 1].volume;
                const lastWeek = weeks[weeks.length - 2].volume;
                const volumeSpike = lastWeek > 0 && ((thisWeek - lastWeek) / lastWeek) > 0.2
                    ? Math.round(((thisWeek - lastWeek) / lastWeek) * 100)
                    : null;

                // Fatigue detection
                const today = new Date().toISOString().split('T')[0];
                const todayLog = this.dailyLogs[today];
                let fatigueWarning = null;
                
                if (todayLog && thisWeek > weeklyAvgVolume * 1.3) {
                    const fatigueScore = (
                        (todayLog.sleep < 7 ? 1 : 0) +
                        (todayLog.energy <= 4 ? 1 : 0) +
                        (todayLog.soreness >= 7 ? 1 : 0) +
                        (todayLog.stress >= 7 ? 1 : 0)
                    );
                    
                    if (fatigueScore >= 2) {
                        fatigueWarning = `High volume (${Math.round(thisWeek/1000)}kg) + poor recovery signals. Consider a deload week.`;
                    }
                }

                // PR Predictions
                const prPredictions = this.calculatePRPredictions();

                // Strength balance ratios
                const strengthBalance = this.calculateStrengthBalance();

                // Muscle imbalances
                const muscleImbalances = this.calculateMuscleImbalances();

                // Performance by day of week
                const performanceByDay = this.calculatePerformanceByDay();

                return {
                    weeklyVolumes: weeks.map(w => w.volume),
                    weeklyAvgVolume,
                    weeklyAvgSets,
                    volumeTrend,
                    volumeSpike,
                    fatigueWarning,
                    prPredictions,
                    strengthBalance,
                    muscleImbalances,
                    performanceByDay
                };
            },

            calculatePRPredictions() {
                const predictions = [];
                const today = new Date().toISOString().split('T')[0];
                const todayLog = this.dailyLogs[today];
                const readiness = todayLog ? this.calculateReadinessScore(todayLog) : null;

                // Main compound lifts to predict
                const compounds = ['Barbell Bench Press', 'Barbell Squat', 'Deadlift', 'Overhead Press'];

                compounds.forEach(exercise => {
                    const recentSets = this.workouts
                        .filter(w => w.exercise === exercise && w.date >= this.daysAgo(60))
                        .flatMap(w => w.sets)
                        .filter(s => s.weight > 0 && s.reps > 0);

                    if (recentSets.length < 5) return;

                    // Calculate estimated 1RM from recent sets (Epley formula)
                    const estimated1RMs = recentSets.map(s => s.weight * (1 + s.reps / 30));
                    const current1RM = Math.max(...estimated1RMs);

                    // Linear regression on recent 1RMs to predict progression
                    const recent1RMs = estimated1RMs.slice(-10);
                    const avgGain = recent1RMs.length > 1
                        ? (recent1RMs[recent1RMs.length - 1] - recent1RMs[0]) / recent1RMs.length
                        : 0;

                    const predicted1RM = Math.round(current1RM + (avgGain * 4)); // 4 weeks projection

                    // PR probability based on readiness
                    const probability = readiness ? Math.min(100, Math.round(readiness.score * 0.9)) : 50;

                    if (predicted1RM > current1RM + 2) {
                        predictions.push({
                            exercise,
                            current1RM: Math.round(current1RM),
                            predicted1RM,
                            gain: predicted1RM - Math.round(current1RM),
                            probability
                        });
                    }
                });

                return predictions.slice(0, 3);
            },

            calculateStrengthBalance() {
                const bench = this.personalRecords['Barbell Bench Press'];
                const squat = this.personalRecords['Barbell Squat'];
                const deadlift = this.personalRecords['Deadlift'];

                if (!bench || !squat || !deadlift) return null;

                const benchSquatRatio = (bench.weight / squat.weight).toFixed(2);
                const squatDeadliftRatio = (squat.weight / deadlift.weight).toFixed(2);

                // Ideal ratios: Bench:Squat ~0.7-0.8, Squat:Deadlift ~0.8-0.9
                const benchSquatStatus = benchSquatRatio < 0.65 ? 'Weak bench' :
                    benchSquatRatio > 0.85 ? 'Weak squat' : 'Balanced';

                const squatDeadliftStatus = squatDeadliftRatio < 0.75 ? 'Weak squat' :
                    squatDeadliftRatio > 0.95 ? 'Weak deadlift' : 'Balanced';

                return { benchSquatRatio, squatDeadliftRatio, benchSquatStatus, squatDeadliftStatus };
            },

            calculateMuscleImbalances() {
                const muscleGroups = ['Chest', 'Back', 'Shoulders', 'Biceps', 'Triceps', 'Quads', 'Hamstrings', 'Glutes'];
                const weekWorkouts = this.getWorkoutsInDays(7);
                const muscleVolume = {};

                muscleGroups.forEach(m => muscleVolume[m] = 0);

                weekWorkouts.forEach(w => {
                    const exercise = this.allExercises?.find(e => e.name === w.exercise);
                    if (exercise?.muscleGroups) {
                        const volume = w.sets.reduce((sum, set) => sum + (set.weight * set.reps), 0);
                        exercise.muscleGroups.forEach(mg => {
                            if (muscleVolume[mg] !== undefined) muscleVolume[mg] += volume;
                        });
                    }
                });

                const avgVolume = Object.values(muscleVolume).reduce((s, v) => s + v, 0) / muscleGroups.length;
                const imbalances = [];

                Object.entries(muscleVolume).forEach(([muscle, vol]) => {
                    if (vol < avgVolume * 0.5 && avgVolume > 0) {
                        imbalances.push({
                            muscle,
                            weeklyVolume: Math.round(vol),
                            deficitPct: Math.round(((avgVolume - vol) / avgVolume) * 100)
                        });
                    }
                });

                return imbalances.sort((a, b) => b.deficitPct - a.deficitPct).slice(0, 3);
            },

            calculatePerformanceByDay() {
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const dayData = {};

                days.forEach(d => dayData[d] = { volume: 0, count: 0 });

                this.workouts.forEach(w => {
                    const dayName = new Date(w.date).toLocaleDateString('en-US', { weekday: 'long' });
                    if (dayData[dayName]) {
                        const volume = w.sets.reduce((sum, set) => sum + (set.weight * set.reps), 0);
                        dayData[dayName].volume += volume;
                        dayData[dayName].count++;
                    }
                });

                const maxAvg = Math.max(...Object.values(dayData).map(d => d.count > 0 ? d.volume / d.count : 0));

                Object.keys(dayData).forEach(day => {
                    const avg = dayData[day].count > 0 ? dayData[day].volume / dayData[day].count : 0;
                    dayData[day] = {
                        avgVolume: Math.round(avg),
                        pct: maxAvg > 0 ? Math.round((avg / maxAvg) * 100) : 0
                    };
                });

                return dayData;
            },

            drawVolumeTrendChart(weeklyVolumes) {
                const canvas = document.getElementById('volumeTrendChart');
                if (!canvas) return;

                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = 200;

                const ctx = canvas.getContext('2d');
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

                // Clear
                ctx.fillStyle = isDark ? '#1A1A18' : '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (weeklyVolumes.length === 0) return;

                const pad = 40;
                const w = canvas.width - pad * 2;
                const h = canvas.height - pad * 2;

                const max = Math.max(...weeklyVolumes, 1);
                const step = w / (weeklyVolumes.length - 1);

                // Grid lines
                ctx.strokeStyle = isDark ? '#2A2A28' : '#E8E8E5';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 4; i++) {
                    const y = pad + (h / 4) * i;
                    ctx.beginPath();
                    ctx.moveTo(pad, y);
                    ctx.lineTo(pad + w, y);
                    ctx.stroke();
                }

                // Line
                ctx.beginPath();
                weeklyVolumes.forEach((vol, i) => {
                    const x = pad + i * step;
                    const y = pad + h - (vol / max) * h;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.strokeStyle = isDark ? '#F7F7F5' : '#141414';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Fill area under line
                ctx.lineTo(pad + w, pad + h);
                ctx.lineTo(pad, pad + h);
                ctx.closePath();
                const gradient = ctx.createLinearGradient(0, pad, 0, pad + h);
                gradient.addColorStop(0, isDark ? 'rgba(247,247,245,0.2)' : 'rgba(20,20,20,0.1)');
                gradient.addColorStop(1, isDark ? 'rgba(247,247,245,0)' : 'rgba(20,20,20,0)');
                ctx.fillStyle = gradient;
                ctx.fill();

                // Dots
                ctx.fillStyle = isDark ? '#F7F7F5' : '#141414';
                weeklyVolumes.forEach((vol, i) => {
                    const x = pad + i * step;
                    const y = pad + h - (vol / max) * h;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                });
            },

            daysAgo(days) {
                const d = new Date();
                d.setDate(d.getDate() - days);
                return d.toISOString().split('T')[0];
            },

            renderAnalytics() {
                const el = document.getElementById('analyticsContent');
                if (!el) return;

                const range = this.analyticsRange || '12weeks';
                const stats = this.calculateAdvancedStats(range);

                let html = `
                    <div class="section-header">
                        <div class="section-title">Analytics</div>
                        <select onchange="app.setAnalyticsRange(this.value)" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface2); color: var(--text-primary); font-size: 13px; font-weight: 600; cursor: pointer;">
                            <option value="4weeks" ${range === '4weeks' ? 'selected' : ''}>4 Weeks</option>
                            <option value="12weeks" ${range === '12weeks' ? 'selected' : ''}>12 Weeks</option>
                            <option value="6months" ${range === '6months' ? 'selected' : ''}>6 Months</option>
                            <option value="1year" ${range === '1year' ? 'selected' : ''}>1 Year</option>
                            <option value="all" ${range === 'all' ? 'selected' : ''}>All Time</option>
                        </select>
                    </div>
                `;

                // Fatigue / Overtraining Warning
                if (stats.fatigueWarning) {
                    html += `
                        <div class="premium-stat-card" style="background: var(--danger); background: linear-gradient(135deg, var(--danger) 0%, #d93842 100%); color: white; margin: 0 20px 12px;">
                            <div style="font-size: 14px; font-weight: 700; margin-bottom: 6px; letter-spacing: -0.01em;">âš ï¸ High Fatigue Detected</div>
                            <div style="font-size: 13px; opacity: 0.95; line-height: 1.5;">${stats.fatigueWarning}</div>
                        </div>
                    `;
                }

                // Volume Spike Warning
                if (stats.volumeSpike) {
                    html += `
                        <div class="premium-stat-card" style="background: var(--warning); color: #141414; margin: 0 20px 12px;">
                            <div style="font-size: 14px; font-weight: 700; margin-bottom: 6px;">ðŸ“ˆ Volume Spike: +${stats.volumeSpike}%</div>
                            <div style="font-size: 13px; opacity: 0.85; line-height: 1.5;">You increased volume significantly this week. Monitor recovery closely.</div>
                        </div>
                    `;
                }

                // Weekly Volume Trend (12 weeks)
                html += `
                    <div class="premium-stat-card" style="margin: 0 20px 12px;">
                        <div class="premium-stat-header">12-Week Volume Trend</div>
                        <canvas id="volumeTrendChart" width="400" height="200" style="width: 100%; max-height: 200px;"></canvas>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: 700; font-family: 'DM Mono', monospace;">${this.formatNumber(stats.weeklyAvgVolume)}</div>
                                <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em;">Avg/Week</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: 700; font-family: 'DM Mono', monospace; color: ${stats.volumeTrend > 0 ? 'var(--success)' : 'var(--danger)'};">${stats.volumeTrend > 0 ? '+' : ''}${stats.volumeTrend}%</div>
                                <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em;">Trend</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: 700; font-family: 'DM Mono', monospace;">${stats.weeklyAvgSets}</div>
                                <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em;">Sets/Week</div>
                            </div>
                        </div>
                    </div>
                `;

                // PR Predictions
                if (stats.prPredictions.length > 0) {
                    html += `
                        <div class="premium-stat-card" style="margin: 0 20px 12px;">
                            <div class="premium-stat-header">PR Predictions</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">Based on your recent progression</div>
                            ${stats.prPredictions.map(p => `
                                <div style="padding: 12px; background: var(--surface2); border-radius: 10px; margin-bottom: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                        <div style="font-size: 14px; font-weight: 600;">${p.exercise}</div>
                                        <div style="font-size: 18px; font-weight: 700; font-family: 'DM Mono', monospace;">${p.predicted1RM}kg</div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary);">
                                        <span>Current: ${p.current1RM}kg</span>
                                        <span style="color: var(--success);">+${p.gain}kg potential</span>
                                    </div>
                                    <div style="margin-top: 8px;">
                                        <div style="height: 4px; background: var(--border); border-radius: 2px; overflow: hidden;">
                                            <div style="width: ${Math.min(100, p.probability)}%; height: 100%; background: var(--accent);"></div>
                                        </div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${p.probability}% PR probability today</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // Strength Balance
                html += `
                    <div class="premium-stat-card" style="margin: 0 20px 12px;">
                        <div class="premium-stat-header">Strength Balance</div>
                        ${stats.strengthBalance ? `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div style="padding: 14px; background: var(--surface2); border-radius: 10px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">BENCH : SQUAT</div>
                                    <div style="font-size: 22px; font-weight: 700; font-family: 'DM Mono', monospace;">${stats.strengthBalance.benchSquatRatio}</div>
                                    <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">${stats.strengthBalance.benchSquatStatus}</div>
                                </div>
                                <div style="padding: 14px; background: var(--surface2); border-radius: 10px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">SQUAT : DEADLIFT</div>
                                    <div style="font-size: 22px; font-weight: 700; font-family: 'DM Mono', monospace;">${stats.strengthBalance.squatDeadliftRatio}</div>
                                    <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">${stats.strengthBalance.squatDeadliftStatus}</div>
                                </div>
                            </div>
                        ` : '<div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 13px;">Track Bench, Squat, and Deadlift to see balance</div>'}
                    </div>
                `;

                // Muscle Imbalances
                if (stats.muscleImbalances.length > 0) {
                    html += `
                        <div class="premium-stat-card" style="margin: 0 20px 12px;">
                            <div class="premium-stat-header">Muscle Imbalances</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">Underdeveloped muscle groups</div>
                            ${stats.muscleImbalances.map(m => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border);">
                                    <div>
                                        <div style="font-size: 14px; font-weight: 600;">${m.muscle}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">${m.weeklyVolume}kg this week</div>
                                    </div>
                                    <div style="padding: 4px 10px; background: var(--warning); color: #141414; border-radius: 6px; font-size: 11px; font-weight: 600;">
                                        ${m.deficitPct}% below avg
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // Best Training Days
                html += `
                    <div class="premium-stat-card" style="margin: 0 20px 80px;">
                        <div class="premium-stat-header">Performance by Day</div>
                        ${Object.entries(stats.performanceByDay).map(([day, perf]) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border);">
                                <div style="font-size: 14px; font-weight: 600; min-width: 80px;">${day}</div>
                                <div style="flex: 1; margin: 0 12px;">
                                    <div style="height: 6px; background: var(--border); border-radius: 3px; overflow: hidden;">
                                        <div style="width: ${perf.pct}%; height: 100%; background: var(--accent);"></div>
                                    </div>
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary); font-family: 'DM Mono', monospace;">${this.formatNumber(perf.avgVolume)}kg</div>
                            </div>
                        `).join('')}
                    </div>
                `;

                el.innerHTML = html;

                // Draw volume trend chart after render
                setTimeout(() => this.drawVolumeTrendChart(stats.weeklyVolumes), 100);
            },

            renderWorkoutCalendar() {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const monthName = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                // Get workout days this month
                const workoutDays = new Set();
                const allSessions = [...this.workoutSessions, ...this.workouts.map(w => ({ date: w.date }))];
                allSessions.forEach(s => {
                    const d = new Date(s.date);
                    if (d.getMonth() === month && d.getFullYear() === year) {
                        workoutDays.add(d.getDate());
                    }
                });

                const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
                
                let calHtml = `
                    <div class="premium-stat-card">
                        <div class="premium-stat-header">${monthName}</div>
                        <div class="workout-calendar">
                            ${days.map(d => `<div class="cal-header">${d}</div>`).join('')}
                            ${Array(firstDay).fill(0).map(() => `<div class="cal-day empty"></div>`).join('')}
                            ${Array.from({length: daysInMonth}, (_, i) => i + 1).map(day => {
                                const isToday = day === today.getDate();
                                const hasWorkout = workoutDays.has(day);
                                let cls = 'cal-day';
                                if (hasWorkout) cls += ' worked-out';
                                if (isToday) cls += ' today';
                                return `<div class="${cls}">${day}</div>`;
                            }).join('')}
                        </div>
                        <div style="display: flex; gap: 16px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 12px; height: 12px; border-radius: 3px; background: var(--accent); color: #141414;"></div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Trained (${workoutDays.size} days)</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 12px; height: 12px; border-radius: 3px; border: 2px solid var(--primary);"></div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Today</div>
                            </div>
                        </div>
                    </div>
                `;
                
                return calHtml;
            },

            renderPersonalRecords() {
                const prs = this.personalRecords;
                const prList = Object.entries(prs).sort((a, b) => b[1].weight - a[1].weight);

                if (prList.length === 0) {
                    return `
                        <div class="premium-stat-card">
                            <div class="premium-stat-header">Personal Records</div>
                            <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 14px;">
                                Complete workouts to see your PRs here!
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="premium-stat-card">
                        <div class="premium-stat-header">Personal Records</div>
                        ${prList.slice(0, 10).map(([exercise, pr]) => `
                            <div class="pr-card">
                                <div>
                                    <div class="pr-exercise">${exercise}</div>
                                    <div class="pr-date">${pr.date || 'All time'} Â· ${pr.reps} reps</div>
                                </div>
                                <div style="text-align: right;">
                                    <span class="pr-weight">${pr.weight}</span>
                                    <span class="pr-unit">kg</span>
                                </div>
                            </div>
                        `).join('')}
                        ${prList.length > 10 ? `
                            <div style="text-align: center; padding: 12px; font-size: 13px; color: var(--text-secondary);">
                                + ${prList.length - 10} more records
                            </div>
                        ` : ''}
                    </div>
                `;
            },

            renderMuscleHeatmap() {
                const muscleGroups = [
                    'Chest', 'Back', 'Shoulders', 'Biceps', 'Triceps',
                    'Quads', 'Hamstrings', 'Glutes', 'Abs', 'Calves'
                ];

                // Calculate volume per muscle group this week
                const weekWorkouts = this.getWorkoutsInDays(7);
                const muscleVolume = {};
                
                muscleGroups.forEach(m => muscleVolume[m] = 0);

                weekWorkouts.forEach(w => {
                    const exercise = this.allExercises?.find(e => e.name === w.exercise);
                    if (exercise?.muscleGroups) {
                        const volume = w.sets.reduce((sum, set) => sum + (set.weight * set.reps), 0);
                        exercise.muscleGroups.forEach(mg => {
                            if (muscleVolume[mg] !== undefined) {
                                muscleVolume[mg] += volume;
                            }
                        });
                    }
                });

                const maxVolume = Math.max(...Object.values(muscleVolume), 1);

                return `
                    <div class="premium-stat-card">
                        <div class="premium-stat-header">Muscle Volume - This Week</div>
                        ${muscleGroups.map(muscle => {
                            const vol = muscleVolume[muscle] || 0;
                            const pct = Math.round((vol / maxVolume) * 100);
                            const level = pct > 60 ? 'high' : pct > 20 ? 'medium' : 'low';
                            return `
                                <div class="muscle-group-bar">
                                    <div class="muscle-bar-label">${muscle}</div>
                                    <div class="muscle-bar-track">
                                        <div class="muscle-bar-fill ${level}" style="width: ${pct}%"></div>
                                    </div>
                                    <div class="muscle-bar-value">${vol > 0 ? this.formatNumber(vol) + 'kg' : 'â€”'}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },

            renderPlateCalculator() {
                return `
                    <div class="premium-stat-card">
                        <div class="premium-stat-header">Plate Calculator</div>
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <div style="flex: 1;">
                                <div class="metric-label-small">Target Weight (kg)</div>
                                <input type="number" id="plateCalcInput" class="set-input" 
                                    style="width: 100%; margin-top: 6px; font-size: 24px; padding: 12px;"
                                    placeholder="100" min="20" step="2.5"
                                    oninput="app.updatePlateCalc()">
                            </div>
                            <div style="flex: 1;">
                                <div class="metric-label-small">Bar Weight (kg)</div>
                                <select id="barWeight" class="set-input" style="width: 100%; margin-top: 6px;"
                                    onchange="app.updatePlateCalc()">
                                    <option value="20">20kg (Standard)</option>
                                    <option value="15">15kg (Women's)</option>
                                    <option value="10">10kg (Technique)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="plateDisplay" class="plate-display">
                            <div style="color: var(--text-secondary); font-size: 14px;">Enter a weight above</div>
                        </div>
                        
                        <div id="plateList" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                        </div>
                    </div>
                `;
            },

            updatePlateCalc() {
                const target = parseFloat(document.getElementById('plateCalcInput')?.value) || 0;
                const barWeight = parseFloat(document.getElementById('barWeight')?.value) || 20;
                
                const plateDisplay = document.getElementById('plateDisplay');
                const plateList = document.getElementById('plateList');
                
                if (!plateDisplay || !plateList) return;
                
                if (target <= barWeight) {
                    plateDisplay.innerHTML = `
                        <div style="color: var(--text-secondary); font-size: 14px; text-align: center;">
                            ${target > 0 ? 'Just the bar!' : 'Enter a weight above'}
                        </div>
                    `;
                    plateList.innerHTML = '';
                    return;
                }

                const weightPerSide = (target - barWeight) / 2;
                const availablePlates = [25, 20, 15, 10, 5, 2.5, 1.25];
                const platesNeeded = [];
                let remaining = weightPerSide;

                availablePlates.forEach(plate => {
                    while (remaining >= plate - 0.001) {
                        platesNeeded.push(plate);
                        remaining -= plate;
                    }
                });

                // Visual plate display
                const plateColors = {
                    25: '#FF3B47', 20: '#0080FF', 15: '#FFB800',
                    10: '#2ecc71', 5: '#fff', 2.5: '#888', 1.25: '#aaa'
                };
                
                const plateHeights = {
                    25: 56, 20: 50, 15: 44, 10: 38, 5: 32, 2.5: 26, 1.25: 20
                };

                // Build visual
                let visualHtml = `<div class="collar"></div>`;
                
                // Plates left side (reversed)
                [...platesNeeded].reverse().forEach(plate => {
                    const h = plateHeights[plate] || 30;
                    const bg = plateColors[plate] || '#888';
                    const textColor = plate === 5 ? '#333' : 'white';
                    visualHtml += `
                        <div class="plate" style="width: 16px; height: ${h}px; background: ${bg}; color: ${textColor}; writing-mode: vertical-rl; font-size: 9px;">
                            ${plate}
                        </div>
                    `;
                });

                visualHtml += `<div class="barbell"></div>`;
                
                // Plates right side
                platesNeeded.forEach(plate => {
                    const h = plateHeights[plate] || 30;
                    const bg = plateColors[plate] || '#888';
                    const textColor = plate === 5 ? '#333' : 'white';
                    visualHtml += `
                        <div class="plate" style="width: 16px; height: ${h}px; background: ${bg}; color: ${textColor}; writing-mode: vertical-rl; font-size: 9px;">
                            ${plate}
                        </div>
                    `;
                });
                
                visualHtml += `<div class="collar"></div>`;

                plateDisplay.innerHTML = visualHtml;

                // Plate count list
                const plateCounts = {};
                platesNeeded.forEach(p => plateCounts[p] = (plateCounts[p] || 0) + 1);
                
                const listItems = Object.entries(plateCounts)
                    .sort((a, b) => b[0] - a[0])
                    .map(([plate, count]) => `
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);">
                            <div style="font-size: 14px; color: var(--text-primary);">${plate}kg plates</div>
                            <div style="font-size: 14px; font-weight: 700; color: var(--primary);">Ã— ${count * 2} (${count} each side)</div>
                        </div>
                    `).join('');

                plateList.innerHTML = `
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                        ${target}kg total Â· ${barWeight}kg bar Â· ${weightPerSide}kg per side
                    </div>
                    ${listItems}
                    ${Math.abs(remaining) > 0.001 ? `
                        <div style="color: var(--warning); font-size: 12px; margin-top: 8px;">
                            Note: Can't make exact weight. Nearest: ${(target - remaining * 2).toFixed(2)}kg
                        </div>
                    ` : ''}
                `;
            },
            getWorkoutsInRange(previous = false) {
                const now = new Date();
                let startDate = new Date();
                
                if (this.timeRange === '7days') {
                    startDate.setDate(now.getDate() - (previous ? 14 : 7));
                } else if (this.timeRange === '30days') {
                    startDate.setDate(now.getDate() - (previous ? 60 : 30));
                } else if (this.timeRange === '90days') {
                    startDate.setDate(now.getDate() - (previous ? 180 : 90));
                } else {
                    return previous ? [] : this.workouts;
                }
                
                const endDate = previous ? new Date(now.getTime() - (this.timeRange === '7days' ? 7 : this.timeRange === '30days' ? 30 : 90) * 24 * 60 * 60 * 1000) : now;
                
                return this.workouts.filter(w => {
                    const workoutDate = new Date(w.date);
                    return workoutDate >= startDate && workoutDate <= endDate;
                });
            },

            setTimeRange(range) {
                this.timeRange = range;
                this.renderAnalytics();
            },

            renderVolumeChart(workouts) {
                // Group by date
                const volumeByDate = {};
                workouts.forEach(w => {
                    const volume = w.sets.reduce((sum, s) => sum + (s.weight * s.reps), 0);
                    volumeByDate[w.date] = (volumeByDate[w.date] || 0) + volume;
                });
                
                const dates = Object.keys(volumeByDate).sort((a, b) => new Date(a) - new Date(b));
                const volumes = dates.map(d => volumeByDate[d]);
                const maxVolume = Math.max(...volumes);
                
                if (dates.length === 0) return '';
                
                return `
                    <div class="chart-container">
                        <div class="chart-title">Volume Over Time</div>
                        <div class="simple-chart">
                            ${dates.slice(-10).map((date, i) => {
                                const volume = volumeByDate[date];
                                const height = (volume / maxVolume) * 100;
                                return `
                                    <div class="chart-bar" style="height: ${height}%">
                                        <div class="chart-bar-value">${this.formatNumber(volume)}</div>
                                        <div class="chart-bar-label">${new Date(date).getDate()}/${new Date(date).getMonth() + 1}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            },

            renderMuscleGroupVolume(workouts) {
                const muscleVolume = {};
                
                workouts.forEach(workout => {
                    const muscles = this.muscleGroupMap[workout.exercise] || ['Other'];
                    const volume = workout.sets.reduce((sum, s) => sum + (s.weight * s.reps), 0);
                    
                    muscles.forEach(muscle => {
                        muscleVolume[muscle] = (muscleVolume[muscle] || 0) + volume;
                    });
                });
                
                const sortedMuscles = Object.entries(muscleVolume)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 6);
                
                if (sortedMuscles.length === 0) return '';
                
                const maxVolume = Math.max(...sortedMuscles.map(m => m[1]));
                
                return `
                    <div class="card">
                        <div class="card-title" style="margin-bottom: 12px;">Volume by Muscle Group</div>
                        <div style="margin-bottom: 16px;">
                            ${sortedMuscles.map(([muscle, volume]) => {
                                const percentage = (volume / maxVolume) * 100;
                                return `
                                    <div style="margin-bottom: 12px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="font-size: 14px; font-weight: 600;">${muscle}</span>
                                            <span style="font-size: 14px; color: var(--text-secondary);">${this.formatNumber(volume)}kg</span>
                                        </div>
                                        <div style="background: var(--background); height: 8px; border-radius: 4px; overflow: hidden;">
                                            <div style="background: var(--accent); color: #141414; height: 100%; width: ${percentage}%; border-radius: 4px; transition: width 0.3s;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            },

            render1RMPredictions() {
                // Find best sets for each exercise (highest weight x reps combo)
                const exerciseMaxes = {};
                
                this.workouts.forEach(workout => {
                    workout.sets.forEach(set => {
                        if (set.weight && set.reps && set.reps <= 12) {
                            const estimated1RM = this.calculate1RM(set.weight, set.reps);
                            
                            if (!exerciseMaxes[workout.exercise] || estimated1RM > exerciseMaxes[workout.exercise].max) {
                                exerciseMaxes[workout.exercise] = {
                                    max: estimated1RM,
                                    weight: set.weight,
                                    reps: set.reps,
                                    date: workout.date
                                };
                            }
                        }
                    });
                });
                
                const topLifts = Object.entries(exerciseMaxes)
                    .sort((a, b) => b[1].max - a[1].max)
                    .slice(0, 5);
                
                if (topLifts.length === 0) return '';
                
                return `
                    <div class="card">
                        <div class="card-title" style="margin-bottom: 12px;">Estimated 1RM</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">
                            Based on your best sets using Epley formula
                        </div>
                        ${topLifts.map(([exercise, data]) => `
                            <div class="history-item">
                                <div>
                                    <div class="history-date">${exercise}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">From ${data.weight}kg Ã— ${data.reps} reps</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${Math.round(data.max)}kg</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            calculate1RM(weight, reps) {
                // Epley formula: 1RM = weight Ã— (1 + reps/30)
                if (reps === 1) return weight;
                return weight * (1 + reps / 30);
            },

            showExerciseProgress(exerciseName) {
                this.showExerciseDetails(exerciseName);
            },

            formatDate(dateStr) {
                const date = new Date(dateStr);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                if (date.toISOString().split('T')[0] === today.toISOString().split('T')[0]) {
                    return 'Today';
                } else if (date.toISOString().split('T')[0] === yesterday.toISOString().split('T')[0]) {
                    return 'Yesterday';
                } else {
                    return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                }
            },

            formatNumber(num) {
                return num >= 1000 ? (num / 1000).toFixed(1) + 'k' : Math.round(num);
            },

            // Templates
            renderTemplates() {
                let html = `
                    <div class="section-header">
                        <div class="section-title">Pre-Built Programs</div>
                    </div>
                    <div style="margin-bottom: 24px;">
                        ${this.programs.map(program => `
                            <div class="template-card" onclick="app.showProgramDetails('${program.id}')">
                                <div class="template-header">
                                    <div class="template-name">${program.name}</div>
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">${program.description}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${program.schedule}</div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="section-header">
                        <div class="section-title">My Custom Templates</div>
                        <div class="section-action" onclick="app.showCreateTemplate()">+ New</div>
                    </div>
                `;
                
                if (this.templates.length === 0) {
                    html += `
                        <div class="empty-state">
                            <div class="empty-icon">â‰¡</div>
                            <div class="empty-text">No custom templates yet<br>Create one to save time!</div>
                        </div>
                    `;
                } else {
                    html += this.templates.map(template => `
                        <div class="template-card" onclick="app.startTemplate('${template.id}')">
                            <div class="template-header">
                                <div class="template-name">${template.name}</div>
                            </div>
                            <div class="template-exercises">${template.exercises.length} exercises: ${template.exercises.map(e => e.name).join(', ')}</div>
                            <div class="template-actions">
                                <button class="icon-btn" onclick="event.stopPropagation(); app.editTemplate('${template.id}')">Edit</button>
                                <button class="icon-btn danger" onclick="event.stopPropagation(); app.deleteTemplate('${template.id}')">Delete</button>
                            </div>
                        </div>
                    `).join('');
                }
                
                document.getElementById('templatesContent').innerHTML = html;
            },

            showProgramDetails(programId) {
                const program = this.programs.find(p => p.id === programId);
                if (!program) return;

                let html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="font-size: 22px; font-weight: 700; margin-bottom: 8px;">${program.name}</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 12px;">${program.description}</p>
                        <div style="background: var(--background); padding: 12px; border-radius: 8px;">
                            <strong>Schedule:</strong> ${program.schedule}
                        </div>
                    </div>

                    ${program.workouts.map((workout, index) => `
                        <div class="card" style="margin-bottom: 12px;">
                            <div class="card-title" style="margin-bottom: 12px;">${workout.name}</div>
                            ${workout.exercises.map(ex => `
                                <div style="padding: 8px 0; border-bottom: 1px solid var(--border); last-child:border-bottom: none;">
                                    <div style="font-weight: 600;">${ex.name}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">${ex.sets} sets Ã— ${ex.reps} reps</div>
                                </div>
                            `).join('')}
                            <button class="btn btn-primary" style="margin-top: 12px;" onclick="app.startProgramWorkout('${programId}', ${index})">
                                Start ${workout.name}
                            </button>
                        </div>
                    `).join('')}
                `;

                // Create a modal or show in templates section
                const modalContent = `
                    <div class="modal active" id="programDetailModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">${program.name}</h2>
                                <button class="close-btn" onclick="document.getElementById('programDetailModal').remove()">Ã—</button>
                            </div>
                            ${html}
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalContent);
            },

            startProgramWorkout(programId, workoutIndex) {
                const program = this.programs.find(p => p.id === programId);
                if (!program || !program.workouts[workoutIndex]) return;

                const workout = program.workouts[workoutIndex];
                
                // Convert to template format and start
                this.currentTemplate = {
                    name: `${program.name} - ${workout.name}`,
                    exercises: workout.exercises.map(ex => ({ name: ex.name }))
                };
                this.currentTemplateIndex = 0;
                
                // Close the detail modal
                const modal = document.getElementById('programDetailModal');
                if (modal) modal.remove();
                
                // Start first exercise
                this.startWorkout(workout.exercises[0].name);
            },

            showTemplates() {
                this.switchTab('templates');
            },

            showCreateTemplate() {
                let html = `
                    <div class="metric-input-group">
                        <label class="metric-label">Template Name</label>
                        <input type="text" class="metric-input" id="templateName" placeholder="e.g., Push Day, Leg Day">
                    </div>
                    
                    <div class="metric-label" style="margin-bottom: 8px;">Select Exercises</div>
                    <div id="exerciseSelectionList"></div>
                    
                    <button class="btn btn-primary" onclick="app.saveTemplate()">Save Template</button>
                `;
                
                document.getElementById('createTemplateContent').innerHTML = html;
                this.renderExerciseSelection();
                document.getElementById('createTemplateModal').classList.add('active');
            },

            renderExerciseSelection() {
                const categories = [...new Set(this.exercises.map(e => e.category))];
                const html = categories.map(cat => `
                    <div class="exercise-category">
                        <div class="category-title">${cat}</div>
                        ${this.exercises.filter(e => e.category === cat).map(ex => `
                            <div class="exercise-item">
                                <div>
                                    <div class="exercise-name">${ex.name}</div>
                                    <div class="exercise-muscle">${ex.muscle}</div>
                                </div>
                                <input type="checkbox" value="${ex.name}" style="width: 24px; height: 24px;">
                            </div>
                        `).join('')}
                    </div>
                `).join('');
                
                document.getElementById('exerciseSelectionList').innerHTML = html;
            },

            async saveTemplate() {
                const name = document.getElementById('templateName').value;
                const checkboxes = document.querySelectorAll('#exerciseSelectionList input[type="checkbox"]:checked');
                const exercises = Array.from(checkboxes).map(cb => ({ name: cb.value }));
                
                if (!name || exercises.length === 0) {
                    alert('Please enter a name and select at least one exercise');
                    return;
                }
                
                const template = {
                    id: Date.now().toString(),
                    name,
                    exercises
                };
                
                this.templates.push(template);
                await this.saveTemplates();
                this.closeCreateTemplate();
                this.renderTemplates();
            },

            closeCreateTemplate() {
                document.getElementById('createTemplateModal').classList.remove('active');
            },

            startTemplate(templateId) {
                const template = this.templates.find(t => t.id === templateId);
                if (!template) return;
                
                // Start workout with first exercise
                if (template.exercises.length > 0) {
                    this.currentTemplate = template;
                    this.currentTemplateIndex = 0;
                    this.startWorkout(template.exercises[0].name);
                }
            },

            async deleteTemplate(templateId) {
                if (!confirm('Delete this template?')) return;
                
                this.templates = this.templates.filter(t => t.id !== templateId);
                await this.saveTemplates();
                this.renderTemplates();
            },

            // Body Metrics
            renderMetrics() {
                let html = `
                    <div class="section-header">
                        <div class="section-title">Progress Photos</div>
                        <div class="section-action" onclick="app.showAddPhoto()">+ Photo</div>
                    </div>
                `;
                
                // Progress Photos Section
                if (this.progressPhotos.length === 0) {
                    html += `
                        <div class="card">
                            <div class="empty-text">No progress photos yet<br>Take your first photo to track visual progress!</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="card">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                                ${this.progressPhotos.slice(-6).reverse().map((photo, i) => `
                                    <div onclick="app.showPhotoComparison(${this.progressPhotos.length - 1 - i})" style="cursor: pointer; position: relative; padding-bottom: 100%; overflow: hidden; border-radius: 8px; background: var(--background);">
                                        <img src="${photo.dataUrl}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" alt="Progress photo">
                                        <div style="position: absolute; bottom: 4px; left: 4px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">
                                            ${new Date(photo.date).toISOString().split('T')[0]}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <button class="btn btn-secondary" onclick="app.showAllPhotos()">View All Photos (${this.progressPhotos.length})</button>
                        </div>
                    `;
                }
                
                html += `
                    <div class="section-header" style="margin-top: 24px;">
                        <div class="section-title">Body Metrics</div>
                        <div class="section-action" onclick="app.showAddMetric()">+ Log</div>
                    </div>
                `;
                
                if (this.bodyMetrics.length === 0) {
                    html += `
                        <div class="empty-state">
                            <div class="empty-icon">â†”</div>
                            <div class="empty-text">No metrics logged yet<br>Track your progress!</div>
                        </div>
                    `;
                } else {
                    // Get latest metrics
                    const latest = this.bodyMetrics[this.bodyMetrics.length - 1];
                    const previous = this.bodyMetrics.length > 1 ? this.bodyMetrics[this.bodyMetrics.length - 2] : null;
                    
                    html += `<div class="stats-grid">`;
                    
                    if (latest.weight) {
                        const change = previous && previous.weight ? ((latest.weight - previous.weight) / previous.weight * 100).toFixed(1) : 0;
                        html += `
                            <div class="stat-card">
                                <div class="stat-value">${latest.weight}kg</div>
                                <div class="stat-label">Body Weight</div>
                                ${change != 0 ? `<div class="stat-change ${change > 0 ? 'negative' : 'positive'}">${change > 0 ? '+' : ''}${change}%</div>` : ''}
                            </div>
                        `;
                    }
                    
                    if (latest.bodyFat) {
                        const change = previous && previous.bodyFat ? (latest.bodyFat - previous.bodyFat).toFixed(1) : 0;
                        html += `
                            <div class="stat-card">
                                <div class="stat-value">${latest.bodyFat}%</div>
                                <div class="stat-label">Body Fat</div>
                                ${change != 0 ? `<div class="stat-change ${change > 0 ? 'negative' : 'positive'}">${change > 0 ? '+' : ''}${change}%</div>` : ''}
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                    
                    // Measurements
                    if (latest.chest || latest.arms || latest.waist || latest.legs) {
                        html += `
                            <div class="card">
                                <div class="card-title" style="margin-bottom: 12px;">Measurements</div>
                                ${latest.chest ? `<div class="history-item"><div class="history-date">Chest</div><div class="history-sets">${latest.chest}cm</div></div>` : ''}
                                ${latest.arms ? `<div class="history-item"><div class="history-date">Arms</div><div class="history-sets">${latest.arms}cm</div></div>` : ''}
                                ${latest.waist ? `<div class="history-item"><div class="history-date">Waist</div><div class="history-sets">${latest.waist}cm</div></div>` : ''}
                                ${latest.legs ? `<div class="history-item"><div class="history-date">Legs</div><div class="history-sets">${latest.legs}cm</div></div>` : ''}
                            </div>
                        `;
                    }
                    
                    // History chart
                    if (this.bodyMetrics.filter(m => m.weight).length > 1) {
                        html += this.renderWeightChart();
                    }
                    
                    // History list
                    html += `
                        <div class="card">
                            <div class="card-title" style="margin-bottom: 12px;">History</div>
                            ${this.bodyMetrics.slice(-10).reverse().map(metric => `
                                <div class="history-item">
                                    <div class="history-date">${this.formatDate(metric.date)}</div>
                                    <div class="history-sets">
                                        ${metric.weight ? `${metric.weight}kg` : ''}
                                        ${metric.bodyFat ? ` â€¢ ${metric.bodyFat}% BF` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                document.getElementById('metricsContent').innerHTML = html;
            },

            renderWeightChart() {
                const weights = this.bodyMetrics.filter(m => m.weight).slice(-10);
                const maxWeight = Math.max(...weights.map(m => m.weight));
                const minWeight = Math.min(...weights.map(m => m.weight));
                const range = maxWeight - minWeight;
                
                return `
                    <div class="chart-container">
                        <div class="chart-title">Weight Progress</div>
                        <div class="simple-chart">
                            ${weights.map(metric => {
                                const height = range > 0 ? ((metric.weight - minWeight) / range) * 100 : 50;
                                return `
                                    <div class="chart-bar" style="height: ${height}%">
                                        <div class="chart-bar-value">${metric.weight}</div>
                                        <div class="chart-bar-label">${new Date(metric.date).getDate()}/${new Date(metric.date).getMonth() + 1}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            },

            showAddMetric() {
                const latest = this.bodyMetrics.length > 0 ? this.bodyMetrics[this.bodyMetrics.length - 1] : {};
                
                const html = `
                    <div class="metric-input-group">
                        <label class="metric-label">Body Weight (kg)</label>
                        <input type="number" step="0.1" class="metric-input" id="metricWeight" placeholder="${latest.weight || '70'}">
                        ${latest.weight ? `<div class="metric-history">Last: ${latest.weight}kg</div>` : ''}
                    </div>
                    
                    <div class="metric-input-group">
                        <label class="metric-label">Body Fat %</label>
                        <input type="number" step="0.1" class="metric-input" id="metricBodyFat" placeholder="${latest.bodyFat || '15'}">
                        ${latest.bodyFat ? `<div class="metric-history">Last: ${latest.bodyFat}%</div>` : ''}
                    </div>
                    
                    <div class="metric-input-group">
                        <label class="metric-label">Chest (cm)</label>
                        <input type="number" step="0.1" class="metric-input" id="metricChest" placeholder="${latest.chest || '100'}">
                    </div>
                    
                    <div class="metric-input-group">
                        <label class="metric-label">Arms (cm)</label>
                        <input type="number" step="0.1" class="metric-input" id="metricArms" placeholder="${latest.arms || '40'}">
                    </div>
                    
                    <div class="metric-input-group">
                        <label class="metric-label">Waist (cm)</label>
                        <input type="number" step="0.1" class="metric-input" id="metricWaist" placeholder="${latest.waist || '80'}">
                    </div>
                    
                    <div class="metric-input-group">
                        <label class="metric-label">Legs (cm)</label>
                        <input type="number" step="0.1" class="metric-input" id="metricLegs" placeholder="${latest.legs || '60'}">
                    </div>
                    
                    <button class="btn btn-primary" onclick="app.saveMetric()">Save Metrics</button>
                `;
                
                document.getElementById('addMetricContent').innerHTML = html;
                document.getElementById('addMetricModal').classList.add('active');
            },

            async saveMetric() {
                const metric = {
                    date: new Date().toISOString().split('T')[0],
                    weight: parseFloat(document.getElementById('metricWeight').value) || null,
                    bodyFat: parseFloat(document.getElementById('metricBodyFat').value) || null,
                    chest: parseFloat(document.getElementById('metricChest').value) || null,
                    arms: parseFloat(document.getElementById('metricArms').value) || null,
                    waist: parseFloat(document.getElementById('metricWaist').value) || null,
                    legs: parseFloat(document.getElementById('metricLegs').value) || null
                };
                
                // Only save if at least one value is provided
                if (Object.values(metric).some(v => v !== null && v !== metric.date)) {
                    this.bodyMetrics.push(metric);
                    await this.saveBodyMetrics();
                    this.closeAddMetric();
                    this.renderMetrics();
                } else {
                    alert('Please enter at least one measurement');
                }
            },

            closeAddMetric() {
                document.getElementById('addMetricModal').classList.remove('active');
            },

            // Theme Functions
            loadTheme() {
                const savedTheme = this.theme || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
                this.updateThemeIcon(savedTheme);
            },

            async toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                this.theme = newTheme;
                localStorage.setItem('theme', newTheme);
                await this.saveSettings();
                // Refresh settings modal to show updated toggle
                const modal = document.getElementById('settingsModal');
                if (modal) { modal.remove(); this.showSettings(); }
            },

            updateThemeIcon(theme) {
                // No-op: theme toggle is now in settings only
            },

            // Import Functions
            showImportModal() {
                document.getElementById('importModal').classList.add('active');
                document.getElementById('importStatus').innerHTML = '';
            },

            closeImportModal() {
                document.getElementById('importModal').classList.remove('active');
            },

            async handleImportFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Validate data structure
                        if (!data.workouts && !data.templates && !data.bodyMetrics) {
                            throw new Error('Invalid backup file format');
                        }

                        // Show confirmation
                        const confirmed = confirm(
                            `Import data from ${data.exportDate || 'backup'}?\n\n` +
                            `This will replace your current data:\n` +
                            `â€¢ ${data.workouts?.length || 0} workouts\n` +
                            `â€¢ ${data.templates?.length || 0} templates\n` +
                            `â€¢ ${data.bodyMetrics?.length || 0} body measurements\n\n` +
                            `Current data will be lost. Continue?`
                        );

                        if (!confirmed) return;

                        // Import data
                        this.workouts = data.workouts || [];
                        this.templates = data.templates || [];
                        this.bodyMetrics = data.bodyMetrics || [];
                        this.personalRecords = data.personalRecords || {};

                        // Save to storage
                        await this.saveWorkouts();
                        await this.saveTemplates();
                        await this.saveBodyMetrics();
                        await this.savePersonalRecords();

                        // Refresh all views
                        this.renderToday();
                        this.renderAnalytics();
                        this.renderTemplates();
                        this.renderMetrics();
                        this.renderLibrary();

                        // Show success
                        document.getElementById('importStatus').innerHTML = `
                            <div style="background: var(--success); color: white; padding: 12px; border-radius: 8px; margin-top: 16px;">
                                âœ“ Successfully imported ${this.workouts.length} workouts, ${this.templates.length} templates, and ${this.bodyMetrics.length} measurements!
                            </div>
                        `;

                        setTimeout(() => {
                            this.closeImportModal();
                        }, 2000);

                    } catch (error) {
                        document.getElementById('importStatus').innerHTML = `
                            <div style="background: var(--danger); color: white; padding: 12px; border-radius: 8px; margin-top: 16px;">
                                âœ— Import failed: ${error.message}
                            </div>
                        `;
                    }
                };

                reader.readAsText(file);
            },

            // Exercise Details
            showExerciseDetails(exerciseName) {
                const exerciseWorkouts = this.workouts
                    .filter(w => w.exercise === exerciseName)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const details = this.exerciseDetails[exerciseName] || {};
                const pr = this.personalRecords[exerciseName];
                
                let html = '';
                
                // Exercise info
                if (details.instructions) {
                    html += `
                        <div class="exercise-info">
                            <div class="info-section">
                                <div class="info-title">HOW TO PERFORM</div>
                                <div class="info-text">${details.instructions}</div>
                            </div>
                            ${details.tips ? `
                                <div class="info-section">
                                    <div class="info-title">TIPS</div>
                                    <div class="info-text">${details.tips}</div>
                                </div>
                            ` : ''}
                            ${details.alternatives ? `
                                <div class="info-section">
                                    <div class="info-title">ALTERNATIVES</div>
                                    <div class="info-text">${details.alternatives.join(', ')}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // PR badge
                if (pr) {
                    html += `
                        <div class="card">
                            <div class="card-title">ðŸ† Personal Record</div>
                            <div style="font-size: 32px; font-weight: 700; margin-top: 8px;">${pr}kg</div>
                        </div>
                    `;
                }
                
                // Progress chart
                if (exerciseWorkouts.length > 1) {
                    const maxWeights = exerciseWorkouts.slice(0, 10).reverse().map(w => 
                        Math.max(...w.sets.map(s => s.weight || 0))
                    );
                    const maxWeight = Math.max(...maxWeights);
                    
                    html += `
                        <div class="chart-container">
                            <div class="chart-title">Max Weight Progress (Last 10 Workouts)</div>
                            <div class="simple-chart">
                                ${exerciseWorkouts.slice(0, 10).reverse().map((workout, i) => {
                                    const weight = Math.max(...workout.sets.map(s => s.weight || 0));
                                    const height = (weight / maxWeight) * 100;
                                    return `
                                        <div class="chart-bar" style="height: ${height}%">
                                            <div class="chart-bar-value">${weight}</div>
                                            <div class="chart-bar-label">${new Date(workout.date).getDate()}/${new Date(workout.date).getMonth() + 1}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${exerciseWorkouts.length > 10 ? `
                                <button class="btn btn-secondary" onclick="app.showFullProgressGraph('${exerciseName.replace(/'/g, "\\'")}')" style="margin-top: 12px; width: 100%;">
                                    View Full Progress Graph
                                </button>
                            ` : ''}
                        </div>
                    `;
                }
                
                // History
                html += `
                    <div class="card">
                        <div class="card-title" style="margin-bottom: 12px;">Recent Workouts</div>
                        ${exerciseWorkouts.length === 0 ? '<div class="empty-text">No history yet</div>' : ''}
                        ${exerciseWorkouts.slice(0, 10).map(workout => `
                            <div class="history-item">
                                <div class="history-date">${this.formatDate(workout.date)}</div>
                                <div class="history-sets">${workout.sets.map(s => `${s.weight}kg Ã— ${s.reps}`).join(', ')}</div>
                            </div>
                        `).join('')}
                        ${exerciseWorkouts.length > 10 ? `
                            <button class="btn btn-secondary" onclick="app.showExerciseHistory('${exerciseName.replace(/'/g, "\\'")}')" style="margin-top: 12px; width: 100%;">
                                View All ${exerciseWorkouts.length} Workouts
                            </button>
                        ` : ''}
                    </div>
                `;
                
                html += `<button class="btn btn-primary" onclick="app.startWorkout('${exerciseName.replace(/'/g, "\\'")}'); app.closeExerciseDetails();">Start Workout</button>`;
                
                document.getElementById('detailsExerciseName').textContent = exerciseName;
                document.getElementById('exerciseDetailsContent').innerHTML = html;
                document.getElementById('exerciseDetailsModal').classList.add('active');
            },

            showFullProgressGraph(exerciseName) {
                const workouts = this.workouts
                    .filter(w => w.exercise === exerciseName)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
                
                const html = `
                    <div class="modal active" id="progressGraphModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">${exerciseName} Progress</h2>
                                <button class="close-btn" onclick="document.getElementById('progressGraphModal').remove()">Ã—</button>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <canvas id="progressChart" width="400" height="250" style="width: 100%; background: var(--surface2); border-radius: 12px;"></canvas>
                            </div>
                            
                            <button class="btn btn-secondary" onclick="document.getElementById('progressGraphModal').remove()">Close</button>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', html);
                
                // Draw chart
                setTimeout(() => {
                    const canvas = document.getElementById('progressChart');
                    const ctx = canvas.getContext('2d');
                    const data = workouts.map(w => ({
                        date: new Date(w.date),
                        weight: Math.max(...w.sets.map(s => s.weight || 0))
                    }));
                    
                    if (data.length === 0) return;
                    
                    const padding = 40;
                    const width = canvas.width;
                    const height = canvas.height;
                    const maxWeight = Math.max(...data.map(d => d.weight));
                    const minWeight = Math.min(...data.map(d => d.weight));
                    const weightRange = maxWeight - minWeight || 1;
                    
                    // Clear
                    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--surface2');
                    ctx.fillRect(0, 0, width, height);
                    
                    // Grid lines
                    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border');
                    ctx.lineWidth = 1;
                    for (let i = 0; i <= 5; i++) {
                        const y = padding + ((height - padding * 2) * i / 5);
                        ctx.beginPath();
                        ctx.moveTo(padding, y);
                        ctx.lineTo(width - padding, y);
                        ctx.stroke();
                    }
                    
                    // Line
                    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent');
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    
                    data.forEach((point, i) => {
                        const x = padding + ((width - padding * 2) * i / (data.length - 1));
                        const y = height - padding - ((point.weight - minWeight) / weightRange * (height - padding * 2));
                        
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    });
                    ctx.stroke();
                    
                    // Points
                    data.forEach((point, i) => {
                        const x = padding + ((width - padding * 2) * i / (data.length - 1));
                        const y = height - padding - ((point.weight - minWeight) / weightRange * (height - padding * 2));
                        
                        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent');
                        ctx.beginPath();
                        ctx.arc(x, y, 5, 0, Math.PI * 2);
                        ctx.fill();
                    });
                    
                    // Labels
                    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
                    ctx.font = '12px DM Mono, monospace';
                    ctx.textAlign = 'right';
                    
                    for (let i = 0; i <= 5; i++) {
                        const weight = minWeight + (weightRange * (5 - i) / 5);
                        const y = padding + ((height - padding * 2) * i / 5);
                        ctx.fillText(Math.round(weight) + 'kg', padding - 10, y + 4);
                    }
                }, 100);
            },

            showExerciseHistory(exerciseName) {
                const exerciseWorkouts = this.workouts
                    .filter(w => w.exercise === exerciseName)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const pr = this.personalRecords[exerciseName];
                const totalVolume = exerciseWorkouts.reduce((sum, w) => 
                    sum + w.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                );
                const totalSets = exerciseWorkouts.reduce((sum, w) => sum + w.sets.length, 0);
                
                const html = `
                    <div class="modal active" id="exerciseHistoryModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">${exerciseName} History</h2>
                                <button class="close-btn" onclick="document.getElementById('exerciseHistoryModal').remove()">Ã—</button>
                            </div>
                            
                            <div class="premium-stat-card" style="margin-bottom: 16px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; text-align: center;">
                                    <div>
                                        <div style="font-size: 24px; font-weight: 700; font-family: 'DM Mono', monospace;">${exerciseWorkouts.length}</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Workouts</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 24px; font-weight: 700; font-family: 'DM Mono', monospace;">${totalSets}</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Total Sets</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 24px; font-weight: 700; font-family: 'DM Mono', monospace;">${pr || 0}kg</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">PR</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="premium-stat-card" style="max-height: 400px; overflow-y: auto;">
                                ${exerciseWorkouts.map(workout => `
                                    <div style="padding: 12px 0; border-bottom: 1px solid var(--border);">
                                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 6px;">${this.formatDate(workout.date)}</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">
                                            ${workout.sets.map((s, i) => `Set ${i+1}: ${s.weight}kg Ã— ${s.reps}${s.rpe ? ` @ ${s.rpe}` : ''}`).join(' â€¢ ')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <button class="btn btn-secondary" onclick="document.getElementById('exerciseHistoryModal').remove()" style="margin-top: 16px;">Close</button>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', html);
            },

            closeExerciseDetails() {
                document.getElementById('exerciseDetailsModal').classList.remove('active');
            },

            // Utility Functions
            duplicateLastWorkout() {
                const dates = [...new Set(this.workouts.map(w => w.date))].sort((a, b) => new Date(b) - new Date(a));
                if (dates.length === 0) {
                    alert('No previous workouts to duplicate');
                    return;
                }
                
                const today = new Date().toISOString().split('T')[0];
                const lastDate = dates.find(d => d !== today);
                
                if (!lastDate) {
                    alert('No previous workouts found (other than today)');
                    return;
                }
                
                const lastWorkouts = this.workouts.filter(w => w.date === lastDate);
                
                // Show preview with smart suggestions
                const preview = lastWorkouts.map(w => {
                    const maxWeight = Math.max(...w.sets.map(s => s.weight || 0));
                    const suggestedIncrease = 2.5;
                    return `â€¢ ${w.exercise}: ${w.sets.length} sets (Max: ${maxWeight}kg â†’ ${maxWeight + suggestedIncrease}kg)`;
                }).join('\n');
                
                const confirmed = confirm(
                    `Repeat workout from ${this.formatDate(lastDate)}?\n\n` +
                    `${preview}\n\n` +
                    `ðŸ’¡ Tip: Weights will be pre-filled with +2.5kg suggestions for progressive overload!`
                );
                
                if (!confirmed) return;
                
                // Start with first exercise
                if (lastWorkouts.length > 0) {
                    this.duplicateWorkouts = lastWorkouts;
                    this.duplicateIndex = 0;
                    this.startWorkoutFromDuplicate(lastWorkouts[0]);
                }
            },

            startWorkoutFromDuplicate(workout) {
                this.currentExercise = workout.exercise;
                
                // Smart progressive overload: add 2.5kg to each set
                this.currentWorkout = {
                    sets: workout.sets.map(s => ({ 
                        weight: (s.weight || 0) + 2.5, 
                        reps: s.reps 
                    }))
                };
                
                const lastWorkout = this.workouts
                    .filter(w => w.exercise === workout.exercise && w.id !== workout.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                
                this.showWorkoutModal(lastWorkout, true);
            },

            async deleteWorkout(workoutId) {
                if (!confirm('Delete this workout?')) return;
                
                this.workouts = this.workouts.filter(w => w.id !== workoutId);
                await this.saveWorkouts();
                this.renderToday();
                this.renderAnalytics();
            },

            showExportModal() {
                document.getElementById('exportModal').classList.add('active');
            },

            closeExportModal() {
                document.getElementById('exportModal').classList.remove('active');
            },

            exportToCSV() {
                const csv = ['Date,Exercise,Set,Weight (kg),Reps,Volume'];
                
                this.workouts.forEach(workout => {
                    workout.sets.forEach((set, i) => {
                        const volume = (set.weight || 0) * (set.reps || 0);
                        csv.push(`${workout.date},${workout.exercise},${i + 1},${set.weight || 0},${set.reps || 0},${volume}`);
                    });
                });
                
                const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gym-tracker-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                this.closeExportModal();
            },

            exportJSON() {
                const data = {
                    workouts: this.workouts,
                    templates: this.templates,
                    bodyMetrics: this.bodyMetrics,
                    personalRecords: this.personalRecords,
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gym-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                this.closeExportModal();
            },

            shareWorkoutSummary() {
                const today = new Date();
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                const weekWorkouts = this.workouts.filter(w => new Date(w.date) >= weekAgo);
                
                const summary = `
ðŸ‹ï¸ My Week in Fitness

ðŸ“Š Stats:
â€¢ ${[...new Set(weekWorkouts.map(w => w.date))].length} workout days
â€¢ ${weekWorkouts.length} total exercises
â€¢ ${weekWorkouts.reduce((sum, w) => sum + w.sets.length, 0)} total sets

ðŸ’ª Top Exercises:
${[...new Set(weekWorkouts.map(w => w.exercise))].slice(0, 5).map(ex => `â€¢ ${ex}`).join('\n')}

Tracked with Gym Tracker
                `.trim();
                
                if (navigator.share) {
                    navigator.share({ text: summary });
                } else {
                    navigator.clipboard.writeText(summary);
                    alert('Summary copied to clipboard!');
                }
                
                this.closeExportModal();
            },

            showExerciseModal() {
                document.getElementById('exerciseModal').classList.add('active');
                document.getElementById('exerciseSearch').value = '';
                this.renderModalExercises();
            },

            closeExerciseModal() {
                document.getElementById('exerciseModal').classList.remove('active');
            },

            renderModalExercises(filter = '') {
                const filtered = this.exercises.filter(e => 
                    e.name.toLowerCase().includes(filter.toLowerCase())
                );

                const categories = [...new Set(filtered.map(e => e.category))];
                const html = categories.map(cat => `
                    <div class="exercise-category">
                        <div class="category-title">${cat}</div>
                        ${filtered.filter(e => e.category === cat).map(ex => `
                            <div class="exercise-item" onclick="app.startWorkout('${ex.name.replace(/'/g, "\\'")}')">
                                <div>
                                    <div class="exercise-name">${ex.name}</div>
                                    <div class="exercise-muscle">${ex.muscle}</div>
                                </div>
                                <div class="chevron">+</div>
                            </div>
                        `).join('')}
                    </div>
                `).join('');

                document.getElementById('modalExerciseList').innerHTML = html;
            },

            filterExercises() {
                const filter = document.getElementById('exerciseSearch').value;
                this.renderModalExercises(filter);
            },

            startWorkout(exerciseName) {
                this.closeExerciseModal();
                this.currentExercise = exerciseName;
                this.currentWorkout = { sets: [{ weight: '', reps: '' }] };
                
                // Get last workout for this exercise
                const lastWorkout = this.workouts
                    .filter(w => w.exercise === exerciseName)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                this.showWorkoutModal(lastWorkout);
            },

            showWorkoutModal(lastWorkout, isDuplicate = false) {
                document.getElementById('workoutExerciseName').textContent = this.currentExercise;
                
                let lastWorkoutHTML = '';
                if (lastWorkout) {
                    const volume = lastWorkout.sets.reduce((sum, s) => sum + (s.weight * s.reps), 0);
                    lastWorkoutHTML = `
                        <div class="last-workout">
                            <div class="last-workout-title">Last Workout (${this.formatDate(lastWorkout.date)})</div>
                            <div class="last-workout-data">
                                ${lastWorkout.sets.map((s, i) => `Set ${i + 1}: ${s.weight}kg Ã— ${s.reps} reps`).join(' â€¢ ')}
                                <br>Total Volume: ${volume}kg
                            </div>
                        </div>
                    `;
                }

                // Suggest next weight based on last performance
                const suggestedWeight = lastWorkout && lastWorkout.sets.length > 0 
                    ? Math.max(...lastWorkout.sets.map(s => s.weight || 0)) + 2.5 
                    : 0;

                const setsHTML = this.currentWorkout.sets.map((set, i) => `
                    <div class="set-item">
                        <div class="set-number">Set ${i + 1}</div>
                        <div class="set-input">
                            <div class="input-group">
                                <label class="input-label">Weight (kg)</label>
                                ${i === 0 && suggestedWeight > 0 ? `
                                    <div class="weight-adjust">
                                        <button class="adjust-btn" onclick="app.quickSetWeight(${i}, ${suggestedWeight - 5})">-5kg</button>
                                        <button class="adjust-btn" onclick="app.quickSetWeight(${i}, ${suggestedWeight - 2.5})">-2.5kg</button>
                                        <button class="adjust-btn" onclick="app.quickSetWeight(${i}, ${suggestedWeight})" style="background: var(--accent); color: #141414; color: white;">â†‘ ${suggestedWeight}kg</button>
                                    </div>
                                ` : ''}
                                <input type="number" 
                                    id="weight-${i}"
                                    value="${set.weight}" 
                                    onchange="app.updateSet(${i}, 'weight', this.value)"
                                    placeholder="${lastWorkout?.sets[i]?.weight || '0'}">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Reps</label>
                                <input type="number" 
                                    id="reps-${i}"
                                    value="${set.reps}" 
                                    onchange="app.updateSet(${i}, 'reps', this.value)"
                                    placeholder="${lastWorkout?.sets[i]?.reps || '0'}">
                            </div>
                            <div class="input-group" style="flex: 0.5;">
                                <label class="input-label">RPE</label>
                                <input type="number" 
                                    id="rpe-${i}"
                                    min="1"
                                    max="10"
                                    value="${set.rpe || ''}" 
                                    onchange="app.updateSet(${i}, 'rpe', this.value)"
                                    placeholder="1-10"
                                    style="text-align: center;">
                            </div>
                        </div>
                        ${i > 0 ? `<button class="delete-set" onclick="app.removeSet(${i})">âˆ’</button>` : ''}
                    </div>
                `).join('');

                document.getElementById('workoutContent').innerHTML = `
                    ${lastWorkoutHTML}
                    <div class="set-list">
                        ${setsHTML}
                    </div>
                    <div class="metric-input-group" style="margin-bottom: 12px;">
                        <label class="input-label">Workout Notes (Optional)</label>
                        <input type="text" id="workoutNotes" class="metric-input" placeholder="How did it feel? Any observations?" style="font-size: 14px;">
                    </div>
                    <button class="btn btn-secondary" onclick="app.addSet()">+ Add Set</button>
                    <button class="btn btn-secondary" onclick="app.startSuperset()" style="background: var(--warning);">ðŸ”— Superset with Next Exercise</button>
                    <button class="btn btn-success" onclick="app.finishWorkout()">âœ“ Finish Workout</button>
                `;

                document.getElementById('workoutModal').classList.add('active');
            },

            quickSetWeight(setIndex, weight) {
                this.currentWorkout.sets[setIndex].weight = weight;
                document.getElementById(`weight-${setIndex}`).value = weight;
            },

            closeWorkoutModal() {
                document.getElementById('workoutModal').classList.remove('active');
            },

            updateSet(index, field, value) {
                this.currentWorkout.sets[index][field] = parseFloat(value) || '';
            },

            addSet() {
                this.currentWorkout.sets.push({ weight: '', reps: '' });
                const lastWorkout = this.workouts
                    .filter(w => w.exercise === this.currentExercise)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                this.showWorkoutModal(lastWorkout);
            },

            removeSet(index) {
                this.currentWorkout.sets.splice(index, 1);
                const lastWorkout = this.workouts
                    .filter(w => w.exercise === this.currentExercise)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                this.showWorkoutModal(lastWorkout);
            },

            async finishWorkout() {
                const validSets = this.currentWorkout.sets.filter(s => s.weight && s.reps);
                
                if (validSets.length === 0) {
                    alert('Please add at least one set with weight and reps');
                    return;
                }

                const notes = document.getElementById('workoutNotes')?.value || '';
                const workoutId = Date.now().toString();

                const workout = {
                    id: workoutId,
                    exercise: this.currentExercise,
                    date: new Date().toISOString().split('T')[0],
                    sets: validSets,
                    superset: this.currentSuperset ? this.currentSuperset : null
                };

                this.workouts.push(workout);

                // Save notes if provided
                if (notes) {
                    this.workoutNotes[workoutId] = notes;
                    await this.saveWorkoutNotes();
                }

                await this.saveWorkouts();
                
                // Check for new achievements
                this.checkAchievements();
                
                this.closeWorkoutModal();
                this.renderToday();
                this.renderAnalytics();
                
                // Check if this is a superset - skip rest timer
                const isSuperset = this.currentSuperset !== null;
                
                // Check if this is part of a template
                if (this.currentTemplate && this.currentTemplateIndex < this.currentTemplate.exercises.length - 1) {
                    // Start rest timer before next exercise (unless superset)
                    if (isSuperset) {
                        this.currentSuperset = null; // Clear superset flag
                        this.currentTemplateIndex++;
                        this.startWorkout(this.currentTemplate.exercises[this.currentTemplateIndex].name);
                    } else {
                        this.startRestTimer(() => {
                            this.currentTemplateIndex++;
                            this.startWorkout(this.currentTemplate.exercises[this.currentTemplateIndex].name);
                        });
                    }
                } else if (this.duplicateWorkouts && this.duplicateIndex < this.duplicateWorkouts.length - 1) {
                    // Continue with duplicate workout
                    if (isSuperset) {
                        this.currentSuperset = null;
                        this.duplicateIndex++;
                        this.startWorkoutFromDuplicate(this.duplicateWorkouts[this.duplicateIndex]);
                    } else {
                        this.startRestTimer(() => {
                            this.duplicateIndex++;
                            this.startWorkoutFromDuplicate(this.duplicateWorkouts[this.duplicateIndex]);
                        });
                    }
                } else {
                    this.currentTemplate = null;
                    this.duplicateWorkouts = null;
                    this.currentSuperset = null;
                }
            },

            // Rest Timer Functions
            startRestTimer(callback = null) {
                this.restTimeRemaining = this.settings.restTimerDuration;
                this.restCallback = callback;
                document.getElementById('restTimer').classList.add('active');
                this.updateTimerDisplay();
                
                this.restTimer = setInterval(() => {
                    this.restTimeRemaining--;
                    this.updateTimerDisplay();
                    
                    if (this.restTimeRemaining <= 0) {
                        this.completeRest();
                    }
                }, 1000);
                
                // Vibrate on start
                if (navigator.vibrate) {
                    navigator.vibrate(200);
                }
            },

            updateTimerDisplay() {
                const minutes = Math.floor(this.restTimeRemaining / 60);
                const seconds = this.restTimeRemaining % 60;
                document.getElementById('timerDisplay').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            },

            completeRest() {
                clearInterval(this.restTimer);
                document.getElementById('restTimer').classList.remove('active');
                
                // Vibrate on complete
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
                
                // Show notification (10)
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Rest Complete! ðŸ’ª', {
                        body: 'Time for your next set',
                        tag: 'rest-timer'
                    });
                }
                
                // Play sound
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgA');
                    audio.volume = 0.3;
                    audio.play().catch(() => {});
                } catch(e) {}
                
                if (this.restCallback) {
                    this.restCallback();
                    this.restCallback = null;
                }
            },

            skipRest() {
                this.completeRest();
            },

            addRestTime(seconds) {
                this.restTimeRemaining += seconds;
                this.updateTimerDisplay();
            },

            // Superset Functions
            startSuperset() {
                // Mark that next exercise should be a superset
                this.currentSuperset = this.currentExercise;
                alert('ðŸ’ª Superset mode activated! Your next exercise will be paired with this one. No rest timer between exercises.');
                this.finishWorkout();
            },

            // Progress Photos Functions
            showAddPhoto() {
                document.getElementById('addPhotoModal').classList.add('active');
                document.getElementById('photoPreview').innerHTML = '';
            },

            closeAddPhoto() {
                document.getElementById('addPhotoModal').classList.remove('active');
            },

            async handlePhotoUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const dataUrl = e.target.result;
                    
                    // Show preview
                    document.getElementById('photoPreview').innerHTML = `
                        <div style="margin-top: 16px;">
                            <img src="${dataUrl}" style="width: 100%; border-radius: 12px; margin-bottom: 12px;" alt="Preview">
                            <input type="text" id="photoNotes" class="metric-input" placeholder="Add notes (optional)" style="margin-bottom: 12px;">
                            <button class="btn btn-primary" onclick="app.savePhoto('${dataUrl.replace(/'/g, "\\'")}')">ðŸ’¾ Save Photo</button>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            },

            async savePhoto(dataUrl) {
                const notes = document.getElementById('photoNotes')?.value || '';
                
                this.progressPhotos.push({
                    date: new Date().toISOString(),
                    dataUrl: dataUrl,
                    notes: notes,
                    weight: this.bodyMetrics.length > 0 ? this.bodyMetrics[this.bodyMetrics.length - 1].weight : null
                });

                await this.saveProgressPhotos();
                this.closeAddPhoto();
                this.renderMetrics();
            },

            showPhotoComparison(index) {
                const photo = this.progressPhotos[index];
                if (!photo) return;

                // Find first photo for comparison
                const firstPhoto = this.progressPhotos[0];
                const daysBetween = Math.floor((new Date(photo.date) - new Date(firstPhoto.date)) / (1000 * 60 * 60 * 24));

                let html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">
                            ${new Date(photo.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                        </h3>
                        ${photo.notes ? `<p style="color: var(--text-secondary);">${photo.notes}</p>` : ''}
                        ${photo.weight ? `<p style="color: var(--text-secondary);">Weight: ${photo.weight}kg</p>` : ''}
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <div>
                            <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">
                                START (${new Date(firstPhoto.date).toISOString().split('T')[0]})
                            </div>
                            <img src="${firstPhoto.dataUrl}" style="width: 100%; border-radius: 12px;" alt="Before">
                            ${firstPhoto.weight ? `<div style="text-align: center; margin-top: 4px; font-size: 12px; color: var(--text-secondary);">${firstPhoto.weight}kg</div>` : ''}
                        </div>
                        <div>
                            <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">
                                CURRENT (+${daysBetween} days)
                            </div>
                            <img src="${photo.dataUrl}" style="width: 100%; border-radius: 12px;" alt="After">
                            ${photo.weight ? `<div style="text-align: center; margin-top: 4px; font-size: 12px; color: var(--text-secondary);">${photo.weight}kg</div>` : ''}
                        </div>
                    </div>

                    ${photo.weight && firstPhoto.weight ? `
                        <div class="card" style="background: var(--accent); color: #141414; color: white;">
                            <div style="text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9;">Weight Change</div>
                                <div style="font-size: 32px; font-weight: 700; margin: 8px 0;">
                                    ${photo.weight > firstPhoto.weight ? '+' : ''}${(photo.weight - firstPhoto.weight).toFixed(1)}kg
                                </div>
                                <div style="font-size: 12px; opacity: 0.9;">${daysBetween} days</div>
                            </div>
                        </div>
                    ` : ''}

                    <button class="btn btn-danger" onclick="app.deletePhoto(${index})">Delete Photo</button>
                `;

                document.getElementById('photoCompareContent').innerHTML = html;
                document.getElementById('photoCompareModal').classList.add('active');
            },

            closePhotoComparison() {
                document.getElementById('photoCompareModal').classList.remove('active');
            },

            async deletePhoto(index) {
                if (!confirm('Delete this progress photo?')) return;
                
                this.progressPhotos.splice(index, 1);
                await this.saveProgressPhotos();
                this.closePhotoComparison();
                this.renderMetrics();
            },

            showAllPhotos() {
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        ${this.progressPhotos.map((photo, i) => `
                            <div onclick="app.showPhotoComparison(${i})" style="cursor: pointer; position: relative; padding-bottom: 100%; overflow: hidden; border-radius: 12px; background: var(--background);">
                                <img src="${photo.dataUrl}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" alt="Progress photo">
                                <div style="position: absolute; bottom: 8px; left: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 6px; border-radius: 6px; font-size: 11px;">
                                    <div>${new Date(photo.date).toISOString().split('T')[0]}</div>
                                    ${photo.weight ? `<div>${photo.weight}kg</div>` : ''}
                                </div>
                            </div>
                        `).reverse().join('')}
                    </div>
                `;

                const modalContent = `
                    <div class="modal active" id="allPhotosModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">All Progress Photos</h2>
                                <button class="close-btn" onclick="document.getElementById('allPhotosModal').remove()">Ã—</button>
                            </div>
                            ${html}
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalContent);
            },

            // More Tab - Settings, Goals, Achievements, Metrics
            renderMore() {
                const isConnected = !!window.db;
                const status = this.syncStatus || { isOnline: navigator.onLine, isConnected, status: isConnected ? 'synced' : 'offline' };
                
                let statusColor = 'var(--border)';
                let statusText = 'Offline';
                let statusIcon = 'ðŸ”´';
                
                if (status.isConnected && status.status === 'success') {
                    statusColor = 'var(--success)';
                    statusText = 'Synced';
                    statusIcon = 'ðŸŸ¢';
                } else if (status.isConnected && status.status === 'error') {
                    statusColor = 'var(--danger)';
                    statusText = 'Sync Failed';
                    statusIcon = 'ðŸ”´';
                } else if (status.isConnected) {
                    statusColor = 'var(--accent)';
                    statusText = 'Connected';
                    statusIcon = 'ðŸŸ¡';
                } else if (status.isOnline) {
                    statusColor = 'var(--warning)';
                    statusText = 'No Database';
                    statusIcon = 'ðŸŸ¡';
                }
                
                const lastSyncText = status.lastSync 
                    ? `Last sync: ${Math.floor((Date.now() - status.lastSync) / 1000)}s ago`
                    : 'Never synced';
                
                let html = `
                    <!-- Sync Status (1 & 2) -->
                    <div class="premium-stat-card sync-status-card" style="margin-bottom: 16px; border-color: ${statusColor};">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <div style="font-size: 15px; font-weight: 700; color: var(--text-primary);">
                                    ${statusIcon} ${statusText}
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">
                                    ${status.isConnected ? lastSyncText : 'Data saved locally only'}
                                </div>
                            </div>
                            <button onclick="app.showSupabaseSetup()" style="background: ${isConnected ? 'var(--border)' : 'var(--primary)'}; color: ${isConnected ? 'var(--text-primary)' : 'white'}; border: none; padding: 8px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                                ${isConnected ? 'Change' : 'Setup'}
                            </button>
                        </div>
                    </div>

                    <!-- Cardio Quick Access -->
                    <div class="premium-stat-card" style="margin-bottom: 16px; background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%); cursor: pointer;" onclick="app.switchTab('cardio')">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px 0;">
                            <div>
                                <div style="font-size: 20px; font-weight: 700; color: white; margin-bottom: 4px;">ðŸƒ Cardio Tracker</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.9);">
                                    ${this.cardioSessions.length} sessions â€¢ ${(this.cardioSessions.reduce((sum, s) => sum + (s.distance || 0), 0) / 1000).toFixed(1)}km total
                                </div>
                            </div>
                            <div style="font-size: 32px; color: rgba(255,255,255,0.3);">â€º</div>
                        </div>
                    </div>

                    <div class="quick-actions" style="margin-bottom: 20px;">
                        <div class="quick-action-btn" onclick="app.switchTab('templates')">
                            <div class="quick-action-icon">â‰¡</div>
                            <div class="quick-action-label">Programs</div>
                        </div>
                        <div class="quick-action-btn" onclick="app.switchTab('library')">
                            <div class="quick-action-icon">â–¤</div>
                            <div class="quick-action-label">Exercise Library</div>
                        </div>
                        <div class="quick-action-btn" onclick="app.showSection('metrics')">
                            <div class="quick-action-icon">â†”</div>
                            <div class="quick-action-label">Body Metrics</div>
                        </div>
                        <div class="quick-action-btn" onclick="app.showSection('goals')">
                            <div class="quick-action-icon">â—Ž</div>
                            <div class="quick-action-label">Goals</div>
                        </div>
                        <div class="quick-action-btn" onclick="app.showSection('achievements')">
                            <div class="quick-action-icon">âœ¦</div>
                            <div class="quick-action-label">Achievements</div>
                        </div>
                        <div class="quick-action-btn" onclick="app.showSection('settings')">
                            <div class="quick-action-icon">â—‹</div>
                            <div class="quick-action-label">Settings</div>
                        </div>
                    </div>

                    <!-- Test Data Generator -->
                    <div class="card" style="margin-bottom: 16px; border: 2px dashed var(--border);">
                        <div class="card-title" style="margin-bottom: 8px;">ðŸ§ª Test Data</div>
                        <button class="btn btn-secondary" onclick="app.generateTestCardio()" style="width: 100%;">
                            Generate Test Cardio Sessions
                        </button>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; text-align: center;">
                            Creates 10 sample runs to test stats & achievements
                        </div>
                    </div>

                    <!-- Export/Import -->
                    <div class="card" style="margin-bottom: 16px;">
                        <div class="card-title" style="margin-bottom: 12px;">ðŸ’¾ Data Management</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="app.exportData()" style="flex: 1;">
                                Export Data
                            </button>
                            <button class="btn btn-secondary" onclick="app.importData()" style="flex: 1;">
                                Import Data
                            </button>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; text-align: center;">
                            Backup or transfer your workout data
                        </div>
                    </div>

                    <!-- Calculators (11 & 12) -->
                    <div class="card" style="margin-bottom: 16px;">
                        <div class="card-title" style="margin-bottom: 12px;">ðŸ”¢ Calculators</div>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <button class="btn btn-secondary" onclick="app.showPlateCalculator()" style="flex: 1;">
                                Plate Calculator
                            </button>
                            <button class="btn btn-secondary" onclick="app.show1RMCalculator()" style="flex: 1;">
                                1RM Calculator
                            </button>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary); text-align: center;">
                            Load plates â€¢ Estimate max
                        </div>
                    </div>

                    <!-- AI Features (6 & 8) -->
                    <div class="card" style="margin-bottom: 16px; border: 2px solid var(--accent);">
                        <div class="card-title" style="margin-bottom: 12px;">ðŸ¤– AI-Powered</div>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <button class="btn btn-primary" onclick="app.generateAIWorkout()" style="flex: 1;">
                                Generate Workout
                            </button>
                            <button class="btn btn-primary" onclick="app.analyzeNutrition()" style="flex: 1;">
                                Scan Meal
                            </button>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary); text-align: center;">
                            AI creates programs â€¢ Photo â†’ macros
                        </div>
                    </div>

                    <!-- Injury & Recovery -->
                    <div class="card" style="margin-bottom: 16px;">
                        <div class="card-title" style="margin-bottom: 12px;">âš•ï¸ Health & Recovery</div>
                        <button class="btn btn-secondary" onclick="app.logInjury()" style="width: 100%; margin-bottom: 8px;">
                            Log Injury/Pain
                        </button>
                        <button class="btn btn-secondary" onclick="app.scheduleDeload()" style="width: 100%;">
                            Schedule Deload Week
                        </button>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; text-align: center;">
                            Track injuries and plan recovery
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title" style="margin-bottom: 12px;">App Info</div>
                        <div class="history-item">
                            <div class="history-date">Version</div>
                            <div class="history-sets">3.2 - Supabase Edition</div>
                        </div>
                        <div class="history-item">
                            <div class="history-date">Total Workouts</div>
                            <div class="history-sets">${this.workouts.length}</div>
                        </div>
                        <div class="history-item">
                            <div class="history-date">Workout Sessions</div>
                            <div class="history-sets">${this.workoutSessions.length}</div>
                        </div>
                        <div class="history-item">
                            <div class="history-date">Achievements Unlocked</div>
                            <div class="history-sets">${this.achievements.length}</div>
                        </div>
                        <div class="history-item">
                            <div class="history-date">Storage</div>
                            <div class="history-sets">${isConnected ? 'â˜ï¸ Supabase' : 'ðŸ“± Local only'}</div>
                        </div>
                    </div>
                `;

                document.getElementById('moreContent').innerHTML = html;
            },

            showSupabaseSetup() {
                const savedUrl = localStorage.getItem('supabaseUrl') || '';
                const savedKey = localStorage.getItem('supabaseKey') || '';

                document.body.insertAdjacentHTML('beforeend', `
                    <div class="modal active" id="supabaseModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">Connect Database</h2>
                                <button class="close-btn" onclick="document.getElementById('supabaseModal').remove()">Ã—</button>
                            </div>

                            <div style="background: rgba(0,212,170,0.1); border: 1px solid rgba(0,212,170,0.3); border-radius: 12px; padding: 14px; margin-bottom: 20px; font-size: 13px; line-height: 1.6; color: var(--text-secondary);">
                                <strong style="color: var(--primary);">How to get your credentials:</strong><br>
                                1. Go to <strong>window.db.com</strong> â†’ Your project<br>
                                2. Click <strong>Settings â†’ API</strong><br>
                                3. Copy <strong>Project URL</strong> and <strong>anon/public key</strong>
                            </div>

                            <div class="metric-input-group">
                                <label class="metric-label">Project URL</label>
                                <input type="text" id="sbUrl" class="metric-input"
                                    value="${savedUrl}"
                                    placeholder="https://xxxxxxxxxxxx.window.db.co"
                                    style="font-size: 13px;">
                            </div>

                            <div class="metric-input-group">
                                <label class="metric-label">Anon / Public Key</label>
                                <input type="text" id="sbKey" class="metric-input"
                                    value="${savedKey}"
                                    placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                                    style="font-size: 13px;">
                            </div>

                            <div id="sbStatus" style="margin: 12px 0; font-size: 13px; min-height: 20px;"></div>

                            <button class="btn btn-primary" onclick="app.testAndSaveSupabase()">
                                ðŸ”Œ Test & Connect
                            </button>
                            ${window.db ? `
                                <button class="btn btn-secondary" onclick="app.disconnectSupabase()" style="margin-top: 8px; color: var(--danger); border-color: var(--danger);">
                                    Disconnect
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `);
            },

            async testAndSaveSupabase() {
                const url = document.getElementById('sbUrl').value.trim();
                const key = document.getElementById('sbKey').value.trim();
                const status = document.getElementById('sbStatus');

                if (!url || !key) {
                    status.innerHTML = '<span style="color: var(--danger);">âŒ Please enter both URL and key</span>';
                    return;
                }

                status.innerHTML = '<span style="color: var(--text-secondary);">ðŸ”„ Testing connection...</span>';

                try {
                    const { createClient } = window.supabase;
                    const testClient = createClient(url, key);
                    const { error } = await testClient.from('settings').select('user_id').limit(1);

                    if (error && error.code !== 'PGRST116') {
                        // PGRST116 = table not found, which means we connected but need to run schema
                        if (error.message.includes('relation') || error.code === '42P01') {
                            status.innerHTML = '<span style="color: var(--warning);">âš ï¸ Connected! But tables not found. Run the SQL schema first (see below).</span>';
                            document.getElementById('sbStatus').insertAdjacentHTML('afterend', `
                                <div style="background: var(--chart-bg); border-radius: 8px; padding: 12px; margin: 12px 0; font-size: 12px;">
                                    <strong>Run this in Supabase SQL Editor:</strong><br><br>
                                    <a href="https://window.db.com/dashboard/project/_/sql" target="_blank" style="color: var(--primary);">Open SQL Editor â†’</a><br><br>
                                    Then paste the schema from the file I'll provide.
                                </div>
                            `);
                            return;
                        }
                        throw error;
                    }

                    // Success!
                    localStorage.setItem('supabaseUrl', url);
                    localStorage.setItem('supabaseKey', key);
                    window.db = testClient;

                    status.innerHTML = '<span style="color: var(--success);">âœ… Connected successfully!</span>';

                    setTimeout(async () => {
                        document.getElementById('supabaseModal').remove();
                        this.showNotification('ðŸŸ¢ Database connected! Syncing data...');
                        // Reload data from Supabase
                        await this.loadData();
                        this.renderToday();
                        this.renderMore();
                    }, 1000);

                } catch (error) {
                    console.error('Supabase test failed:', error);
                    status.innerHTML = `<span style="color: var(--danger);">âŒ Failed: ${error.message}</span>`;
                }
            },

            disconnectSupabase() {
                localStorage.removeItem('supabaseUrl');
                localStorage.removeItem('supabaseKey');
                window.db = null;
                document.getElementById('supabaseModal').remove();
                this.showNotification('ðŸ”Œ Database disconnected');
                this.renderMore();
            },

            renderCardio() {
                const el = document.getElementById('cardioContent');
                if (!el) return;

                const isActive = this._cardioActive;
                const types = ['Run', 'Cycle', 'Walk'];

                if (isActive) {
                    // ACTIVE TRACKING UI (keep as-is)
                    const elapsed = this.getCardioElapsed();
                    const mins = Math.floor(elapsed / 60);
                    const secs = String(elapsed % 60).padStart(2, '0');
                    const dist = (this._cardioDistance / 1000).toFixed(2);
                    const pace = this._cardioDistance > 50
                        ? this.formatPace((elapsed / 60) / (this._cardioDistance / 1000))
                        : '--:--';
                    const isPaused = !!this._cardioPauseStart;

                    el.innerHTML = `
                        <div class="content" style="padding-bottom: 100px;">
                            <div style="padding: 20px 20px 12px; display:flex; align-items:center; justify-content:space-between;">
                                <div style="font-size:13px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.06em;">${this._cardioType} in progress</div>
                                ${isPaused ? '<div style="font-size:12px; color:var(--warning); font-weight:600;">PAUSED</div>' : '<div style="width:8px;height:8px;border-radius:50%;background:var(--danger);animation:pulse 1.2s infinite;"></div>'}
                            </div>

                            <!-- Live stats -->
                            <div style="padding: 0 20px 12px;">
                                <div class="cardio-stat-grid">
                                    <div class="cardio-stat" style="grid-column:1/-1; padding: 24px;">
                                        <div class="cardio-stat-value" style="font-size:52px;" id="liveTimer">${mins}:${secs}</div>
                                        <div class="cardio-stat-label">Elapsed</div>
                                    </div>
                                    <div class="cardio-stat">
                                        <div class="cardio-stat-value" id="liveDist">${dist}</div>
                                        <div class="cardio-stat-label">km</div>
                                    </div>
                                    <div class="cardio-stat">
                                        <div class="cardio-stat-value" id="livePace">${pace}</div>
                                        <div class="cardio-stat-label">min/km</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Map -->
                            <div style="padding: 0 20px 12px;">
                                <div class="cardio-map" id="cardioMapContainer">
                                    <canvas id="cardioMapCanvas"></canvas>
                                    <div id="cardioMapPlaceholder" class="cardio-map-placeholder" style="${this._cardioCoords.length > 0 ? 'display:none;' : ''}">
                                        <div style="font-size:32px; opacity:0.3;">â—‰</div>
                                        <div>Waiting for GPS signal...</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Splits -->
                            ${this._cardioSplits.length > 0 ? `
                                <div style="padding: 0 20px 12px;">
                                    <div class="card">
                                        <div class="card-title" style="margin-bottom:12px;">Splits</div>
                                        <div class="splits-list">
                                            ${this._cardioSplits.map((s, i) => {
                                                const fastest = Math.min(...this._cardioSplits.map(x => x.pace));
                                                const pct = fastest / s.pace * 100;
                                                return `
                                                    <div class="split-row">
                                                        <span class="split-km">km ${i + 1}</span>
                                                        <div style="flex:1; margin: 0 12px;">
                                                            <div class="split-bar" style="width:${pct}%;"></div>
                                                        </div>
                                                        <span class="split-pace">${this.formatPace(s.pace)}</span>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Controls -->
                            <div style="padding: 0 20px; display:flex; gap:10px;">
                                <button onclick="app.toggleCardioPause()" 
                                    style="flex:1; padding:16px; border-radius:14px; border:1px solid var(--border); 
                                    background:var(--surface2); color:var(--text-primary); font-size:15px; font-weight:600; 
                                    cursor:pointer; font-family:'DM Sans',sans-serif;">
                                    ${isPaused ? 'Resume' : 'Pause'}
                                </button>
                                <button onclick="app.stopCardio()" 
                                    style="flex:1; padding:16px; border-radius:14px; border:none; 
                                    background:var(--danger); color:white; font-size:15px; font-weight:600; 
                                    cursor:pointer; font-family:'DM Sans',sans-serif;">
                                    Finish
                                </button>
                            </div>
                        </div>
                    `;
                    this.startCardioTimer();
                    this.drawCardioMap();
                } else {
                    // IDLE UI - Complete rebuild with stats
                    const stats = this.calculateCardioStats();
                    
                    // Weekly summary
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    const thisWeekSessions = this.cardioSessions.filter(s => new Date(s.date) >= weekAgo);
                    const thisWeekKm = thisWeekSessions.reduce((sum, s) => sum + (s.distance || 0), 0) / 1000;
                    
                    el.innerHTML = `
                        <div class="content" style="padding-bottom: 100px;">
                            <div class="section-header">
                                <div class="section-title">Cardio</div>
                            </div>

                            ${this.cardioSessions.length === 0 ? `
                                <div style="padding: 0 20px;">
                                    <div class="cardio-type-selector">
                                        ${types.map(t => `
                                            <button class="cardio-type-btn ${this._cardioType === t ? 'active' : ''}" 
                                                onclick="app.setCardioType('${t}')">
                                                ${t === 'Run' ? 'â†‘ Run' : t === 'Cycle' ? 'â—Ž Cycle' : 'â†’ Walk'}
                                            </button>
                                        `).join('')}
                                    </div>

                                    <div class="cardio-map" style="margin-bottom: 16px;">
                                        <div class="cardio-map-placeholder">
                                            <div style="font-size:40px; opacity:0.2;">â—‰</div>
                                            <div>Route map will appear here</div>
                                            <div style="font-size:11px; opacity:0.6;">GPS tracking requires location permission</div>
                                        </div>
                                    </div>

                                    <button class="cardio-start-btn" onclick="app.startCardio()">
                                        Start ${this._cardioType}
                                    </button>

                                    <div class="empty-state" style="margin-top: 24px;">
                                        <div class="empty-icon">â—‰</div>
                                        <div class="empty-text">No cardio sessions yet<br>Start your first ${this._cardioType.toLowerCase()}!</div>
                                    </div>
                                </div>
                            ` : `
                                <!-- Week Summary -->
                                ${thisWeekSessions.length > 0 ? `
                                    <div style="padding: 0 20px; margin-bottom: 16px;">
                                        <div class="premium-stat-card" style="padding: 12px 16px; background: linear-gradient(135deg, var(--surface) 0%, var(--surface2) 100%);">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px;">This Week</div>
                                                    <div style="font-size: 24px; font-weight: 700; font-family: 'DM Mono', monospace;">${thisWeekKm.toFixed(1)}km</div>
                                                </div>
                                                <div style="text-align: right;">
                                                    <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px;">${thisWeekSessions.length} ${thisWeekSessions.length === 1 ? 'session' : 'sessions'}</div>
                                                    <div style="font-size: 16px; font-weight: 600; color: var(--accent);">ðŸ’ª</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}

                                <!-- Overall Stats -->
                                <div style="padding: 0 20px; margin-bottom: 16px;">
                                    <!-- Monthly Goal Progress -->
                                    ${(() => {
                                        const monthlyGoal = this.settings.monthlyCardioGoal || 50; // default 50km
                                        const thisMonth = new Date().getMonth();
                                        const thisYear = new Date().getFullYear();
                                        const monthSessions = this.cardioSessions.filter(s => {
                                            const d = new Date(s.date);
                                            return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
                                        });
                                        const monthKm = monthSessions.reduce((sum, s) => sum + (s.distance || 0), 0) / 1000;
                                        const pct = Math.min(100, (monthKm / monthlyGoal * 100));
                                        
                                        return `
                                            <div class="premium-stat-card" style="padding: 16px; margin-bottom: 16px;">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                                    <div style="font-size: 13px; font-weight: 600; color: var(--text-primary);">Monthly Goal</div>
                                                    <div style="font-size: 13px; font-weight: 700; font-family: 'DM Mono', monospace; color: ${pct >= 100 ? 'var(--success)' : 'var(--text-primary)'};">${monthKm.toFixed(1)}/${monthlyGoal}km</div>
                                                </div>
                                                <div style="height: 8px; background: var(--border); border-radius: 10px; overflow: hidden;">
                                                    <div style="height: 100%; width: ${pct}%; background: ${pct >= 100 ? 'var(--success)' : pct >= 75 ? 'var(--accent)' : 'var(--primary)'}; transition: width 0.3s;"></div>
                                                </div>
                                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 6px; text-align: center;">
                                                    ${pct >= 100 ? 'ðŸŽ‰ Goal reached!' : `${(monthlyGoal - monthKm).toFixed(1)}km to go`}
                                                </div>
                                            </div>
                                        `;
                                    })()}
                                    
                                    <div class="premium-stat-card" style="padding: 16px;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                            <div style="text-align: center;">
                                                <div style="font-size: 32px; font-weight: 700; font-family: 'DM Mono', monospace; color: var(--text-primary);">${stats.totalDistance.toFixed(1)}</div>
                                                <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; margin-top: 4px;">Total km</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 32px; font-weight: 700; font-family: 'DM Mono', monospace; color: var(--text-primary);">${stats.totalSessions}</div>
                                                <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; margin-top: 4px;">Sessions</div>
                                            </div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                                            <div style="text-align: center;">
                                                <div style="font-size: 18px; font-weight: 700; font-family: 'DM Mono', monospace;">${this.formatDuration(stats.totalTime)}</div>
                                                <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase;">Time</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 18px; font-weight: 700; font-family: 'DM Mono', monospace;">${this.formatPace(stats.avgPace)}</div>
                                                <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase;">Avg Pace</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 18px; font-weight: 700; font-family: 'DM Mono', monospace;">${stats.longestRun.toFixed(1)}km</div>
                                                <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase;">Longest</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Personal Bests -->
                                <div style="padding: 0 20px; margin-bottom: 16px;">
                                    <div class="premium-stat-card">
                                        <div class="premium-stat-header">Personal Bests</div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                            ${stats.pb5k ? `
                                                <div style="padding: 12px; background: var(--surface2); border-radius: 10px;">
                                                    <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px;">5K PB</div>
                                                    <div style="font-size: 24px; font-weight: 700; font-family: 'DM Mono', monospace;">${this.formatDuration(stats.pb5k)}</div>
                                                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">${this.formatPace(stats.pb5k / 5)} pace</div>
                                                </div>
                                            ` : '<div style="padding: 12px; background: var(--surface2); border-radius: 10px; opacity: 0.5; text-align: center;"><div style="font-size: 11px; color: var(--text-secondary);">5K PB</div><div style="font-size: 20px; opacity: 0.3;">â€”</div></div>'}
                                            ${stats.pb10k ? `
                                                <div style="padding: 12px; background: var(--surface2); border-radius: 10px;">
                                                    <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px;">10K PB</div>
                                                    <div style="font-size: 24px; font-weight: 700; font-family: 'DM Mono', monospace;">${this.formatDuration(stats.pb10k)}</div>
                                                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">${this.formatPace(stats.pb10k / 10)} pace</div>
                                                </div>
                                            ` : '<div style="padding: 12px; background: var(--surface2); border-radius: 10px; opacity: 0.5; text-align: center;"><div style="font-size: 11px; color: var(--text-secondary);">10K PB</div><div style="font-size: 20px; opacity: 0.3;">â€”</div></div>'}
                                        </div>
                                        <div style="padding: 12px; background: var(--surface2); border-radius: 10px; margin-top: 12px;">
                                            <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px;">Fastest Pace</div>
                                            <div style="font-size: 24px; font-weight: 700; font-family: 'DM Mono', monospace;">${this.formatPace(stats.fastestPace)}</div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">per km</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Start new session -->
                                <div style="padding: 0 20px; margin-bottom: 16px;">
                                    <div class="cardio-type-selector">
                                        ${types.map(t => `
                                            <button class="cardio-type-btn ${this._cardioType === t ? 'active' : ''}" 
                                                onclick="app.setCardioType('${t}')">
                                                ${t === 'Run' ? 'â†‘ Run' : t === 'Cycle' ? 'â—Ž Cycle' : 'â†’ Walk'}
                                            </button>
                                        `).join('')}
                                    </div>
                                    <button class="cardio-start-btn" onclick="app.startCardio()" style="margin-bottom: 8px;">
                                        Start ${this._cardioType}
                                    </button>
                                    <button class="btn btn-secondary" onclick="app.addManualCardio()" style="width: 100%;">
                                        + Add Manual Entry
                                    </button>
                                </div>

                                <!-- Recent Sessions -->
                                <div style="padding: 0 20px; margin-bottom: 80px;">
                                    <div class="premium-stat-card">
                                        <div class="premium-stat-header">Recent Sessions</div>
                                        ${this.cardioSessions.slice(-10).reverse().map((s, idx) => {
                                            const dist = (s.distance / 1000).toFixed(2);
                                            const pace = s.distance > 0 ? (s.duration / 60) / (s.distance / 1000) : 0;
                                            const paceStr = s.distance > 0 ? this.formatPace(pace) : '--';
                                            const mins = Math.floor(s.duration / 60);
                                            const secs = String(s.duration % 60).padStart(2, '0');
                                            
                                            // Pace zone (2: pace zones)
                                            let zoneColor = 'var(--success)'; // easy (>6:00/km)
                                            let zoneLabel = 'ðŸŸ¢ Easy';
                                            if (pace < 6 && pace >= 5) {
                                                zoneColor = 'var(--warning)';
                                                zoneLabel = 'ðŸŸ¡ Tempo';
                                            } else if (pace < 5) {
                                                zoneColor = 'var(--danger)';
                                                zoneLabel = 'ðŸ”´ Hard';
                                            }
                                            
                                            return `
                                                <div style="padding: 12px 0; border-bottom: 1px solid var(--border); cursor: pointer;" onclick="app.showCardioSession(${this.cardioSessions.length - 1 - idx})">
                                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                                        <div>
                                                            <div style="font-size:15px; font-weight:600;">${s.type} Â· ${s.date}</div>
                                                            <div style="font-size:11px; color: ${zoneColor}; margin-top: 2px;">${zoneLabel}</div>
                                                        </div>
                                                        <div style="font-size:12px; color:var(--text-secondary); font-family: 'DM Mono', monospace;">${mins}:${secs}</div>
                                                    </div>
                                                    <div style="display:flex; gap:16px;">
                                                        <div><div style="font-size:10px;color:var(--text-secondary);text-transform:uppercase;">Distance</div><div style="font-size:16px;font-weight:700;font-family:'DM Mono',monospace;">${dist} km</div></div>
                                                        <div><div style="font-size:10px;color:var(--text-secondary);text-transform:uppercase;">Pace</div><div style="font-size:16px;font-weight:700;font-family:'DM Mono',monospace;">${paceStr}</div></div>
                                                        ${s.splits?.length ? `<div><div style="font-size:10px;color:var(--text-secondary);text-transform:uppercase;">Splits</div><div style="font-size:16px;font-weight:700;font-family:'DM Mono',monospace;">${s.splits.length}</div></div>` : ''}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `}
                        </div>
                    `;
                }
            },

            editSessionNotes(sessionId, event) {
                event?.stopPropagation();
                
                const session = this.workoutSessions.find(s => s.id == sessionId);
                if (!session) return;
                
                const currentNote = session.notes || '';
                const newNote = prompt('Add a note about this workout:', currentNote);
                
                if (newNote !== null) {
                    session.notes = newNote.trim();
                    this.saveWorkoutSessions();
                    this.renderHistory();
                }
            },

            duplicateLastWorkout() {
                const lastSession = this.workoutSessions[this.workoutSessions.length - 1];
                if (!lastSession) {
                    alert('No previous workouts found');
                    return;
                }
                
                // Start new session with same exercises
                this.currentSession = {
                    id: Date.now(),
                    exercises: lastSession.exercises.map(ex => ({
                        name: ex.name,
                        sets: [{ weight: '', reps: '', rpe: '' }]
                    })),
                    startTime: new Date().toISOString()
                };
                this.sessionStartTime = Date.now();
                
                this.switchTab('workout');
                this.renderActiveWorkout();
                this.showNotification('âœ… Repeating last workout!');
            },

            showCardioSession(index) {
                const session = this.cardioSessions[index];
                if (!session) return;
                
                const dist = (session.distance / 1000).toFixed(2);
                const pace = session.distance > 0 ? this.formatPace((session.duration / 60) / (session.distance / 1000)) : '--';
                const mins = Math.floor(session.duration / 60);
                const secs = String(session.duration % 60).padStart(2, '0');
                
                document.body.insertAdjacentHTML('beforeend', `
                    <div class="modal active" id="cardioSessionModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">${session.type} - ${session.date}</h2>
                                <button class="close-btn" onclick="document.getElementById('cardioSessionModal').remove()">Ã—</button>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div style="text-align: center; padding: 12px; background: var(--surface2); border-radius: 10px;">
                                    <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 4px;">Distance</div>
                                    <div style="font-size: 24px; font-weight: 700; font-family: 'DM Mono', monospace;">${dist}km</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: var(--surface2); border-radius: 10px;">
                                    <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 4px;">Time</div>
                                    <div style="font-size: 24px; font-weight: 700; font-family: 'DM Mono', monospace;">${mins}:${secs}</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: var(--surface2); border-radius: 10px;">
                                    <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 4px;">Pace</div>
                                    <div style="font-size: 24px; font-weight: 700; font-family: 'DM Mono', monospace;">${pace}</div>
                                </div>
                            </div>
                            
                            ${session.route && session.route.length > 0 ? `
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">Route Map</div>
                                    <div style="width: 100%; height: 300px; background: var(--surface2); border-radius: 12px; position: relative;" id="sessionMapContainer">
                                        <canvas id="sessionMapCanvas" style="width: 100%; height: 100%; border-radius: 12px;"></canvas>
                                    </div>
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 40px; background: var(--surface2); border-radius: 12px;">
                                    <div style="font-size: 32px; opacity: 0.3; margin-bottom: 8px;">â—‰</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">No route data recorded</div>
                                </div>
                            `}
                            
                            ${session.splits && session.splits.length > 0 ? `
                                <div style="margin-top: 16px;">
                                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">Splits</div>
                                    ${session.splits.map((s, i) => `
                                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                                            <span style="font-weight: 600;">Km ${i + 1}</span>
                                            <span style="font-family: 'DM Mono', monospace;">${this.formatPace(s.pace)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <button class="btn btn-secondary" onclick="document.getElementById('cardioSessionModal').remove()" style="margin-top: 16px; width: 100%;">Close</button>
                        </div>
                    </div>
                `);
                
                // Draw route if available
                if (session.route && session.route.length > 0) {
                    setTimeout(() => this.drawSessionMap(session.route), 100);
                }
            },

            drawSessionMap(route) {
                const canvas = document.getElementById('sessionMapCanvas');
                if (!canvas || !route || route.length === 0) return;
                
                const ctx = canvas.getContext('2d');
                const container = canvas.parentElement;
                canvas.width = container.offsetWidth;
                canvas.height = container.offsetHeight;
                
                // Calculate bounds
                const lats = route.map(p => p.lat);
                const lngs = route.map(p => p.lng);
                const minLat = Math.min(...lats);
                const maxLat = Math.max(...lats);
                const minLng = Math.min(...lngs);
                const maxLng = Math.max(...lngs);
                
                const latRange = maxLat - minLat || 0.001;
                const lngRange = maxLng - minLng || 0.001;
                
                // Draw route
                ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent');
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                ctx.beginPath();
                route.forEach((point, i) => {
                    const x = ((point.lng - minLng) / lngRange) * (canvas.width - 40) + 20;
                    const y = canvas.height - (((point.lat - minLat) / latRange) * (canvas.height - 40) + 20);
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
                
                // Start marker
                const startX = ((route[0].lng - minLng) / lngRange) * (canvas.width - 40) + 20;
                const startY = canvas.height - (((route[0].lat - minLat) / latRange) * (canvas.height - 40) + 20);
                ctx.fillStyle = '#4ade80';
                ctx.beginPath();
                ctx.arc(startX, startY, 6, 0, Math.PI * 2);
                ctx.fill();
                
                // End marker
                const endX = ((route[route.length - 1].lng - minLng) / lngRange) * (canvas.width - 40) + 20;
                const endY = canvas.height - (((route[route.length - 1].lat - minLat) / latRange) * (canvas.height - 40) + 20);
                ctx.fillStyle = '#ef4444';
                ctx.beginPath();
                ctx.arc(endX, endY, 6, 0, Math.PI * 2);
                ctx.fill();
            },

            calculateCardioStats() {
                const sessions = this.cardioSessions;
                
                const totalDistance = sessions.reduce((sum, s) => sum + (s.distance || 0), 0) / 1000; // in km
                const totalTime = sessions.reduce((sum, s) => sum + (s.duration || 0), 0); // in seconds
                const totalSessions = sessions.length;
                
                // Average pace (min/km)
                const avgPace = totalDistance > 0 ? (totalTime / 60) / totalDistance : 0;
                
                // Longest run
                const longestRun = Math.max(...sessions.map(s => (s.distance || 0) / 1000), 0);
                
                // Fastest pace ever (min/km)
                const paces = sessions.map(s => {
                    if (!s.distance || !s.duration) return Infinity;
                    return (s.duration / 60) / (s.distance / 1000);
                }).filter(p => p < Infinity);
                const fastestPace = paces.length > 0 ? Math.min(...paces) : 0;
                
                // Personal bests for standard distances
                const pb5k = sessions
                    .filter(s => (s.distance / 1000) >= 4.8 && (s.distance / 1000) <= 5.2)
                    .map(s => s.duration)
                    .sort((a, b) => a - b)[0] || null;
                    
                const pb10k = sessions
                    .filter(s => (s.distance / 1000) >= 9.8 && (s.distance / 1000) <= 10.2)
                    .map(s => s.duration)
                    .sort((a, b) => a - b)[0] || null;
                
                return {
                    totalDistance,
                    totalTime,
                    totalSessions,
                    avgPace,
                    longestRun,
                    fastestPace,
                    pb5k,
                    pb10k
                };
            },


            setCardioType(type) {
                this._cardioType = type;
                this.renderCardio();
            },

            startCardio() {
                if (!navigator.geolocation) {
                    this.showNotification('GPS not available on this device');
                    return;
                }
                this._cardioActive = true;
                this._cardioStart = Date.now();
                this._cardioCoords = [];
                this._cardioDistance = 0;
                this._cardioPausedMs = 0;
                this._cardioPauseStart = null;
                this._cardioSplits = [];
                this._cardioLastSplitDist = 0;

                this.renderCardio();

                this._cardioWatchId = navigator.geolocation.watchPosition(
                    pos => this.onCardioPosition(pos),
                    err => console.warn('GPS error:', err),
                    { enableHighAccuracy: true, maximumAge: 2000, timeout: 10000 }
                );
            },

            onCardioPosition(pos) {
                if (this._cardioPauseStart) return; // paused

                const { latitude, longitude, accuracy } = pos.coords;
                if (accuracy > 50) return; // ignore poor accuracy

                const pt = { lat: latitude, lng: longitude, t: Date.now() };

                if (this._cardioCoords.length > 0) {
                    const last = this._cardioCoords[this._cardioCoords.length - 1];
                    const d = this.haversineDistance(last.lat, last.lng, latitude, longitude);
                    if (d < 3) return; // filter jitter < 3m
                    this._cardioDistance += d;

                    // Log 1km splits
                    const kmDone = Math.floor(this._cardioDistance / 1000);
                    const kmLast = Math.floor(this._cardioLastSplitDist / 1000);
                    if (kmDone > kmLast) {
                        const elapsed = this.getCardioElapsed();
                        const splitPace = (elapsed / 60) / (this._cardioDistance / 1000) -
                            (this._cardioSplits.reduce((s, x) => s + x.pace, 0));
                        this._cardioSplits.push({ km: kmDone, pace: Math.max(0.5, splitPace) });
                        this._cardioLastSplitDist = this._cardioDistance;
                    }
                }

                this._cardioCoords.push(pt);
                this.updateCardioLiveStats();
                this.drawCardioMap();
            },

            updateCardioLiveStats() {
                const elapsed = this.getCardioElapsed();
                const mins = Math.floor(elapsed / 60);
                const secs = String(elapsed % 60).padStart(2, '0');
                const dist = (this._cardioDistance / 1000).toFixed(2);
                const pace = this._cardioDistance > 50
                    ? this.formatPace((elapsed / 60) / (this._cardioDistance / 1000))
                    : '--:--';

                const t = document.getElementById('liveTimer');
                const d = document.getElementById('liveDist');
                const p = document.getElementById('livePace');
                if (t) t.textContent = `${mins}:${secs}`;
                if (d) d.textContent = dist;
                if (p) p.textContent = pace;
            },

            startCardioTimer() {
                clearInterval(this._cardioTimerInterval);
                this._cardioTimerInterval = setInterval(() => {
                    if (this._cardioActive && !this._cardioPauseStart) {
                        this.updateCardioLiveStats();
                    }
                }, 1000);
            },

            getCardioElapsed() {
                if (!this._cardioStart) return 0;
                const now = Date.now();
                const paused = this._cardioPauseStart ? (now - this._cardioPauseStart) : 0;
                return Math.floor((now - this._cardioStart - this._cardioPausedMs - paused) / 1000);
            },

            toggleCardioPause() {
                if (this._cardioPauseStart) {
                    // Resume
                    this._cardioPausedMs += Date.now() - this._cardioPauseStart;
                    this._cardioPauseStart = null;
                } else {
                    // Pause
                    this._cardioPauseStart = Date.now();
                }
                this.renderCardio();
            },

            stopCardio() {
                if (!confirm('Finish this session?')) return;

                clearInterval(this._cardioTimerInterval);
                if (this._cardioWatchId !== null) {
                    navigator.geolocation.clearWatch(this._cardioWatchId);
                    this._cardioWatchId = null;
                }

                const duration = this.getCardioElapsed();
                const session = {
                    id: Date.now().toString(),
                    date: new Date().toISOString().split('T')[0],
                    type: this._cardioType,
                    distance: Math.round(this._cardioDistance),
                    duration,
                    coords: this._cardioCoords.map(c => [c.lat, c.lng]),
                    splits: this._cardioSplits,
                };

                this.cardioSessions.push(session);
                localStorage.setItem('cardioSessions', JSON.stringify(this.cardioSessions));

                this._cardioActive = false;
                this._cardioCoords = [];
                this._cardioDistance = 0;
                localStorage.removeItem('appState'); // Clear saved state

                this.renderCardio();
                this.showNotification(`${session.type} saved â€” ${(session.distance/1000).toFixed(2)} km`);
            },

            drawCardioMap() {
                const canvas = document.getElementById('cardioMapCanvas');
                if (!canvas || this._cardioCoords.length < 2) return;

                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                const ctx = canvas.getContext('2d');
                const pts = this._cardioCoords;

                // Find bounds
                const lats = pts.map(p => p.lat);
                const lngs = pts.map(p => p.lng);
                const minLat = Math.min(...lats), maxLat = Math.max(...lats);
                const minLng = Math.min(...lngs), maxLng = Math.max(...lngs);

                const pad = 24;
                const w = canvas.width - pad * 2;
                const h = canvas.height - pad * 2;

                const toX = lng => pad + ((lng - minLng) / (maxLng - minLng || 0.0001)) * w;
                const toY = lat => pad + (1 - (lat - minLat) / (maxLat - minLat || 0.0001)) * h;

                // Dark background
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                ctx.fillStyle = isDark ? '#1A1A18' : '#F0F0ED';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Draw route
                ctx.beginPath();
                ctx.moveTo(toX(pts[0].lng), toY(pts[0].lat));
                for (let i = 1; i < pts.length; i++) {
                    ctx.lineTo(toX(pts[i].lng), toY(pts[i].lat));
                }
                ctx.strokeStyle = isDark ? '#F7F7F5' : '#141414';
                ctx.lineWidth = 3;
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                ctx.stroke();

                // Start dot (green)
                ctx.beginPath();
                ctx.arc(toX(pts[0].lng), toY(pts[0].lat), 6, 0, Math.PI * 2);
                ctx.fillStyle = '#22c55e';
                ctx.fill();

                // Current position (accent)
                const last = pts[pts.length - 1];
                ctx.beginPath();
                ctx.arc(toX(last.lng), toY(last.lat), 7, 0, Math.PI * 2);
                ctx.fillStyle = isDark ? '#F7F7F5' : '#141414';
                ctx.fill();
                ctx.beginPath();
                ctx.arc(toX(last.lng), toY(last.lat), 4, 0, Math.PI * 2);
                ctx.fillStyle = '#C8F55A';
                ctx.fill();

                // Hide placeholder
                const ph = document.getElementById('cardioMapPlaceholder');
                if (ph) ph.style.display = 'none';
            },

            haversineDistance(lat1, lng1, lat2, lng2) {
                const R = 6371000;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2)**2 +
                    Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLng/2)**2;
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            },

            saveAppState() {
                // Save critical state that needs to survive backgrounding
                const state = {
                    cardioActive: this._cardioActive,
                    cardioType: this._cardioType,
                    cardioStart: this._cardioStart,
                    cardioCoords: this._cardioCoords,
                    cardioDistance: this._cardioDistance,
                    cardioPausedMs: this._cardioPausedMs,
                    cardioPauseStart: this._cardioPauseStart,
                    cardioSplits: this._cardioSplits,
                    cardioLastSplitDist: this._cardioLastSplitDist,
                };
                localStorage.setItem('appState', JSON.stringify(state));
            },

            restoreCardioState() {
                const saved = localStorage.getItem('appState');
                if (!saved) return;

                try {
                    const state = JSON.parse(saved);
                    
                    if (state.cardioActive && state.cardioStart) {
                        // Restore active cardio session
                        this._cardioActive = state.cardioActive;
                        this._cardioType = state.cardioType;
                        this._cardioStart = state.cardioStart;
                        this._cardioCoords = state.cardioCoords || [];
                        this._cardioDistance = state.cardioDistance || 0;
                        this._cardioPausedMs = state.cardioPausedMs || 0;
                        this._cardioPauseStart = state.cardioPauseStart;
                        this._cardioSplits = state.cardioSplits || [];
                        this._cardioLastSplitDist = state.cardioLastSplitDist || 0;

                        // Resume GPS tracking
                        if (navigator.geolocation) {
                            this._cardioWatchId = navigator.geolocation.watchPosition(
                                pos => this.onCardioPosition(pos),
                                err => console.warn('GPS error:', err),
                                { enableHighAccuracy: true, maximumAge: 2000, timeout: 10000 }
                            );
                        }

                        // Switch to cardio tab to show restored session
                        this.switchTab('cardio');
                        this.showNotification('Cardio session restored');
                    }
                } catch (e) {
                    console.error('Failed to restore state:', e);
                }
            },

            formatPace(minPerKm) {
                if (!minPerKm || !isFinite(minPerKm) || minPerKm > 60) return '--:--';
                const m = Math.floor(minPerKm);
                const s = String(Math.round((minPerKm - m) * 60)).padStart(2, '0');
                return `${m}:${s}`;
            },

            generateTestCardio() {
                // Generate 10 test cardio sessions with realistic data
                const testSessions = [
                    { type: 'Run', date: '2024-02-10', distance: 3200, duration: 18 * 60 + 30, splits: [] }, // 3.2km easy
                    { type: 'Run', date: '2024-02-12', distance: 5100, duration: 28 * 60 + 45, splits: [] }, // 5K PB attempt
                    { type: 'Run', date: '2024-02-14', distance: 4500, duration: 24 * 60 + 20, splits: [] }, // 4.5km tempo
                    { type: 'Walk', date: '2024-02-15', distance: 2800, duration: 35 * 60, splits: [] }, // recovery walk
                    { type: 'Run', date: '2024-02-17', distance: 7200, duration: 42 * 60 + 10, splits: [] }, // long run
                    { type: 'Run', date: '2024-02-19', distance: 5000, duration: 26 * 60 + 15, splits: [] }, // 5K
                    { type: 'Cycle', date: '2024-02-20', distance: 15000, duration: 45 * 60, splits: [] }, // bike ride
                    { type: 'Run', date: '2024-02-22', distance: 10200, duration: 58 * 60 + 30, splits: [] }, // 10K PB
                    { type: 'Run', date: '2024-02-24', distance: 3800, duration: 20 * 60, splits: [] }, // easy 3.8K
                    { type: 'Run', date: '2024-02-26', distance: 6000, duration: 34 * 60, splits: [] }, // 6K steady
                ];
                
                this.cardioSessions = [...this.cardioSessions, ...testSessions];
                this.saveCardioSessions();
                this.renderCardio();
                this.showNotification('âœ… Generated 10 test cardio sessions!');
            },

            showSection(section) {
                if (section === 'achievements') {
                    document.body.insertAdjacentHTML('beforeend', `
                        <div class="modal active" id="achievementsModal" style="display: flex;">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h2 class="modal-title">Achievements</h2>
                                    <button class="close-btn" onclick="document.getElementById('achievementsModal').remove()">Ã—</button>
                                </div>
                                ${this.renderAchievementsPage()}
                            </div>
                        </div>
                    `);
                    return;
                }
                if (section === 'metrics') {
                    this.switchTab('metrics');
                } else if (section === 'goals') {
                    this.showGoals();
                } else if (section === 'achievements') {
                    this.showAchievements();
                } else if (section === 'settings') {
                    this.showSettings();
                }
            },

            showSettings() {
                const isDark = this.theme === 'dark';
                const html = `
                    <div class="metric-input-group">
                        <label class="metric-label">Appearance</label>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: var(--surface2); border-radius: 12px; border: 1px solid var(--border);">
                            <div>
                                <div style="font-size: 15px; font-weight: 500; color: var(--text-primary);">Dark Mode</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">Easy on the eyes at night</div>
                            </div>
                            <div onclick="app.toggleTheme()" style="width: 48px; height: 28px; background: ${isDark ? 'var(--accent)' : 'var(--border)'}; border-radius: 100px; position: relative; cursor: pointer; transition: background 0.2s;">
                                <div style="position: absolute; top: 3px; left: ${isDark ? '23px' : '3px'}; width: 22px; height: 22px; background: ${isDark ? '#141414' : 'white'}; border-radius: 50%; transition: left 0.2s; box-shadow: 0 1px 4px rgba(0,0,0,0.2);"></div>
                            </div>
                        </div>
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">Rest Timer Duration</label>
                        <select id="restDuration" class="metric-input" onchange="app.updateSetting('restTimerDuration', parseInt(this.value))">
                            <option value="60" ${this.settings.restTimerDuration === 60 ? 'selected' : ''}>60 seconds</option>
                            <option value="90" ${this.settings.restTimerDuration === 90 ? 'selected' : ''}>90 seconds</option>
                            <option value="120" ${this.settings.restTimerDuration === 120 ? 'selected' : ''}>2 minutes</option>
                            <option value="180" ${this.settings.restTimerDuration === 180 ? 'selected' : ''}>3 minutes</option>
                            <option value="240" ${this.settings.restTimerDuration === 240 ? 'selected' : ''}>4 minutes</option>
                        </select>
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">Weight Increment</label>
                        <select id="weightInc" class="metric-input" onchange="app.updateSetting('weightIncrement', parseFloat(this.value))">
                            <option value="1.25" ${this.settings.weightIncrement === 1.25 ? 'selected' : ''}>1.25 kg</option>
                            <option value="2.5" ${this.settings.weightIncrement === 2.5 ? 'selected' : ''}>2.5 kg</option>
                            <option value="5" ${this.settings.weightIncrement === 5 ? 'selected' : ''}>5 kg</option>
                            <option value="10" ${this.settings.weightIncrement === 10 ? 'selected' : ''}>10 kg</option>
                        </select>
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">Units</label>
                        <select id="units" class="metric-input" onchange="app.updateSetting('units', this.value)">
                            <option value="kg" ${this.settings.units === 'kg' ? 'selected' : ''}>Kilograms (kg)</option>
                            <option value="lbs" ${this.settings.units === 'lbs' ? 'selected' : ''}>Pounds (lbs)</option>
                        </select>
                    </div>

                    <button class="btn btn-danger" onclick="app.clearAllData()" style="margin-top: 20px;">
                        Clear All Data
                    </button>
                `;

                document.body.insertAdjacentHTML('beforeend', `
                    <div class="modal active" id="settingsModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">Settings</h2>
                                <button class="close-btn" onclick="document.getElementById('settingsModal').remove()">Ã—</button>
                            </div>
                            ${html}
                        </div>
                    </div>
                `);
            },

            async updateSetting(key, value) {
                this.settings[key] = value;
                await this.saveSettings();
            },

            async clearAllData() {
                if (!confirm('Are you sure? This will delete ALL your data permanently!')) return;
                if (!confirm('Last chance! This cannot be undone. Delete everything?')) return;

                this.workouts = [];
                this.templates = [];
                this.bodyMetrics = [];
                this.progressPhotos = [];
                this.personalRecords = {};
                this.goals = [];
                this.achievements = [];
                this.workoutNotes = {};

                await this.saveWorkouts();
                await this.saveTemplates();
                await this.saveBodyMetrics();
                await this.saveProgressPhotos();
                await this.savePersonalRecords();
                await this.saveGoals();
                await this.saveAchievements();
                await this.saveWorkoutNotes();

                alert('All data cleared!');
                location.reload();
            },

            // Goals
            showGoals() {
                let html = `
                    <button class="btn btn-primary" onclick="app.showAddGoal()" style="margin-bottom: 16px;">+ Add New Goal</button>
                `;

                if (this.goals.length === 0) {
                    html += `
                        <div class="empty-state">
                            <div class="empty-icon">ðŸŽ¯</div>
                            <div class="empty-text">No goals set yet<br>Set a goal to stay motivated!</div>
                        </div>
                    `;
                } else {
                    html += this.goals.map((goal, i) => {
                        const progress = this.calculateGoalProgress(goal);
                        return `
                            <div class="card">
                                <div class="card-title">${goal.type === 'strength' ? 'ðŸ’ª' : 'âš–ï¸'} ${goal.title}</div>
                                <div class="card-subtitle" style="margin-bottom: 12px;">
                                    ${goal.type === 'strength' ? goal.exercise : 'Body Weight'} â€¢ Target: ${goal.target}${goal.type === 'strength' ? 'kg' : 'kg'}
                                </div>
                                <div style="background: var(--background); height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 8px;">
                                    <div style="background: var(--accent); color: #141414; height: 100%; width: ${Math.min(progress, 100)}%; transition: width 0.3s;"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                    <span>${goal.current || 0}${goal.type === 'strength' ? 'kg' : 'kg'} / ${goal.target}${goal.type === 'strength' ? 'kg' : 'kg'}</span>
                                    <span style="color: var(--primary); font-weight: 600;">${Math.round(progress)}%</span>
                                </div>
                                ${progress >= 100 ? '<div style="margin-top: 8px; color: var(--success); font-weight: 600;">ðŸŽ‰ Goal Achieved!</div>' : ''}
                                <button class="btn btn-danger" style="margin-top: 12px;" onclick="app.deleteGoal(${i})">Delete Goal</button>
                            </div>
                        `;
                    }).join('');
                }

                const modalContent = `
                    <div class="modal active" id="goalsModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">My Goals</h2>
                                <button class="close-btn" onclick="document.getElementById('goalsModal').remove()">Ã—</button>
                            </div>
                            ${html}
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalContent);
            },

            showAddGoal() {
                const html = `
                    <div class="metric-input-group">
                        <label class="metric-label">Goal Type</label>
                        <select id="goalType" class="metric-input" onchange="app.toggleGoalFields()">
                            <option value="strength">Strength Goal (e.g., Squat 140kg)</option>
                            <option value="bodyweight">Body Weight Goal</option>
                        </select>
                    </div>

                    <div id="strengthFields">
                        <div class="metric-input-group">
                            <label class="metric-label">Exercise</label>
                            <select id="goalExercise" class="metric-input">
                                ${this.exercises.map(ex => `<option value="${ex.name}">${ex.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">Target Weight (kg)</label>
                        <input type="number" id="goalTarget" class="metric-input" placeholder="140">
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">Goal Title</label>
                        <input type="text" id="goalTitle" class="metric-input" placeholder="e.g., Squat 140kg by June">
                    </div>

                    <button class="btn btn-primary" onclick="app.saveGoal()">ðŸ’¾ Save Goal</button>
                `;

                const modalContent = `
                    <div class="modal active" id="addGoalModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">Add New Goal</h2>
                                <button class="close-btn" onclick="document.getElementById('addGoalModal').remove()">Ã—</button>
                            </div>
                            ${html}
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalContent);
            },

            toggleGoalFields() {
                const type = document.getElementById('goalType').value;
                const strengthFields = document.getElementById('strengthFields');
                if (strengthFields) {
                    strengthFields.style.display = type === 'strength' ? 'block' : 'none';
                }
            },

            async saveGoal() {
                const type = document.getElementById('goalType').value;
                const target = parseFloat(document.getElementById('goalTarget').value);
                const title = document.getElementById('goalTitle').value;

                if (!target || !title) {
                    alert('Please fill in all fields');
                    return;
                }

                const goal = {
                    id: Date.now().toString(),
                    type: type,
                    title: title,
                    target: target,
                    current: 0,
                    createdAt: new Date().toISOString()
                };

                if (type === 'strength') {
                    goal.exercise = document.getElementById('goalExercise').value;
                    // Set current from best performance
                    const best = this.getBestPerformance(goal.exercise);
                    goal.current = best;
                }

                this.goals.push(goal);
                await this.saveGoals();

                document.getElementById('addGoalModal').remove();
                document.getElementById('goalsModal').remove();
                this.showGoals();
            },

            getBestPerformance(exercise) {
                const exerciseWorkouts = this.workouts.filter(w => w.exercise === exercise);
                if (exerciseWorkouts.length === 0) return 0;

                let maxWeight = 0;
                exerciseWorkouts.forEach(w => {
                    w.sets.forEach(s => {
                        if (s.weight > maxWeight) maxWeight = s.weight;
                    });
                });

                return maxWeight;
            },

            calculateGoalProgress(goal) {
                if (goal.type === 'strength') {
                    const current = this.getBestPerformance(goal.exercise);
                    goal.current = current;
                    return (current / goal.target) * 100;
                } else {
                    const latestWeight = this.bodyMetrics.length > 0 ? this.bodyMetrics[this.bodyMetrics.length - 1].weight : 0;
                    goal.current = latestWeight;
                    return (latestWeight / goal.target) * 100;
                }
            },

            async deleteGoal(index) {
                if (!confirm('Delete this goal?')) return;
                this.goals.splice(index, 1);
                await this.saveGoals();
                document.getElementById('goalsModal').remove();
                this.showGoals();
            },

            // Achievements
            showAchievements() {
                this.checkAchievements(); // Update achievements

                const allAchievements = [
                    { id: 'first_workout', icon: 'ðŸŽ¯', title: 'First Workout', description: 'Complete your first workout' },
                    { id: '10_workouts', icon: 'ðŸ’ª', title: '10 Workouts', description: 'Complete 10 workouts' },
                    { id: '50_workouts', icon: 'ðŸ”¥', title: '50 Workouts', description: 'Complete 50 workouts' },
                    { id: '100_workouts', icon: 'ðŸ†', title: 'Century Club', description: 'Complete 100 workouts' },
                    { id: '7_day_streak', icon: 'âš¡', title: '7 Day Streak', description: 'Workout 7 days in a row' },
                    { id: '30_day_streak', icon: 'ðŸŒŸ', title: '30 Day Streak', description: 'Workout 30 days in a row' },
                    { id: 'first_pr', icon: 'ðŸ¥‡', title: 'First PR', description: 'Set your first personal record' },
                    { id: '10_prs', icon: 'ðŸŽ–ï¸', title: 'PR Machine', description: 'Set 10 personal records' },
                    { id: '1000kg_volume', icon: 'ðŸ’Ž', title: '1000kg Volume', description: 'Complete 1000kg volume in one workout' },
                    { id: 'first_photo', icon: 'ðŸ“¸', title: 'Progress Tracker', description: 'Take your first progress photo' },
                    { id: 'goal_achieved', icon: 'ðŸŽ‰', title: 'Goal Crusher', description: 'Achieve your first goal' },
                    { id: '100kg_squat', icon: 'ðŸ‹ï¸', title: '100kg Squat', description: 'Squat 100kg or more' },
                    { id: '100kg_bench', icon: 'ðŸ’ª', title: '100kg Bench', description: 'Bench press 100kg or more' },
                    { id: '140kg_deadlift', icon: 'âš¡', title: '140kg Deadlift', description: 'Deadlift 140kg or more' }
                ];

                const unlockedIds = this.achievements.map(a => a.id);

                const html = `
                    <div style="margin-bottom: 20px;">
                        <div style="text-align: center; font-size: 48px; margin-bottom: 12px;">ðŸ†</div>
                        <div style="text-align: center; font-size: 24px; font-weight: 700; margin-bottom: 4px;">
                            ${unlockedIds.length} / ${allAchievements.length}
                        </div>
                        <div style="text-align: center; color: var(--text-secondary);">Achievements Unlocked</div>
                    </div>

                    ${allAchievements.map(ach => {
                        const unlocked = unlockedIds.includes(ach.id);
                        const achievement = this.achievements.find(a => a.id === ach.id);
                        return `
                            <div class="card" style="opacity: ${unlocked ? '1' : '0.5'};">
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div style="font-size: 48px;">${unlocked ? ach.icon : 'ðŸ”’'}</div>
                                    <div style="flex: 1;">
                                        <div class="card-title">${ach.title}</div>
                                        <div class="card-subtitle">${ach.description}</div>
                                        ${unlocked && achievement ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Unlocked: ${new Date(achievement.unlockedAt).toISOString().split('T')[0]}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;

                const modalContent = `
                    <div class="modal active" id="achievementsModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">Achievements</h2>
                                <button class="close-btn" onclick="document.getElementById('achievementsModal').remove()">Ã—</button>
                            </div>
                            ${html}
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalContent);
            },

            checkAchievements() {
                const totalWorkouts = [...new Set(this.workouts.map(w => w.date))].length;
                const streak = this.calculateStreak();
                const prCount = Object.keys(this.personalRecords).length;

                const newAchievements = [];

                // Workout milestones
                if (totalWorkouts >= 1 && !this.hasAchievement('first_workout')) {
                    newAchievements.push({ id: 'first_workout', unlockedAt: new Date().toISOString() });
                }
                if (totalWorkouts >= 10 && !this.hasAchievement('10_workouts')) {
                    newAchievements.push({ id: '10_workouts', unlockedAt: new Date().toISOString() });
                }
                if (totalWorkouts >= 50 && !this.hasAchievement('50_workouts')) {
                    newAchievements.push({ id: '50_workouts', unlockedAt: new Date().toISOString() });
                }
                if (totalWorkouts >= 100 && !this.hasAchievement('100_workouts')) {
                    newAchievements.push({ id: '100_workouts', unlockedAt: new Date().toISOString() });
                }

                // Streak achievements
                if (streak >= 7 && !this.hasAchievement('7_day_streak')) {
                    newAchievements.push({ id: '7_day_streak', unlockedAt: new Date().toISOString() });
                }
                if (streak >= 30 && !this.hasAchievement('30_day_streak')) {
                    newAchievements.push({ id: '30_day_streak', unlockedAt: new Date().toISOString() });
                }

                // PR achievements
                if (prCount >= 1 && !this.hasAchievement('first_pr')) {
                    newAchievements.push({ id: 'first_pr', unlockedAt: new Date().toISOString() });
                }
                if (prCount >= 10 && !this.hasAchievement('10_prs')) {
                    newAchievements.push({ id: '10_prs', unlockedAt: new Date().toISOString() });
                }

                // Photo achievement
                if (this.progressPhotos.length >= 1 && !this.hasAchievement('first_photo')) {
                    newAchievements.push({ id: 'first_photo', unlockedAt: new Date().toISOString() });
                }

                // Weight achievements
                if (this.personalRecords['Barbell Squat'] >= 100 && !this.hasAchievement('100kg_squat')) {
                    newAchievements.push({ id: '100kg_squat', unlockedAt: new Date().toISOString() });
                }
                if (this.personalRecords['Barbell Bench Press'] >= 100 && !this.hasAchievement('100kg_bench')) {
                    newAchievements.push({ id: '100kg_bench', unlockedAt: new Date().toISOString() });
                }
                if (this.personalRecords['Deadlift'] >= 140 && !this.hasAchievement('140kg_deadlift')) {
                    newAchievements.push({ id: '140kg_deadlift', unlockedAt: new Date().toISOString() });
                }

                if (newAchievements.length > 0) {
                    this.achievements.push(...newAchievements);
                    this.saveAchievements();
                    this.showAchievementNotification(newAchievements[0]);
                }
            },

            hasAchievement(id) {
                return this.achievements.some(a => a.id === id);
            },

            showAchievementNotification(achievement) {
                const achievementData = {
                    'first_workout': { icon: 'ðŸŽ¯', title: 'First Workout' },
                    '10_workouts': { icon: 'ðŸ’ª', title: '10 Workouts' },
                    '50_workouts': { icon: 'ðŸ”¥', title: '50 Workouts' },
                    '100_workouts': { icon: 'ðŸ†', title: 'Century Club' },
                    '7_day_streak': { icon: 'âš¡', title: '7 Day Streak' },
                    '30_day_streak': { icon: 'ðŸŒŸ', title: '30 Day Streak' },
                    'first_pr': { icon: 'ðŸ¥‡', title: 'First PR' },
                    '10_prs': { icon: 'ðŸŽ–ï¸', title: 'PR Machine' },
                    'first_photo': { icon: 'ðŸ“¸', title: 'Progress Tracker' },
                    '100kg_squat': { icon: 'ðŸ‹ï¸', title: '100kg Squat' },
                    '100kg_bench': { icon: 'ðŸ’ª', title: '100kg Bench' },
                    '140kg_deadlift': { icon: 'âš¡', title: '140kg Deadlift' }
                };

                const data = achievementData[achievement.id];
                if (!data) return;

                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--text-primary);
                    color: white;
                    padding: 20px 24px;
                    border-radius: 16px;
                    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
                    z-index: 10000;
                    max-width: 300px;
                    text-align: center;
                    animation: slideDown 0.5s ease;
                `;

                notification.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 8px;">${data.icon}</div>
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">Achievement Unlocked!</div>
                    <div style="font-size: 16px;">${data.title}</div>
                `;

                document.body.appendChild(notification);

                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200, 100, 200]);
                }

                setTimeout(() => {
                    notification.style.animation = 'slideUp 0.5s ease';
                    setTimeout(() => notification.remove(), 500);
                }, 3000);
            },

            // Search Functionality
            showSearch() {
                document.getElementById('searchModal').classList.add('active');
                document.getElementById('globalSearch').focus();
                this.performSearch();
            },

            closeSearch() {
                document.getElementById('searchModal').classList.remove('active');
            },

            performSearch() {
                const query = document.getElementById('globalSearch').value.toLowerCase();
                
                if (!query) {
                    document.getElementById('searchResults').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ðŸ”</div>
                            <div class="empty-text">Start typing to search your workouts</div>
                        </div>
                    `;
                    return;
                }
                
                // Search through workouts
                const results = this.workouts.filter(w => {
                    const exerciseMatch = w.exercise.toLowerCase().includes(query);
                    const dateMatch = w.date.includes(query);
                    const notesMatch = this.workoutNotes[w.id]?.toLowerCase().includes(query);
                    return exerciseMatch || dateMatch || notesMatch;
                }).sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (results.length === 0) {
                    document.getElementById('searchResults').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ðŸ˜•</div>
                            <div class="empty-text">No results for "${query}"</div>
                        </div>
                    `;
                    return;
                }
                
                const html = `
                    <div style="margin-bottom: 12px; color: var(--text-secondary); font-size: 14px;">
                        ${results.length} result${results.length !== 1 ? 's' : ''} found
                    </div>
                    ${results.slice(0, 50).map(workout => {
                        const notes = this.workoutNotes[workout.id];
                        return `
                            <div class="card" onclick="app.closeSearch()">
                                <div class="card-title">${workout.exercise}</div>
                                <div class="card-subtitle">${this.formatDate(workout.date)} â€¢ ${workout.sets.length} sets</div>
                                ${notes ? `<div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px; font-style: italic;">${notes}</div>` : ''}
                                <div style="margin-top: 8px;">
                                    ${workout.sets.map((s, i) => `<span style="font-size: 13px; color: var(--text-secondary); margin-right: 8px;">Set ${i+1}: ${s.weight}kg Ã— ${s.reps}</span>`).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                    ${results.length > 50 ? `<div style="text-align: center; color: var(--text-secondary); margin-top: 12px;">Showing first 50 results</div>` : ''}
                `;
                
                document.getElementById('searchResults').innerHTML = html;
            },

            // Trend Analysis
            addTrendAnalysis() {
                // Add to analytics tab
                const trends = this.analyzeTrends();
                
                if (!trends || trends.length === 0) return '';
                
                return `
                    <div class="card">
                        <div class="card-title" style="margin-bottom: 12px;">ðŸ“ˆ Trends & Insights</div>
                        ${trends.map(trend => `
                            <div style="padding: 12px; background: var(--background); border-radius: 8px; margin-bottom: 8px;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${trend.icon} ${trend.title}</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">${trend.description}</div>
                                ${trend.change ? `<div style="font-size: 14px; font-weight: 600; margin-top: 4px; color: ${trend.change > 0 ? 'var(--success)' : 'var(--danger)'};">${trend.change > 0 ? '+' : ''}${trend.change}%</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            analyzeTrends() {
                const trends = [];
                
                if (this.workouts.length < 10) return trends;
                
                // Volume trend
                const last30Days = this.getWorkoutsInDays(30);
                const prev30Days = this.getWorkoutsInDays(60, 30);
                
                const currentVolume = last30Days.reduce((sum, w) => 
                    sum + w.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                );
                const previousVolume = prev30Days.reduce((sum, w) => 
                    sum + w.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                );
                
                if (previousVolume > 0) {
                    const volumeChange = Math.round(((currentVolume - previousVolume) / previousVolume) * 100);
                    if (Math.abs(volumeChange) > 10) {
                        trends.push({
                            icon: volumeChange > 0 ? 'ðŸ“ˆ' : 'ðŸ“‰',
                            title: `Volume ${volumeChange > 0 ? 'Increasing' : 'Decreasing'}`,
                            description: `Your total training volume is ${volumeChange > 0 ? 'up' : 'down'} compared to last month`,
                            change: volumeChange
                        });
                    }
                }
                
                // Frequency trend
                const currentWorkouts = [...new Set(last30Days.map(w => w.date))].length;
                const previousWorkouts = [...new Set(prev30Days.map(w => w.date))].length;
                
                if (previousWorkouts > 0) {
                    const freqChange = Math.round(((currentWorkouts - previousWorkouts) / previousWorkouts) * 100);
                    if (Math.abs(freqChange) > 15) {
                        trends.push({
                            icon: freqChange > 0 ? 'ðŸ’ª' : 'âš ï¸',
                            title: `Workout Frequency ${freqChange > 0 ? 'Up' : 'Down'}`,
                            description: `You're training ${currentWorkouts} days/month vs ${previousWorkouts} last month`,
                            change: freqChange
                        });
                    }
                }
                
                // Strength progression
                const strengthGains = this.calculateStrengthGains();
                if (strengthGains.length > 0) {
                    const topGain = strengthGains[0];
                    trends.push({
                        icon: 'ðŸ’ª',
                        title: `${topGain.exercise} Progressing Well`,
                        description: `Up ${topGain.change}kg over last month`,
                        change: Math.round((topGain.change / topGain.previous) * 100)
                    });
                }
                
                // RPE trend
                const avgRPE = this.getAverageRPELastWeek();
                if (avgRPE > 8.5) {
                    trends.push({
                        icon: 'ðŸ˜°',
                        title: 'High Training Intensity',
                        description: `Average RPE of ${avgRPE.toFixed(1)}/10. Consider a deload week for recovery.`
                    });
                } else if (avgRPE > 0 && avgRPE < 6) {
                    trends.push({
                        icon: 'ðŸ’¤',
                        title: 'Low Training Intensity',
                        description: `Average RPE of ${avgRPE.toFixed(1)}/10. You might be able to push harder.`
                    });
                }
                
                return trends;
            },

            getWorkoutsInDays(days, offset = 0) {
                const now = new Date();
                const startDate = new Date(now.getTime() - (days + offset) * 24 * 60 * 60 * 1000);
                const endDate = offset > 0 ? new Date(now.getTime() - offset * 24 * 60 * 60 * 1000) : now;
                
                return this.workouts.filter(w => {
                    const workoutDate = new Date(w.date);
                    return workoutDate >= startDate && workoutDate <= endDate;
                });
            },

            calculateStrengthGains() {
                const gains = [];
                const exercises = [...new Set(this.workouts.map(w => w.exercise))];
                
                exercises.forEach(exercise => {
                    const last30 = this.getWorkoutsInDays(30).filter(w => w.exercise === exercise);
                    const prev30 = this.getWorkoutsInDays(60, 30).filter(w => w.exercise === exercise);
                    
                    if (last30.length > 0 && prev30.length > 0) {
                        const currentMax = Math.max(...last30.flatMap(w => w.sets.map(s => s.weight)));
                        const previousMax = Math.max(...prev30.flatMap(w => w.sets.map(s => s.weight)));
                        
                        if (currentMax > previousMax) {
                            gains.push({
                                exercise,
                                change: currentMax - previousMax,
                                previous: previousMax,
                                current: currentMax
                            });
                        }
                    }
                });
                
                return gains.sort((a, b) => b.change - a.change);
            },

            // Workout Session System
            startWorkoutSession() {
                this.currentSession = {
                    id: Date.now().toString(),
                    exercises: [],
                    startTime: new Date().toISOString(),
                    date: new Date().toISOString().split('T')[0],
                    notes: ''
                };
                this.sessionStartTime = Date.now();
                
                this.renderActiveWorkout();
                document.getElementById('activeWorkoutModal').classList.add('active');
                
                // Update header button
                document.getElementById('startWorkoutBtn').textContent = 'â¸ï¸ In Progress';
                document.getElementById('startWorkoutBtn').style.background = 'var(--success)';
            },

            renderActiveWorkout() {
                if (!this.currentSession) return;
                
                const elapsedTime = this.getElapsedTime();
                const totalSets = this.currentSession.exercises.reduce((sum, ex) => sum + ex.sets.length, 0);
                const totalVolume = this.currentSession.exercises.reduce((sum, ex) => 
                    sum + ex.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                );
                
                let html = `
                    <div class="card" style="background: var(--text-primary); color: var(--background); margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 13px; opacity: 0.9;">Duration</div>
                                <div style="font-size: 32px; font-weight: 700;" id="sessionTimer">${elapsedTime}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 13px; opacity: 0.9;">Volume</div>
                                <div style="font-size: 24px; font-weight: 600;" id="liveVolume">${this.formatNumber(totalVolume)}kg</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 20px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.2);">
                            <div>
                                <span style="opacity: 0.9;">Exercises:</span> <strong>${this.currentSession.exercises.length}</strong>
                            </div>
                            <div>
                                <span style="opacity: 0.9;">Sets:</span> <strong id="liveSets">${totalSets}</strong>
                            </div>
                            <div style="margin-left: auto;">
                                <button onclick="app.pauseWorkout()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; font-weight: 600;">
                                    ${this.workoutPaused ? 'â–¶ Resume' : 'â¸ Pause'}
                                </button>
                            </div>
                        </div>
                    </div>

                    ${this.currentSession.exercises.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-icon">+</div>
                            <div class="empty-text">No exercises yet<br>Tap below to add one!</div>
                        </div>
                    ` : ''}

                    ${this.currentSession.exercises.map((exercise, exIndex) => {
                        const lastWorkout = this.getLastWorkoutForExercise(exercise.name);
                        const suggestion = lastWorkout ? this.calculateProgressionSuggestion(exercise.name, lastWorkout) : null;
                        
                        return `
                            <div class="card" style="margin-bottom: 12px;">
                                <div class="card-header">
                                    <div class="card-title">${exercise.name}</div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="app.startVoiceInput(${exIndex}, -1); event.stopPropagation();" 
                                            style="background: var(--surface2); border: 1px solid var(--border); width: 36px; height: 36px; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;"
                                            id="voiceBtn-${exIndex}" title="Voice input">
                                            ðŸŽ¤
                                        </button>
                                        <button class="icon-btn danger" onclick="app.removeExerciseFromSession(${exIndex})">Ã—</button>
                                    </div>
                                </div>
                                
                                ${lastWorkout ? `
                                    <div style="margin-bottom: 12px;">
                                        <div style="font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 6px;">Last Workout</div>
                                        <div style="font-size: 14px; color: var(--text-secondary);">${lastWorkout.sets.map(s => `${s.weight}kg Ã— ${s.reps}`).join(', ')}</div>
                                    </div>
                                ` : ''}

                                ${suggestion ? `
                                    <div style="padding: 10px 12px; background: var(--accent); color: #141414; border-radius: 10px; margin-bottom: 16px;">
                                        <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 3px;">ðŸ’ª Progressive Overload</div>
                                        <div style="font-size: 14px; font-weight: 600; letter-spacing: -0.01em;">${suggestion.message}</div>
                                        ${suggestion.reason ? `<div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">${suggestion.reason}</div>` : ''}
                                    </div>
                                ` : ''}

                                ${exercise.sets.map((set, setIndex) => {
                                    const lastSet = lastWorkout?.sets[setIndex];
                                    const showComparison = lastSet && set.weight && set.reps;
                                    const betterThanLast = showComparison && 
                                        ((set.weight > lastSet.weight) || 
                                         (set.weight === lastSet.weight && set.reps > lastSet.reps));
                                    const isBodyweight = set.reps && !set.weight;
                                    
                                    return `
                                    <div style="margin-bottom: 16px;" 
                                        onclick="app.focusFirstEmptyInput(event, ${exIndex}, ${setIndex})"
                                        ontouchstart="app.handleSetTouchStart(event, ${exIndex}, ${setIndex})"
                                        ontouchmove="app.handleSetTouchMove(event)"
                                        ontouchend="app.handleSetTouchEnd(event, ${exIndex}, ${setIndex})">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="font-size: 13px; font-weight: 700; color: var(--text-primary); font-family: 'DM Mono', monospace;">SET ${setIndex + 1}</div>
                                                ${isBodyweight ? '<div style="padding: 2px 8px; background: var(--accent); color: #141414; border-radius: 6px; font-size: 10px; font-weight: 700; letter-spacing: 0.05em;">BW</div>' : ''}
                                            </div>
                                            ${setIndex > 0 ? `<button onclick="app.removeSetFromSession(${exIndex}, ${setIndex}); event.stopPropagation();" style="background: var(--danger); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center;">âˆ’</button>` : ''}
                                        </div>
                                        
                                        ${showComparison ? `
                                            <div style="padding: 6px 10px; background: ${betterThanLast ? 'var(--accent)' : 'var(--surface2)'}; color: ${betterThanLast ? '#141414' : 'var(--text-secondary)'}; border-radius: 8px; font-size: 11px; margin-bottom: 8px; font-weight: 600; display: flex; justify-content: space-between;">
                                                <span>Last: ${lastSet.weight}kg Ã— ${lastSet.reps}</span>
                                                <span>Now: ${set.weight}kg Ã— ${set.reps} ${betterThanLast ? 'ðŸ’ª' : ''}</span>
                                            </div>
                                        ` : ''}
                                        
                                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                                            <div>
                                                <label style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; display: block; margin-bottom: 4px;">Weight</label>
                                                <input type="number" id="weight-${exIndex}-${setIndex}" value="${set.weight || ''}" 
                                                    min="0" max="1000" step="0.5"
                                                    onchange="app.updateSessionSet(${exIndex}, ${setIndex}, 'weight', this.value); app.updateLiveVolume();"
                                                    onclick="event.stopPropagation()"
                                                    placeholder="BW" 
                                                    style="width: 100%; padding: 12px 8px; border: 1px solid var(--border); border-radius: 10px; font-size: 16px; background: var(--surface2); color: var(--text-primary); font-family: 'DM Mono', monospace; text-align: center;">
                                            </div>
                                            <div>
                                                <label style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; display: block; margin-bottom: 4px;">Reps</label>
                                                <input type="number" id="reps-${exIndex}-${setIndex}" value="${set.reps || ''}" 
                                                    min="1" max="100" step="1"
                                                    onchange="app.updateSessionSet(${exIndex}, ${setIndex}, 'reps', this.value); app.maybeStartRestTimer(); app.checkForPR(${exIndex}, ${setIndex}); app.updateLiveVolume();"
                                                    onclick="event.stopPropagation()"
                                                    placeholder="${lastWorkout?.sets[setIndex]?.reps || '0'}" 
                                                    style="width: 100%; padding: 12px 8px; border: 1px solid var(--border); border-radius: 10px; font-size: 16px; background: var(--surface2); color: var(--text-primary); font-family: 'DM Mono', monospace; text-align: center;">
                                            </div>
                                            <div>
                                                <label style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; display: block; margin-bottom: 4px;">RPE</label>
                                                <input type="number" min="1" max="10" step="0.5" id="rpe-${exIndex}-${setIndex}" value="${set.rpe || ''}" 
                                                    onchange="app.updateSessionSet(${exIndex}, ${setIndex}, 'rpe', this.value)"
                                                    onclick="event.stopPropagation()"
                                                    placeholder="â€”" 
                                                    style="width: 100%; padding: 12px 8px; border: 1px solid var(--border); border-radius: 10px; font-size: 16px; background: var(--surface2); color: var(--text-primary); font-family: 'DM Mono', monospace; text-align: center;">
                                            </div>
                                        </div>
                                    </div>
                                `}).join('')}
                                
                                <div style="display: flex; gap: 8px; margin-top: 4px;">
                                    <button class="btn btn-secondary" onclick="app.addSetToSessionExercise(${exIndex})" style="flex: 1;">
                                        + Add Set
                                    </button>
                                    ${exercise.sets.length > 0 ? `
                                        <button class="btn btn-secondary" onclick="app.duplicateLastSet(${exIndex})" style="padding: 0 16px;" title="Duplicate last set">
                                            âŽ˜
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}

                    ${this.currentSession.exercises.length > 0 ? `
                        <div class="metric-input-group" style="margin-top: 8px;">
                            <label class="metric-label">Workout Notes</label>
                            <textarea id="sessionNotes" class="metric-input" rows="2" placeholder="How was the workout?">${this.currentSession.notes || ''}</textarea>
                        </div>

                        <button class="btn btn-primary" onclick="app.addExerciseToSession()" style="margin-top: 16px;">
                            + Add Exercise
                        </button>

                        <button class="btn btn-success" onclick="app.finishWorkoutSession()" style="margin-top: 8px;">
                            Finish Workout
                        </button>
                        <button class="btn btn-danger" onclick="app.cancelWorkoutSession()" style="margin-top: 8px;">
                            Cancel Workout
                        </button>
                    ` : `
                        <button class="btn btn-primary" onclick="app.addExerciseToSession()" style="margin-top: 16px;">
                            + Add Exercise
                        </button>
                    `}
                `;
                
                document.getElementById('activeWorkoutContent').innerHTML = html;
                
                // Update timer every second
                if (this.sessionTimerInterval) clearInterval(this.sessionTimerInterval);
                this.sessionTimerInterval = setInterval(() => {
                    const timer = document.getElementById('sessionTimer');
                    if (timer && this.currentSession) {
                        timer.textContent = this.getElapsedTime();
                    }
                }, 1000);
            },

            getElapsedTime() {
                if (!this.sessionStartTime) return '0:00';
                const elapsed = Math.floor((Date.now() - this.sessionStartTime) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                
                if (hours > 0) {
                    return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            },

            addExerciseToSession() {
                this.showExerciseModal('session');
            },

            showExerciseModal(mode = 'single') {
                this.exerciseModalMode = mode;
                document.getElementById('exerciseModal').classList.add('active');
                document.getElementById('exerciseSearch').value = '';
                this.renderModalExercises();
            },

            renderModalExercises(filter = '') {
                const allExercises = this.allExercises || [...this.exercises, ...this.customExercises];
                const filtered = allExercises.filter(e => 
                    e.name.toLowerCase().includes(filter.toLowerCase())
                );

                const categories = [...new Set(filtered.map(e => e.category))];
                const html = `
                    <button class="btn btn-secondary" onclick="app.showAddCustomExercise()" style="margin-bottom: 16px;">
                        âž• Create Custom Exercise
                    </button>
                    ${categories.map(cat => `
                        <div class="exercise-category">
                            <div class="category-title">${cat}</div>
                            ${filtered.filter(e => e.category === cat).map(ex => `
                                <div class="exercise-item" onclick="app.selectExerciseFromModal('${ex.name.replace(/'/g, "\\'")}')">
                                    <div>
                                        <div class="exercise-name">${ex.name}${ex.custom ? ' â­' : ''}</div>
                                        <div class="exercise-muscle">${ex.muscle}</div>
                                    </div>
                                    <div class="chevron">+</div>
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                `;

                document.getElementById('modalExerciseList').innerHTML = html;
            },

            selectExerciseFromModal(exerciseName) {
                this.closeExerciseModal();
                
                if (this.exerciseModalMode === 'session') {
                    this.currentSession.exercises.push({
                        name: exerciseName,
                        sets: [{ weight: '', reps: '', rpe: '' }]
                    });
                    this.renderActiveWorkout();
                } else {
                    this.startWorkout(exerciseName);
                }
            },

            closeExerciseModal() {
                document.getElementById('exerciseModal').classList.remove('active');
            },

            startVoiceInput(exIndex, setIndex) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!SpeechRecognition) {
                    alert('Voice input not supported on this device');
                    return;
                }

                const recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.continuous = false;
                recognition.interimResults = false;

                // Find next empty set if setIndex is -1 (exercise-level button)
                let targetSetIndex = setIndex;
                if (setIndex === -1) {
                    const exercise = this.currentSession.exercises[exIndex];
                    targetSetIndex = exercise.sets.findIndex(s => !s.weight || !s.reps);
                    if (targetSetIndex === -1) targetSetIndex = exercise.sets.length - 1; // Use last set if all filled
                }

                const btn = document.getElementById(setIndex === -1 ? `voiceBtn-${exIndex}` : `voiceBtn-${exIndex}-${setIndex}`);
                btn.style.background = 'var(--danger)';
                btn.textContent = 'ðŸ”´';
                this.triggerHaptic();

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.toLowerCase();

                    const parsed = this.parseVoiceInput(transcript);
                    
                    if (parsed.weight !== null) {
                        const input = document.getElementById(`weight-${exIndex}-${targetSetIndex}`);
                        if (input) {
                            input.value = parsed.weight;
                            this.updateSessionSet(exIndex, targetSetIndex, 'weight', parsed.weight);
                        }
                    }
                    
                    if (parsed.reps !== null) {
                        const input = document.getElementById(`reps-${exIndex}-${targetSetIndex}`);
                        if (input) {
                            input.value = parsed.reps;
                            this.updateSessionSet(exIndex, targetSetIndex, 'reps', parsed.reps);
                            this.maybeStartRestTimer();
                            this.checkForPR(exIndex, targetSetIndex);
                        }
                    }
                    
                    if (parsed.rpe !== null) {
                        const input = document.getElementById(`rpe-${exIndex}-${targetSetIndex}`);
                        if (input) {
                            input.value = parsed.rpe;
                            this.updateSessionSet(exIndex, targetSetIndex, 'rpe', parsed.rpe);
                        }
                    }

                    this.updateLiveVolume();
                    this.triggerHaptic();
                    btn.style.background = 'var(--success)';
                    btn.textContent = 'âœ“';
                    setTimeout(() => {
                        btn.style.background = 'var(--surface2)';
                        btn.textContent = 'ðŸŽ¤';
                    }, 1500);
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    btn.style.background = 'var(--surface2)';
                    btn.textContent = 'ðŸŽ¤';
                    if (event.error !== 'no-speech') {
                        alert('Voice input error: ' + event.error);
                    }
                };

                recognition.onend = () => {
                    btn.style.background = 'var(--surface2)';
                    if (btn.textContent === 'ðŸ”´') btn.textContent = 'ðŸŽ¤';
                };

                recognition.start();
            },

            parseVoiceInput(text) {
                // Extract numbers from text
                const result = { weight: null, reps: null, rpe: null };
                
                // Convert words to numbers
                const wordNumbers = {
                    'one': 1, 'two': 2, 'three': 3, 'four': 4, 'five': 5,
                    'six': 6, 'seven': 7, 'eight': 8, 'nine': 9, 'ten': 10,
                    'eleven': 11, 'twelve': 12, 'fifteen': 15, 'twenty': 20,
                    'thirty': 30, 'forty': 40, 'fifty': 50, 'sixty': 60,
                    'seventy': 70, 'eighty': 80, 'ninety': 90, 'hundred': 100
                };
                
                let processedText = text;
                Object.entries(wordNumbers).forEach(([word, num]) => {
                    processedText = processedText.replace(new RegExp(word, 'gi'), num.toString());
                });

                // Extract all numbers
                const numbers = processedText.match(/\d+(\.\d+)?/g)?.map(n => parseFloat(n)) || [];
                
                if (numbers.length === 0) return result;

                // Common patterns:
                // "100 8" â†’ weight, reps
                // "100kg 8 reps" â†’ weight, reps
                // "8 reps" â†’ reps only
                // "100" â†’ weight only
                // "100 8 rpe 9" â†’ weight, reps, rpe

                if (text.includes('rpe')) {
                    // Has explicit RPE
                    const rpeMatch = text.match(/rpe\s*(\d+)/i);
                    if (rpeMatch) result.rpe = parseInt(rpeMatch[1]);
                }

                // Filter out RPE from numbers list
                const dataNumbers = result.rpe !== null 
                    ? numbers.filter(n => n !== result.rpe)
                    : numbers;

                if (dataNumbers.length >= 2) {
                    // Weight and reps
                    result.weight = dataNumbers[0];
                    result.reps = dataNumbers[1];
                } else if (dataNumbers.length === 1) {
                    // Determine if it's weight or reps based on context
                    const num = dataNumbers[0];
                    if (text.includes('rep') || text.includes('time') || num < 30) {
                        result.reps = num;
                    } else {
                        result.weight = num;
                    }
                }

                return result;
            },

            updateLiveVolume() {
                if (!this.currentSession) return;
                
                const totalVolume = this.currentSession.exercises.reduce((sum, ex) => 
                    sum + ex.sets.reduce((s, set) => s + ((set.weight || 0) * (set.reps || 0)), 0), 0
                );
                
                const totalSets = this.currentSession.exercises.reduce((sum, ex) => 
                    sum + ex.sets.filter(s => s.weight || s.reps).length, 0
                );
                
                const volEl = document.getElementById('liveVolume');
                const setsEl = document.getElementById('liveSets');
                
                if (volEl) volEl.textContent = this.formatNumber(totalVolume) + 'kg';
                if (setsEl) setsEl.textContent = totalSets;
            },

            showConfetti() {
                // Create confetti container
                const container = document.createElement('div');
                container.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    pointer-events: none;
                    z-index: 9999;
                `;
                document.body.appendChild(container);

                // Create 50 confetti pieces
                const colors = ['#C8F55A', '#4ade80', '#fbbf24', '#f87171', '#60a5fa'];
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.style.cssText = `
                        position: absolute;
                        width: 10px;
                        height: 10px;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        top: -10px;
                        left: ${Math.random() * 100}%;
                        opacity: 1;
                        transform: rotate(${Math.random() * 360}deg);
                        animation: confettiFall ${2 + Math.random() * 2}s ease-out forwards;
                    `;
                    container.appendChild(confetti);
                }

                // Add animation CSS
                if (!document.getElementById('confettiAnimation')) {
                    const style = document.createElement('style');
                    style.id = 'confettiAnimation';
                    style.textContent = `
                        @keyframes confettiFall {
                            to {
                                transform: translateY(100vh) rotate(${Math.random() * 720}deg);
                                opacity: 0;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }

                // Clean up after animation
                setTimeout(() => container.remove(), 4000);
            },

            initPullToRefresh() {
                let startY = 0;
                let isPulling = false;
                const threshold = 80;
                
                const todayView = document.getElementById('today');
                if (!todayView) return;

                todayView.addEventListener('touchstart', (e) => {
                    if (todayView.scrollTop === 0) {
                        startY = e.touches[0].clientY;
                        isPulling = true;
                    }
                });

                todayView.addEventListener('touchmove', (e) => {
                    if (!isPulling) return;
                    
                    const currentY = e.touches[0].clientY;
                    const diff = currentY - startY;
                    
                    if (diff > 0 && todayView.scrollTop === 0) {
                        e.preventDefault();
                        // Could add visual feedback here
                    }
                });

                todayView.addEventListener('touchend', (e) => {
                    if (!isPulling) return;
                    
                    const endY = e.changedTouches[0].clientY;
                    const diff = endY - startY;
                    
                    if (diff > threshold) {
                        this.triggerHaptic();
                        this.renderToday();
                    }
                    
                    isPulling = false;
                });
            },

            focusFirstEmptyInput(e, exIndex, setIndex) {
                // Don't trigger if clicking on input or button
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
                
                const set = this.currentSession.exercises[exIndex].sets[setIndex];
                
                // Focus first empty field
                if (!set.weight) {
                    document.getElementById(`weight-${exIndex}-${setIndex}`)?.focus();
                } else if (!set.reps) {
                    document.getElementById(`reps-${exIndex}-${setIndex}`)?.focus();
                } else if (!set.rpe) {
                    document.getElementById(`rpe-${exIndex}-${setIndex}`)?.focus();
                }
            },

            checkForPR(exIndex, setIndex) {
                const exercise = this.currentSession.exercises[exIndex];
                const set = exercise.sets[setIndex];
                
                if (!set.weight || !set.reps) return;
                
                const exerciseName = exercise.name;
                const currentPR = this.personalRecords[exerciseName];
                
                // Check if this is a new PR
                const isPR = !currentPR || set.weight > currentPR.weight || 
                    (set.weight === currentPR.weight && set.reps > currentPR.reps);
                
                if (isPR) {
                    this.triggerHaptic();
                    this.showPRBadge(exIndex, setIndex);
                }
            },

            showPRBadge(exIndex, setIndex) {
                // Find the set element and add PR badge
                const setEl = document.querySelector(`#weight-${exIndex}-${setIndex}`)?.closest('div[style*="margin-bottom: 16px"]');
                if (!setEl) return;
                
                // Check if badge already exists
                if (setEl.querySelector('.pr-badge-live')) return;
                
                const badge = document.createElement('div');
                badge.className = 'pr-badge-live';
                badge.innerHTML = 'ðŸ† NEW PR!';
                badge.style.cssText = `
                    position: absolute;
                    top: -10px;
                    right: -10px;
                    background: var(--accent);
                    color: #141414;
                    padding: 4px 10px;
                    border-radius: 12px;
                    font-size: 11px;
                    font-weight: 700;
                    letter-spacing: 0.05em;
                    animation: prPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                    box-shadow: 0 4px 12px rgba(200, 245, 90, 0.4);
                `;
                
                setEl.style.position = 'relative';
                setEl.appendChild(badge);
                
                // Add CSS animation if not exists
                if (!document.getElementById('prPopAnimation')) {
                    const style = document.createElement('style');
                    style.id = 'prPopAnimation';
                    style.textContent = `
                        @keyframes prPop {
                            0% { transform: scale(0); }
                            50% { transform: scale(1.1); }
                            100% { transform: scale(1); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            },

            duplicateLastSet(exIndex) {
                const exercise = this.currentSession.exercises[exIndex];
                const lastSet = exercise.sets[exercise.sets.length - 1];
                
                // Create exact copy
                exercise.sets.push({ 
                    weight: lastSet.weight, 
                    reps: lastSet.reps, 
                    rpe: lastSet.rpe 
                });
                
                this.triggerHaptic();
                this.renderActiveWorkout();
            },

            updateSessionSet(exIndex, setIndex, field, value) {
                const numValue = parseFloat(value);
                
                // Validation (6)
                if (field === 'weight' && (numValue < 0 || numValue > 1000)) {
                    this.showNotification('âš ï¸ Weight must be 0-1000kg');
                    document.getElementById(`weight-${exIndex}-${setIndex}`).value = '';
                    return;
                }
                if (field === 'reps' && (numValue < 1 || numValue > 100)) {
                    this.showNotification('âš ï¸ Reps must be 1-100');
                    document.getElementById(`reps-${exIndex}-${setIndex}`).value = '';
                    return;
                }
                if (field === 'rpe' && (numValue < 1 || numValue > 10)) {
                    this.showNotification('âš ï¸ RPE must be 1-10');
                    document.getElementById(`rpe-${exIndex}-${setIndex}`).value = '';
                    return;
                }
                
                this.currentSession.exercises[exIndex].sets[setIndex][field] = numValue || '';
                
                // Trigger haptic feedback when completing a set (both weight and reps filled)
                const set = this.currentSession.exercises[exIndex].sets[setIndex];
                if (field === 'reps' && set.weight && set.reps) {
                    this.triggerHaptic();
                }
            },

            triggerHaptic() {
                if ('vibrate' in navigator) {
                    navigator.vibrate(50); // 50ms subtle vibration
                }
            },

            maybeStartRestTimer() {
                // Auto-start rest timer after logging reps (only if not already running)
                if (!this.restTimer && this.settings.restTimerDuration > 0) {
                    this.startRestTimer();
                }
            },

            // Swipe to delete detection
            _swipeStartX: 0,
            _swipeStartY: 0,
            
            handleSetTouchStart(e, exIndex, setIndex) {
                if (setIndex === 0) return; // Can't delete first set
                this._swipeStartX = e.touches[0].clientX;
                this._swipeStartY = e.touches[0].clientY;
            },

            handleSetTouchMove(e) {
                // Could add visual feedback here
            },

            handleSetTouchEnd(e, exIndex, setIndex) {
                if (setIndex === 0) return;
                
                const endX = e.changedTouches[0].clientX;
                const endY = e.changedTouches[0].clientY;
                const diffX = this._swipeStartX - endX;
                const diffY = Math.abs(this._swipeStartY - endY);

                // Swipe left at least 100px, and mostly horizontal
                if (diffX > 100 && diffY < 50) {
                    this.triggerHaptic();
                    this.removeSetFromSession(exIndex, setIndex);
                }
            },

            addSetToSessionExercise(exIndex) {
                const exercise = this.currentSession.exercises[exIndex];
                const lastSet = exercise.sets[exercise.sets.length - 1];
                
                // Pre-fill with last set's values
                exercise.sets.push({ 
                    weight: lastSet?.weight || '', 
                    reps: lastSet?.reps || '', 
                    rpe: '' 
                });
                this.renderActiveWorkout();
            },

            removeSetFromSession(exIndex, setIndex) {
                this.currentSession.exercises[exIndex].sets.splice(setIndex, 1);
                this.renderActiveWorkout();
            },

            removeExerciseFromSession(exIndex) {
                if (!confirm('Remove this exercise from the workout?')) return;
                this.currentSession.exercises.splice(exIndex, 1);
                this.renderActiveWorkout();
            },

            calculateProgressionSuggestion(exerciseName, lastWorkout) {
                if (!lastWorkout || !lastWorkout.sets || lastWorkout.sets.length === 0) return null;

                // Get workout history for this exercise
                const history = this.workouts
                    .filter(w => w.exercise === exerciseName)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 5); // Last 5 workouts

                if (history.length < 2) {
                    // First time doing this exercise recently - suggest same weight
                    const topSet = lastWorkout.sets[0];
                    return {
                        message: `Try ${topSet.weight}kg Ã— ${topSet.reps} reps`,
                        reason: 'Match last workout first'
                    };
                }

                const lastSets = lastWorkout.sets;
                const topSet = lastSets[0]; // Heaviest set
                const allRepsCompleted = lastSets.every(s => s.reps >= topSet.reps);
                const avgRPE = lastSets.filter(s => s.rpe).reduce((sum, s, _, arr) => sum + s.rpe / arr.length, 0);

                // Calculate progression rate from history
                const firstWeight = history[history.length - 1].sets[0].weight;
                const currentWeight = topSet.weight;
                const workoutCount = history.length;
                const avgIncrease = (currentWeight - firstWeight) / workoutCount;

                // Decision logic
                let newWeight = topSet.weight;
                let newReps = topSet.reps;
                let reason = '';

                // Strong performance - increase weight
                if (allRepsCompleted && (!avgRPE || avgRPE < 8)) {
                    // Easy sets, RPE < 8
                    newWeight = topSet.weight + (avgIncrease > 0 ? Math.round(avgIncrease) : 2.5);
                    reason = 'You crushed it last time';
                } else if (allRepsCompleted && avgRPE >= 8 && avgRPE <= 9) {
                    // Hard but completed, RPE 8-9
                    newWeight = topSet.weight + 2.5;
                    reason = 'Solid progress, small jump';
                } else if (allRepsCompleted && avgRPE > 9) {
                    // Maxed out, RPE 10
                    newWeight = topSet.weight;
                    newReps = topSet.reps + 1;
                    reason = 'Add reps before adding weight';
                } else if (!allRepsCompleted) {
                    // Failed reps - check if it's a pattern
                    const previousWorkout = history[1];
                    const previousFailed = previousWorkout && previousWorkout.sets.some(s => s.reps < topSet.reps);
                    
                    if (previousFailed) {
                        // Failing repeatedly - deload
                        newWeight = Math.max(topSet.weight * 0.9, topSet.weight - 5);
                        reason = 'Deload to build back up';
                    } else {
                        // First failure - try same weight
                        newWeight = topSet.weight;
                        reason = 'Match last workout';
                    }
                }

                // Round to nearest 2.5kg
                newWeight = Math.round(newWeight / 2.5) * 2.5;

                return {
                    message: `Try ${newWeight}kg Ã— ${newReps} reps`,
                    reason
                };
            },

            getLastWorkoutForExercise(exerciseName) {
                const previous = this.workouts
                    .filter(w => w.exercise === exerciseName)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                return previous;
            },

            async finishWorkoutSession() {
                if (!this.currentSession) return;
                
                // Validate at least one exercise with sets
                const hasValidExercises = this.currentSession.exercises.some(ex => 
                    ex.sets.some(s => s.weight && s.reps)
                );
                
                if (!hasValidExercises) {
                    alert('Please complete at least one set before finishing the workout');
                    return;
                }
                
                // Show loading (9)
                this.showNotification('ðŸ’¾ Saving workout...');
                
                // Get notes
                const notes = document.getElementById('sessionNotes')?.value || '';
                this.currentSession.notes = notes;
                
                // Calculate duration
                this.currentSession.endTime = new Date().toISOString();
                this.currentSession.duration = Math.floor((Date.now() - this.sessionStartTime) / 1000);
                
                // Process each exercise and add to old workouts array for compatibility
                this.currentSession.exercises.forEach(exercise => {
                    const validSets = exercise.sets.filter(s => s.weight && s.reps);
                    if (validSets.length > 0) {
                        this.workouts.push({
                            id: Date.now().toString() + Math.random(),
                            exercise: exercise.name,
                            date: this.currentSession.date,
                            sets: validSets,
                            sessionId: this.currentSession.id
                        });
                    }
                });
                
                // Save session
                this.workoutSessions.push(this.currentSession);
                await this.saveWorkoutSessions();
                await this.saveWorkouts();
                
                // Export to Apple Health / Google Fit
                this.exportWorkoutToHealthApp(this.currentSession);
                
                // Check achievements
                this.checkAchievements();
                this.checkAndUnlockAchievements();
                
                // Clear session
                clearInterval(this.sessionTimerInterval);
                this.currentSession = null;
                this.sessionStartTime = null;
                
                // Close modal
                document.getElementById('activeWorkoutModal').classList.remove('active');
                
                // Reset header button
                document.getElementById('startWorkoutBtn').textContent = 'â–¶ï¸ Start Workout';
                document.getElementById('startWorkoutBtn').style.background = 'var(--primary)';
                
                // Refresh views
                this.renderToday();
                this.renderAnalytics();
                
                // Show completion message
                this.showConfetti();
                this.showSuccessAnimation(); // 10
                this.triggerHaptic();
                
                // Offer to save as template (3)
                const sessionRef = {...this.workoutSessions[this.workoutSessions.length - 1]};
                setTimeout(() => {
                    if (confirm('ðŸ’¾ Save this workout as a template for next time?')) {
                        this.saveWorkoutAsTemplate(sessionRef);
                    }
                }, 2500);
                
                // Offer to share (3)
                setTimeout(() => {
                    if (confirm('ðŸ“¤ Share this workout on social media?')) {
                        this.shareWorkout(sessionRef);
                    }
                }, 4000);
            },

            async generateAIWorkout() {
                const goal = prompt('What\'s your goal?', 'Build muscle in chest and back');
                if (!goal) return;
                
                const days = prompt('How many days per week?', '3');
                if (!days) return;
                
                const experience = prompt('Experience level? (beginner/intermediate/advanced)', 'intermediate');
                if (!experience) return;
                
                this.showNotification('ðŸ¤– AI generating workout...');
                
                try {
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 1000,
                            messages: [{
                                role: "user",
                                content: `Create a ${days}-day per week workout program for a ${experience} lifter.
Goal: ${goal}

Return ONLY valid JSON (no markdown, no explanation) in this exact format:
{
  "name": "Program Name",
  "workouts": [
    {
      "name": "Day 1 Name",
      "exercises": [
        {"name": "Exercise Name", "sets": 3, "reps": "8-10"}
      ]
    }
  ]
}

Use proper exercise names from: Bench Press, Squat, Deadlift, Overhead Press, Barbell Row, Pull-ups, Dips, etc.`
                            }]
                        })
                    });
                    
                    const data = await response.json();
                    const text = data.content[0].text;
                    const program = JSON.parse(text);
                    
                    // Save as program
                    program.id = Date.now().toString();
                    program.schedule = `${days}x per week`;
                    program.description = `AI-generated for: ${goal}`;
                    this.programs.push(program);
                    
                    this.showNotification('âœ… AI workout created!');
                    this.switchTab('templates');
                    this.renderTemplates();
                    
                } catch (err) {
                    console.error('AI generation failed:', err);
                    alert('AI generation failed. Please try again.');
                }
            },

            async analyzeNutrition() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.capture = 'environment';
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    this.showNotification('ðŸ¤– AI analyzing meal...');
                    
                    // Convert to base64
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const base64 = event.target.result.split(',')[1];
                        
                        try {
                            const response = await fetch("https://api.anthropic.com/v1/messages", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    model: "claude-sonnet-4-20250514",
                                    max_tokens: 500,
                                    messages: [{
                                        role: "user",
                                        content: [
                                            {
                                                type: "image",
                                                source: {
                                                    type: "base64",
                                                    media_type: file.type,
                                                    data: base64
                                                }
                                            },
                                            {
                                                type: "text",
                                                text: `Analyze this meal and estimate macros. Return ONLY valid JSON (no markdown):
{
  "food": "Brief description",
  "calories": number,
  "protein": number,
  "carbs": number,
  "fat": number,
  "confidence": "high/medium/low"
}`
                                            }
                                        ]
                                    }]
                                })
                            });
                            
                            const data = await response.json();
                            const text = data.content[0].text;
                            const nutrition = JSON.parse(text);
                            
                            // Show results and offer to log
                            const log = confirm(`${nutrition.food}\n\nCalories: ${nutrition.calories}\nProtein: ${nutrition.protein}g\nCarbs: ${nutrition.carbs}g\nFat: ${nutrition.fat}g\n\nConfidence: ${nutrition.confidence}\n\nLog to nutrition tracker?`);
                            
                            if (log) {
                                const today = new Date().toISOString().split('T')[0];
                                if (!this.dailyLogs[today]) this.dailyLogs[today] = {};
                                
                                this.dailyLogs[today].caloriesIn = (this.dailyLogs[today].caloriesIn || 0) + nutrition.calories;
                                this.dailyLogs[today].protein = (this.dailyLogs[today].protein || 0) + nutrition.protein;
                                this.dailyLogs[today].carbs = (this.dailyLogs[today].carbs || 0) + nutrition.carbs;
                                this.dailyLogs[today].fat = (this.dailyLogs[today].fat || 0) + nutrition.fat;
                                
                                this.saveDailyLogs();
                                this.showNotification('âœ… Nutrition logged!');
                            }
                            
                        } catch (err) {
                            console.error('AI analysis failed:', err);
                            alert('AI analysis failed. Please try again.');
                        }
                    };
                    reader.readAsDataURL(file);
                };
                
                input.click();
            },

            showPlateCalculator() {
                const weight = prompt('Target weight (kg):', '100');
                if (!weight) return;
                
                const target = parseFloat(weight);
                const barWeight = 20; // Standard Olympic bar
                const perSide = (target - barWeight) / 2;
                
                // Available plates
                const plates = [25, 20, 15, 10, 5, 2.5, 1.25, 0.5];
                let remaining = perSide;
                const loadout = [];
                
                for (const plate of plates) {
                    while (remaining >= plate) {
                        loadout.push(plate);
                        remaining -= plate;
                    }
                }
                
                const actual = barWeight + (loadout.reduce((sum, p) => sum + p, 0) * 2);
                
                alert(`Load ${target}kg:\n\nBar: ${barWeight}kg\nPer side: ${loadout.join(' + ')}kg\n\nActual weight: ${actual}kg${remaining > 0 ? `\nâš ï¸ Can't load exact weight (${remaining.toFixed(2)}kg short per side)` : ''}`);
            },

            show1RMCalculator() {
                const weight = prompt('Weight lifted (kg):', '100');
                if (!weight) return;
                
                const reps = prompt('Reps completed:', '5');
                if (!reps) return;
                
                const w = parseFloat(weight);
                const r = parseFloat(reps);
                
                // Epley formula: 1RM = weight Ã— (1 + reps/30)
                const epley = w * (1 + r / 30);
                
                // Brzycki formula: 1RM = weight Ã— (36 / (37 - reps))
                const brzycki = w * (36 / (37 - r));
                
                const avg = (epley + brzycki) / 2;
                
                alert(`1RM Estimate for ${w}kg Ã— ${r}:\n\nEpley: ${epley.toFixed(1)}kg\nBrzycki: ${brzycki.toFixed(1)}kg\nAverage: ${avg.toFixed(1)}kg\n\nTraining percentages:\n60%: ${(avg * 0.6).toFixed(1)}kg\n70%: ${(avg * 0.7).toFixed(1)}kg\n80%: ${(avg * 0.8).toFixed(1)}kg\n90%: ${(avg * 0.9).toFixed(1)}kg`);
            },

            shareWorkout(session) {
                // Generate shareable image card
                const canvas = document.createElement('canvas');
                canvas.width = 1080;
                canvas.height = 1080;
                const ctx = canvas.getContext('2d');
                
                // Background gradient
                const gradient = ctx.createLinearGradient(0, 0, 0, 1080);
                gradient.addColorStop(0, '#1a1a1a');
                gradient.addColorStop(1, '#0a0a0a');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 1080, 1080);
                
                // Stats
                const totalVolume = session.exercises.reduce((sum, ex) => 
                    sum + ex.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                );
                const totalSets = session.exercises.reduce((sum, ex) => sum + ex.sets.length, 0);
                const duration = this.formatDuration(session.duration);
                
                // Title
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 60px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ðŸ’ª WORKOUT COMPLETE', 540, 120);
                
                // Date
                ctx.font = '32px Arial';
                ctx.fillStyle = '#888888';
                ctx.fillText(new Date(session.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }), 540, 180);
                
                // Stats box
                ctx.fillStyle = '#222222';
                ctx.fillRect(90, 240, 900, 200);
                
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 72px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(this.formatNumber(totalVolume) + 'kg', 540, 330);
                ctx.font = '28px Arial';
                ctx.fillStyle = '#888888';
                ctx.fillText('TOTAL VOLUME', 540, 380);
                
                // Secondary stats
                ctx.fillStyle = '#333333';
                ctx.fillRect(90, 470, 420, 120);
                ctx.fillRect(570, 470, 420, 120);
                
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 48px Arial';
                ctx.fillText(totalSets, 300, 530);
                ctx.fillText(duration, 780, 530);
                
                ctx.font = '20px Arial';
                ctx.fillStyle = '#888888';
                ctx.fillText('SETS', 300, 565);
                ctx.fillText('DURATION', 780, 565);
                
                // Exercises
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 32px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('EXERCISES', 90, 660);
                
                ctx.font = '28px Arial';
                let y = 720;
                session.exercises.slice(0, 8).forEach(ex => {
                    ctx.fillText(`â€¢ ${ex.name}`, 110, y);
                    ctx.fillStyle = '#666666';
                    ctx.fillText(`${ex.sets.length} sets`, 850, y);
                    ctx.fillStyle = '#ffffff';
                    y += 50;
                });
                
                if (session.exercises.length > 8) {
                    ctx.fillStyle = '#666666';
                    ctx.fillText(`+ ${session.exercises.length - 8} more...`, 110, y);
                }
                
                // Footer
                ctx.fillStyle = '#888888';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Gym Tracker', 540, 1030);
                
                // Convert to blob and share
                canvas.toBlob(blob => {
                    const file = new File([blob], 'workout.png', { type: 'image/png' });
                    
                    if (navigator.share) {
                        navigator.share({
                            title: 'My Workout',
                            text: `Just completed a workout!\n${this.formatNumber(totalVolume)}kg total volume â€¢ ${totalSets} sets â€¢ ${duration}`,
                            files: [file]
                        }).catch(() => this.downloadWorkoutImage(canvas));
                    } else {
                        this.downloadWorkoutImage(canvas);
                    }
                });
            },

            downloadWorkoutImage(canvas) {
                const link = document.createElement('a');
                link.download = `workout-${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
                this.showNotification('ðŸ“¥ Workout image downloaded!');
            },

            saveWorkoutAsTemplate(session) {
                const name = prompt('Template name:', `${session.exercises.map(e => e.name).slice(0, 2).join(' + ')} Workout`);
                if (!name) return;
                
                const template = {
                    id: Date.now().toString(),
                    name,
                    exercises: session.exercises.map(ex => ({
                        name: ex.name,
                        sets: ex.sets.length,
                        targetReps: Math.round(ex.sets.reduce((sum, s) => sum + (s.reps || 0), 0) / ex.sets.length) || 10
                    }))
                };
                
                this.templates.push(template);
                this.saveTemplates();
                this.showNotification('âœ… Template saved!');
            },

            cancelWorkoutSession() {
                if (!confirm('Cancel this workout? All progress will be lost.')) return;
                
                clearInterval(this.sessionTimerInterval);
                this.currentSession = null;
                this.sessionStartTime = null;
                
                document.getElementById('activeWorkoutModal').classList.remove('active');
                document.getElementById('startWorkoutBtn').textContent = 'â–¶ï¸ Start Workout';
                document.getElementById('startWorkoutBtn').style.background = 'var(--primary)';
            },

            // Custom Exercise Creator
            showAddCustomExercise() {
                const html = `
                    <div class="metric-input-group">
                        <label class="metric-label">Exercise Name</label>
                        <input type="text" id="customExName" class="metric-input" placeholder="e.g., Cable Crossover">
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">Category</label>
                        <select id="customExCategory" class="metric-input">
                            <option value="Chest">Chest</option>
                            <option value="Back">Back</option>
                            <option value="Legs">Legs</option>
                            <option value="Shoulders">Shoulders</option>
                            <option value="Arms">Arms</option>
                            <option value="Core">Core</option>
                            <option value="Cardio">Cardio</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">Target Muscles</label>
                        <input type="text" id="customExMuscle" class="metric-input" placeholder="e.g., Chest, Front Delts">
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">Muscle Groups (for volume tracking)</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">
                            ${['Chest', 'Back', 'Quads', 'Hamstrings', 'Glutes', 'Shoulders', 'Biceps', 'Triceps', 'Core', 'Calves'].map(muscle => `
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" value="${muscle}" class="custom-muscle-checkbox">
                                    <span>${muscle}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="app.saveCustomExercise()">ðŸ’¾ Save Exercise</button>
                `;

                document.getElementById('addCustomExerciseContent').innerHTML = html;
                document.getElementById('addCustomExerciseModal').classList.add('active');
            },

            closeAddCustomExercise() {
                document.getElementById('addCustomExerciseModal').classList.remove('active');
            },

            async saveCustomExercise() {
                const name = document.getElementById('customExName').value.trim();
                const category = document.getElementById('customExCategory').value;
                const muscle = document.getElementById('customExMuscle').value.trim();
                
                if (!name || !muscle) {
                    alert('Please fill in exercise name and target muscles');
                    return;
                }
                
                // Check if exercise already exists
                const allExercises = [...this.exercises, ...this.customExercises];
                if (allExercises.some(ex => ex.name.toLowerCase() === name.toLowerCase())) {
                    alert('An exercise with this name already exists');
                    return;
                }
                
                // Get selected muscle groups
                const checkboxes = document.querySelectorAll('.custom-muscle-checkbox:checked');
                const muscleGroups = Array.from(checkboxes).map(cb => cb.value);
                
                const customExercise = {
                    name,
                    category,
                    muscle,
                    custom: true
                };
                
                this.customExercises.push(customExercise);
                
                // Add to muscle group map
                if (muscleGroups.length > 0) {
                    this.muscleGroupMap[name] = muscleGroups;
                }
                
                // Update allExercises
                this.allExercises = [...this.exercises, ...this.customExercises];
                
                await this.saveCustomExercises();
                
                this.closeAddCustomExercise();
                this.renderModalExercises();
                
                alert(`âœ“ "${name}" added to your exercise library!`);
            },

            // Health Dashboard System
            renderHealth() {
                const today = new Date().toISOString().split('T')[0];
                const todayLog = this.dailyLogs[today] || null;
                const readiness = todayLog ? this.calculateReadinessScore(todayLog) : null;
                
                let html = `
                    <div class="section-header">
                        <div class="section-title">Health</div>
                        <div class="section-action" onclick="app.logDailyHealth()">+ Log</div>
                    </div>
                `;
                
                // Readiness Ring (always show, even if empty)
                if (readiness) {
                    const circumference = 2 * Math.PI * 90;
                    const offset = circumference - (readiness.score / 100) * circumference;
                    
                    let ringColor = 'var(--accent)';
                    if (readiness.score < 40) ringColor = 'var(--danger)';
                    else if (readiness.score < 70) ringColor = 'var(--warning)';
                    
                    html += `
                        <div class="premium-stat-card" style="background: var(--surface); margin-bottom: 16px;">
                            <div class="readiness-ring">
                                <svg width="200" height="200">
                                    <circle class="readiness-ring-bg" cx="100" cy="100" r="90"/>
                                    <circle class="readiness-ring-progress" 
                                        cx="100" cy="100" r="90"
                                        stroke="${ringColor}"
                                        stroke-dasharray="${circumference}"
                                        stroke-dashoffset="${offset}"/>
                                </svg>
                                <div class="readiness-score-text">
                                    <div class="readiness-score-number">${readiness.score}</div>
                                    <div class="readiness-score-label">READINESS</div>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 16px;">
                                <div style="font-size: 15px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">
                                    ${readiness.status}
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5; max-width: 280px; margin: 0 auto;">
                                    ${readiness.recommendation}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="premium-stat-card" style="text-align: center; padding: 40px 20px; margin-bottom: 16px;">
                            <div style="font-size: 48px; margin-bottom: 12px; opacity: 0.3;">ðŸ“Š</div>
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                                No data logged today
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px;">
                                Log your metrics to see your readiness score
                            </div>
                            <button class="btn btn-primary" onclick="app.logDailyHealth()">Log Today's Data</button>
                        </div>
                    `;
                }
                
                // 2x2 Dashboard Grid
                // Calculate weekly averages for comparison
                const weeklyData = this.getWeeklyHealthData();
                const avgSleep = weeklyData.length > 0 ? this.calculateAverage(weeklyData.map(d => d.sleep).filter(Boolean)) : null;
                const avgEnergy = weeklyData.length > 0 ? this.calculateAverage(weeklyData.map(d => d.energy).filter(Boolean)) : null;
                const avgHRV = weeklyData.length > 0 ? this.calculateAverage(weeklyData.map(d => d.hrv).filter(Boolean)) : null;
                const avgRHR = weeklyData.length > 0 ? this.calculateAverage(weeklyData.map(d => d.rhr).filter(Boolean)) : null;

                html += `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <!-- Sleep Card -->
                        <div class="premium-stat-card" onclick="app.quickLogMetric('recovery')" style="cursor: pointer; padding: 16px;">
                            <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px;">Sleep</div>
                            ${todayLog?.sleep ? `
                                <div style="font-size: 32px; font-weight: 700; font-family: 'DM Mono', monospace; color: var(--text-primary); margin-bottom: 4px;">${todayLog.sleep}<span style="font-size: 18px;">h</span></div>
                                ${avgSleep && Math.abs(todayLog.sleep - avgSleep) >= 0.5 ? `
                                    <div style="font-size: 12px; color: ${todayLog.sleep > avgSleep ? 'var(--success)' : 'var(--danger)'}; margin-bottom: 6px;">
                                        ${todayLog.sleep > avgSleep ? '+' : ''}${(todayLog.sleep - avgSleep).toFixed(1)}h vs avg
                                    </div>
                                ` : avgSleep ? `<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">On target</div>` : ''}
                                ${this.renderMiniSparkline(weeklyData.map(d => d.sleep || 0))}
                            ` : `
                                <div style="font-size: 32px; font-weight: 700; color: var(--text-secondary); opacity: 0.3; margin-bottom: 4px;">â€”</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Tap to log</div>
                            `}
                        </div>

                        <!-- Energy Card -->
                        <div class="premium-stat-card" onclick="app.quickLogMetric('recovery')" style="cursor: pointer; padding: 16px;">
                            <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px;">Energy</div>
                            ${todayLog?.energy ? `
                                <div style="font-size: 32px; font-weight: 700; font-family: 'DM Mono', monospace; color: var(--text-primary); margin-bottom: 4px;">${todayLog.energy}<span style="font-size: 18px;">/10</span></div>
                                ${avgEnergy && Math.abs(todayLog.energy - avgEnergy) >= 1 ? `
                                    <div style="font-size: 12px; color: ${todayLog.energy > avgEnergy ? 'var(--success)' : 'var(--danger)'}; margin-bottom: 6px;">
                                        ${todayLog.energy > avgEnergy ? '+' : ''}${(todayLog.energy - avgEnergy).toFixed(1)} vs avg
                                    </div>
                                ` : avgEnergy ? `<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">Normal</div>` : ''}
                                <div style="display: flex; gap: 2px; margin-top: 8px;">
                                    ${Array.from({length: 10}, (_, i) => `
                                        <div style="flex: 1; height: 4px; background: ${i < todayLog.energy ? 'var(--accent)' : 'var(--border)'}; border-radius: 2px;"></div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div style="font-size: 32px; font-weight: 700; color: var(--text-secondary); opacity: 0.3; margin-bottom: 4px;">â€”</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Tap to log</div>
                            `}
                        </div>

                        <!-- Nutrition Card -->
                        <div class="premium-stat-card" onclick="app.quickLogMetric('nutrition')" style="cursor: pointer; padding: 16px;">
                            <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px;">Nutrition</div>
                            ${todayLog?.caloriesIn ? `
                                <div style="font-size: 32px; font-weight: 700; font-family: 'DM Mono', monospace; color: var(--text-primary); margin-bottom: 4px;">${todayLog.caloriesIn}<span style="font-size: 14px;">kcal</span></div>
                                ${todayLog.protein ? `
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">Protein: ${todayLog.protein}g</div>
                                ` : ''}
                                ${this.renderMiniSparkline(weeklyData.map(d => d.caloriesIn || 0))}
                            ` : `
                                <div style="font-size: 32px; font-weight: 700; color: var(--text-secondary); opacity: 0.3; margin-bottom: 4px;">â€”</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Tap to log</div>
                            `}
                        </div>

                        <!-- Recovery Card -->
                        <div class="premium-stat-card" onclick="app.quickLogMetric('recovery')" style="cursor: pointer; padding: 16px;">
                            <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px;">Recovery</div>
                            ${todayLog?.hrv ? `
                                <div style="font-size: 32px; font-weight: 700; font-family: 'DM Mono', monospace; color: var(--text-primary); margin-bottom: 4px;">${todayLog.hrv}<span style="font-size: 14px;">ms</span></div>
                                ${avgHRV && Math.abs(todayLog.hrv - avgHRV) >= 5 ? `
                                    <div style="font-size: 12px; color: ${todayLog.hrv > avgHRV ? 'var(--success)' : 'var(--danger)'}; margin-bottom: 6px;">
                                        ${todayLog.hrv > avgHRV ? '+' : ''}${Math.round(todayLog.hrv - avgHRV)}ms vs avg
                                    </div>
                                ` : avgHRV ? `<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">Normal</div>` : ''}
                                ${this.renderMiniSparkline(weeklyData.map(d => d.hrv || 0))}
                            ` : todayLog?.rhr ? `
                                <div style="font-size: 32px; font-weight: 700; font-family: 'DM Mono', monospace; color: var(--text-primary); margin-bottom: 4px;">${todayLog.rhr}<span style="font-size: 14px;">bpm</span></div>
                                ${avgRHR && Math.abs(todayLog.rhr - avgRHR) >= 3 ? `
                                    <div style="font-size: 12px; color: ${todayLog.rhr < avgRHR ? 'var(--success)' : 'var(--danger)'}; margin-bottom: 6px;">
                                        ${todayLog.rhr < avgRHR ? '' : '+'}${Math.round(todayLog.rhr - avgRHR)}bpm vs avg
                                    </div>
                                ` : avgRHR ? `<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">Normal</div>` : ''}
                                ${this.renderMiniSparkline(weeklyData.map(d => d.rhr || 0))}
                            ` : `
                                <div style="font-size: 32px; font-weight: 700; color: var(--text-secondary); opacity: 0.3; margin-bottom: 4px;">â€”</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Tap to log</div>
                            `}
                        </div>
                    </div>
                `;

                // Quick Actions
                html += `
                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <button class="btn btn-secondary" onclick="app.showWeeklyReport()" style="flex: 1;">
                            ðŸ“Š Weekly Report
                        </button>
                        <button class="btn btn-secondary" onclick="app.syncHealthData()" style="flex: 1;">
                            ðŸ”„ Sync Health Data
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <button class="btn btn-primary" onclick="app.scanBarcode()" style="flex: 1;">
                            ðŸ“· Scan Barcode
                        </button>
                        <button class="btn btn-primary" onclick="app.generateMealPlan()" style="flex: 1;">
                            ðŸ½ï¸ Meal Plan
                        </button>
                    </div>
                    
                    <div style="font-size: 11px; color: var(--text-secondary); text-align: center; margin-bottom: 80px;">
                        Scan food labels â€¢ AI generates meal plans with macros
                    </div>
                `;
                
                document.getElementById('health').innerHTML = html;
            },

            async scanBarcode() {
                // Check if device supports camera
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('Camera not available on this device');
                    return;
                }
                
                // Create barcode scanner UI
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h2 class="modal-title">Scan Barcode</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove(); app.stopBarcodeScanner();">Ã—</button>
                        </div>
                        
                        <div style="position: relative; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 16px;">
                            <video id="barcodeVideo" style="width: 100%; height: 300px; object-fit: cover;" autoplay playsinline></video>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 40%; border: 2px solid var(--success); border-radius: 8px; pointer-events: none;"></div>
                        </div>
                        
                        <div id="barcodeResult" style="margin-bottom: 16px;"></div>
                        
                        <div style="font-size: 12px; color: var(--text-secondary); text-align: center; margin-bottom: 16px;">
                            Point camera at barcode on food packaging
                        </div>
                        
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove(); app.stopBarcodeScanner();">Cancel</button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Start camera
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' }
                    });
                    
                    const video = document.getElementById('barcodeVideo');
                    video.srcObject = stream;
                    this.barcodeStream = stream;
                    
                    // Start scanning loop
                    this.startBarcodeDetection(video);
                    
                } catch (err) {
                    alert('Camera access denied. Please enable camera permissions.');
                    modal.remove();
                }
            },

            async startBarcodeDetection(video) {
                // Use browser BarcodeDetector API if available
                if ('BarcodeDetector' in window) {
                    const barcodeDetector = new BarcodeDetector();
                    
                    const detectBarcode = async () => {
                        if (!this.barcodeStream) return;
                        
                        try {
                            const barcodes = await barcodeDetector.detect(video);
                            if (barcodes.length > 0) {
                                const barcode = barcodes[0].rawValue;
                                this.lookupBarcode(barcode);
                                return;
                            }
                        } catch (err) {
                            console.error('Barcode detection error:', err);
                        }
                        
                        requestAnimationFrame(detectBarcode);
                    };
                    
                    detectBarcode();
                } else {
                    // Fallback: manual entry
                    document.getElementById('barcodeResult').innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="margin-bottom: 12px; color: var(--text-secondary);">Barcode scanner not supported on this device</div>
                            <input type="text" id="manualBarcode" placeholder="Enter barcode manually" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface2); color: var(--text-primary); margin-bottom: 8px;">
                            <button class="btn btn-primary" onclick="app.lookupBarcode(document.getElementById('manualBarcode').value)" style="width: 100%;">Look Up</button>
                        </div>
                    `;
                }
            },

            stopBarcodeScanner() {
                if (this.barcodeStream) {
                    this.barcodeStream.getTracks().forEach(track => track.stop());
                    this.barcodeStream = null;
                }
            },

            async lookupBarcode(barcode) {
                this.stopBarcodeScanner();
                
                const resultDiv = document.getElementById('barcodeResult');
                resultDiv.innerHTML = '<div style="text-align: center; padding: 20px;">ðŸ” Looking up product...</div>';
                
                try {
                    // Use Open Food Facts API
                    const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                    const data = await response.json();
                    
                    if (data.status === 1) {
                        const product = data.product;
                        const nutriments = product.nutriments;
                        
                        const servingSize = product.serving_size || '100g';
                        const calories = Math.round(nutriments.energy_value || nutriments['energy-kcal'] || 0);
                        const protein = Math.round(nutriments.proteins || 0);
                        const carbs = Math.round(nutriments.carbohydrates || 0);
                        const fat = Math.round(nutriments.fat || 0);
                        
                        resultDiv.innerHTML = `
                            <div class="premium-stat-card">
                                <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">${product.product_name || 'Unknown Product'}</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">${product.brands || ''} â€¢ ${servingSize}</div>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Calories</div>
                                        <div style="font-size: 24px; font-weight: 700;">${calories}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Protein</div>
                                        <div style="font-size: 24px; font-weight: 700; color: var(--success);">${protein}g</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Carbs</div>
                                        <div style="font-size: 24px; font-weight: 700;">${carbs}g</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Fat</div>
                                        <div style="font-size: 24px; font-weight: 700;">${fat}g</div>
                                    </div>
                                </div>
                                
                                <button class="btn btn-primary" onclick="app.logScannedFood('${product.product_name}', ${calories}, ${protein}, ${carbs}, ${fat})" style="width: 100%;">
                                    Log to Nutrition
                                </button>
                            </div>
                        `;
                        
                    } else {
                        resultDiv.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                Product not found. Try scanning again or enter manually.
                            </div>
                        `;
                    }
                    
                } catch (err) {
                    console.error('Barcode lookup failed:', err);
                    resultDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--danger);">
                            Lookup failed. Check internet connection.
                        </div>
                    `;
                }
            },

            logScannedFood(name, calories, protein, carbs, fat) {
                const today = new Date().toISOString().split('T')[0];
                if (!this.dailyLogs[today]) this.dailyLogs[today] = {};
                
                this.dailyLogs[today].caloriesIn = (this.dailyLogs[today].caloriesIn || 0) + calories;
                this.dailyLogs[today].protein = (this.dailyLogs[today].protein || 0) + protein;
                this.dailyLogs[today].carbs = (this.dailyLogs[today].carbs || 0) + carbs;
                this.dailyLogs[today].fat = (this.dailyLogs[today].fat || 0) + fat;
                
                // Add to meal log
                if (!this.dailyLogs[today].meals) this.dailyLogs[today].meals = [];
                this.dailyLogs[today].meals.push({ name, calories, protein, carbs, fat, time: new Date().toLocaleTimeString() });
                
                this.saveDailyLogs();
                document.querySelector('.modal')?.remove();
                this.renderHealth();
                this.showNotification(`âœ… Logged: ${name}`);
            },

            async generateMealPlan() {
                const days = prompt('How many days?', '7');
                if (!days) return;
                
                const calories = prompt('Target calories per day?', '2000');
                if (!calories) return;
                
                const protein = prompt('Target protein (g)?', '150');
                if (!protein) return;
                
                const preferences = prompt('Any preferences? (e.g., vegetarian, high carb, low fat)', 'balanced');
                
                this.showNotification('ðŸ¤– AI generating meal plan...');
                
                try {
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 2000,
                            messages: [{
                                role: "user",
                                content: `Create a ${days}-day meal plan with ${calories} calories and ${protein}g protein per day.
Preferences: ${preferences}

Return ONLY valid JSON (no markdown):
{
  "days": [
    {
      "day": 1,
      "meals": [
        {
          "name": "Meal name",
          "calories": number,
          "protein": number,
          "carbs": number,
          "fat": number,
          "ingredients": ["item1", "item2"]
        }
      ]
    }
  ]
}`
                            }]
                        })
                    });
                    
                    const data = await response.json();
                    const text = data.content[0].text;
                    const mealPlan = JSON.parse(text);
                    
                    this.showMealPlanModal(mealPlan);
                    
                } catch (err) {
                    console.error('Meal plan generation failed:', err);
                    alert('Failed to generate meal plan. Try again.');
                }
            },

            showMealPlanModal(mealPlan) {
                const html = `
                    <div class="modal active" id="mealPlanModal" style="display: flex;">
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">
                                <h2 class="modal-title">${mealPlan.days.length}-Day Meal Plan</h2>
                                <button class="close-btn" onclick="document.getElementById('mealPlanModal').remove()">Ã—</button>
                            </div>
                            
                            <div style="max-height: 500px; overflow-y: auto;">
                                ${mealPlan.days.map(day => `
                                    <div class="premium-stat-card" style="margin-bottom: 16px;">
                                        <div class="premium-stat-header">Day ${day.day}</div>
                                        ${day.meals.map(meal => `
                                            <div style="padding: 12px 0; border-bottom: 1px solid var(--border);">
                                                <div style="font-weight: 600; margin-bottom: 4px;">${meal.name}</div>
                                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">
                                                    ${meal.calories} cal â€¢ ${meal.protein}g protein â€¢ ${meal.carbs}g carbs â€¢ ${meal.fat}g fat
                                                </div>
                                                <div style="font-size: 11px; color: var(--text-secondary);">
                                                    ${meal.ingredients.join(', ')}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `).join('')}
                            </div>
                            
                            <button class="btn btn-primary" onclick="app.saveMealPlan(${JSON.stringify(mealPlan).replace(/"/g, '&quot;')})" style="width: 100%; margin-top: 16px;">
                                Save Meal Plan
                            </button>
                            <button class="btn btn-secondary" onclick="document.getElementById('mealPlanModal').remove()" style="width: 100%; margin-top: 8px;">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', html);
            },

            saveMealPlan(mealPlan) {
                this.currentMealPlan = mealPlan;
                localStorage.setItem('mealPlan', JSON.stringify(mealPlan));
                document.getElementById('mealPlanModal')?.remove();
                this.showNotification('âœ… Meal plan saved!');
            },

            async syncHealthData() {
                // Check platform and available APIs
                const isApple = /iPhone|iPad|iPod/.test(navigator.userAgent);
                const isAndroid = /Android/.test(navigator.userAgent);
                
                if (!isApple && !isAndroid) {
                    alert('Health data sync is only available on mobile devices.\n\nOn iOS: requires Apple Health\nOn Android: requires Google Fit');
                    return;
                }
                
                // Request HealthKit permission (iOS)
                if (isApple && window.webkit?.messageHandlers?.healthKit) {
                    try {
                        const granted = await this.requestHealthKitPermission();
                        if (granted) {
                            await this.importAppleHealthData();
                        }
                    } catch (err) {
                        alert('Apple Health not available. This feature requires the native iOS app.');
                    }
                }
                // Request Google Fit permission (Android)
                else if (isAndroid && window.Android?.requestFitPermission) {
                    try {
                        const granted = await window.Android.requestFitPermission();
                        if (granted) {
                            await this.importGoogleFitData();
                        }
                    } catch (err) {
                        alert('Google Fit not available. This feature requires the native Android app.');
                    }
                }
                // Web fallback: show manual entry instructions
                else {
                    this.showManualHealthEntry();
                }
            },

            async requestHealthKitPermission() {
                return new Promise((resolve) => {
                    // Request read permission for: sleep, steps, heart rate, active energy
                    window.webkit.messageHandlers.healthKit.postMessage({
                        action: 'requestPermission',
                        types: ['sleepAnalysis', 'stepCount', 'heartRate', 'activeEnergyBurned']
                    });
                    
                    // Listen for response
                    window.healthKitCallback = (granted) => resolve(granted);
                    setTimeout(() => resolve(false), 5000); // timeout
                });
            },

            async importAppleHealthData() {
                this.showNotification('ðŸ“± Importing from Apple Health...');
                
                // Get last 7 days of data
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 7);
                
                window.webkit.messageHandlers.healthKit.postMessage({
                    action: 'queryData',
                    startDate: startDate.toISOString(),
                    endDate: endDate.toISOString()
                });
                
                // Callback receives data
                window.healthKitDataCallback = (data) => {
                    this.processHealthData(data);
                    this.showNotification('âœ… Imported from Apple Health!');
                };
            },

            async importGoogleFitData() {
                this.showNotification('ðŸ“± Importing from Google Fit...');
                
                const endDate = Date.now();
                const startDate = endDate - (7 * 24 * 60 * 60 * 1000); // 7 days ago
                
                const data = await window.Android.queryFitData(startDate, endDate);
                this.processHealthData(JSON.parse(data));
                this.showNotification('âœ… Imported from Google Fit!');
            },

            processHealthData(data) {
                // Data format: { date: string, sleep: number, steps: number, heartRate: number, calories: number }[]
                data.forEach(day => {
                    const existing = this.dailyLogs[day.date] || {};
                    
                    // Merge imported data with existing
                    this.dailyLogs[day.date] = {
                        ...existing,
                        sleep: day.sleep || existing.sleep,
                        rhr: day.heartRate || existing.rhr,
                        steps: day.steps || existing.steps,
                        caloriesOut: day.calories || existing.caloriesOut,
                        importedFrom: data.source || 'health_app',
                        lastImport: new Date().toISOString()
                    };
                });
                
                this.saveDailyLogs();
                this.renderHealth();
            },

            exportWorkoutToHealthApp(session) {
                const isApple = /iPhone|iPad|iPod/.test(navigator.userAgent);
                const isAndroid = /Android/.test(navigator.userAgent);
                
                // Calculate workout metrics
                const totalVolume = session.exercises.reduce((sum, ex) => 
                    sum + ex.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                );
                const estimatedCalories = Math.round(totalVolume * 0.05); // Rough estimate: 0.05 cal per kg lifted
                
                // Export to Apple Health
                if (isApple && window.webkit?.messageHandlers?.healthKit) {
                    window.webkit.messageHandlers.healthKit.postMessage({
                        action: 'saveWorkout',
                        type: 'traditionalStrengthTraining',
                        startDate: session.startTime || new Date(session.date).toISOString(),
                        endDate: session.endTime || new Date().toISOString(),
                        duration: session.duration,
                        energyBurned: estimatedCalories,
                        metadata: {
                            exercises: session.exercises.length,
                            totalVolume: totalVolume,
                            notes: session.notes
                        }
                    });
                }
                
                // Export to Google Fit
                if (isAndroid && window.Android?.saveWorkout) {
                    window.Android.saveWorkout(JSON.stringify({
                        activityType: 'strength_training',
                        startTime: new Date(session.date).getTime(),
                        endTime: new Date(session.date).getTime() + (session.duration * 1000),
                        calories: estimatedCalories,
                        description: session.exercises.map(e => e.name).join(', ')
                    }));
                }
            },

            showManualHealthEntry() {
                alert('ðŸ”„ Health Data Sync\n\nThis feature works best in the native mobile app.\n\nFor web:\n1. Open Apple Health / Google Fit\n2. Manually log data in the Health tab\n\nNative app features:\nâ€¢ Auto-sync sleep data\nâ€¢ Import steps & heart rate\nâ€¢ Background updates\n\nDownload from App Store / Play Store (coming soon)');
            },

            renderMiniSparkline(data) {
                // Show last 7 days as tiny line chart
                if (!data || data.length < 2) return '';
                
                const last7 = data.slice(-7);
                const max = Math.max(...last7.filter(Boolean));
                const min = Math.min(...last7.filter(Boolean));
                const range = max - min || 1;
                
                const points = last7.map((val, i) => {
                    if (!val) return '';
                    const x = (i / (last7.length - 1)) * 100;
                    const y = 100 - ((val - min) / range * 100);
                    return `${x},${y}`;
                }).filter(Boolean).join(' ');
                
                if (!points) return '';
                
                return `
                    <svg width="100%" height="24" style="margin-top: 6px;">
                        <polyline 
                            points="${points}" 
                            fill="none" 
                            stroke="var(--text-secondary)" 
                            stroke-width="2" 
                            opacity="0.4"
                            vector-effect="non-scaling-stroke"
                        />
                    </svg>
                `;
            },

            quickLogMetric(tab) {
                // Open log modal with specific tab pre-selected
                this._preSelectedTab = tab;
                this.logDailyHealth();
            },

            expandMetric(type) {
                // Open log modal with specific tab pre-selected
                this.logDailyHealth();
                // Could add logic to auto-focus the relevant tab
            },

            logDailyHealth() {
                const today = new Date().toISOString().split('T')[0];
                const existing = this.dailyLogs[today] || {};
                
                // Determine initial tab (from quickLogMetric or default to recovery)
                const initialTab = this._preSelectedTab || 'recovery';
                this._preSelectedTab = null; // Reset after use

                document.body.insertAdjacentHTML('beforeend', `
                    <div class="modal active" id="logHealthModal" style="display: flex;">
                        <div class="modal-content" style="padding-bottom: 32px;">
                            <div class="modal-header">
                                <h2 class="modal-title">Daily Log</h2>
                                <button class="close-btn" onclick="document.getElementById('logHealthModal').remove()">Ã—</button>
                            </div>

                            <!-- Tab switcher -->
                            <div style="display: flex; gap: 4px; background: var(--surface2); border-radius: 12px; padding: 4px; margin-bottom: 24px;">
                                <button onclick="app.switchLogTab('recovery')" id="logTab-recovery" style="flex:1; padding: 8px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; background: ${initialTab === 'recovery' ? 'var(--surface)' : 'transparent'}; color: ${initialTab === 'recovery' ? 'var(--text-primary)' : 'var(--text-secondary)'}; font-family: 'DM Sans', sans-serif;">Recovery</button>
                                <button onclick="app.switchLogTab('nutrition')" id="logTab-nutrition" style="flex:1; padding: 8px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; background: ${initialTab === 'nutrition' ? 'var(--surface)' : 'transparent'}; color: ${initialTab === 'nutrition' ? 'var(--text-primary)' : 'var(--text-secondary)'}; font-family: 'DM Sans', sans-serif;">Nutrition</button>
                                <button onclick="app.switchLogTab('body')" id="logTab-body" style="flex:1; padding: 8px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; background: ${initialTab === 'body' ? 'var(--surface)' : 'transparent'}; color: ${initialTab === 'body' ? 'var(--text-primary)' : 'var(--text-secondary)'}; font-family: 'DM Sans', sans-serif;">Body</button>
                            </div>

                            <!-- RECOVERY TAB -->
                            <div id="logSection-recovery" style="display:${initialTab === 'recovery' ? 'block' : 'none'};"
                                <div class="metric-input-group">
                                    <label class="metric-label">Hours Slept</label>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <input type="range" min="3" max="12" step="0.5" id="healthSleep" 
                                            value="${existing.sleep || 7}" oninput="document.getElementById('sleepVal').textContent = this.value + 'h'"
                                            style="flex:1; accent-color: var(--text-primary);">
                                        <span id="sleepVal" style="font-size: 18px; font-weight: 700; min-width: 40px; text-align: right; font-family: 'DM Mono', monospace;">${existing.sleep || 7}h</span>
                                    </div>
                                </div>

                                <div class="metric-input-group">
                                    <label class="metric-label">Sleep Quality</label>
                                    <div style="display: flex; gap: 6px;">
                                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `
                                            <button onclick="app.selectRating('sleepQuality', ${n}, this)" 
                                                style="flex:1; aspect-ratio:1; border-radius: 8px; border: 1px solid var(--border); 
                                                background: ${existing.sleepQuality === n ? 'var(--text-primary)' : 'var(--surface2)'}; 
                                                color: ${existing.sleepQuality === n ? 'var(--background)' : 'var(--text-secondary)'}; 
                                                font-size: 12px; font-weight: 600; cursor: pointer; font-family: 'DM Sans', sans-serif;">${n}</button>
                                        `).join('')}
                                    </div>
                                    <input type="hidden" id="healthSleepQuality" value="${existing.sleepQuality || ''}">
                                </div>

                                <div class="metric-input-group">
                                    <label class="metric-label">Energy Level</label>
                                    <div style="display: flex; gap: 6px;">
                                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `
                                            <button onclick="app.selectRating('energy', ${n}, this)" 
                                                style="flex:1; aspect-ratio:1; border-radius: 8px; border: 1px solid var(--border); 
                                                background: ${existing.energy === n ? 'var(--text-primary)' : 'var(--surface2)'}; 
                                                color: ${existing.energy === n ? 'var(--background)' : 'var(--text-secondary)'}; 
                                                font-size: 12px; font-weight: 600; cursor: pointer; font-family: 'DM Sans', sans-serif;">${n}</button>
                                        `).join('')}
                                    </div>
                                    <input type="hidden" id="healthEnergy" value="${existing.energy || ''}">
                                </div>

                                <div class="metric-input-group">
                                    <label class="metric-label">Stress Level</label>
                                    <div style="display: flex; gap: 6px;">
                                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `
                                            <button onclick="app.selectRating('stress', ${n}, this)" 
                                                style="flex:1; aspect-ratio:1; border-radius: 8px; border: 1px solid var(--border); 
                                                background: ${existing.stress === n ? 'var(--text-primary)' : 'var(--surface2)'}; 
                                                color: ${existing.stress === n ? 'var(--background)' : 'var(--text-secondary)'}; 
                                                font-size: 12px; font-weight: 600; cursor: pointer; font-family: 'DM Sans', sans-serif;">${n}</button>
                                        `).join('')}
                                    </div>
                                    <input type="hidden" id="healthStress" value="${existing.stress || ''}">
                                </div>

                                <div class="metric-input-group">
                                    <label class="metric-label">Muscle Soreness</label>
                                    <div style="display: flex; gap: 6px;">
                                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `
                                            <button onclick="app.selectRating('soreness', ${n}, this)" 
                                                style="flex:1; aspect-ratio:1; border-radius: 8px; border: 1px solid var(--border); 
                                                background: ${existing.soreness === n ? 'var(--text-primary)' : 'var(--surface2)'}; 
                                                color: ${existing.soreness === n ? 'var(--background)' : 'var(--text-secondary)'}; 
                                                font-size: 12px; font-weight: 600; cursor: pointer; font-family: 'DM Sans', sans-serif;">${n}</button>
                                        `).join('')}
                                    </div>
                                    <input type="hidden" id="healthSoreness" value="${existing.soreness || ''}">
                                </div>

                                <div class="metric-input-group">
                                    <label class="metric-label">Resting Heart Rate (bpm)</label>
                                    <input type="number" id="healthRHR" class="metric-input" placeholder="55" value="${existing.rhr || ''}">
                                </div>

                                <div class="metric-input-group">
                                    <label class="metric-label">HRV (ms) â€” optional</label>
                                    <input type="number" id="healthHRV" class="metric-input" placeholder="85" value="${existing.hrv || ''}">
                                </div>

                                <div class="metric-input-group">
                                    <label class="metric-label">Notes</label>
                                    <textarea id="healthNotes" class="metric-input" rows="2" placeholder="How are you feeling?">${existing.notes || ''}</textarea>
                                </div>
                            </div>

                            <!-- NUTRITION TAB -->
                            <div id="logSection-nutrition" style="display:${initialTab === 'nutrition' ? 'block' : 'none'};">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                    <div>
                                        <label class="metric-label">Calories</label>
                                        <input type="number" id="healthCaloriesIn" class="metric-input" 
                                            placeholder="${this.settings.calTarget || 2500}" 
                                            value="${existing.caloriesIn || ''}"
                                            oninput="app.updateCalRemaining()">
                                        ${this.settings.calTarget ? `<div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;" id="calRemaining">Target: ${this.settings.calTarget} kcal</div>` : ''}
                                    </div>
                                    <div>
                                        <label class="metric-label">Water (glasses)</label>
                                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 0;">
                                            <button onclick="app.adjustWater(-1)" style="width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:var(--surface2);font-size:18px;cursor:pointer;">âˆ’</button>
                                            <span id="waterDisplay" style="font-size:22px;font-weight:700;font-family:'DM Mono',monospace;min-width:24px;text-align:center;">${existing.water || 0}</span>
                                            <button onclick="app.adjustWater(1)" style="width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:var(--surface2);font-size:18px;cursor:pointer;">+</button>
                                        </div>
                                        <input type="hidden" id="healthWater" value="${existing.water || 0}">
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 16px;">
                                    <div>
                                        <label class="metric-label">Protein (g)</label>
                                        <input type="number" id="healthProtein" class="metric-input" 
                                            placeholder="${this.settings.proteinTarget || 160}" 
                                            value="${existing.protein || ''}">
                                    </div>
                                    <div>
                                        <label class="metric-label">Carbs (g)</label>
                                        <input type="number" id="healthCarbs" class="metric-input" 
                                            placeholder="${this.settings.carbTarget || 250}" 
                                            value="${existing.carbs || ''}">
                                    </div>
                                    <div>
                                        <label class="metric-label">Fats (g)</label>
                                        <input type="number" id="healthFats" class="metric-input" 
                                            placeholder="${this.settings.fatTarget || 80}" 
                                            value="${existing.fats || ''}">
                                    </div>
                                </div>

                                <!-- Quick add common foods -->
                                <div class="metric-input-group">
                                    <label class="metric-label">Quick Add Food</label>
                                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                        <input type="text" id="foodSearch" class="metric-input" placeholder="e.g. chicken breast, rice..." 
                                            oninput="app.searchFood(this.value)" style="flex:1;">
                                    </div>
                                    <div id="foodResults" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
                                </div>

                                <div class="metric-input-group">
                                    <label class="metric-label">Steps</label>
                                    <input type="number" id="healthSteps" class="metric-input" placeholder="10000" value="${existing.steps || ''}">
                                </div>

                                <div class="metric-input-group">
                                    <label class="metric-label">Calories Burned</label>
                                    <input type="number" id="healthCalories" class="metric-input" placeholder="2500" value="${existing.calories || ''}">
                                </div>
                            </div>

                            <!-- BODY TAB -->
                            <div id="logSection-body" style="display:${initialTab === 'body' ? 'block' : 'none'};">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label class="metric-label">Weight (kg)</label>
                                        <input type="number" step="0.1" id="bodyWeight" class="metric-input" 
                                            placeholder="75.0" value="${this.bodyMetrics[this.bodyMetrics.length-1]?.weight || ''}">
                                    </div>
                                    <div>
                                        <label class="metric-label">Body Fat %</label>
                                        <input type="number" step="0.1" id="bodyFat" class="metric-input" 
                                            placeholder="15.0" value="${this.bodyMetrics[this.bodyMetrics.length-1]?.bodyFat || ''}">
                                    </div>
                                </div>
                                <div style="margin-top: 12px;">
                                    <label class="metric-label">Eating Quality (1-10)</label>
                                    <div style="display: flex; gap: 6px; margin-top: 4px;">
                                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `
                                            <button onclick="app.selectRating('eatingQuality', ${n}, this)" 
                                                style="flex:1; aspect-ratio:1; border-radius: 8px; border: 1px solid var(--border); 
                                                background: ${existing.eatingQuality === n ? 'var(--text-primary)' : 'var(--surface2)'}; 
                                                color: ${existing.eatingQuality === n ? 'var(--background)' : 'var(--text-secondary)'}; 
                                                font-size: 12px; font-weight: 600; cursor: pointer; font-family: 'DM Sans', sans-serif;">${n}</button>
                                        `).join('')}
                                    </div>
                                    <input type="hidden" id="healthEatingQuality" value="${existing.eatingQuality || ''}">
                                </div>

                                ${this.bodyMetrics.length > 0 ? `
                                    <div style="margin-top: 20px;">
                                        <label class="metric-label">Weight History</label>
                                        <div style="display: flex; align-items: flex-end; gap: 4px; height: 60px; margin-top: 8px;">
                                            ${this.bodyMetrics.slice(-14).map(m => {
                                                const vals = this.bodyMetrics.slice(-14).map(x => x.weight).filter(Boolean);
                                                const min = Math.min(...vals), max = Math.max(...vals);
                                                const range = max - min || 1;
                                                const pct = ((m.weight - min) / range * 70 + 20);
                                                return `<div style="flex:1; background: var(--text-primary); border-radius: 3px 3px 0 0; height: ${pct}%; opacity: 0.7;" title="${m.weight}kg"></div>`;
                                            }).join('')}
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                                            <span>${this.bodyMetrics.slice(-14)[0]?.date?.slice(5)}</span>
                                            <span>${this.bodyMetrics[this.bodyMetrics.length-1]?.weight}kg</span>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <button class="btn btn-primary" onclick="app.saveDailyHealth()" style="margin-top: 20px;">Save</button>
                        </div>
                    </div>
                `);
            },

            switchLogTab(tab) {
                ['recovery', 'nutrition', 'body'].forEach(t => {
                    document.getElementById(`logSection-${t}`).style.display = t === tab ? 'block' : 'none';
                    const btn = document.getElementById(`logTab-${t}`);
                    btn.style.background = t === tab ? 'var(--surface)' : 'transparent';
                    btn.style.color = t === tab ? 'var(--text-primary)' : 'var(--text-secondary)';
                });
            },

            selectRating(field, value, btn) {
                // Update hidden input
                document.getElementById(`health${field.charAt(0).toUpperCase() + field.slice(1)}`).value = value;
                // Update button styles
                const parent = btn.parentElement;
                parent.querySelectorAll('button').forEach((b, i) => {
                    b.style.background = (i + 1) === value ? 'var(--text-primary)' : 'var(--surface2)';
                    b.style.color = (i + 1) === value ? 'var(--background)' : 'var(--text-secondary)';
                });
            },

            adjustWater(delta) {
                const input = document.getElementById('healthWater');
                const display = document.getElementById('waterDisplay');
                const val = Math.max(0, Math.min(20, parseInt(input.value || 0) + delta));
                input.value = val;
                display.textContent = val;
            },

            updateCalRemaining() {
                const el = document.getElementById('calRemaining');
                if (!el) return;
                const target = this.settings.calTarget || 2500;
                const consumed = parseInt(document.getElementById('healthCaloriesIn').value) || 0;
                const remaining = target - consumed;
                el.textContent = remaining >= 0 
                    ? `${remaining} kcal remaining` 
                    : `${Math.abs(remaining)} kcal over target`;
                el.style.color = remaining >= 0 ? 'var(--success)' : 'var(--danger)';
            },

            searchFood(query) {
                const results = document.getElementById('foodResults');
                if (!query || query.length < 2) { results.innerHTML = ''; return; }
                
                // Local database for instant results
                const foods = [
                    { name: 'Chicken Breast', cal: 165, p: 31, c: 0, f: 4, per: '100g' },
                    { name: 'Chicken Thigh', cal: 209, p: 26, c: 0, f: 11, per: '100g' },
                    { name: 'Salmon', cal: 208, p: 20, c: 0, f: 13, per: '100g' },
                    { name: 'Tuna (canned)', cal: 128, p: 28, c: 0, f: 1, per: '100g' },
                    { name: 'Eggs (2 large)', cal: 140, p: 12, c: 1, f: 10, per: '2 eggs' },
                    { name: 'Greek Yogurt', cal: 100, p: 17, c: 6, f: 0, per: '170g' },
                    { name: 'Cottage Cheese', cal: 98, p: 11, c: 4, f: 4, per: '100g' },
                    { name: 'Whey Protein', cal: 120, p: 24, c: 3, f: 2, per: '1 scoop' },
                    { name: 'White Rice', cal: 206, p: 4, c: 45, f: 0, per: '1 cup cooked' },
                    { name: 'Brown Rice', cal: 216, p: 5, c: 45, f: 2, per: '1 cup cooked' },
                    { name: 'Oats', cal: 154, p: 5, c: 28, f: 3, per: '40g dry' },
                    { name: 'Sweet Potato', cal: 103, p: 2, c: 24, f: 0, per: '1 medium' },
                    { name: 'Pasta', cal: 220, p: 8, c: 43, f: 1, per: '80g dry' },
                    { name: 'Bread (slice)', cal: 79, p: 3, c: 15, f: 1, per: '1 slice' },
                    { name: 'Banana', cal: 105, p: 1, c: 27, f: 0, per: '1 medium' },
                    { name: 'Apple', cal: 95, p: 0, c: 25, f: 0, per: '1 medium' },
                    { name: 'Avocado', cal: 234, p: 3, c: 12, f: 21, per: '1 medium' },
                    { name: 'Olive Oil', cal: 119, p: 0, c: 0, f: 14, per: '1 tbsp' },
                    { name: 'Almonds', cal: 164, p: 6, c: 6, f: 14, per: '28g' },
                    { name: 'Peanut Butter', cal: 190, p: 8, c: 6, f: 16, per: '2 tbsp' },
                    { name: 'Milk (whole)', cal: 149, p: 8, c: 12, f: 8, per: '1 cup' },
                    { name: 'Beef (lean mince)', cal: 215, p: 26, c: 0, f: 12, per: '100g' },
                    { name: 'Steak (sirloin)', cal: 207, p: 26, c: 0, f: 11, per: '100g' },
                    { name: 'Broccoli', cal: 55, p: 4, c: 11, f: 1, per: '1 cup' },
                ];
                
                const matches = foods.filter(f => f.name.toLowerCase().includes(query.toLowerCase())).slice(0, 6);
                
                results.innerHTML = matches.map(f => `
                    <button onclick="app.addFood(${f.cal}, ${f.p}, ${f.c}, ${f.f})"
                        style="padding: 8px 10px; border: 1px solid var(--border); border-radius: 10px; background: var(--surface2); 
                        cursor: pointer; text-align: left; font-family: 'DM Sans', sans-serif; width: 100%;">
                        <div style="font-size: 13px; font-weight: 600; color: var(--text-primary);">${f.name} <span style="font-weight:400;color:var(--text-secondary);">${f.per}</span></div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">${f.cal} kcal &nbsp;Â·&nbsp; ${f.p}g protein &nbsp;Â·&nbsp; ${f.c}g carbs &nbsp;Â·&nbsp; ${f.f}g fat</div>
                    </button>
                `).join('') || `<div style="font-size: 13px; color: var(--text-secondary); padding: 8px 0;">No matches â€” try chicken, rice, oats, etc.</div>`;
            },

            addFood(cal, protein, carbs, fats) {
                const add = (id, val) => {
                    const el = document.getElementById(id);
                    el.value = (parseInt(el.value) || 0) + val;
                };
                add('healthCaloriesIn', cal);
                add('healthProtein', protein);
                add('healthCarbs', carbs);
                add('healthFats', fats);
                document.getElementById('foodSearch').value = '';
                document.getElementById('foodResults').innerHTML = '';
                this.updateCalRemaining();
                this.showNotification(`+${cal} kcal added`);
            },

            async saveDailyHealth() {
                const today = new Date().toISOString().split('T')[0];
                
                const log = {
                    date: today,
                    sleep: parseFloat(document.getElementById('healthSleep')?.value) || null,
                    sleepQuality: parseInt(document.getElementById('healthSleepQuality')?.value) || null,
                    rhr: parseInt(document.getElementById('healthRHR')?.value) || null,
                    hrv: parseInt(document.getElementById('healthHRV')?.value) || null,
                    energy: parseInt(document.getElementById('healthEnergy')?.value) || null,
                    stress: parseInt(document.getElementById('healthStress')?.value) || null,
                    soreness: parseInt(document.getElementById('healthSoreness')?.value) || null,
                    steps: parseInt(document.getElementById('healthSteps')?.value) || null,
                    calories: parseInt(document.getElementById('healthCalories')?.value) || null,
                    water: parseInt(document.getElementById('healthWater')?.value) || null,
                    notes: document.getElementById('healthNotes')?.value || '',
                    caloriesIn: parseInt(document.getElementById('healthCaloriesIn')?.value) || null,
                    protein: parseInt(document.getElementById('healthProtein')?.value) || null,
                    carbs: parseInt(document.getElementById('healthCarbs')?.value) || null,
                    fats: parseInt(document.getElementById('healthFats')?.value) || null,
                    eatingQuality: parseInt(document.getElementById('healthEatingQuality')?.value) || null
                };
                
                this.dailyLogs[today] = log;
                await this.saveDailyLogs();

                // Save body metrics if entered
                const bw = parseFloat(document.getElementById('bodyWeight')?.value);
                const bf = parseFloat(document.getElementById('bodyFat')?.value);
                if (bw || bf) {
                    const existing = this.bodyMetrics.findIndex(m => m.date === today);
                    const metric = { date: today, weight: bw || null, bodyFat: bf || null };
                    if (existing >= 0) this.bodyMetrics[existing] = metric;
                    else this.bodyMetrics.push(metric);
                    this.bodyMetrics.sort((a, b) => a.date.localeCompare(b.date));
                    await this.saveBodyMetrics();
                }
                
                document.getElementById('logHealthModal').remove();
                this.renderHealth();
                this.showNotification('Health data saved!');
            },

            calculateReadinessScore(log) {
                let score = 50; // Base score
                let factors = [];
                
                // Sleep (30 points max)
                if (log.sleep) {
                    if (log.sleep >= 8) {
                        score += 30;
                        factors.push('Great sleep');
                    } else if (log.sleep >= 7) {
                        score += 20;
                        factors.push('Good sleep');
                    } else if (log.sleep >= 6) {
                        score += 10;
                        factors.push('Adequate sleep');
                    } else {
                        factors.push('Low sleep');
                    }
                }
                
                // Energy (20 points max)
                if (log.energy) {
                    score += (log.energy - 5) * 4;
                    if (log.energy >= 8) factors.push('High energy');
                    else if (log.energy <= 4) factors.push('Low energy');
                }
                
                // Soreness (reduce score)
                if (log.soreness) {
                    score -= (log.soreness - 3) * 3;
                    if (log.soreness >= 7) factors.push('Very sore');
                }
                
                // Stress (reduce score)
                if (log.stress) {
                    score -= (log.stress - 4) * 2;
                    if (log.stress >= 7) factors.push('High stress');
                }
                
                // RHR (if available)
                if (log.rhr) {
                    const avgRHR = this.calculateAverage(
                        Object.values(this.dailyLogs).map(l => l.rhr).filter(Boolean)
                    );
                    if (avgRHR && log.rhr < avgRHR - 3) {
                        score += 10;
                        factors.push('Low RHR (well rested)');
                    } else if (avgRHR && log.rhr > avgRHR + 5) {
                        score -= 10;
                        factors.push('Elevated RHR');
                    }
                }
                
                // Cap between 0-100
                score = Math.max(0, Math.min(100, score));
                
                let status, recommendation;
                if (score >= 85) {
                    status = 'Excellent - Peak Performance';
                    recommendation = 'ðŸ’ª Perfect day for PRs and heavy lifting!';
                } else if (score >= 70) {
                    status = 'Good - Ready to Train';
                    recommendation = 'âœ… Good to train hard. Push yourself!';
                } else if (score >= 55) {
                    status = 'Moderate - Train Smart';
                    recommendation = 'âš ï¸ Train but listen to your body. Avoid PRs.';
                } else if (score >= 40) {
                    status = 'Low - Light Training';
                    recommendation = 'ðŸŸ¡ Consider light workout or active recovery.';
                } else {
                    status = 'Poor - Rest Day';
                    recommendation = 'ðŸ›‘ Strong rest day candidate. Prioritize recovery.';
                }
                
                return { score: Math.round(score), status, recommendation, factors };
            },

            getWeeklyHealthData() {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                return Object.entries(this.dailyLogs)
                    .filter(([date]) => new Date(date) >= weekAgo)
                    .map(([date, log]) => ({ date, ...log }))
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
            },

            calculateAverage(arr) {
                const filtered = arr.filter(x => x != null && !isNaN(x));
                if (filtered.length === 0) return null;
                return filtered.reduce((sum, val) => sum + val, 0) / filtered.length;
            },


            showNutritionTargets() {
                document.body.insertAdjacentHTML('beforeend', `
                    <div class="modal active" id="nutritionTargetsModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">Nutrition Targets</h2>
                                <button class="close-btn" onclick="document.getElementById('nutritionTargetsModal').remove()">Ã—</button>
                            </div>
                            <div class="metric-input-group">
                                <label class="metric-label">Daily Calories (kcal)</label>
                                <input type="number" id="calTarget" class="metric-input" 
                                    value="${this.settings.calTarget || 2500}" placeholder="2500">
                            </div>
                            <div class="metric-input-group">
                                <label class="metric-label">Protein Target (g)</label>
                                <input type="number" id="proteinTarget" class="metric-input"
                                    value="${this.settings.proteinTarget || 160}" placeholder="160">
                            </div>
                            <div class="metric-input-group">
                                <label class="metric-label">Carbs Target (g)</label>
                                <input type="number" id="carbTarget" class="metric-input"
                                    value="${this.settings.carbTarget || 250}" placeholder="250">
                            </div>
                            <div class="metric-input-group">
                                <label class="metric-label">Fats Target (g)</label>
                                <input type="number" id="fatTarget" class="metric-input"
                                    value="${this.settings.fatTarget || 80}" placeholder="80">
                            </div>
                            <button class="btn btn-primary" onclick="app.saveNutritionTargets()">Save Targets</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('nutritionTargetsModal').remove()">Cancel</button>
                        </div>
                    </div>
                `);
            },

            saveNutritionTargets() {
                this.settings.calTarget = parseFloat(document.getElementById('calTarget').value) || 2500;
                this.settings.proteinTarget = parseFloat(document.getElementById('proteinTarget').value) || 160;
                this.settings.carbTarget = parseFloat(document.getElementById('carbTarget').value) || 250;
                this.settings.fatTarget = parseFloat(document.getElementById('fatTarget').value) || 80;
                this.saveSettings();
                document.getElementById('nutritionTargetsModal').remove();
                this.renderHealth();
                this.showNotification('âœ… Nutrition targets saved!');
            },

            // Enhanced Achievements
            getAllAchievements() {
                const workouts = this.workouts;
                const sessions = this.workoutSessions;
                const totalWorkouts = sessions.length || workouts.length;
                const totalVolume = workouts.reduce((sum, w) =>
                    sum + w.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                );
                const streak = this.calculateStreak();
                const prs = Object.keys(this.personalRecords).length;

                // Cardio stats
                const cardioStats = this.calculateCardioStats();
                const totalCardioKm = cardioStats.totalDistance;
                const totalCardioSessions = cardioStats.totalSessions;

                return [
                    // Workout count
                    { id: 'first_workout', icon: 'ðŸ‹ï¸', name: 'First Step', desc: 'Complete 1 workout', unlocked: totalWorkouts >= 1 },
                    { id: 'ten_workouts', icon: 'ðŸ’ª', name: 'Getting Started', desc: '10 workouts', unlocked: totalWorkouts >= 10 },
                    { id: 'fifty_workouts', icon: 'ðŸ”¥', name: 'Dedicated', desc: '50 workouts', unlocked: totalWorkouts >= 50 },
                    { id: 'century', icon: 'ðŸ’¯', name: 'Century Club', desc: '100 workouts', unlocked: totalWorkouts >= 100 },
                    // Streaks
                    { id: 'streak_3', icon: 'ðŸ“…', name: '3 Day Streak', desc: '3 days in a row', unlocked: streak >= 3 },
                    { id: 'streak_7', icon: 'ðŸ—“ï¸', name: 'Week Warrior', desc: '7 days in a row', unlocked: streak >= 7 },
                    { id: 'streak_30', icon: 'ðŸ“†', name: 'Monthly Master', desc: '30 days in a row', unlocked: streak >= 30 },
                    // Volume
                    { id: 'vol_10k', icon: 'âš¡', name: '10K Club', desc: 'Lift 10,000kg total', unlocked: totalVolume >= 10000 },
                    { id: 'vol_100k', icon: 'ðŸš€', name: '100K Club', desc: 'Lift 100,000kg total', unlocked: totalVolume >= 100000 },
                    { id: 'vol_1m', icon: 'ðŸŒ', name: 'Million Kg', desc: 'Lift 1,000,000kg total', unlocked: totalVolume >= 1000000 },
                    // PRs
                    { id: 'first_pr', icon: 'ðŸ†', name: 'Personal Best', desc: 'Set your first PR', unlocked: prs >= 1 },
                    { id: 'pr_5', icon: 'ðŸ¥‡', name: 'Record Breaker', desc: 'Set 5 PRs', unlocked: prs >= 5 },
                    { id: 'pr_20', icon: 'ðŸ‘‘', name: 'PR Machine', desc: 'Set 20 PRs', unlocked: prs >= 20 },
                    // Cardio - Distance
                    { id: 'first_run', icon: 'ðŸ‘Ÿ', name: 'First Run', desc: 'Complete your first cardio session', unlocked: totalCardioSessions >= 1 },
                    { id: 'cardio_10k', icon: 'ðŸƒ', name: '10K Total', desc: 'Run 10km total distance', unlocked: totalCardioKm >= 10 },
                    { id: 'cardio_50k', icon: 'ðŸŽ½', name: '50K Runner', desc: 'Run 50km total distance', unlocked: totalCardioKm >= 50 },
                    { id: 'cardio_100k', icon: 'ðŸ…', name: 'Centurion', desc: 'Run 100km total distance', unlocked: totalCardioKm >= 100 },
                    { id: 'cardio_500k', icon: 'ðŸŒŸ', name: '500K Legend', desc: 'Run 500km total distance', unlocked: totalCardioKm >= 500 },
                    // Cardio - Speed
                    { id: 'sub30_5k', icon: 'âš¡', name: 'Sub-30 5K', desc: 'Run 5K in under 30 minutes', unlocked: cardioStats.pb5k && cardioStats.pb5k < 30 * 60 },
                    { id: 'sub25_5k', icon: 'ðŸ”¥', name: 'Sub-25 5K', desc: 'Run 5K in under 25 minutes', unlocked: cardioStats.pb5k && cardioStats.pb5k < 25 * 60 },
                    { id: 'sub60_10k', icon: 'ðŸ’¨', name: 'Sub-60 10K', desc: 'Run 10K in under 60 minutes', unlocked: cardioStats.pb10k && cardioStats.pb10k < 60 * 60 },
                    { id: 'sub50_10k', icon: 'ðŸš€', name: 'Sub-50 10K', desc: 'Run 10K in under 50 minutes', unlocked: cardioStats.pb10k && cardioStats.pb10k < 50 * 60 },
                    // Cardio - Consistency
                    { id: 'cardio_week', icon: 'ðŸ“†', name: 'Cardio Week', desc: 'Run 3 times in one week', unlocked: this.achievements.includes('cardio_week') },
                    { id: 'cardio_streak', icon: 'ðŸ”¥', name: 'Cardio Streak', desc: 'Run 5 days in a row', unlocked: this.achievements.includes('cardio_streak') },
                    // Special
                    { id: 'early_bird', icon: 'ðŸŒ…', name: 'Early Bird', desc: 'Log a workout before 7am', unlocked: this.achievements.includes('early_bird') },
                    { id: 'night_owl', icon: 'ðŸ¦‰', name: 'Night Owl', desc: 'Log a workout after 9pm', unlocked: this.achievements.includes('night_owl') },
                    { id: 'big_session', icon: 'ðŸ’¥', name: 'Beast Mode', desc: 'Log 10+ exercises in one session', unlocked: sessions.some(s => s.exercises?.length >= 10) },
                    { id: 'heavy_day', icon: 'ðŸ—ï¸', name: 'Heavy Day', desc: '10,000kg in one session', unlocked: sessions.some(s => s.exercises?.reduce((sum, ex) => sum + ex.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0) >= 10000) },
                    { id: 'consistent', icon: 'ðŸ“Š', name: 'Consistent', desc: 'Work out 4+ days this week', unlocked: [...new Set(this.getWorkoutsInDays(7).map(w => w.date))].length >= 4 },
                    { id: 'health_logger', icon: 'â¤ï¸', name: 'Health Tracker', desc: 'Log health 7 days in a row', unlocked: Object.keys(this.dailyLogs).length >= 7 },
                    { id: 'nutrition_pro', icon: 'ðŸ¥—', name: 'Nutrition Pro', desc: 'Hit protein target 5 days', unlocked: this.achievements.includes('nutrition_pro') },
                ];
            },

            checkAndUnlockAchievements() {
                const all = this.getAllAchievements();
                let newUnlocks = [];
                all.forEach(a => {
                    if (a.unlocked && !this.achievements.includes(a.id)) {
                        this.achievements.push(a.id);
                        newUnlocks.push(a);
                    }
                });
                if (newUnlocks.length > 0) {
                    this.saveAchievements();
                    newUnlocks.forEach(a => {
                        setTimeout(() => this.showNotification(`ðŸ† Achievement: ${a.name}!`), 500);
                    });
                }
            },

            renderAchievementsPage() {
                const all = this.getAllAchievements();
                const unlocked = all.filter(a => a.unlocked).length;

                return `
                    <div class="premium-stat-card">
                        <div class="premium-stat-header">Achievements</div>
                        <div style="text-align: center; padding: 12px 0 20px;">
                            <div style="font-size: 48px; font-weight: 800; color: var(--primary);">${unlocked}</div>
                            <div style="font-size: 14px; color: var(--text-secondary);">of ${all.length} unlocked</div>
                            <div style="background: var(--border); border-radius: 8px; height: 8px; margin: 12px 0; overflow: hidden;">
                                <div style="background: var(--accent); color: #141414; width: ${Math.round(unlocked/all.length*100)}%; height: 100%; border-radius: 8px;"></div>
                            </div>
                        </div>
                        <div class="achievement-grid">
                            ${all.map(a => `
                                <div class="achievement-badge ${a.unlocked ? 'unlocked' : 'locked'}">
                                    <div class="achievement-icon">${a.icon}</div>
                                    <div class="achievement-name">${a.name}</div>
                                    <div class="achievement-desc">${a.desc}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            async syncGarmin() {
                alert('Garmin sync coming soon! Need backend server for OAuth 1.0a security.');
            },

            // Workout History View
            renderHistory() {
                const sessions = [...this.workoutSessions].reverse();
                const filter = this.historyFilter || 'all';
                const searchTerm = this.historySearch || '';
                
                // 12. Lazy loading - show 20 at a time
                const itemsPerPage = 20;
                if (!this.historyPage) this.historyPage = 1;
                
                let html = `
                    <div class="section-header">
                        <div class="section-title">Workout History</div>
                        <div class="section-action" onclick="app.showHistoryFilters()">Filter</div>
                    </div>

                    <input type="text" 
                        class="search-box" 
                        placeholder="Search workouts..." 
                        value="${searchTerm}"
                        oninput="app.filterHistory(this.value)"
                        style="margin-bottom: 16px;">
                `;

                if (sessions.length === 0) {
                    html += `
                        <div class="empty-state">
                            <svg width="120" height="120" viewBox="0 0 120 120" style="opacity: 0.3; margin-bottom: 16px;">
                                <rect x="20" y="30" width="80" height="60" rx="8" fill="none" stroke="currentColor" stroke-width="3"/>
                                <line x1="30" y1="50" x2="70" y2="50" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                                <line x1="30" y1="65" x2="90" y2="65" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                                <line x1="30" y1="80" x2="60" y2="80" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                            </svg>
                            <div class="empty-text">No workout history yet<br>Start your first workout to see it here!</div>
                        </div>
                    `;
                } else {
                    // Group by month
                    const grouped = {};
                    sessions.forEach(session => {
                        const date = new Date(session.date);
                        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                        
                        if (!grouped[monthKey]) {
                            grouped[monthKey] = { name: monthName, sessions: [] };
                        }
                        
                        // Filter by search
                        if (searchTerm) {
                            const searchLower = searchTerm.toLowerCase();
                            const hasMatch = session.exercises.some(ex => 
                                ex.name.toLowerCase().includes(searchLower)
                            ) || session.notes?.toLowerCase().includes(searchLower);
                            
                            if (!hasMatch) return;
                        }
                        
                        grouped[monthKey].sessions.push(session);
                    });

                    // Render groups
                    Object.keys(grouped).sort().reverse().forEach(monthKey => {
                        const group = grouped[monthKey];
                        if (group.sessions.length === 0) return;
                        
                        html += `
                            <div class="premium-stat-header" style="margin: 24px 0 12px 0;">${group.name}</div>
                        `;
                        
                        group.sessions.forEach(session => {
                            const duration = session.duration ? this.formatDuration(session.duration) : 'N/A';
                            const totalVolume = session.exercises.reduce((sum, ex) => 
                                sum + ex.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                            );
                            const totalSets = session.exercises.reduce((sum, ex) => sum + ex.sets.length, 0);
                            const dateObj = new Date(session.date);
                            const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' });
                            
                            html += `
                                <div class="premium-stat-card" onclick="app.viewSessionDetails('${session.id}')" style="cursor: pointer;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                        <div>
                                            <div style="font-size: 15px; font-weight: 600; color: var(--text-primary);">${dayName}</div>
                                            <div style="font-size: 13px; color: var(--text-secondary); margin-top: 2px;">
                                                ${session.exercises.map(e => e.name).slice(0, 3).join(', ')}${session.exercises.length > 3 ? '...' : ''}
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 15px; font-weight: 600; color: var(--text-primary);">${duration}</div>
                                            <div style="font-size: 13px; color: var(--text-secondary);">${totalSets} sets</div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 16px; padding-top: 12px; border-top: 1px solid var(--border);">
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Exercises</div>
                                            <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">${session.exercises.length}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Volume</div>
                                            <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">${this.formatNumber(totalVolume)}kg</div>
                                        </div>
                                        <div style="margin-left: auto;">
                                            <button onclick="app.editSessionNotes('${session.id}', event)" style="background: var(--surface2); border: 1px solid var(--border); padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; color: var(--text-primary);">
                                                ðŸ“ ${session.notes ? 'Edit' : 'Note'}
                                            </button>
                                        </div>
                                    </div>
                                    ${session.notes ? `
                                        <div style="margin-top: 12px; padding: 10px; background: var(--surface2); border-radius: 8px; border-left: 3px solid var(--accent);">
                                            <div style="font-size: 13px; color: var(--text-primary); font-style: italic;">"${session.notes}"</div>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                    });
                }

                // Quick stats summary
                if (sessions.length > 0) {
                    const totalWorkouts = sessions.length;
                    const totalVolume = sessions.reduce((sum, s) => 
                        sum + s.exercises.reduce((esum, ex) => 
                            esum + ex.sets.reduce((ssum, set) => ssum + (set.weight * set.reps), 0), 0
                        ), 0
                    );
                    const avgDuration = sessions
                        .filter(s => s.duration)
                        .reduce((sum, s) => sum + s.duration, 0) / sessions.filter(s => s.duration).length;

                    html += `
                        <div class="premium-stat-card" style="margin-top: 24px; background: var(--chart-bg);">
                            <div class="premium-stat-header" style="margin-bottom: 12px;">All-Time Stats</div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${totalWorkouts}</div>
                                    <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Workouts</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${this.formatNumber(totalVolume)}kg</div>
                                    <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Total Volume</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${Math.round(avgDuration / 60)}min</div>
                                    <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Avg Duration</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                document.getElementById('historyContent').innerHTML = html;
            },

            filterHistory(searchTerm) {
                this.historySearch = searchTerm;
                this.renderHistory();
            },

            getRecentPRs(days) {
                const since = new Date();
                since.setDate(since.getDate() - days);
                
                return this.workouts.filter(w => {
                    const workoutDate = new Date(w.date);
                    return workoutDate >= since && this.checkIfPR(w);
                });
            },

            editSession(sessionId) {
                const session = this.workoutSessions.find(s => s.id == sessionId);
                if (!session) return;
                
                document.getElementById('sessionDetailsModal')?.remove();
                
                // Open edit modal
                let html = `
                    <div class="modal active" id="editSessionModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">Edit Workout</h2>
                                <button class="close-btn" onclick="document.getElementById('editSessionModal').remove()">Ã—</button>
                            </div>
                            
                            ${session.exercises.map((exercise, exIdx) => `
                                <div class="premium-stat-card" style="margin-bottom: 16px;">
                                    <div class="premium-stat-header">${exercise.name}</div>
                                    ${exercise.sets.map((set, setIdx) => `
                                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px;">
                                            <input type="number" min="0" max="1000" step="0.5" value="${set.weight}" id="edit-${exIdx}-${setIdx}-weight" placeholder="Weight" style="padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface2); color: var(--text-primary);">
                                            <input type="number" min="1" max="100" step="1" value="${set.reps}" id="edit-${exIdx}-${setIdx}-reps" placeholder="Reps" style="padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface2); color: var(--text-primary);">
                                            <input type="number" min="1" max="10" step="0.5" value="${set.rpe || ''}" id="edit-${exIdx}-${setIdx}-rpe" placeholder="RPE" style="padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface2); color: var(--text-primary);">
                                            <button onclick="this.parentElement.remove()" style="background: var(--danger); color: white; border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer;">Ã—</button>
                                        </div>
                                    `).join('')}
                                    <button class="btn btn-secondary" onclick="app.addEditSet(${exIdx})" style="margin-top: 8px;">+ Add Set</button>
                                </div>
                            `).join('')}
                            
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-primary" onclick="app.saveEditedSession('${sessionId}')" style="flex: 1;">Save Changes</button>
                                <button class="btn btn-secondary" onclick="document.getElementById('editSessionModal').remove()" style="flex: 1;">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', html);
            },

            addEditSet(exIdx) {
                const container = document.querySelectorAll('.premium-stat-card')[exIdx];
                const setCount = container.querySelectorAll('[id^="edit-"]').length / 3;
                const newSet = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px;">
                        <input type="number" min="0" max="1000" step="0.5" value="" id="edit-${exIdx}-${setCount}-weight" placeholder="Weight" style="padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface2); color: var(--text-primary);">
                        <input type="number" min="1" max="100" step="1" value="" id="edit-${exIdx}-${setCount}-reps" placeholder="Reps" style="padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface2); color: var(--text-primary);">
                        <input type="number" min="1" max="10" step="0.5" value="" id="edit-${exIdx}-${setCount}-rpe" placeholder="RPE" style="padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface2); color: var(--text-primary);">
                        <button onclick="this.parentElement.remove()" style="background: var(--danger); color: white; border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer;">Ã—</button>
                    </div>
                `;
                container.querySelector('.btn-secondary').insertAdjacentHTML('beforebegin', newSet);
            },

            saveEditedSession(sessionId) {
                const session = this.workoutSessions.find(s => s.id == sessionId);
                if (!session) return;
                
                // Collect edited values
                session.exercises.forEach((exercise, exIdx) => {
                    const newSets = [];
                    let setIdx = 0;
                    while (document.getElementById(`edit-${exIdx}-${setIdx}-weight`)) {
                        const weight = parseFloat(document.getElementById(`edit-${exIdx}-${setIdx}-weight`).value) || 0;
                        const reps = parseFloat(document.getElementById(`edit-${exIdx}-${setIdx}-reps`).value) || 0;
                        const rpe = parseFloat(document.getElementById(`edit-${exIdx}-${setIdx}-rpe`).value) || null;
                        
                        if (weight || reps) {
                            newSets.push({ weight, reps, rpe });
                        }
                        setIdx++;
                    }
                    exercise.sets = newSets;
                });
                
                this.saveWorkoutSessions();
                this.updatePersonalRecords();
                document.getElementById('editSessionModal').remove();
                this.renderHistory();
                this.showNotification('âœ… Workout updated!');
            },

            deleteSession(sessionId) {
                const session = this.workoutSessions.find(s => s.id == sessionId);
                if (!session) return;
                
                // Show what's being deleted (7)
                const preview = `${session.exercises.length} exercises, ${session.exercises.reduce((sum, ex) => sum + ex.sets.length, 0)} sets`;
                if (!confirm(`Delete workout from ${session.date}?\n${preview}\n\nThis cannot be undone.`)) return;
                
                // Store for undo (8)
                this._lastDeleted = { type: 'session', data: session };
                
                this.workoutSessions = this.workoutSessions.filter(s => s.id != sessionId);
                this.saveWorkoutSessions();
                document.getElementById('sessionDetailsModal')?.remove();
                this.renderHistory();
                this.renderToday();
                this.showNotification('ðŸ—‘ï¸ Workout deleted', true); // true = show undo
            },

            showNotification(message, showUndo = false) {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.style.cssText = `
                    position: fixed;
                    bottom: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--text-primary);
                    color: var(--background);
                    padding: 12px 20px;
                    border-radius: 12px;
                    font-weight: 600;
                    z-index: 10000;
                    display: flex;
                    gap: 12px;
                    align-items: center;
                    animation: slideUp 0.3s ease;
                `;
                
                notification.innerHTML = `
                    <span>${message}</span>
                    ${showUndo ? `<button onclick="app.undo()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 12px; border-radius: 6px; font-weight: 600; cursor: pointer;">UNDO</button>` : ''}
                `;
                
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), showUndo ? 5000 : 3000);
            },

            showSuccessAnimation() {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.8); z-index: 10000;
                    display: flex; align-items: center; justify-content: center;
                    animation: fadeIn 0.3s;
                `;
                
                overlay.innerHTML = `
                    <div style="text-align: center; transform: scale(0); animation: popIn 0.5s forwards;">
                        <div style="font-size: 80px; margin-bottom: 16px;">âœ…</div>
                        <div style="font-size: 24px; font-weight: 700; color: white; margin-bottom: 8px;">Workout Complete!</div>
                        <div style="font-size: 16px; color: rgba(255,255,255,0.8);">Great work ðŸ’ª</div>
                    </div>
                `;
                
                if (!document.getElementById('successAnimStyles')) {
                    const style = document.createElement('style');
                    style.id = 'successAnimStyles';
                    style.textContent = `
                        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                        @keyframes popIn { 0% { transform: scale(0); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
                    `;
                    document.head.appendChild(style);
                }
                
                document.body.appendChild(overlay);
                setTimeout(() => overlay.remove(), 2000);
            },

            updateSessionTimer() {
                if (!this.sessionStartTime || !this.currentSession) {
                    clearInterval(this.sessionTimerInterval);
                    return;
                }
                
                // 14. Pause timer when tab hidden to save battery
                if (document.hidden) return;
                
                const elapsed = Math.floor((Date.now() - this.sessionStartTime) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                
                const timerEl = document.getElementById('sessionTimer');
                if (timerEl) {
                    timerEl.textContent = hours > 0 
                        ? `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`
                        : `${minutes}:${String(seconds).padStart(2, '0')}`;
                }
            },

            undo() {
                if (!this._lastDeleted) return;
                
                if (this._lastDeleted.type === 'session') {
                    this.workoutSessions.push(this._lastDeleted.data);
                    this.saveWorkoutSessions();
                    this.renderHistory();
                    this.renderToday();
                    this.showNotification('âœ… Workout restored');
                }
                
                this._lastDeleted = null;
                document.querySelector('.notification')?.remove();
            },

            viewSessionDetails(sessionId) {
                const session = this.workoutSessions.find(s => s.id === sessionId);
                if (!session) return;

                const duration = session.duration ? this.formatDuration(session.duration) : 'N/A';
                const totalVolume = session.exercises.reduce((sum, ex) => 
                    sum + ex.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                );
                const totalSets = session.exercises.reduce((sum, ex) => sum + ex.sets.length, 0);

                const html = `
                    <div class="premium-stat-card" style="background: var(--text-primary); color: white; margin-bottom: 16px;">
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">${this.formatDate(session.date)}</div>
                        <div style="display: flex; gap: 24px; opacity: 0.9;">
                            <div>â±ï¸ ${duration}</div>
                            <div>ðŸ’ª ${session.exercises.length} exercises</div>
                            <div>ðŸ“Š ${totalSets} sets</div>
                        </div>
                    </div>

                    ${session.exercises.map((exercise, i) => `
                        <div class="premium-stat-card">
                            <div class="premium-stat-header">${exercise.name}</div>
                            ${exercise.sets.map((set, j) => `
                                <div class="metric-row">
                                    <div class="metric-label-small">Set ${j + 1}</div>
                                    <div class="metric-value-small">${set.weight}kg Ã— ${set.reps} reps${set.rpe ? ` @ RPE ${set.rpe}` : ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}

                    ${session.notes ? `
                        <div class="premium-stat-card">
                            <div class="premium-stat-header">Notes</div>
                            <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">${session.notes}</div>
                        </div>
                    ` : ''}

                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="app.editSession('${sessionId}')" style="flex: 1;">Edit Workout</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('sessionDetailsModal').remove()" style="flex: 1;">Close</button>
                        <button class="btn" onclick="app.deleteSession('${sessionId}')" style="background: var(--danger); color: white; padding: 0 16px;">ðŸ—‘ï¸</button>
                    </div>
                `;

                const modal = `
                    <div class="modal active" id="sessionDetailsModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">Workout Details</h2>
                                <button class="close-btn" onclick="document.getElementById('sessionDetailsModal').remove()">Ã—</button>
                            </div>
                            ${html}
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modal);
            }

        };

        // Initialize app
        window.addEventListener('load', () => app.init());
    </script>
</body>
</html>
