<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Gym Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #00D4AA;
            --primary-dark: #00B894;
            --success: #00D4AA;
            --warning: #FFB800;
            --danger: #FF3B47;
            --background: #FAFAFA;
            --surface: #FFFFFF;
            --text-primary: #1A1A1A;
            --text-secondary: #6B6B6B;
            --border: #E8E8E8;
            --shadow: rgba(0, 0, 0, 0.04);
            --gradient: linear-gradient(135deg, #00D4AA 0%, #00B894 100%);
            --chart-bg: #F5F5F5;
        }

        [data-theme="dark"] {
            --primary: #00D4AA;
            --primary-dark: #00B894;
            --success: #00D4AA;
            --warning: #FFB800;
            --danger: #FF3B47;
            --background: #0A0A0A;
            --surface: #1A1A1A;
            --text-primary: #FFFFFF;
            --text-secondary: #8F8F8F;
            --border: #2A2A2A;
            --shadow: rgba(0, 0, 0, 0.3);
            --gradient: linear-gradient(135deg, #00D4AA 0%, #00B894 100%);
            --chart-bg: #141414;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            overflow-x: hidden;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .app-container {
            max-width: 428px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--background);
            position: relative;
        }

        /* Header */
        .header {
            background: var(--surface);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 34px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .header-btn:active {
            transform: scale(0.95);
            background: var(--primary-dark);
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .theme-toggle {
            background: var(--background);
            border: 1px solid var(--border);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 20px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        /* Tab Bar */
        .tab-bar {
            display: flex;
            background: var(--surface);
            border-top: 1px solid var(--border);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 428px;
            margin: 0 auto;
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .tab {
            flex: 1;
            padding: 8px 0;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 10px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: color 0.2s;
        }

        .tab.active {
            color: var(--primary);
        }

        .tab-icon {
            font-size: 24px;
        }

        /* Content */
        .content {
            padding: 16px 20px 80px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
        }

        .card-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Exercise List */
        .exercise-category {
            margin-bottom: 24px;
        }

        .category-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .exercise-item {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .exercise-item:active {
            transform: scale(0.98);
        }

        .exercise-name {
            font-size: 17px;
            font-weight: 500;
        }

        .exercise-muscle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .chevron {
            color: var(--text-secondary);
            font-size: 20px;
        }

        /* Workout Tracking */
        .exercise-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .exercise-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .last-workout {
            background: #F8F9FA;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .last-workout-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .last-workout-data {
            font-size: 15px;
            color: var(--text-primary);
        }

        .set-list {
            margin-bottom: 16px;
        }

        .set-item {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }

        .set-number {
            width: 40px;
            font-size: 17px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .set-input {
            flex: 1;
            display: flex;
            gap: 8px;
        }

        .input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .input-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 17px;
            background: var(--surface);
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        .delete-set {
            background: var(--danger);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .delete-set:active {
            transform: scale(0.9);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:active {
            background: var(--primary-dark);
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--background);
            color: var(--primary);
        }

        .btn-secondary:active {
            transform: scale(0.98);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:active {
            transform: scale(0.98);
        }

        /* History */
        .history-item {
            margin-bottom: 12px;
        }

        .history-date {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .history-sets {
            font-size: 15px;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-text {
            font-size: 17px;
            color: var(--text-secondary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: flex-end;
        }

        .modal.active {
            display: flex;
        }

        /* Higher z-index for modals that appear on top of other modals */
        #exerciseModal.active,
        #addCustomExerciseModal.active {
            z-index: 2000;
            background: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background: var(--surface);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 428px;
            margin: 0 auto;
            padding: 20px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .search-box {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 17px;
            margin-bottom: 16px;
            background: var(--background);
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stat-change {
            font-size: 12px;
            margin-top: 4px;
            font-weight: 600;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        /* Progress Indicators */
        .pr-badge {
            display: inline-block;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 8px;
            letter-spacing: 0.5px;
        }

        .improvement-badge {
            display: inline-block;
            background: var(--success);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Rest Timer */
        .rest-timer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            z-index: 2000;
            min-width: 280px;
            display: none;
        }

        .rest-timer.active {
            display: block;
        }

        .timer-display {
            font-size: 72px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            margin-bottom: 20px;
        }

        .timer-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .timer-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Charts */
        .chart-container {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            height: 200px;
            position: relative;
        }

        .chart-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .simple-chart {
            display: flex;
            align-items: flex-end;
            height: 140px;
            gap: 8px;
            padding: 0 8px;
        }

        .chart-bar {
            flex: 1;
            background: var(--primary);
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            position: relative;
            transition: all 0.3s;
        }

        .chart-bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .chart-bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Templates */
        .template-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .template-card:active {
            transform: scale(0.98);
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .template-name {
            font-size: 20px;
            font-weight: 600;
        }

        .template-exercises {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .template-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .icon-btn {
            background: var(--background);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            color: var(--primary);
        }

        .icon-btn:active {
            transform: scale(0.95);
        }

        .icon-btn.danger {
            color: var(--danger);
        }

        /* Body Metrics */
        .metric-input-group {
            margin-bottom: 16px;
        }

        .metric-label {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }

        .metric-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 17px;
            background: var(--surface);
        }

        .metric-history {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Swipe Actions */
        .swipeable {
            position: relative;
            overflow: hidden;
        }

        .swipe-actions {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-right: 16px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .swipe-actions.visible {
            opacity: 1;
        }

        .swipe-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            color: white;
        }

        .swipe-btn.edit {
            background: var(--warning);
        }

        .swipe-btn.delete {
            background: var(--danger);
        }

        /* Weight Adjustment Buttons */
        .weight-adjust {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .adjust-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            background: var(--surface);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
        }

        .adjust-btn:active {
            background: var(--background);
        }

        /* Exercise Info */
        .exercise-info {
            background: #F8F9FA;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .info-section {
            margin-bottom: 12px;
        }

        .info-section:last-child {
            margin-bottom: 0;
        }

        .info-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .info-text {
            font-size: 14px;
            line-height: 1.5;
        }

        /* Streak Badge */
        .streak-badge {
            background: var(--gradient);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .streak-icon {
            font-size: 32px;
        }

        .streak-text {
            flex: 1;
        }

        .streak-number {
            font-size: 24px;
            font-weight: 700;
        }

        .streak-label {
            font-size: 13px;
            opacity: 0.9;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
        }

        .section-action {
            color: var(--primary);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .quick-action-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action-btn:active {
            transform: scale(0.98);
            background: var(--background);
        }

        .quick-action-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .quick-action-label {
            font-size: 14px;
            font-weight: 600;
        }

        /* Export Modal */
        .export-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .export-btn {
            padding: 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-btn:active {
            background: var(--background);
        }

        .export-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .export-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Time Range Selector */
        .time-range-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background: var(--background);
            padding: 4px;
            border-radius: 10px;
        }

        .time-range-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-range-btn.active {
            background: var(--surface);
            color: var(--primary);
            box-shadow: 0 2px 4px var(--shadow);
        }

        /* Percentage Badge */
        .percentage {
            font-size: 12px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
        }

        .percentage.up {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success);
        }

        .percentage.down {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger);
        }

        /* Achievement Animations */
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            to {
                transform: translateX(-50%) translateY(-100px);
                opacity: 0;
            }
        }

        /* Whoop-Style Data Visualization */
        .readiness-ring {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }

        .readiness-ring svg {
            transform: rotate(-90deg);
        }

        .readiness-ring-bg {
            fill: none;
            stroke: var(--border);
            stroke-width: 12;
        }

        .readiness-ring-progress {
            fill: none;
            stroke: var(--primary);
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease;
        }

        .readiness-score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .readiness-score-number {
            font-size: 56px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            letter-spacing: -2px;
        }

        .readiness-score-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            margin-top: 4px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label-small {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .metric-value-large {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .metric-value-small {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .metric-change {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            margin-left: 8px;
        }

        .metric-change.positive {
            background: rgba(0, 212, 170, 0.1);
            color: var(--success);
        }

        .metric-change.negative {
            background: rgba(255, 59, 71, 0.1);
            color: var(--danger);
        }

        .mini-chart {
            height: 40px;
            display: flex;
            align-items: flex-end;
            gap: 2px;
        }

        .mini-chart-bar {
            flex: 1;
            background: var(--border);
            border-radius: 2px;
            min-height: 4px;
            transition: all 0.3s;
        }

        .mini-chart-bar.active {
            background: var(--primary);
        }

        .section-divider {
            height: 1px;
            background: var(--border);
            margin: 24px 0;
        }

        .premium-stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
        }

        .premium-stat-header {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .premium-stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            letter-spacing: -1px;
            margin-bottom: 8px;
        }

        .premium-stat-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1>üí™ Gym Tracker</h1>
            <div class="header-actions">
                <button class="theme-toggle" onclick="app.showSearch()" id="searchBtn">üîç</button>
                <button class="theme-toggle" onclick="app.toggleTheme()" id="themeToggle">üåô</button>
                <button class="header-btn" onclick="app.startWorkoutSession()" id="startWorkoutBtn">‚ñ∂Ô∏è Start Workout</button>
            </div>
        </div>

        <!-- Search Modal -->
        <div id="searchModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Search Workouts</h2>
                    <button class="close-btn" onclick="app.closeSearch()">√ó</button>
                </div>
                <input type="text" class="search-box" id="globalSearch" placeholder="Search exercises, dates, notes..." oninput="app.performSearch()">
                <div id="searchResults"></div>
            </div>
        </div>

        <!-- Today View -->
        <div id="today" class="content view active">
            <div id="todayWorkouts"></div>
        </div>

        <!-- Library View -->
        <div id="library" class="content view">
            <div id="exerciseLibrary"></div>
        </div>

        <!-- Analytics View -->
        <div id="analytics" class="content view">
            <div id="analyticsContent"></div>
        </div>

        <!-- Templates View -->
        <div id="templates" class="content view">
            <div id="templatesContent"></div>
        </div>

        <!-- Library View -->
        <div id="library" class="content view">
            <div id="libraryContent"></div>
        </div>

        <!-- Health View -->
        <div id="health" class="content view">
            <div id="healthContent"></div>
        </div>

        <!-- More View -->
        <div id="more" class="content view">
            <div id="moreContent"></div>
        </div>

        <!-- Tab Bar -->
        <div class="tab-bar">
            <button class="tab active" onclick="app.switchTab('today')">
                <span class="tab-icon">üèãÔ∏è</span>
                <span>Today</span>
            </button>
            <button class="tab" onclick="app.switchTab('health')">
                <span class="tab-icon">‚ù§Ô∏è</span>
                <span>Health</span>
            </button>
            <button class="tab" onclick="app.switchTab('analytics')">
                <span class="tab-icon">üìä</span>
                <span>Stats</span>
            </button>
            <button class="tab" onclick="app.switchTab('templates')">
                <span class="tab-icon">üìã</span>
                <span>Programs</span>
            </button>
            <button class="tab" onclick="app.switchTab('more')">
                <span class="tab-icon">‚öôÔ∏è</span>
                <span>More</span>
            </button>
        </div>

        <!-- Exercise Selection Modal -->
        <div id="exerciseModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Select Exercise</h2>
                    <button class="close-btn" onclick="app.closeExerciseModal()">√ó</button>
                </div>
                <input type="text" class="search-box" id="exerciseSearch" placeholder="Search exercises..." oninput="app.filterExercises()">
                <div id="modalExerciseList"></div>
            </div>
        </div>

        <!-- Workout Tracking Modal -->
        <div id="workoutModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="workoutExerciseName"></h2>
                    <button class="close-btn" onclick="app.closeWorkoutModal()">√ó</button>
                </div>
                <div id="workoutContent"></div>
            </div>
        </div>

        <!-- Rest Timer -->
        <div id="restTimer" class="rest-timer">
            <div class="timer-display" id="timerDisplay">0:00</div>
            <div style="font-size: 17px; margin-bottom: 20px;">Rest Timer</div>
            <div class="timer-buttons">
                <button class="timer-btn" style="background: var(--warning); color: white;" onclick="app.skipRest()">Skip</button>
                <button class="timer-btn" style="background: var(--success); color: white;" onclick="app.addRestTime(30)">+30s</button>
            </div>
        </div>

        <!-- Exercise Details Modal -->
        <div id="exerciseDetailsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="detailsExerciseName"></h2>
                    <button class="close-btn" onclick="app.closeExerciseDetails()">√ó</button>
                </div>
                <div id="exerciseDetailsContent"></div>
            </div>
        </div>

        <!-- Create Template Modal -->
        <div id="createTemplateModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Create Template</h2>
                    <button class="close-btn" onclick="app.closeCreateTemplate()">√ó</button>
                </div>
                <div id="createTemplateContent"></div>
            </div>
        </div>

        <!-- Export Modal -->
        <div id="exportModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Export & Import</h2>
                    <button class="close-btn" onclick="app.closeExportModal()">√ó</button>
                </div>
                <div class="export-options">
                    <button class="export-btn" onclick="app.showImportModal(); app.closeExportModal();">
                        <div class="export-title">üì• Import Backup</div>
                        <div class="export-desc">Restore data from a backup file</div>
                    </button>
                    <button class="export-btn" onclick="app.exportToCSV()">
                        <div class="export-title">üìä Export to CSV</div>
                        <div class="export-desc">Download all workout data as spreadsheet</div>
                    </button>
                    <button class="export-btn" onclick="app.shareWorkoutSummary()">
                        <div class="export-title">üì§ Share Summary</div>
                        <div class="export-desc">Share this week's workout summary</div>
                    </button>
                    <button class="export-btn" onclick="app.exportJSON()">
                        <div class="export-title">üíæ Backup Data (JSON)</div>
                        <div class="export-desc">Download complete backup file</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Metric Modal -->
        <div id="addMetricModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Log Body Metrics</h2>
                    <button class="close-btn" onclick="app.closeAddMetric()">√ó</button>
                </div>
                <div id="addMetricContent"></div>
            </div>
        </div>

        <!-- Import Data Modal -->
        <div id="importModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Import Data</h2>
                    <button class="close-btn" onclick="app.closeImportModal()">√ó</button>
                </div>
                <div style="margin-bottom: 16px;">
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        Import a backup file to restore your workouts, templates, and metrics.
                    </p>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="app.handleImportFile(event)">
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">
                        üìÅ Choose Backup File
                    </button>
                </div>
                <div id="importStatus"></div>
            </div>
        </div>

        <!-- Add Photo Modal -->
        <div id="addPhotoModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Add Progress Photo</h2>
                    <button class="close-btn" onclick="app.closeAddPhoto()">√ó</button>
                </div>
                <div style="margin-bottom: 16px;">
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        Take or upload a photo to track your visual progress over time.
                    </p>
                    <input type="file" id="photoFile" accept="image/*" capture="environment" style="display: none;" onchange="app.handlePhotoUpload(event)">
                    <button class="btn btn-primary" onclick="document.getElementById('photoFile').click()">
                        üì∑ Take/Upload Photo
                    </button>
                </div>
                <div id="photoPreview"></div>
            </div>
        </div>

        <!-- Photo Comparison Modal -->
        <div id="photoCompareModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Progress Comparison</h2>
                    <button class="close-btn" onclick="app.closePhotoComparison()">√ó</button>
                </div>
                <div id="photoCompareContent"></div>
            </div>
        </div>

        <!-- Active Workout Session Modal -->
        <div id="activeWorkoutModal" class="modal">
            <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2 class="modal-title">Active Workout</h2>
                    <button class="close-btn" onclick="app.cancelWorkoutSession()">√ó</button>
                </div>
                <div id="activeWorkoutContent"></div>
            </div>
        </div>

        <!-- Add Custom Exercise Modal -->
        <div id="addCustomExerciseModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Create Custom Exercise</h2>
                    <button class="close-btn" onclick="app.closeAddCustomExercise()">√ó</button>
                </div>
                <div id="addCustomExerciseContent"></div>
            </div>
        </div>
    </div>

    <script>
        const app = {
            currentTab: 'today',
            currentExercise: null,
            currentWorkout: {
                sets: []
            },
            restTimer: null,
            restTimeRemaining: 0,
            defaultRestTime: 90, // seconds
            timeRange: '7days',
            progressPhotos: [],
            currentSuperset: null,
            settings: {
                restTimerDuration: 90,
                weightIncrement: 2.5,
                units: 'kg',
                notificationsEnabled: true
            },
            goals: [],
            achievements: [],
            workoutNotes: {},
            customExercises: [],
            workoutSessions: [],
            currentSession: null,
            sessionStartTime: null,
            healthMetrics: [],
            dailyLogs: {},

            exerciseDetails: {
                'Barbell Bench Press': {
                    instructions: 'Lie flat on bench, grip bar slightly wider than shoulders. Lower to chest, press up explosively.',
                    tips: 'Keep feet flat on floor, arch lower back slightly, retract shoulder blades',
                    alternatives: ['Dumbbell Bench Press', 'Push-ups'],
                    primaryMuscle: 'Chest',
                    secondaryMuscles: ['Triceps', 'Shoulders']
                },
                'Barbell Squat': {
                    instructions: 'Bar on upper back, feet shoulder-width. Descend until thighs parallel, drive through heels.',
                    tips: 'Keep chest up, knees track over toes, core tight',
                    alternatives: ['Leg Press', 'Goblet Squat'],
                    primaryMuscle: 'Quads',
                    secondaryMuscles: ['Glutes', 'Hamstrings']
                },
                'Deadlift': {
                    instructions: 'Feet hip-width, grip bar outside legs. Keep back straight, lift by extending hips and knees.',
                    tips: 'Bar stays close to body, neutral spine throughout, engage lats',
                    alternatives: ['Romanian Deadlift', 'Trap Bar Deadlift'],
                    primaryMuscle: 'Back',
                    secondaryMuscles: ['Hamstrings', 'Glutes']
                }
            },

            // Muscle group mapping for all exercises
            muscleGroupMap: {
                'Barbell Bench Press': ['Chest', 'Triceps'],
                'Dumbbell Bench Press': ['Chest', 'Triceps'],
                'Incline Bench Press': ['Chest', 'Triceps'],
                'Push-ups': ['Chest', 'Triceps'],
                'Cable Flyes': ['Chest'],
                'Deadlift': ['Back', 'Hamstrings', 'Glutes'],
                'Pull-ups': ['Back', 'Biceps'],
                'Barbell Row': ['Back'],
                'Lat Pulldown': ['Back'],
                'Seated Cable Row': ['Back'],
                'Barbell Squat': ['Quads', 'Glutes'],
                'Leg Press': ['Quads', 'Glutes'],
                'Romanian Deadlift': ['Hamstrings', 'Glutes'],
                'Leg Curl': ['Hamstrings'],
                'Leg Extension': ['Quads'],
                'Calf Raise': ['Calves'],
                'Overhead Press': ['Shoulders', 'Triceps'],
                'Lateral Raise': ['Shoulders'],
                'Face Pull': ['Shoulders'],
                'Arnold Press': ['Shoulders'],
                'Barbell Curl': ['Biceps'],
                'Hammer Curl': ['Biceps'],
                'Tricep Pushdown': ['Triceps'],
                'Skull Crushers': ['Triceps'],
                'Dips': ['Triceps', 'Chest'],
                'Plank': ['Core'],
                'Cable Crunch': ['Core'],
                'Hanging Leg Raise': ['Core']
            },

            // Pre-built workout programs
            programs: [
                {
                    id: 'stronglifts',
                    name: 'StrongLifts 5x5',
                    description: 'Classic beginner strength program. 3x per week, compound lifts, linear progression.',
                    schedule: 'A/B split, 3 days per week',
                    workouts: [
                        {
                            name: 'Workout A',
                            exercises: [
                                { name: 'Barbell Squat', sets: 5, reps: 5 },
                                { name: 'Barbell Bench Press', sets: 5, reps: 5 },
                                { name: 'Barbell Row', sets: 5, reps: 5 }
                            ]
                        },
                        {
                            name: 'Workout B',
                            exercises: [
                                { name: 'Barbell Squat', sets: 5, reps: 5 },
                                { name: 'Overhead Press', sets: 5, reps: 5 },
                                { name: 'Deadlift', sets: 1, reps: 5 }
                            ]
                        }
                    ]
                },
                {
                    id: 'ppl',
                    name: 'Push/Pull/Legs',
                    description: 'Popular 6-day split focusing on movement patterns. Great for hypertrophy.',
                    schedule: '6 days per week, 2x frequency per muscle',
                    workouts: [
                        {
                            name: 'Push Day',
                            exercises: [
                                { name: 'Barbell Bench Press', sets: 4, reps: 8 },
                                { name: 'Overhead Press', sets: 4, reps: 8 },
                                { name: 'Incline Bench Press', sets: 3, reps: 10 },
                                { name: 'Lateral Raise', sets: 3, reps: 12 },
                                { name: 'Tricep Pushdown', sets: 3, reps: 12 }
                            ]
                        },
                        {
                            name: 'Pull Day',
                            exercises: [
                                { name: 'Deadlift', sets: 4, reps: 6 },
                                { name: 'Pull-ups', sets: 4, reps: 8 },
                                { name: 'Barbell Row', sets: 4, reps: 8 },
                                { name: 'Face Pull', sets: 3, reps: 12 },
                                { name: 'Barbell Curl', sets: 3, reps: 10 }
                            ]
                        },
                        {
                            name: 'Leg Day',
                            exercises: [
                                { name: 'Barbell Squat', sets: 4, reps: 8 },
                                { name: 'Romanian Deadlift', sets: 4, reps: 10 },
                                { name: 'Leg Press', sets: 3, reps: 12 },
                                { name: 'Leg Curl', sets: 3, reps: 12 },
                                { name: 'Calf Raise', sets: 4, reps: 15 }
                            ]
                        }
                    ]
                },
                {
                    id: 'upper_lower',
                    name: 'Upper/Lower Split',
                    description: '4-day split perfect for balanced development and recovery.',
                    schedule: '4 days per week (ULUL)',
                    workouts: [
                        {
                            name: 'Upper A',
                            exercises: [
                                { name: 'Barbell Bench Press', sets: 4, reps: 6 },
                                { name: 'Barbell Row', sets: 4, reps: 6 },
                                { name: 'Overhead Press', sets: 3, reps: 8 },
                                { name: 'Pull-ups', sets: 3, reps: 8 },
                                { name: 'Barbell Curl', sets: 3, reps: 10 }
                            ]
                        },
                        {
                            name: 'Lower A',
                            exercises: [
                                { name: 'Barbell Squat', sets: 4, reps: 6 },
                                { name: 'Romanian Deadlift', sets: 4, reps: 8 },
                                { name: 'Leg Press', sets: 3, reps: 10 },
                                { name: 'Leg Curl', sets: 3, reps: 10 },
                                { name: 'Calf Raise', sets: 4, reps: 12 }
                            ]
                        },
                        {
                            name: 'Upper B',
                            exercises: [
                                { name: 'Overhead Press', sets: 4, reps: 6 },
                                { name: 'Deadlift', sets: 4, reps: 5 },
                                { name: 'Dumbbell Bench Press', sets: 3, reps: 10 },
                                { name: 'Lat Pulldown', sets: 3, reps: 10 },
                                { name: 'Lateral Raise', sets: 3, reps: 12 }
                            ]
                        },
                        {
                            name: 'Lower B',
                            exercises: [
                                { name: 'Deadlift', sets: 3, reps: 6 },
                                { name: 'Barbell Squat', sets: 3, reps: 8 },
                                { name: 'Leg Extension', sets: 3, reps: 12 },
                                { name: 'Leg Curl', sets: 3, reps: 12 },
                                { name: 'Calf Raise', sets: 4, reps: 15 }
                            ]
                        }
                    ]
                },
                {
                    id: 'fullbody',
                    name: 'Full Body 3x',
                    description: 'Train your whole body 3 times per week. Great for beginners and time efficiency.',
                    schedule: '3 days per week (e.g., Mon/Wed/Fri)',
                    workouts: [
                        {
                            name: 'Full Body A',
                            exercises: [
                                { name: 'Barbell Squat', sets: 3, reps: 8 },
                                { name: 'Barbell Bench Press', sets: 3, reps: 8 },
                                { name: 'Barbell Row', sets: 3, reps: 8 },
                                { name: 'Overhead Press', sets: 3, reps: 10 },
                                { name: 'Plank', sets: 3, reps: 60 }
                            ]
                        },
                        {
                            name: 'Full Body B',
                            exercises: [
                                { name: 'Deadlift', sets: 3, reps: 6 },
                                { name: 'Dumbbell Bench Press', sets: 3, reps: 10 },
                                { name: 'Pull-ups', sets: 3, reps: 8 },
                                { name: 'Romanian Deadlift', sets: 3, reps: 10 },
                                { name: 'Lateral Raise', sets: 3, reps: 12 }
                            ]
                        },
                        {
                            name: 'Full Body C',
                            exercises: [
                                { name: 'Barbell Squat', sets: 4, reps: 6 },
                                { name: 'Overhead Press', sets: 3, reps: 8 },
                                { name: 'Lat Pulldown', sets: 3, reps: 10 },
                                { name: 'Leg Curl', sets: 3, reps: 12 },
                                { name: 'Barbell Curl', sets: 3, reps: 10 }
                            ]
                        }
                    ]
                }
            ],

            exercises: [
                // Chest
                { name: 'Barbell Bench Press', category: 'Chest', muscle: 'Chest, Triceps' },
                { name: 'Dumbbell Bench Press', category: 'Chest', muscle: 'Chest, Triceps' },
                { name: 'Incline Bench Press', category: 'Chest', muscle: 'Upper Chest' },
                { name: 'Push-ups', category: 'Chest', muscle: 'Chest, Triceps' },
                { name: 'Cable Flyes', category: 'Chest', muscle: 'Chest' },
                
                // Back
                { name: 'Deadlift', category: 'Back', muscle: 'Full Back, Legs' },
                { name: 'Pull-ups', category: 'Back', muscle: 'Lats, Biceps' },
                { name: 'Barbell Row', category: 'Back', muscle: 'Mid Back' },
                { name: 'Lat Pulldown', category: 'Back', muscle: 'Lats' },
                { name: 'Seated Cable Row', category: 'Back', muscle: 'Mid Back' },
                
                // Legs
                { name: 'Barbell Squat', category: 'Legs', muscle: 'Quads, Glutes' },
                { name: 'Leg Press', category: 'Legs', muscle: 'Quads, Glutes' },
                { name: 'Romanian Deadlift', category: 'Legs', muscle: 'Hamstrings, Glutes' },
                { name: 'Leg Curl', category: 'Legs', muscle: 'Hamstrings' },
                { name: 'Leg Extension', category: 'Legs', muscle: 'Quads' },
                { name: 'Calf Raise', category: 'Legs', muscle: 'Calves' },
                
                // Shoulders
                { name: 'Overhead Press', category: 'Shoulders', muscle: 'Shoulders, Triceps' },
                { name: 'Lateral Raise', category: 'Shoulders', muscle: 'Side Delts' },
                { name: 'Face Pull', category: 'Shoulders', muscle: 'Rear Delts' },
                { name: 'Arnold Press', category: 'Shoulders', muscle: 'Shoulders' },
                
                // Arms
                { name: 'Barbell Curl', category: 'Arms', muscle: 'Biceps' },
                { name: 'Hammer Curl', category: 'Arms', muscle: 'Biceps, Forearms' },
                { name: 'Tricep Pushdown', category: 'Arms', muscle: 'Triceps' },
                { name: 'Skull Crushers', category: 'Arms', muscle: 'Triceps' },
                { name: 'Dips', category: 'Arms', muscle: 'Triceps, Chest' },
                
                // Core
                { name: 'Plank', category: 'Core', muscle: 'Abs, Core' },
                { name: 'Cable Crunch', category: 'Core', muscle: 'Abs' },
                { name: 'Hanging Leg Raise', category: 'Core', muscle: 'Lower Abs' },
            ],

            async init() {
                // Check if storage is available
                if (!window.storage) {
                    console.warn('Storage API not available - data will not persist');
                    this.workouts = [];
                    this.templates = [];
                    this.bodyMetrics = [];
                    this.personalRecords = {};
                } else {
                    await this.loadData();
                }
                
                // Load theme preference
                this.loadTheme();
                
                this.renderLibrary();
                this.renderToday();
                this.renderAnalytics();
                this.renderTemplates();
                this.renderHealth();
            },

            async loadData() {
                try {
                    const workoutsResult = await window.storage.get('workouts', false);
                    this.workouts = workoutsResult ? JSON.parse(workoutsResult.value) : [];
                    
                    const templatesResult = await window.storage.get('templates', false);
                    this.templates = templatesResult ? JSON.parse(templatesResult.value) : [];
                    
                    const metricsResult = await window.storage.get('bodyMetrics', false);
                    this.bodyMetrics = metricsResult ? JSON.parse(metricsResult.value) : [];
                    
                    const prsResult = await window.storage.get('personalRecords', false);
                    this.personalRecords = prsResult ? JSON.parse(prsResult.value) : {};
                    
                    const themeResult = await window.storage.get('theme', false);
                    this.theme = themeResult ? themeResult.value : 'light';
                    
                    const photosResult = await window.storage.get('progressPhotos', false);
                    this.progressPhotos = photosResult ? JSON.parse(photosResult.value) : [];
                    
                    const settingsResult = await window.storage.get('settings', false);
                    this.settings = settingsResult ? JSON.parse(settingsResult.value) : {
                        restTimerDuration: 90,
                        weightIncrement: 2.5,
                        units: 'kg',
                        notificationsEnabled: true
                    };
                    
                    const goalsResult = await window.storage.get('goals', false);
                    this.goals = goalsResult ? JSON.parse(goalsResult.value) : [];
                    
                    const achievementsResult = await window.storage.get('achievements', false);
                    this.achievements = achievementsResult ? JSON.parse(achievementsResult.value) : [];
                    
                    const notesResult = await window.storage.get('workoutNotes', false);
                    this.workoutNotes = notesResult ? JSON.parse(notesResult.value) : {};
                    
                    const customExResult = await window.storage.get('customExercises', false);
                    this.customExercises = customExResult ? JSON.parse(customExResult.value) : [];
                    
                    const sessionsResult = await window.storage.get('workoutSessions', false);
                    this.workoutSessions = sessionsResult ? JSON.parse(sessionsResult.value) : [];
                    
                    const healthResult = await window.storage.get('healthMetrics', false);
                    this.healthMetrics = healthResult ? JSON.parse(healthResult.value) : [];
                    
                    const dailyLogsResult = await window.storage.get('dailyLogs', false);
                    this.dailyLogs = dailyLogsResult ? JSON.parse(dailyLogsResult.value) : {};
                    
                    // Merge custom exercises into main exercises array
                    this.allExercises = [...this.exercises, ...this.customExercises];
                } catch (error) {
                    this.workouts = [];
                    this.templates = [];
                    this.bodyMetrics = [];
                    this.personalRecords = {};
                    this.theme = 'light';
                    this.progressPhotos = [];
                    this.settings = {
                        restTimerDuration: 90,
                        weightIncrement: 2.5,
                        units: 'kg',
                        notificationsEnabled: true
                    };
                    this.goals = [];
                    this.achievements = [];
                    this.workoutNotes = {};
                    this.customExercises = [];
                    this.workoutSessions = [];
                    this.allExercises = this.exercises;
                    this.healthMetrics = [];
                    this.dailyLogs = {};
                }
            },

            async saveWorkouts() {
                if (!window.storage) return;
                try {
                    await window.storage.set('workouts', JSON.stringify(this.workouts), false);
                } catch (error) {
                    console.error('Failed to save workouts:', error);
                }
            },

            async saveTemplates() {
                if (!window.storage) return;
                try {
                    await window.storage.set('templates', JSON.stringify(this.templates), false);
                } catch (error) {
                    console.error('Failed to save templates:', error);
                }
            },

            async saveBodyMetrics() {
                if (!window.storage) return;
                try {
                    await window.storage.set('bodyMetrics', JSON.stringify(this.bodyMetrics), false);
                } catch (error) {
                    console.error('Failed to save metrics:', error);
                }
            },

            async savePersonalRecords() {
                if (!window.storage) return;
                try {
                    await window.storage.set('personalRecords', JSON.stringify(this.personalRecords), false);
                } catch (error) {
                    console.error('Failed to save PRs:', error);
                }
            },

            async saveProgressPhotos() {
                if (!window.storage) return;
                try {
                    await window.storage.set('progressPhotos', JSON.stringify(this.progressPhotos), false);
                } catch (error) {
                    console.error('Failed to save photos:', error);
                }
            },

            async saveSettings() {
                if (!window.storage) return;
                try {
                    await window.storage.set('settings', JSON.stringify(this.settings), false);
                } catch (error) {
                    console.error('Failed to save settings:', error);
                }
            },

            async saveGoals() {
                if (!window.storage) return;
                try {
                    await window.storage.set('goals', JSON.stringify(this.goals), false);
                } catch (error) {
                    console.error('Failed to save goals:', error);
                }
            },

            async saveAchievements() {
                if (!window.storage) return;
                try {
                    await window.storage.set('achievements', JSON.stringify(this.achievements), false);
                } catch (error) {
                    console.error('Failed to save achievements:', error);
                }
            },

            async saveWorkoutNotes() {
                if (!window.storage) return;
                try {
                    await window.storage.set('workoutNotes', JSON.stringify(this.workoutNotes), false);
                } catch (error) {
                    console.error('Failed to save notes:', error);
                }
            },

            async saveCustomExercises() {
                if (!window.storage) return;
                try {
                    await window.storage.set('customExercises', JSON.stringify(this.customExercises), false);
                } catch (error) {
                    console.error('Failed to save custom exercises:', error);
                }
            },

            async saveWorkoutSessions() {
                if (!window.storage) return;
                try {
                    await window.storage.set('workoutSessions', JSON.stringify(this.workoutSessions), false);
                } catch (error) {
                    console.error('Failed to save sessions:', error);
                }
            },

            async saveHealthMetrics() {
                if (!window.storage) return;
                try {
                    await window.storage.set('healthMetrics', JSON.stringify(this.healthMetrics), false);
                } catch (error) {
                    console.error('Failed to save health metrics:', error);
                }
            },

            async saveDailyLogs() {
                if (!window.storage) return;
                try {
                    await window.storage.set('dailyLogs', JSON.stringify(this.dailyLogs), false);
                } catch (error) {
                    console.error('Failed to save daily logs:', error);
                }
            },

            switchTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.getElementById(tab).classList.add('active');
                document.querySelector(`[onclick="app.switchTab('${tab}')"]`).classList.add('active');
                
                if (tab === 'today') this.renderToday();
                if (tab === 'health') this.renderHealth();
                if (tab === 'analytics') this.renderAnalytics();
                if (tab === 'templates') this.renderTemplates();
                if (tab === 'library') this.renderLibrary();
                if (tab === 'more') this.renderMore();
            },

            renderLibrary() {
                const categories = [...new Set(this.exercises.map(e => e.category))];
                const html = categories.map(cat => `
                    <div class="exercise-category">
                        <div class="category-title">${cat}</div>
                        ${this.exercises.filter(e => e.category === cat).map(ex => `
                            <div class="exercise-item" onclick="app.showExerciseDetails('${ex.name.replace(/'/g, "\\'")}')">
                                <div>
                                    <div class="exercise-name">${ex.name}</div>
                                    <div class="exercise-muscle">${ex.muscle}</div>
                                </div>
                                <div class="chevron">‚Ä∫</div>
                            </div>
                        `).join('')}
                    </div>
                `).join('');
                
                document.getElementById('exerciseLibrary').innerHTML = html;
            },

            renderToday() {
                const today = new Date().toLocaleDateString();
                const todayWorkouts = this.workouts.filter(w => w.date === today);
                
                // Calculate streak
                const streak = this.calculateStreak();
                
                // Calculate today's stats
                const totalSets = todayWorkouts.reduce((sum, w) => sum + w.sets.length, 0);
                const totalVolume = todayWorkouts.reduce((sum, w) => 
                    sum + w.sets.reduce((s, set) => s + ((set.weight || 0) * (set.reps || 0)), 0), 0
                );
                
                let html = '';
                
                // Smart Recommendations
                const recommendations = this.getSmartRecommendations();
                if (recommendations.length > 0 && todayWorkouts.length === 0) {
                    html += `
                        <div class="card" style="background: var(--gradient); color: white; margin-bottom: 16px;">
                            <div style="font-size: 16px; font-weight: 700; margin-bottom: 12px;">üí° Smart Suggestions</div>
                            ${recommendations.slice(0, 3).map(rec => `
                                <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.2); last-child:border: none;">
                                    ${rec.icon} <strong>${rec.title}</strong><br>
                                    <span style="font-size: 13px; opacity: 0.9;">${rec.reason}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Streak badge
                if (streak > 0) {
                    html += `
                        <div class="streak-badge">
                            <div class="streak-icon">üî•</div>
                            <div class="streak-text">
                                <div class="streak-number">${streak} Day${streak > 1 ? 's' : ''}</div>
                                <div class="streak-label">Workout Streak</div>
                            </div>
                        </div>
                    `;
                }
                
                // Quick actions
                html += `
                    <div class="quick-actions">
                        <div class="quick-action-btn" onclick="app.showTemplates()">
                            <div class="quick-action-icon">üìã</div>
                            <div class="quick-action-label">Start Template</div>
                        </div>
                        <div class="quick-action-btn" onclick="app.duplicateLastWorkout()">
                            <div class="quick-action-icon">üîÑ</div>
                            <div class="quick-action-label">Repeat Last</div>
                        </div>
                    </div>
                `;
                
                // Today's stats
                if (todayWorkouts.length > 0) {
                    html += `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${todayWorkouts.length}</div>
                                <div class="stat-label">Exercises</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${totalSets}</div>
                                <div class="stat-label">Total Sets</div>
                            </div>
                        </div>
                        <div class="stat-card" style="margin-bottom: 16px;">
                            <div class="stat-value">${this.formatNumber(totalVolume)}kg</div>
                            <div class="stat-label">Total Volume</div>
                        </div>
                    `;
                }
                
                if (todayWorkouts.length === 0) {
                    html += `
                        <div class="empty-state">
                            <div class="empty-icon">üèãÔ∏è</div>
                            <div class="empty-text">No workouts logged today<br>Tap "Start Workout" to begin!</div>
                        </div>
                    `;
                } else {
                    // Group workouts by session
                    const todaySessions = this.workoutSessions.filter(s => s.date === today);
                    
                    if (todaySessions.length > 0) {
                        // Show full sessions
                        html += todaySessions.map(session => {
                            const duration = session.duration ? this.formatDuration(session.duration) : 'N/A';
                            const totalVolume = session.exercises.reduce((sum, ex) => 
                                sum + ex.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                            );
                            const totalSets = session.exercises.reduce((sum, ex) => sum + ex.sets.length, 0);
                            
                            return `
                                <div class="card" style="margin-bottom: 16px;">
                                    <div class="card-header">
                                        <div>
                                            <div class="card-title">üí™ Workout Session</div>
                                            <div class="card-subtitle">
                                                ${session.exercises.length} exercises ‚Ä¢ ${totalSets} sets ‚Ä¢ ${duration}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="background: var(--background); padding: 12px; border-radius: 8px; margin: 12px 0;">
                                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Duration</div>
                                                <div style="font-size: 18px; font-weight: 600;">${duration}</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Volume</div>
                                                <div style="font-size: 18px; font-weight: 600;">${this.formatNumber(totalVolume)}kg</div>
                                            </div>
                                        </div>
                                    </div>

                                    ${session.exercises.map((exercise, i) => {
                                        const workout = todayWorkouts.find(w => w.exercise === exercise.name && w.sessionId === session.id);
                                        const isPR = workout ? this.checkIfPR(workout) : false;
                                        const improvement = workout ? this.calculateImprovement(workout) : 0;
                                        
                                        return `
                                            <div style="padding: 12px 0; border-top: 1px solid var(--border);">
                                                <div style="font-weight: 600; margin-bottom: 4px;">
                                                    ${exercise.name}
                                                    ${isPR ? '<span class="pr-badge">üèÜ PR</span>' : ''}
                                                    ${improvement > 0 ? `<span class="improvement-badge">+${improvement}%</span>` : ''}
                                                </div>
                                                ${exercise.sets.map((set, j) => `
                                                    <div style="font-size: 14px; color: var(--text-secondary); padding: 2px 0;">
                                                        Set ${j + 1}: ${set.weight}kg √ó ${set.reps} reps
                                                        ${set.rpe ? ` @ RPE ${set.rpe}` : ''}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `;
                                    }).join('')}
                                    
                                    ${session.notes ? `
                                        <div style="margin-top: 12px; padding: 12px; background: var(--background); border-radius: 8px;">
                                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Notes:</div>
                                            <div style="font-size: 14px; font-style: italic;">${session.notes}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('');
                    } else {
                        // Fallback: Show individual exercises (old format)
                        html += todayWorkouts.map(workout => {
                            const isPR = this.checkIfPR(workout);
                            const improvement = this.calculateImprovement(workout);
                            const notes = this.workoutNotes[workout.id];
                            
                            return `
                                <div class="card swipeable">
                                    <div class="card-header">
                                        <div>
                                            <div class="card-title">
                                                ${workout.superset ? 'üîó ' : ''}${workout.exercise}
                                                ${isPR ? '<span class="pr-badge">üèÜ PR</span>' : ''}
                                                ${improvement > 0 ? `<span class="improvement-badge">+${improvement}%</span>` : ''}
                                            </div>
                                            <div class="card-subtitle">
                                                ${workout.sets.length} sets ‚Ä¢ ${workout.sets.reduce((sum, s) => sum + (s.reps || 0), 0)} total reps
                                                ${workout.superset ? ` ‚Ä¢ Superset with ${workout.superset}` : ''}
                                            </div>
                                            ${notes ? `<div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px; font-style: italic;">üí≠ ${notes}</div>` : ''}
                                        </div>
                                    </div>
                                    ${workout.sets.map((set, i) => `
                                        <div style="padding: 4px 0;">
                                            Set ${i + 1}: ${set.weight}kg √ó ${set.reps} reps
                                            ${set.rpe ? ` <span style="color: var(--text-secondary); font-size: 12px;">@ RPE ${set.rpe}</span>` : ''}
                                        </div>
                                    `).join('')}
                                    <div class="swipe-actions">
                                        <button class="swipe-btn delete" onclick="app.deleteWorkout('${workout.id}')">Delete</button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }

                document.getElementById('todayWorkouts').innerHTML = html;
            },

            formatDuration(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                
                if (hours > 0) {
                    return `${hours}h ${minutes}m`;
                }
                return `${minutes}m`;
            },

            getSmartRecommendations() {
                const recommendations = [];
                const now = new Date();
                
                // Get last workout date
                const lastWorkoutDate = this.workouts.length > 0 
                    ? new Date(Math.max(...this.workouts.map(w => new Date(w.date))))
                    : null;
                
                const daysSinceLastWorkout = lastWorkoutDate 
                    ? Math.floor((now - lastWorkoutDate) / (1000 * 60 * 60 * 24))
                    : 999;
                
                // Recommendation: Haven't worked out in a while
                if (daysSinceLastWorkout >= 3) {
                    recommendations.push({
                        icon: '‚è∞',
                        title: `${daysSinceLastWorkout} days since last workout`,
                        reason: "Time to get back in the gym! Your muscles are recovered.",
                        action: 'start_workout'
                    });
                }
                
                // Recommendation: Muscle group imbalance
                const muscleVolume = this.getMuscleVolumeLastWeek();
                const volumes = Object.values(muscleVolume);
                if (volumes.length > 0) {
                    const maxVolume = Math.max(...volumes);
                    const minVolume = Math.min(...volumes.filter(v => v > 0));
                    
                    if (maxVolume > minVolume * 2) {
                        const undertrainedMuscle = Object.entries(muscleVolume)
                            .filter(([_, vol]) => vol === minVolume)[0][0];
                        
                        recommendations.push({
                            icon: '‚öñÔ∏è',
                            title: `${undertrainedMuscle} needs attention`,
                            reason: `Low volume this week. Consider training ${undertrainedMuscle} today.`,
                            action: 'train_muscle',
                            muscle: undertrainedMuscle
                        });
                    }
                }
                
                // Recommendation: Approaching goal
                this.goals.forEach(goal => {
                    const progress = this.calculateGoalProgress(goal);
                    if (progress >= 90 && progress < 100) {
                        recommendations.push({
                            icon: 'üéØ',
                            title: `You're ${Math.round(100 - progress)}% away from "${goal.title}"`,
                            reason: `Push hard today - you're almost there!`,
                            action: 'work_on_goal',
                            goal: goal
                        });
                    }
                });
                
                // Recommendation: Deload suggestion
                const recentRPE = this.getAverageRPELastWeek();
                if (recentRPE >= 8.5) {
                    recommendations.push({
                        icon: 'üò∞',
                        title: 'High fatigue detected',
                        reason: `Average RPE: ${recentRPE.toFixed(1)}/10. Consider a deload or rest day.`,
                        action: 'deload'
                    });
                }
                
                // Recommendation: Consistency boost
                const streak = this.calculateStreak();
                if (streak >= 5 && streak < 7) {
                    recommendations.push({
                        icon: 'üî•',
                        title: `${7 - streak} more days to 7-day streak!`,
                        reason: "Keep going - achievement within reach!",
                        action: 'maintain_streak'
                    });
                }
                
                // Recommendation: No leg training
                const lastLegWorkout = this.getLastMuscleGroupWorkout('Quads');
                const daysSinceLegs = lastLegWorkout 
                    ? Math.floor((now - new Date(lastLegWorkout.date)) / (1000 * 60 * 60 * 24))
                    : 999;
                
                if (daysSinceLegs >= 5) {
                    recommendations.push({
                        icon: 'ü¶µ',
                        title: "Leg day overdue",
                        reason: `${daysSinceLegs} days since last leg workout. Don't skip leg day!`,
                        action: 'train_legs'
                    });
                }
                
                return recommendations;
            },

            getMuscleVolumeLastWeek() {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                const recentWorkouts = this.workouts.filter(w => new Date(w.date) >= weekAgo);
                const muscleVolume = {};
                
                recentWorkouts.forEach(workout => {
                    const muscles = this.muscleGroupMap[workout.exercise] || ['Other'];
                    const volume = workout.sets.reduce((sum, s) => sum + (s.weight * s.reps), 0);
                    
                    muscles.forEach(muscle => {
                        muscleVolume[muscle] = (muscleVolume[muscle] || 0) + volume;
                    });
                });
                
                return muscleVolume;
            },

            getAverageRPELastWeek() {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                const recentWorkouts = this.workouts.filter(w => new Date(w.date) >= weekAgo);
                const rpeValues = [];
                
                recentWorkouts.forEach(workout => {
                    workout.sets.forEach(set => {
                        if (set.rpe) rpeValues.push(set.rpe);
                    });
                });
                
                if (rpeValues.length === 0) return 0;
                return rpeValues.reduce((sum, rpe) => sum + rpe, 0) / rpeValues.length;
            },

            getLastMuscleGroupWorkout(muscleGroup) {
                const muscleWorkouts = this.workouts.filter(w => {
                    const muscles = this.muscleGroupMap[w.exercise] || [];
                    return muscles.includes(muscleGroup);
                }).sort((a, b) => new Date(b.date) - new Date(a.date));
                
                return muscleWorkouts[0] || null;
            },

            calculateStreak() {
                if (this.workouts.length === 0) return 0;
                
                const dates = [...new Set(this.workouts.map(w => w.date))].sort((a, b) => new Date(b) - new Date(a));
                let streak = 0;
                let currentDate = new Date();
                currentDate.setHours(0, 0, 0, 0);
                
                for (let date of dates) {
                    const workoutDate = new Date(date);
                    workoutDate.setHours(0, 0, 0, 0);
                    
                    const diffDays = Math.floor((currentDate - workoutDate) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === streak) {
                        streak++;
                        currentDate = workoutDate;
                    } else if (diffDays > streak) {
                        break;
                    }
                }
                
                return streak;
            },

            checkIfPR(workout) {
                const exerciseName = workout.exercise;
                const maxWeight = Math.max(...workout.sets.map(s => s.weight || 0));
                
                if (!this.personalRecords[exerciseName] || maxWeight > this.personalRecords[exerciseName]) {
                    this.personalRecords[exerciseName] = maxWeight;
                    this.savePersonalRecords();
                    return true;
                }
                return false;
            },

            calculateImprovement(workout) {
                const previousWorkouts = this.workouts.filter(w => 
                    w.exercise === workout.exercise && w.date !== workout.date && w.id !== workout.id
                ).sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (previousWorkouts.length === 0) return 0;
                
                const lastWorkout = previousWorkouts[0];
                const currentVolume = workout.sets.reduce((sum, s) => sum + (s.weight * s.reps), 0);
                const lastVolume = lastWorkout.sets.reduce((sum, s) => sum + (s.weight * s.reps), 0);
                
                if (lastVolume === 0) return 0;
                return Math.round(((currentVolume - lastVolume) / lastVolume) * 100);
            },

            renderAnalytics() {
                const workouts = this.getWorkoutsInRange();
                
                if (workouts.length === 0) {
                    document.getElementById('analyticsContent').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìä</div>
                            <div class="empty-text">No workout data yet</div>
                        </div>
                    `;
                    return;
                }
                
                // Time range selector
                let html = `
                    <div class="time-range-selector">
                        <button class="time-range-btn ${this.timeRange === '7days' ? 'active' : ''}" onclick="app.setTimeRange('7days')">7 Days</button>
                        <button class="time-range-btn ${this.timeRange === '30days' ? 'active' : ''}" onclick="app.setTimeRange('30days')">30 Days</button>
                        <button class="time-range-btn ${this.timeRange === '90days' ? 'active' : ''}" onclick="app.setTimeRange('90days')">90 Days</button>
                        <button class="time-range-btn ${this.timeRange === 'all' ? 'active' : ''}" onclick="app.setTimeRange('all')">All Time</button>
                    </div>
                `;
                
                // Summary stats
                const totalWorkouts = [...new Set(workouts.map(w => w.date))].length;
                const totalSets = workouts.reduce((sum, w) => sum + w.sets.length, 0);
                const totalVolume = workouts.reduce((sum, w) => 
                    sum + w.sets.reduce((s, set) => s + ((set.weight || 0) * (set.reps || 0)), 0), 0
                );
                const avgVolume = totalWorkouts > 0 ? Math.round(totalVolume / totalWorkouts) : 0;
                
                // Get previous period for comparison
                const prevWorkouts = this.getWorkoutsInRange(true);
                const prevVolume = prevWorkouts.reduce((sum, w) => 
                    sum + w.sets.reduce((s, set) => s + ((set.weight || 0) * (set.reps || 0)), 0), 0
                );
                const volumeChange = prevVolume > 0 ? Math.round(((totalVolume - prevVolume) / prevVolume) * 100) : 0;
                
                html += `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${totalWorkouts}</div>
                            <div class="stat-label">Workouts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${totalSets}</div>
                            <div class="stat-label">Total Sets</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${this.formatNumber(totalVolume)}kg</div>
                            <div class="stat-label">Total Volume</div>
                            ${volumeChange !== 0 ? `<div class="stat-change ${volumeChange > 0 ? 'positive' : 'negative'}">${volumeChange > 0 ? '+' : ''}${volumeChange}% vs previous</div>` : ''}
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${this.formatNumber(avgVolume)}kg</div>
                            <div class="stat-label">Avg per Workout</div>
                        </div>
                    </div>
                `;
                
                // Muscle Group Volume Distribution
                html += this.renderMuscleGroupVolume(workouts);
                
                // Trends & Insights
                html += this.addTrendAnalysis();
                
                // Volume chart
                html += this.renderVolumeChart(workouts);
                
                // 1RM Predictions
                html += this.render1RMPredictions();
                
                // Top exercises
                const exerciseCounts = {};
                workouts.forEach(w => {
                    exerciseCounts[w.exercise] = (exerciseCounts[w.exercise] || 0) + 1;
                });
                
                const topExercises = Object.entries(exerciseCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                html += `
                    <div class="card">
                        <div class="card-title" style="margin-bottom: 12px;">Most Performed Exercises</div>
                        ${topExercises.map(([exercise, count]) => `
                            <div class="history-item" onclick="app.showExerciseProgress('${exercise}')">
                                <div class="history-date">${exercise}</div>
                                <div class="history-sets">${count} workouts</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                // Personal Records
                html += `
                    <div class="card">
                        <div class="card-title" style="margin-bottom: 12px;">üèÜ Personal Records</div>
                        ${Object.entries(this.personalRecords).slice(0, 5).map(([exercise, weight]) => `
                            <div class="history-item">
                                <div class="history-date">${exercise}</div>
                                <div class="history-sets">${weight}kg</div>
                            </div>
                        `).join('')}
                        ${Object.keys(this.personalRecords).length === 0 ? '<div class="empty-text">No PRs yet - keep training!</div>' : ''}
                    </div>
                `;
                
                // Export button
                html += `
                    <button class="btn btn-secondary" onclick="app.showExportModal()">üì§ Export Data</button>
                `;
                
                document.getElementById('analyticsContent').innerHTML = html;
            },

            getWorkoutsInRange(previous = false) {
                const now = new Date();
                let startDate = new Date();
                
                if (this.timeRange === '7days') {
                    startDate.setDate(now.getDate() - (previous ? 14 : 7));
                } else if (this.timeRange === '30days') {
                    startDate.setDate(now.getDate() - (previous ? 60 : 30));
                } else if (this.timeRange === '90days') {
                    startDate.setDate(now.getDate() - (previous ? 180 : 90));
                } else {
                    return previous ? [] : this.workouts;
                }
                
                const endDate = previous ? new Date(now.getTime() - (this.timeRange === '7days' ? 7 : this.timeRange === '30days' ? 30 : 90) * 24 * 60 * 60 * 1000) : now;
                
                return this.workouts.filter(w => {
                    const workoutDate = new Date(w.date);
                    return workoutDate >= startDate && workoutDate <= endDate;
                });
            },

            setTimeRange(range) {
                this.timeRange = range;
                this.renderAnalytics();
            },

            renderVolumeChart(workouts) {
                // Group by date
                const volumeByDate = {};
                workouts.forEach(w => {
                    const volume = w.sets.reduce((sum, s) => sum + (s.weight * s.reps), 0);
                    volumeByDate[w.date] = (volumeByDate[w.date] || 0) + volume;
                });
                
                const dates = Object.keys(volumeByDate).sort((a, b) => new Date(a) - new Date(b));
                const volumes = dates.map(d => volumeByDate[d]);
                const maxVolume = Math.max(...volumes);
                
                if (dates.length === 0) return '';
                
                return `
                    <div class="chart-container">
                        <div class="chart-title">Volume Over Time</div>
                        <div class="simple-chart">
                            ${dates.slice(-10).map((date, i) => {
                                const volume = volumeByDate[date];
                                const height = (volume / maxVolume) * 100;
                                return `
                                    <div class="chart-bar" style="height: ${height}%">
                                        <div class="chart-bar-value">${this.formatNumber(volume)}</div>
                                        <div class="chart-bar-label">${new Date(date).getDate()}/${new Date(date).getMonth() + 1}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            },

            renderMuscleGroupVolume(workouts) {
                const muscleVolume = {};
                
                workouts.forEach(workout => {
                    const muscles = this.muscleGroupMap[workout.exercise] || ['Other'];
                    const volume = workout.sets.reduce((sum, s) => sum + (s.weight * s.reps), 0);
                    
                    muscles.forEach(muscle => {
                        muscleVolume[muscle] = (muscleVolume[muscle] || 0) + volume;
                    });
                });
                
                const sortedMuscles = Object.entries(muscleVolume)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 6);
                
                if (sortedMuscles.length === 0) return '';
                
                const maxVolume = Math.max(...sortedMuscles.map(m => m[1]));
                
                return `
                    <div class="card">
                        <div class="card-title" style="margin-bottom: 12px;">üí™ Volume by Muscle Group</div>
                        <div style="margin-bottom: 16px;">
                            ${sortedMuscles.map(([muscle, volume]) => {
                                const percentage = (volume / maxVolume) * 100;
                                return `
                                    <div style="margin-bottom: 12px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="font-size: 14px; font-weight: 600;">${muscle}</span>
                                            <span style="font-size: 14px; color: var(--text-secondary);">${this.formatNumber(volume)}kg</span>
                                        </div>
                                        <div style="background: var(--background); height: 8px; border-radius: 4px; overflow: hidden;">
                                            <div style="background: var(--primary); height: 100%; width: ${percentage}%; border-radius: 4px; transition: width 0.3s;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            },

            render1RMPredictions() {
                // Find best sets for each exercise (highest weight x reps combo)
                const exerciseMaxes = {};
                
                this.workouts.forEach(workout => {
                    workout.sets.forEach(set => {
                        if (set.weight && set.reps && set.reps <= 12) {
                            const estimated1RM = this.calculate1RM(set.weight, set.reps);
                            
                            if (!exerciseMaxes[workout.exercise] || estimated1RM > exerciseMaxes[workout.exercise].max) {
                                exerciseMaxes[workout.exercise] = {
                                    max: estimated1RM,
                                    weight: set.weight,
                                    reps: set.reps,
                                    date: workout.date
                                };
                            }
                        }
                    });
                });
                
                const topLifts = Object.entries(exerciseMaxes)
                    .sort((a, b) => b[1].max - a[1].max)
                    .slice(0, 5);
                
                if (topLifts.length === 0) return '';
                
                return `
                    <div class="card">
                        <div class="card-title" style="margin-bottom: 12px;">üéØ Estimated 1RM (One Rep Max)</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">
                            Based on your best sets using Epley formula
                        </div>
                        ${topLifts.map(([exercise, data]) => `
                            <div class="history-item">
                                <div>
                                    <div class="history-date">${exercise}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">From ${data.weight}kg √ó ${data.reps} reps</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${Math.round(data.max)}kg</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            calculate1RM(weight, reps) {
                // Epley formula: 1RM = weight √ó (1 + reps/30)
                if (reps === 1) return weight;
                return weight * (1 + reps / 30);
            },

            showExerciseProgress(exerciseName) {
                this.showExerciseDetails(exerciseName);
            },

            formatDate(dateStr) {
                const date = new Date(dateStr);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                if (date.toLocaleDateString() === today.toLocaleDateString()) {
                    return 'Today';
                } else if (date.toLocaleDateString() === yesterday.toLocaleDateString()) {
                    return 'Yesterday';
                } else {
                    return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                }
            },

            formatNumber(num) {
                return num >= 1000 ? (num / 1000).toFixed(1) + 'k' : Math.round(num);
            },

            // Templates
            renderTemplates() {
                let html = `
                    <div class="section-header">
                        <div class="section-title">Pre-Built Programs</div>
                    </div>
                    <div style="margin-bottom: 24px;">
                        ${this.programs.map(program => `
                            <div class="template-card" onclick="app.showProgramDetails('${program.id}')">
                                <div class="template-header">
                                    <div class="template-name">${program.name}</div>
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">${program.description}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">üìÖ ${program.schedule}</div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="section-header">
                        <div class="section-title">My Custom Templates</div>
                        <div class="section-action" onclick="app.showCreateTemplate()">+ New</div>
                    </div>
                `;
                
                if (this.templates.length === 0) {
                    html += `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <div class="empty-text">No custom templates yet<br>Create one to save time!</div>
                        </div>
                    `;
                } else {
                    html += this.templates.map(template => `
                        <div class="template-card" onclick="app.startTemplate('${template.id}')">
                            <div class="template-header">
                                <div class="template-name">${template.name}</div>
                            </div>
                            <div class="template-exercises">${template.exercises.length} exercises: ${template.exercises.map(e => e.name).join(', ')}</div>
                            <div class="template-actions">
                                <button class="icon-btn" onclick="event.stopPropagation(); app.editTemplate('${template.id}')">‚úèÔ∏è Edit</button>
                                <button class="icon-btn danger" onclick="event.stopPropagation(); app.deleteTemplate('${template.id}')">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `).join('');
                }
                
                document.getElementById('templatesContent').innerHTML = html;
            },

            showProgramDetails(programId) {
                const program = this.programs.find(p => p.id === programId);
                if (!program) return;

                let html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="font-size: 22px; font-weight: 700; margin-bottom: 8px;">${program.name}</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 12px;">${program.description}</p>
                        <div style="background: var(--background); padding: 12px; border-radius: 8px;">
                            <strong>Schedule:</strong> ${program.schedule}
                        </div>
                    </div>

                    ${program.workouts.map((workout, index) => `
                        <div class="card" style="margin-bottom: 12px;">
                            <div class="card-title" style="margin-bottom: 12px;">${workout.name}</div>
                            ${workout.exercises.map(ex => `
                                <div style="padding: 8px 0; border-bottom: 1px solid var(--border); last-child:border-bottom: none;">
                                    <div style="font-weight: 600;">${ex.name}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">${ex.sets} sets √ó ${ex.reps} reps</div>
                                </div>
                            `).join('')}
                            <button class="btn btn-primary" style="margin-top: 12px;" onclick="app.startProgramWorkout('${programId}', ${index})">
                                Start ${workout.name}
                            </button>
                        </div>
                    `).join('')}
                `;

                // Create a modal or show in templates section
                const modalContent = `
                    <div class="modal active" id="programDetailModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">${program.name}</h2>
                                <button class="close-btn" onclick="document.getElementById('programDetailModal').remove()">√ó</button>
                            </div>
                            ${html}
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalContent);
            },

            startProgramWorkout(programId, workoutIndex) {
                const program = this.programs.find(p => p.id === programId);
                if (!program || !program.workouts[workoutIndex]) return;

                const workout = program.workouts[workoutIndex];
                
                // Convert to template format and start
                this.currentTemplate = {
                    name: `${program.name} - ${workout.name}`,
                    exercises: workout.exercises.map(ex => ({ name: ex.name }))
                };
                this.currentTemplateIndex = 0;
                
                // Close the detail modal
                const modal = document.getElementById('programDetailModal');
                if (modal) modal.remove();
                
                // Start first exercise
                this.startWorkout(workout.exercises[0].name);
            },

            showTemplates() {
                this.switchTab('templates');
            },

            showCreateTemplate() {
                let html = `
                    <div class="metric-input-group">
                        <label class="metric-label">Template Name</label>
                        <input type="text" class="metric-input" id="templateName" placeholder="e.g., Push Day, Leg Day">
                    </div>
                    
                    <div class="metric-label" style="margin-bottom: 8px;">Select Exercises</div>
                    <div id="exerciseSelectionList"></div>
                    
                    <button class="btn btn-primary" onclick="app.saveTemplate()">üíæ Save Template</button>
                `;
                
                document.getElementById('createTemplateContent').innerHTML = html;
                this.renderExerciseSelection();
                document.getElementById('createTemplateModal').classList.add('active');
            },

            renderExerciseSelection() {
                const categories = [...new Set(this.exercises.map(e => e.category))];
                const html = categories.map(cat => `
                    <div class="exercise-category">
                        <div class="category-title">${cat}</div>
                        ${this.exercises.filter(e => e.category === cat).map(ex => `
                            <div class="exercise-item">
                                <div>
                                    <div class="exercise-name">${ex.name}</div>
                                    <div class="exercise-muscle">${ex.muscle}</div>
                                </div>
                                <input type="checkbox" value="${ex.name}" style="width: 24px; height: 24px;">
                            </div>
                        `).join('')}
                    </div>
                `).join('');
                
                document.getElementById('exerciseSelectionList').innerHTML = html;
            },

            async saveTemplate() {
                const name = document.getElementById('templateName').value;
                const checkboxes = document.querySelectorAll('#exerciseSelectionList input[type="checkbox"]:checked');
                const exercises = Array.from(checkboxes).map(cb => ({ name: cb.value }));
                
                if (!name || exercises.length === 0) {
                    alert('Please enter a name and select at least one exercise');
                    return;
                }
                
                const template = {
                    id: Date.now().toString(),
                    name,
                    exercises
                };
                
                this.templates.push(template);
                await this.saveTemplates();
                this.closeCreateTemplate();
                this.renderTemplates();
            },

            closeCreateTemplate() {
                document.getElementById('createTemplateModal').classList.remove('active');
            },

            startTemplate(templateId) {
                const template = this.templates.find(t => t.id === templateId);
                if (!template) return;
                
                // Start workout with first exercise
                if (template.exercises.length > 0) {
                    this.currentTemplate = template;
                    this.currentTemplateIndex = 0;
                    this.startWorkout(template.exercises[0].name);
                }
            },

            async deleteTemplate(templateId) {
                if (!confirm('Delete this template?')) return;
                
                this.templates = this.templates.filter(t => t.id !== templateId);
                await this.saveTemplates();
                this.renderTemplates();
            },

            // Body Metrics
            renderMetrics() {
                let html = `
                    <div class="section-header">
                        <div class="section-title">Progress Photos</div>
                        <div class="section-action" onclick="app.showAddPhoto()">+ Photo</div>
                    </div>
                `;
                
                // Progress Photos Section
                if (this.progressPhotos.length === 0) {
                    html += `
                        <div class="card">
                            <div class="empty-text">No progress photos yet<br>Take your first photo to track visual progress!</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="card">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                                ${this.progressPhotos.slice(-6).reverse().map((photo, i) => `
                                    <div onclick="app.showPhotoComparison(${this.progressPhotos.length - 1 - i})" style="cursor: pointer; position: relative; padding-bottom: 100%; overflow: hidden; border-radius: 8px; background: var(--background);">
                                        <img src="${photo.dataUrl}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" alt="Progress photo">
                                        <div style="position: absolute; bottom: 4px; left: 4px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">
                                            ${new Date(photo.date).toLocaleDateString()}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <button class="btn btn-secondary" onclick="app.showAllPhotos()">View All Photos (${this.progressPhotos.length})</button>
                        </div>
                    `;
                }
                
                html += `
                    <div class="section-header" style="margin-top: 24px;">
                        <div class="section-title">Body Metrics</div>
                        <div class="section-action" onclick="app.showAddMetric()">+ Log</div>
                    </div>
                `;
                
                if (this.bodyMetrics.length === 0) {
                    html += `
                        <div class="empty-state">
                            <div class="empty-icon">üìè</div>
                            <div class="empty-text">No metrics logged yet<br>Track your progress!</div>
                        </div>
                    `;
                } else {
                    // Get latest metrics
                    const latest = this.bodyMetrics[this.bodyMetrics.length - 1];
                    const previous = this.bodyMetrics.length > 1 ? this.bodyMetrics[this.bodyMetrics.length - 2] : null;
                    
                    html += `<div class="stats-grid">`;
                    
                    if (latest.weight) {
                        const change = previous && previous.weight ? ((latest.weight - previous.weight) / previous.weight * 100).toFixed(1) : 0;
                        html += `
                            <div class="stat-card">
                                <div class="stat-value">${latest.weight}kg</div>
                                <div class="stat-label">Body Weight</div>
                                ${change != 0 ? `<div class="stat-change ${change > 0 ? 'negative' : 'positive'}">${change > 0 ? '+' : ''}${change}%</div>` : ''}
                            </div>
                        `;
                    }
                    
                    if (latest.bodyFat) {
                        const change = previous && previous.bodyFat ? (latest.bodyFat - previous.bodyFat).toFixed(1) : 0;
                        html += `
                            <div class="stat-card">
                                <div class="stat-value">${latest.bodyFat}%</div>
                                <div class="stat-label">Body Fat</div>
                                ${change != 0 ? `<div class="stat-change ${change > 0 ? 'negative' : 'positive'}">${change > 0 ? '+' : ''}${change}%</div>` : ''}
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                    
                    // Measurements
                    if (latest.chest || latest.arms || latest.waist || latest.legs) {
                        html += `
                            <div class="card">
                                <div class="card-title" style="margin-bottom: 12px;">üìê Measurements</div>
                                ${latest.chest ? `<div class="history-item"><div class="history-date">Chest</div><div class="history-sets">${latest.chest}cm</div></div>` : ''}
                                ${latest.arms ? `<div class="history-item"><div class="history-date">Arms</div><div class="history-sets">${latest.arms}cm</div></div>` : ''}
                                ${latest.waist ? `<div class="history-item"><div class="history-date">Waist</div><div class="history-sets">${latest.waist}cm</div></div>` : ''}
                                ${latest.legs ? `<div class="history-item"><div class="history-date">Legs</div><div class="history-sets">${latest.legs}cm</div></div>` : ''}
                            </div>
                        `;
                    }
                    
                    // History chart
                    if (this.bodyMetrics.filter(m => m.weight).length > 1) {
                        html += this.renderWeightChart();
                    }
                    
                    // History list
                    html += `
                        <div class="card">
                            <div class="card-title" style="margin-bottom: 12px;">History</div>
                            ${this.bodyMetrics.slice(-10).reverse().map(metric => `
                                <div class="history-item">
                                    <div class="history-date">${this.formatDate(metric.date)}</div>
                                    <div class="history-sets">
                                        ${metric.weight ? `${metric.weight}kg` : ''}
                                        ${metric.bodyFat ? ` ‚Ä¢ ${metric.bodyFat}% BF` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                document.getElementById('metricsContent').innerHTML = html;
            },

            renderWeightChart() {
                const weights = this.bodyMetrics.filter(m => m.weight).slice(-10);
                const maxWeight = Math.max(...weights.map(m => m.weight));
                const minWeight = Math.min(...weights.map(m => m.weight));
                const range = maxWeight - minWeight;
                
                return `
                    <div class="chart-container">
                        <div class="chart-title">Weight Progress</div>
                        <div class="simple-chart">
                            ${weights.map(metric => {
                                const height = range > 0 ? ((metric.weight - minWeight) / range) * 100 : 50;
                                return `
                                    <div class="chart-bar" style="height: ${height}%">
                                        <div class="chart-bar-value">${metric.weight}</div>
                                        <div class="chart-bar-label">${new Date(metric.date).getDate()}/${new Date(metric.date).getMonth() + 1}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            },

            showAddMetric() {
                const latest = this.bodyMetrics.length > 0 ? this.bodyMetrics[this.bodyMetrics.length - 1] : {};
                
                const html = `
                    <div class="metric-input-group">
                        <label class="metric-label">Body Weight (kg)</label>
                        <input type="number" step="0.1" class="metric-input" id="metricWeight" placeholder="${latest.weight || '70'}">
                        ${latest.weight ? `<div class="metric-history">Last: ${latest.weight}kg</div>` : ''}
                    </div>
                    
                    <div class="metric-input-group">
                        <label class="metric-label">Body Fat %</label>
                        <input type="number" step="0.1" class="metric-input" id="metricBodyFat" placeholder="${latest.bodyFat || '15'}">
                        ${latest.bodyFat ? `<div class="metric-history">Last: ${latest.bodyFat}%</div>` : ''}
                    </div>
                    
                    <div class="metric-input-group">
                        <label class="metric-label">Chest (cm)</label>
                        <input type="number" step="0.1" class="metric-input" id="metricChest" placeholder="${latest.chest || '100'}">
                    </div>
                    
                    <div class="metric-input-group">
                        <label class="metric-label">Arms (cm)</label>
                        <input type="number" step="0.1" class="metric-input" id="metricArms" placeholder="${latest.arms || '40'}">
                    </div>
                    
                    <div class="metric-input-group">
                        <label class="metric-label">Waist (cm)</label>
                        <input type="number" step="0.1" class="metric-input" id="metricWaist" placeholder="${latest.waist || '80'}">
                    </div>
                    
                    <div class="metric-input-group">
                        <label class="metric-label">Legs (cm)</label>
                        <input type="number" step="0.1" class="metric-input" id="metricLegs" placeholder="${latest.legs || '60'}">
                    </div>
                    
                    <button class="btn btn-primary" onclick="app.saveMetric()">üíæ Save Metrics</button>
                `;
                
                document.getElementById('addMetricContent').innerHTML = html;
                document.getElementById('addMetricModal').classList.add('active');
            },

            async saveMetric() {
                const metric = {
                    date: new Date().toLocaleDateString(),
                    weight: parseFloat(document.getElementById('metricWeight').value) || null,
                    bodyFat: parseFloat(document.getElementById('metricBodyFat').value) || null,
                    chest: parseFloat(document.getElementById('metricChest').value) || null,
                    arms: parseFloat(document.getElementById('metricArms').value) || null,
                    waist: parseFloat(document.getElementById('metricWaist').value) || null,
                    legs: parseFloat(document.getElementById('metricLegs').value) || null
                };
                
                // Only save if at least one value is provided
                if (Object.values(metric).some(v => v !== null && v !== metric.date)) {
                    this.bodyMetrics.push(metric);
                    await this.saveBodyMetrics();
                    this.closeAddMetric();
                    this.renderMetrics();
                } else {
                    alert('Please enter at least one measurement');
                }
            },

            closeAddMetric() {
                document.getElementById('addMetricModal').classList.remove('active');
            },

            // Theme Functions
            loadTheme() {
                const savedTheme = this.theme || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
                this.updateThemeIcon(savedTheme);
            },

            async toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                this.theme = newTheme;
                this.updateThemeIcon(newTheme);
                
                // Save preference
                if (window.storage) {
                    try {
                        await window.storage.set('theme', newTheme, false);
                    } catch (error) {
                        console.error('Failed to save theme:', error);
                    }
                }
            },

            updateThemeIcon(theme) {
                const icon = document.getElementById('themeToggle');
                if (icon) {
                    icon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                }
            },

            // Import Functions
            showImportModal() {
                document.getElementById('importModal').classList.add('active');
                document.getElementById('importStatus').innerHTML = '';
            },

            closeImportModal() {
                document.getElementById('importModal').classList.remove('active');
            },

            async handleImportFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Validate data structure
                        if (!data.workouts && !data.templates && !data.bodyMetrics) {
                            throw new Error('Invalid backup file format');
                        }

                        // Show confirmation
                        const confirmed = confirm(
                            `Import data from ${data.exportDate || 'backup'}?\n\n` +
                            `This will replace your current data:\n` +
                            `‚Ä¢ ${data.workouts?.length || 0} workouts\n` +
                            `‚Ä¢ ${data.templates?.length || 0} templates\n` +
                            `‚Ä¢ ${data.bodyMetrics?.length || 0} body measurements\n\n` +
                            `Current data will be lost. Continue?`
                        );

                        if (!confirmed) return;

                        // Import data
                        this.workouts = data.workouts || [];
                        this.templates = data.templates || [];
                        this.bodyMetrics = data.bodyMetrics || [];
                        this.personalRecords = data.personalRecords || {};

                        // Save to storage
                        await this.saveWorkouts();
                        await this.saveTemplates();
                        await this.saveBodyMetrics();
                        await this.savePersonalRecords();

                        // Refresh all views
                        this.renderToday();
                        this.renderAnalytics();
                        this.renderTemplates();
                        this.renderMetrics();
                        this.renderLibrary();

                        // Show success
                        document.getElementById('importStatus').innerHTML = `
                            <div style="background: var(--success); color: white; padding: 12px; border-radius: 8px; margin-top: 16px;">
                                ‚úì Successfully imported ${this.workouts.length} workouts, ${this.templates.length} templates, and ${this.bodyMetrics.length} measurements!
                            </div>
                        `;

                        setTimeout(() => {
                            this.closeImportModal();
                        }, 2000);

                    } catch (error) {
                        document.getElementById('importStatus').innerHTML = `
                            <div style="background: var(--danger); color: white; padding: 12px; border-radius: 8px; margin-top: 16px;">
                                ‚úó Import failed: ${error.message}
                            </div>
                        `;
                    }
                };

                reader.readAsText(file);
            },

            // Exercise Details
            showExerciseDetails(exerciseName) {
                const exerciseWorkouts = this.workouts
                    .filter(w => w.exercise === exerciseName)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const details = this.exerciseDetails[exerciseName] || {};
                const pr = this.personalRecords[exerciseName];
                
                let html = '';
                
                // Exercise info
                if (details.instructions) {
                    html += `
                        <div class="exercise-info">
                            <div class="info-section">
                                <div class="info-title">HOW TO PERFORM</div>
                                <div class="info-text">${details.instructions}</div>
                            </div>
                            ${details.tips ? `
                                <div class="info-section">
                                    <div class="info-title">TIPS</div>
                                    <div class="info-text">${details.tips}</div>
                                </div>
                            ` : ''}
                            ${details.alternatives ? `
                                <div class="info-section">
                                    <div class="info-title">ALTERNATIVES</div>
                                    <div class="info-text">${details.alternatives.join(', ')}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // PR badge
                if (pr) {
                    html += `
                        <div class="card">
                            <div class="card-title">üèÜ Personal Record</div>
                            <div style="font-size: 32px; font-weight: 700; margin-top: 8px;">${pr}kg</div>
                        </div>
                    `;
                }
                
                // Progress chart
                if (exerciseWorkouts.length > 1) {
                    const maxWeights = exerciseWorkouts.slice(0, 10).reverse().map(w => 
                        Math.max(...w.sets.map(s => s.weight || 0))
                    );
                    const maxWeight = Math.max(...maxWeights);
                    
                    html += `
                        <div class="chart-container">
                            <div class="chart-title">Max Weight Progress</div>
                            <div class="simple-chart">
                                ${exerciseWorkouts.slice(0, 10).reverse().map((workout, i) => {
                                    const weight = Math.max(...workout.sets.map(s => s.weight || 0));
                                    const height = (weight / maxWeight) * 100;
                                    return `
                                        <div class="chart-bar" style="height: ${height}%">
                                            <div class="chart-bar-value">${weight}</div>
                                            <div class="chart-bar-label">${new Date(workout.date).getDate()}/${new Date(workout.date).getMonth() + 1}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // History
                html += `
                    <div class="card">
                        <div class="card-title" style="margin-bottom: 12px;">Recent Workouts</div>
                        ${exerciseWorkouts.length === 0 ? '<div class="empty-text">No history yet</div>' : ''}
                        ${exerciseWorkouts.slice(0, 10).map(workout => `
                            <div class="history-item">
                                <div class="history-date">${this.formatDate(workout.date)}</div>
                                <div class="history-sets">${workout.sets.map(s => `${s.weight}kg √ó ${s.reps}`).join(', ')}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                html += `<button class="btn btn-primary" onclick="app.startWorkout('${exerciseName.replace(/'/g, "\\'")}'); app.closeExerciseDetails();">Start Workout</button>`;
                
                document.getElementById('detailsExerciseName').textContent = exerciseName;
                document.getElementById('exerciseDetailsContent').innerHTML = html;
                document.getElementById('exerciseDetailsModal').classList.add('active');
            },

            closeExerciseDetails() {
                document.getElementById('exerciseDetailsModal').classList.remove('active');
            },

            // Utility Functions
            duplicateLastWorkout() {
                const dates = [...new Set(this.workouts.map(w => w.date))].sort((a, b) => new Date(b) - new Date(a));
                if (dates.length === 0) {
                    alert('No previous workouts to duplicate');
                    return;
                }
                
                const today = new Date().toLocaleDateString();
                const lastDate = dates.find(d => d !== today);
                
                if (!lastDate) {
                    alert('No previous workouts found (other than today)');
                    return;
                }
                
                const lastWorkouts = this.workouts.filter(w => w.date === lastDate);
                
                // Show preview with smart suggestions
                const preview = lastWorkouts.map(w => {
                    const maxWeight = Math.max(...w.sets.map(s => s.weight || 0));
                    const suggestedIncrease = 2.5;
                    return `‚Ä¢ ${w.exercise}: ${w.sets.length} sets (Max: ${maxWeight}kg ‚Üí ${maxWeight + suggestedIncrease}kg)`;
                }).join('\n');
                
                const confirmed = confirm(
                    `Repeat workout from ${this.formatDate(lastDate)}?\n\n` +
                    `${preview}\n\n` +
                    `üí° Tip: Weights will be pre-filled with +2.5kg suggestions for progressive overload!`
                );
                
                if (!confirmed) return;
                
                // Start with first exercise
                if (lastWorkouts.length > 0) {
                    this.duplicateWorkouts = lastWorkouts;
                    this.duplicateIndex = 0;
                    this.startWorkoutFromDuplicate(lastWorkouts[0]);
                }
            },

            startWorkoutFromDuplicate(workout) {
                this.currentExercise = workout.exercise;
                
                // Smart progressive overload: add 2.5kg to each set
                this.currentWorkout = {
                    sets: workout.sets.map(s => ({ 
                        weight: (s.weight || 0) + 2.5, 
                        reps: s.reps 
                    }))
                };
                
                const lastWorkout = this.workouts
                    .filter(w => w.exercise === workout.exercise && w.id !== workout.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                
                this.showWorkoutModal(lastWorkout, true);
            },

            async deleteWorkout(workoutId) {
                if (!confirm('Delete this workout?')) return;
                
                this.workouts = this.workouts.filter(w => w.id !== workoutId);
                await this.saveWorkouts();
                this.renderToday();
                this.renderAnalytics();
            },

            showExportModal() {
                document.getElementById('exportModal').classList.add('active');
            },

            closeExportModal() {
                document.getElementById('exportModal').classList.remove('active');
            },

            exportToCSV() {
                const csv = ['Date,Exercise,Set,Weight (kg),Reps,Volume'];
                
                this.workouts.forEach(workout => {
                    workout.sets.forEach((set, i) => {
                        const volume = (set.weight || 0) * (set.reps || 0);
                        csv.push(`${workout.date},${workout.exercise},${i + 1},${set.weight || 0},${set.reps || 0},${volume}`);
                    });
                });
                
                const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gym-tracker-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                this.closeExportModal();
            },

            exportJSON() {
                const data = {
                    workouts: this.workouts,
                    templates: this.templates,
                    bodyMetrics: this.bodyMetrics,
                    personalRecords: this.personalRecords,
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gym-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                this.closeExportModal();
            },

            shareWorkoutSummary() {
                const today = new Date();
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                const weekWorkouts = this.workouts.filter(w => new Date(w.date) >= weekAgo);
                
                const summary = `
üèãÔ∏è My Week in Fitness

üìä Stats:
‚Ä¢ ${[...new Set(weekWorkouts.map(w => w.date))].length} workout days
‚Ä¢ ${weekWorkouts.length} total exercises
‚Ä¢ ${weekWorkouts.reduce((sum, w) => sum + w.sets.length, 0)} total sets

üí™ Top Exercises:
${[...new Set(weekWorkouts.map(w => w.exercise))].slice(0, 5).map(ex => `‚Ä¢ ${ex}`).join('\n')}

Tracked with Gym Tracker
                `.trim();
                
                if (navigator.share) {
                    navigator.share({ text: summary });
                } else {
                    navigator.clipboard.writeText(summary);
                    alert('Summary copied to clipboard!');
                }
                
                this.closeExportModal();
            },

            showExerciseModal() {
                document.getElementById('exerciseModal').classList.add('active');
                document.getElementById('exerciseSearch').value = '';
                this.renderModalExercises();
            },

            closeExerciseModal() {
                document.getElementById('exerciseModal').classList.remove('active');
            },

            renderModalExercises(filter = '') {
                const filtered = this.exercises.filter(e => 
                    e.name.toLowerCase().includes(filter.toLowerCase())
                );

                const categories = [...new Set(filtered.map(e => e.category))];
                const html = categories.map(cat => `
                    <div class="exercise-category">
                        <div class="category-title">${cat}</div>
                        ${filtered.filter(e => e.category === cat).map(ex => `
                            <div class="exercise-item" onclick="app.startWorkout('${ex.name.replace(/'/g, "\\'")}')">
                                <div>
                                    <div class="exercise-name">${ex.name}</div>
                                    <div class="exercise-muscle">${ex.muscle}</div>
                                </div>
                                <div class="chevron">+</div>
                            </div>
                        `).join('')}
                    </div>
                `).join('');

                document.getElementById('modalExerciseList').innerHTML = html;
            },

            filterExercises() {
                const filter = document.getElementById('exerciseSearch').value;
                this.renderModalExercises(filter);
            },

            startWorkout(exerciseName) {
                this.closeExerciseModal();
                this.currentExercise = exerciseName;
                this.currentWorkout = { sets: [{ weight: '', reps: '' }] };
                
                // Get last workout for this exercise
                const lastWorkout = this.workouts
                    .filter(w => w.exercise === exerciseName)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                this.showWorkoutModal(lastWorkout);
            },

            showWorkoutModal(lastWorkout, isDuplicate = false) {
                document.getElementById('workoutExerciseName').textContent = this.currentExercise;
                
                let lastWorkoutHTML = '';
                if (lastWorkout) {
                    const volume = lastWorkout.sets.reduce((sum, s) => sum + (s.weight * s.reps), 0);
                    lastWorkoutHTML = `
                        <div class="last-workout">
                            <div class="last-workout-title">Last Workout (${this.formatDate(lastWorkout.date)})</div>
                            <div class="last-workout-data">
                                ${lastWorkout.sets.map((s, i) => `Set ${i + 1}: ${s.weight}kg √ó ${s.reps} reps`).join(' ‚Ä¢ ')}
                                <br>Total Volume: ${volume}kg
                            </div>
                        </div>
                    `;
                }

                // Suggest next weight based on last performance
                const suggestedWeight = lastWorkout && lastWorkout.sets.length > 0 
                    ? Math.max(...lastWorkout.sets.map(s => s.weight || 0)) + 2.5 
                    : 0;

                const setsHTML = this.currentWorkout.sets.map((set, i) => `
                    <div class="set-item">
                        <div class="set-number">Set ${i + 1}</div>
                        <div class="set-input">
                            <div class="input-group">
                                <label class="input-label">Weight (kg)</label>
                                ${i === 0 && suggestedWeight > 0 ? `
                                    <div class="weight-adjust">
                                        <button class="adjust-btn" onclick="app.quickSetWeight(${i}, ${suggestedWeight - 5})">-5kg</button>
                                        <button class="adjust-btn" onclick="app.quickSetWeight(${i}, ${suggestedWeight - 2.5})">-2.5kg</button>
                                        <button class="adjust-btn" onclick="app.quickSetWeight(${i}, ${suggestedWeight})" style="background: var(--primary); color: white;">‚Üë ${suggestedWeight}kg</button>
                                    </div>
                                ` : ''}
                                <input type="number" 
                                    id="weight-${i}"
                                    value="${set.weight}" 
                                    onchange="app.updateSet(${i}, 'weight', this.value)"
                                    placeholder="${lastWorkout?.sets[i]?.weight || '0'}">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Reps</label>
                                <input type="number" 
                                    id="reps-${i}"
                                    value="${set.reps}" 
                                    onchange="app.updateSet(${i}, 'reps', this.value)"
                                    placeholder="${lastWorkout?.sets[i]?.reps || '0'}">
                            </div>
                            <div class="input-group" style="flex: 0.5;">
                                <label class="input-label">RPE</label>
                                <input type="number" 
                                    id="rpe-${i}"
                                    min="1"
                                    max="10"
                                    value="${set.rpe || ''}" 
                                    onchange="app.updateSet(${i}, 'rpe', this.value)"
                                    placeholder="1-10"
                                    style="text-align: center;">
                            </div>
                        </div>
                        ${i > 0 ? `<button class="delete-set" onclick="app.removeSet(${i})">‚àí</button>` : ''}
                    </div>
                `).join('');

                document.getElementById('workoutContent').innerHTML = `
                    ${lastWorkoutHTML}
                    <div class="set-list">
                        ${setsHTML}
                    </div>
                    <div class="metric-input-group" style="margin-bottom: 12px;">
                        <label class="input-label">Workout Notes (Optional)</label>
                        <input type="text" id="workoutNotes" class="metric-input" placeholder="How did it feel? Any observations?" style="font-size: 14px;">
                    </div>
                    <button class="btn btn-secondary" onclick="app.addSet()">+ Add Set</button>
                    <button class="btn btn-secondary" onclick="app.startSuperset()" style="background: var(--warning);">üîó Superset with Next Exercise</button>
                    <button class="btn btn-success" onclick="app.finishWorkout()">‚úì Finish Workout</button>
                `;

                document.getElementById('workoutModal').classList.add('active');
            },

            quickSetWeight(setIndex, weight) {
                this.currentWorkout.sets[setIndex].weight = weight;
                document.getElementById(`weight-${setIndex}`).value = weight;
            },

            closeWorkoutModal() {
                document.getElementById('workoutModal').classList.remove('active');
            },

            updateSet(index, field, value) {
                this.currentWorkout.sets[index][field] = parseFloat(value) || '';
            },

            addSet() {
                this.currentWorkout.sets.push({ weight: '', reps: '' });
                const lastWorkout = this.workouts
                    .filter(w => w.exercise === this.currentExercise)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                this.showWorkoutModal(lastWorkout);
            },

            removeSet(index) {
                this.currentWorkout.sets.splice(index, 1);
                const lastWorkout = this.workouts
                    .filter(w => w.exercise === this.currentExercise)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                this.showWorkoutModal(lastWorkout);
            },

            async finishWorkout() {
                const validSets = this.currentWorkout.sets.filter(s => s.weight && s.reps);
                
                if (validSets.length === 0) {
                    alert('Please add at least one set with weight and reps');
                    return;
                }

                const notes = document.getElementById('workoutNotes')?.value || '';
                const workoutId = Date.now().toString();

                const workout = {
                    id: workoutId,
                    exercise: this.currentExercise,
                    date: new Date().toLocaleDateString(),
                    sets: validSets,
                    superset: this.currentSuperset ? this.currentSuperset : null
                };

                this.workouts.push(workout);

                // Save notes if provided
                if (notes) {
                    this.workoutNotes[workoutId] = notes;
                    await this.saveWorkoutNotes();
                }

                await this.saveWorkouts();
                
                // Check for new achievements
                this.checkAchievements();
                
                this.closeWorkoutModal();
                this.renderToday();
                this.renderAnalytics();
                
                // Check if this is a superset - skip rest timer
                const isSuperset = this.currentSuperset !== null;
                
                // Check if this is part of a template
                if (this.currentTemplate && this.currentTemplateIndex < this.currentTemplate.exercises.length - 1) {
                    // Start rest timer before next exercise (unless superset)
                    if (isSuperset) {
                        this.currentSuperset = null; // Clear superset flag
                        this.currentTemplateIndex++;
                        this.startWorkout(this.currentTemplate.exercises[this.currentTemplateIndex].name);
                    } else {
                        this.startRestTimer(() => {
                            this.currentTemplateIndex++;
                            this.startWorkout(this.currentTemplate.exercises[this.currentTemplateIndex].name);
                        });
                    }
                } else if (this.duplicateWorkouts && this.duplicateIndex < this.duplicateWorkouts.length - 1) {
                    // Continue with duplicate workout
                    if (isSuperset) {
                        this.currentSuperset = null;
                        this.duplicateIndex++;
                        this.startWorkoutFromDuplicate(this.duplicateWorkouts[this.duplicateIndex]);
                    } else {
                        this.startRestTimer(() => {
                            this.duplicateIndex++;
                            this.startWorkoutFromDuplicate(this.duplicateWorkouts[this.duplicateIndex]);
                        });
                    }
                } else {
                    this.currentTemplate = null;
                    this.duplicateWorkouts = null;
                    this.currentSuperset = null;
                }
            },

            // Rest Timer Functions
            startRestTimer(callback = null) {
                this.restTimeRemaining = this.settings.restTimerDuration;
                this.restCallback = callback;
                document.getElementById('restTimer').classList.add('active');
                this.updateTimerDisplay();
                
                this.restTimer = setInterval(() => {
                    this.restTimeRemaining--;
                    this.updateTimerDisplay();
                    
                    if (this.restTimeRemaining <= 0) {
                        this.completeRest();
                    }
                }, 1000);
                
                // Vibrate on start
                if (navigator.vibrate) {
                    navigator.vibrate(200);
                }
            },

            updateTimerDisplay() {
                const minutes = Math.floor(this.restTimeRemaining / 60);
                const seconds = this.restTimeRemaining % 60;
                document.getElementById('timerDisplay').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            },

            completeRest() {
                clearInterval(this.restTimer);
                document.getElementById('restTimer').classList.remove('active');
                
                // Vibrate on complete
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
                
                if (this.restCallback) {
                    this.restCallback();
                    this.restCallback = null;
                }
            },

            skipRest() {
                this.completeRest();
            },

            addRestTime(seconds) {
                this.restTimeRemaining += seconds;
                this.updateTimerDisplay();
            },

            // Superset Functions
            startSuperset() {
                // Mark that next exercise should be a superset
                this.currentSuperset = this.currentExercise;
                alert('üí™ Superset mode activated! Your next exercise will be paired with this one. No rest timer between exercises.');
                this.finishWorkout();
            },

            // Progress Photos Functions
            showAddPhoto() {
                document.getElementById('addPhotoModal').classList.add('active');
                document.getElementById('photoPreview').innerHTML = '';
            },

            closeAddPhoto() {
                document.getElementById('addPhotoModal').classList.remove('active');
            },

            async handlePhotoUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const dataUrl = e.target.result;
                    
                    // Show preview
                    document.getElementById('photoPreview').innerHTML = `
                        <div style="margin-top: 16px;">
                            <img src="${dataUrl}" style="width: 100%; border-radius: 12px; margin-bottom: 12px;" alt="Preview">
                            <input type="text" id="photoNotes" class="metric-input" placeholder="Add notes (optional)" style="margin-bottom: 12px;">
                            <button class="btn btn-primary" onclick="app.savePhoto('${dataUrl.replace(/'/g, "\\'")}')">üíæ Save Photo</button>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            },

            async savePhoto(dataUrl) {
                const notes = document.getElementById('photoNotes')?.value || '';
                
                this.progressPhotos.push({
                    date: new Date().toISOString(),
                    dataUrl: dataUrl,
                    notes: notes,
                    weight: this.bodyMetrics.length > 0 ? this.bodyMetrics[this.bodyMetrics.length - 1].weight : null
                });

                await this.saveProgressPhotos();
                this.closeAddPhoto();
                this.renderMetrics();
            },

            showPhotoComparison(index) {
                const photo = this.progressPhotos[index];
                if (!photo) return;

                // Find first photo for comparison
                const firstPhoto = this.progressPhotos[0];
                const daysBetween = Math.floor((new Date(photo.date) - new Date(firstPhoto.date)) / (1000 * 60 * 60 * 24));

                let html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">
                            ${new Date(photo.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                        </h3>
                        ${photo.notes ? `<p style="color: var(--text-secondary);">${photo.notes}</p>` : ''}
                        ${photo.weight ? `<p style="color: var(--text-secondary);">Weight: ${photo.weight}kg</p>` : ''}
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <div>
                            <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">
                                START (${new Date(firstPhoto.date).toLocaleDateString()})
                            </div>
                            <img src="${firstPhoto.dataUrl}" style="width: 100%; border-radius: 12px;" alt="Before">
                            ${firstPhoto.weight ? `<div style="text-align: center; margin-top: 4px; font-size: 12px; color: var(--text-secondary);">${firstPhoto.weight}kg</div>` : ''}
                        </div>
                        <div>
                            <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">
                                CURRENT (+${daysBetween} days)
                            </div>
                            <img src="${photo.dataUrl}" style="width: 100%; border-radius: 12px;" alt="After">
                            ${photo.weight ? `<div style="text-align: center; margin-top: 4px; font-size: 12px; color: var(--text-secondary);">${photo.weight}kg</div>` : ''}
                        </div>
                    </div>

                    ${photo.weight && firstPhoto.weight ? `
                        <div class="card" style="background: var(--primary); color: white;">
                            <div style="text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9;">Weight Change</div>
                                <div style="font-size: 32px; font-weight: 700; margin: 8px 0;">
                                    ${photo.weight > firstPhoto.weight ? '+' : ''}${(photo.weight - firstPhoto.weight).toFixed(1)}kg
                                </div>
                                <div style="font-size: 12px; opacity: 0.9;">${daysBetween} days</div>
                            </div>
                        </div>
                    ` : ''}

                    <button class="btn btn-danger" onclick="app.deletePhoto(${index})">üóëÔ∏è Delete Photo</button>
                `;

                document.getElementById('photoCompareContent').innerHTML = html;
                document.getElementById('photoCompareModal').classList.add('active');
            },

            closePhotoComparison() {
                document.getElementById('photoCompareModal').classList.remove('active');
            },

            async deletePhoto(index) {
                if (!confirm('Delete this progress photo?')) return;
                
                this.progressPhotos.splice(index, 1);
                await this.saveProgressPhotos();
                this.closePhotoComparison();
                this.renderMetrics();
            },

            showAllPhotos() {
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        ${this.progressPhotos.map((photo, i) => `
                            <div onclick="app.showPhotoComparison(${i})" style="cursor: pointer; position: relative; padding-bottom: 100%; overflow: hidden; border-radius: 12px; background: var(--background);">
                                <img src="${photo.dataUrl}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" alt="Progress photo">
                                <div style="position: absolute; bottom: 8px; left: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 6px; border-radius: 6px; font-size: 11px;">
                                    <div>${new Date(photo.date).toLocaleDateString()}</div>
                                    ${photo.weight ? `<div>${photo.weight}kg</div>` : ''}
                                </div>
                            </div>
                        `).reverse().join('')}
                    </div>
                `;

                const modalContent = `
                    <div class="modal active" id="allPhotosModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">All Progress Photos</h2>
                                <button class="close-btn" onclick="document.getElementById('allPhotosModal').remove()">√ó</button>
                            </div>
                            ${html}
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalContent);
            },

            // More Tab - Settings, Goals, Achievements, Metrics
            renderMore() {
                let html = `
                    <div class="quick-actions" style="margin-bottom: 20px;">
                        <div class="quick-action-btn" onclick="app.showSection('metrics')">
                            <div class="quick-action-icon">üìè</div>
                            <div class="quick-action-label">Body Metrics</div>
                        </div>
                        <div class="quick-action-btn" onclick="app.switchTab('library')">
                            <div class="quick-action-icon">üìö</div>
                            <div class="quick-action-label">Exercise Library</div>
                        </div>
                        <div class="quick-action-btn" onclick="app.showSection('goals')">
                            <div class="quick-action-icon">üéØ</div>
                            <div class="quick-action-label">Goals</div>
                        </div>
                        <div class="quick-action-btn" onclick="app.showSection('achievements')">
                            <div class="quick-action-icon">üèÖ</div>
                            <div class="quick-action-label">Achievements</div>
                        </div>
                        <div class="quick-action-btn" onclick="app.showSection('settings')">
                            <div class="quick-action-icon">‚öôÔ∏è</div>
                            <div class="quick-action-label">Settings</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title" style="margin-bottom: 12px;">App Info</div>
                        <div class="history-item">
                            <div class="history-date">Version</div>
                            <div class="history-sets">3.0 - Health Edition</div>
                        </div>
                        <div class="history-item">
                            <div class="history-date">Total Workouts</div>
                            <div class="history-sets">${this.workouts.length}</div>
                        </div>
                        <div class="history-item">
                            <div class="history-date">Workout Sessions</div>
                            <div class="history-sets">${this.workoutSessions.length}</div>
                        </div>
                        <div class="history-item">
                            <div class="history-date">Achievements Unlocked</div>
                            <div class="history-sets">${this.achievements.length}</div>
                        </div>
                    </div>
                `;

                document.getElementById('moreContent').innerHTML = html;
            },

            showSection(section) {
                if (section === 'metrics') {
                    this.switchTab('metrics');
                } else if (section === 'goals') {
                    this.showGoals();
                } else if (section === 'achievements') {
                    this.showAchievements();
                } else if (section === 'settings') {
                    this.showSettings();
                }
            },

            // Settings
            showSettings() {
                const html = `
                    <div class="metric-input-group">
                        <label class="metric-label">Rest Timer Duration</label>
                        <select id="restDuration" class="metric-input" onchange="app.updateSetting('restTimerDuration', parseInt(this.value))">
                            <option value="60" ${this.settings.restTimerDuration === 60 ? 'selected' : ''}>60 seconds</option>
                            <option value="90" ${this.settings.restTimerDuration === 90 ? 'selected' : ''}>90 seconds (default)</option>
                            <option value="120" ${this.settings.restTimerDuration === 120 ? 'selected' : ''}>2 minutes</option>
                            <option value="180" ${this.settings.restTimerDuration === 180 ? 'selected' : ''}>3 minutes</option>
                            <option value="240" ${this.settings.restTimerDuration === 240 ? 'selected' : ''}>4 minutes</option>
                        </select>
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">Default Weight Increment</label>
                        <select id="weightInc" class="metric-input" onchange="app.updateSetting('weightIncrement', parseFloat(this.value))">
                            <option value="1.25" ${this.settings.weightIncrement === 1.25 ? 'selected' : ''}>1.25 kg</option>
                            <option value="2.5" ${this.settings.weightIncrement === 2.5 ? 'selected' : ''}>2.5 kg (default)</option>
                            <option value="5" ${this.settings.weightIncrement === 5 ? 'selected' : ''}>5 kg</option>
                            <option value="10" ${this.settings.weightIncrement === 10 ? 'selected' : ''}>10 kg</option>
                        </select>
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">Units</label>
                        <select id="units" class="metric-input" onchange="app.updateSetting('units', this.value)">
                            <option value="kg" ${this.settings.units === 'kg' ? 'selected' : ''}>Kilograms (kg)</option>
                            <option value="lbs" ${this.settings.units === 'lbs' ? 'selected' : ''}>Pounds (lbs)</option>
                        </select>
                        <div class="metric-history">Note: Unit conversion coming soon!</div>
                    </div>

                    <button class="btn btn-danger" onclick="app.clearAllData()" style="margin-top: 20px;">
                        üóëÔ∏è Clear All Data
                    </button>
                `;

                const modalContent = `
                    <div class="modal active" id="settingsModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">Settings</h2>
                                <button class="close-btn" onclick="document.getElementById('settingsModal').remove()">√ó</button>
                            </div>
                            ${html}
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalContent);
            },

            async updateSetting(key, value) {
                this.settings[key] = value;
                await this.saveSettings();
            },

            async clearAllData() {
                if (!confirm('Are you sure? This will delete ALL your data permanently!')) return;
                if (!confirm('Last chance! This cannot be undone. Delete everything?')) return;

                this.workouts = [];
                this.templates = [];
                this.bodyMetrics = [];
                this.progressPhotos = [];
                this.personalRecords = {};
                this.goals = [];
                this.achievements = [];
                this.workoutNotes = {};

                await this.saveWorkouts();
                await this.saveTemplates();
                await this.saveBodyMetrics();
                await this.saveProgressPhotos();
                await this.savePersonalRecords();
                await this.saveGoals();
                await this.saveAchievements();
                await this.saveWorkoutNotes();

                alert('All data cleared!');
                location.reload();
            },

            // Goals
            showGoals() {
                let html = `
                    <button class="btn btn-primary" onclick="app.showAddGoal()" style="margin-bottom: 16px;">+ Add New Goal</button>
                `;

                if (this.goals.length === 0) {
                    html += `
                        <div class="empty-state">
                            <div class="empty-icon">üéØ</div>
                            <div class="empty-text">No goals set yet<br>Set a goal to stay motivated!</div>
                        </div>
                    `;
                } else {
                    html += this.goals.map((goal, i) => {
                        const progress = this.calculateGoalProgress(goal);
                        return `
                            <div class="card">
                                <div class="card-title">${goal.type === 'strength' ? 'üí™' : '‚öñÔ∏è'} ${goal.title}</div>
                                <div class="card-subtitle" style="margin-bottom: 12px;">
                                    ${goal.type === 'strength' ? goal.exercise : 'Body Weight'} ‚Ä¢ Target: ${goal.target}${goal.type === 'strength' ? 'kg' : 'kg'}
                                </div>
                                <div style="background: var(--background); height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 8px;">
                                    <div style="background: var(--primary); height: 100%; width: ${Math.min(progress, 100)}%; transition: width 0.3s;"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                    <span>${goal.current || 0}${goal.type === 'strength' ? 'kg' : 'kg'} / ${goal.target}${goal.type === 'strength' ? 'kg' : 'kg'}</span>
                                    <span style="color: var(--primary); font-weight: 600;">${Math.round(progress)}%</span>
                                </div>
                                ${progress >= 100 ? '<div style="margin-top: 8px; color: var(--success); font-weight: 600;">üéâ Goal Achieved!</div>' : ''}
                                <button class="btn btn-danger" style="margin-top: 12px;" onclick="app.deleteGoal(${i})">Delete Goal</button>
                            </div>
                        `;
                    }).join('');
                }

                const modalContent = `
                    <div class="modal active" id="goalsModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">My Goals</h2>
                                <button class="close-btn" onclick="document.getElementById('goalsModal').remove()">√ó</button>
                            </div>
                            ${html}
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalContent);
            },

            showAddGoal() {
                const html = `
                    <div class="metric-input-group">
                        <label class="metric-label">Goal Type</label>
                        <select id="goalType" class="metric-input" onchange="app.toggleGoalFields()">
                            <option value="strength">Strength Goal (e.g., Squat 140kg)</option>
                            <option value="bodyweight">Body Weight Goal</option>
                        </select>
                    </div>

                    <div id="strengthFields">
                        <div class="metric-input-group">
                            <label class="metric-label">Exercise</label>
                            <select id="goalExercise" class="metric-input">
                                ${this.exercises.map(ex => `<option value="${ex.name}">${ex.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">Target Weight (kg)</label>
                        <input type="number" id="goalTarget" class="metric-input" placeholder="140">
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">Goal Title</label>
                        <input type="text" id="goalTitle" class="metric-input" placeholder="e.g., Squat 140kg by June">
                    </div>

                    <button class="btn btn-primary" onclick="app.saveGoal()">üíæ Save Goal</button>
                `;

                const modalContent = `
                    <div class="modal active" id="addGoalModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">Add New Goal</h2>
                                <button class="close-btn" onclick="document.getElementById('addGoalModal').remove()">√ó</button>
                            </div>
                            ${html}
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalContent);
            },

            toggleGoalFields() {
                const type = document.getElementById('goalType').value;
                const strengthFields = document.getElementById('strengthFields');
                if (strengthFields) {
                    strengthFields.style.display = type === 'strength' ? 'block' : 'none';
                }
            },

            async saveGoal() {
                const type = document.getElementById('goalType').value;
                const target = parseFloat(document.getElementById('goalTarget').value);
                const title = document.getElementById('goalTitle').value;

                if (!target || !title) {
                    alert('Please fill in all fields');
                    return;
                }

                const goal = {
                    id: Date.now().toString(),
                    type: type,
                    title: title,
                    target: target,
                    current: 0,
                    createdAt: new Date().toISOString()
                };

                if (type === 'strength') {
                    goal.exercise = document.getElementById('goalExercise').value;
                    // Set current from best performance
                    const best = this.getBestPerformance(goal.exercise);
                    goal.current = best;
                }

                this.goals.push(goal);
                await this.saveGoals();

                document.getElementById('addGoalModal').remove();
                document.getElementById('goalsModal').remove();
                this.showGoals();
            },

            getBestPerformance(exercise) {
                const exerciseWorkouts = this.workouts.filter(w => w.exercise === exercise);
                if (exerciseWorkouts.length === 0) return 0;

                let maxWeight = 0;
                exerciseWorkouts.forEach(w => {
                    w.sets.forEach(s => {
                        if (s.weight > maxWeight) maxWeight = s.weight;
                    });
                });

                return maxWeight;
            },

            calculateGoalProgress(goal) {
                if (goal.type === 'strength') {
                    const current = this.getBestPerformance(goal.exercise);
                    goal.current = current;
                    return (current / goal.target) * 100;
                } else {
                    const latestWeight = this.bodyMetrics.length > 0 ? this.bodyMetrics[this.bodyMetrics.length - 1].weight : 0;
                    goal.current = latestWeight;
                    return (latestWeight / goal.target) * 100;
                }
            },

            async deleteGoal(index) {
                if (!confirm('Delete this goal?')) return;
                this.goals.splice(index, 1);
                await this.saveGoals();
                document.getElementById('goalsModal').remove();
                this.showGoals();
            },

            // Achievements
            showAchievements() {
                this.checkAchievements(); // Update achievements

                const allAchievements = [
                    { id: 'first_workout', icon: 'üéØ', title: 'First Workout', description: 'Complete your first workout' },
                    { id: '10_workouts', icon: 'üí™', title: '10 Workouts', description: 'Complete 10 workouts' },
                    { id: '50_workouts', icon: 'üî•', title: '50 Workouts', description: 'Complete 50 workouts' },
                    { id: '100_workouts', icon: 'üèÜ', title: 'Century Club', description: 'Complete 100 workouts' },
                    { id: '7_day_streak', icon: '‚ö°', title: '7 Day Streak', description: 'Workout 7 days in a row' },
                    { id: '30_day_streak', icon: 'üåü', title: '30 Day Streak', description: 'Workout 30 days in a row' },
                    { id: 'first_pr', icon: 'ü•á', title: 'First PR', description: 'Set your first personal record' },
                    { id: '10_prs', icon: 'üéñÔ∏è', title: 'PR Machine', description: 'Set 10 personal records' },
                    { id: '1000kg_volume', icon: 'üíé', title: '1000kg Volume', description: 'Complete 1000kg volume in one workout' },
                    { id: 'first_photo', icon: 'üì∏', title: 'Progress Tracker', description: 'Take your first progress photo' },
                    { id: 'goal_achieved', icon: 'üéâ', title: 'Goal Crusher', description: 'Achieve your first goal' },
                    { id: '100kg_squat', icon: 'üèãÔ∏è', title: '100kg Squat', description: 'Squat 100kg or more' },
                    { id: '100kg_bench', icon: 'üí™', title: '100kg Bench', description: 'Bench press 100kg or more' },
                    { id: '140kg_deadlift', icon: '‚ö°', title: '140kg Deadlift', description: 'Deadlift 140kg or more' }
                ];

                const unlockedIds = this.achievements.map(a => a.id);

                const html = `
                    <div style="margin-bottom: 20px;">
                        <div style="text-align: center; font-size: 48px; margin-bottom: 12px;">üèÜ</div>
                        <div style="text-align: center; font-size: 24px; font-weight: 700; margin-bottom: 4px;">
                            ${unlockedIds.length} / ${allAchievements.length}
                        </div>
                        <div style="text-align: center; color: var(--text-secondary);">Achievements Unlocked</div>
                    </div>

                    ${allAchievements.map(ach => {
                        const unlocked = unlockedIds.includes(ach.id);
                        const achievement = this.achievements.find(a => a.id === ach.id);
                        return `
                            <div class="card" style="opacity: ${unlocked ? '1' : '0.5'};">
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div style="font-size: 48px;">${unlocked ? ach.icon : 'üîí'}</div>
                                    <div style="flex: 1;">
                                        <div class="card-title">${ach.title}</div>
                                        <div class="card-subtitle">${ach.description}</div>
                                        ${unlocked && achievement ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Unlocked: ${new Date(achievement.unlockedAt).toLocaleDateString()}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;

                const modalContent = `
                    <div class="modal active" id="achievementsModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">Achievements</h2>
                                <button class="close-btn" onclick="document.getElementById('achievementsModal').remove()">√ó</button>
                            </div>
                            ${html}
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalContent);
            },

            checkAchievements() {
                const totalWorkouts = [...new Set(this.workouts.map(w => w.date))].length;
                const streak = this.calculateStreak();
                const prCount = Object.keys(this.personalRecords).length;

                const newAchievements = [];

                // Workout milestones
                if (totalWorkouts >= 1 && !this.hasAchievement('first_workout')) {
                    newAchievements.push({ id: 'first_workout', unlockedAt: new Date().toISOString() });
                }
                if (totalWorkouts >= 10 && !this.hasAchievement('10_workouts')) {
                    newAchievements.push({ id: '10_workouts', unlockedAt: new Date().toISOString() });
                }
                if (totalWorkouts >= 50 && !this.hasAchievement('50_workouts')) {
                    newAchievements.push({ id: '50_workouts', unlockedAt: new Date().toISOString() });
                }
                if (totalWorkouts >= 100 && !this.hasAchievement('100_workouts')) {
                    newAchievements.push({ id: '100_workouts', unlockedAt: new Date().toISOString() });
                }

                // Streak achievements
                if (streak >= 7 && !this.hasAchievement('7_day_streak')) {
                    newAchievements.push({ id: '7_day_streak', unlockedAt: new Date().toISOString() });
                }
                if (streak >= 30 && !this.hasAchievement('30_day_streak')) {
                    newAchievements.push({ id: '30_day_streak', unlockedAt: new Date().toISOString() });
                }

                // PR achievements
                if (prCount >= 1 && !this.hasAchievement('first_pr')) {
                    newAchievements.push({ id: 'first_pr', unlockedAt: new Date().toISOString() });
                }
                if (prCount >= 10 && !this.hasAchievement('10_prs')) {
                    newAchievements.push({ id: '10_prs', unlockedAt: new Date().toISOString() });
                }

                // Photo achievement
                if (this.progressPhotos.length >= 1 && !this.hasAchievement('first_photo')) {
                    newAchievements.push({ id: 'first_photo', unlockedAt: new Date().toISOString() });
                }

                // Weight achievements
                if (this.personalRecords['Barbell Squat'] >= 100 && !this.hasAchievement('100kg_squat')) {
                    newAchievements.push({ id: '100kg_squat', unlockedAt: new Date().toISOString() });
                }
                if (this.personalRecords['Barbell Bench Press'] >= 100 && !this.hasAchievement('100kg_bench')) {
                    newAchievements.push({ id: '100kg_bench', unlockedAt: new Date().toISOString() });
                }
                if (this.personalRecords['Deadlift'] >= 140 && !this.hasAchievement('140kg_deadlift')) {
                    newAchievements.push({ id: '140kg_deadlift', unlockedAt: new Date().toISOString() });
                }

                if (newAchievements.length > 0) {
                    this.achievements.push(...newAchievements);
                    this.saveAchievements();
                    this.showAchievementNotification(newAchievements[0]);
                }
            },

            hasAchievement(id) {
                return this.achievements.some(a => a.id === id);
            },

            showAchievementNotification(achievement) {
                const achievementData = {
                    'first_workout': { icon: 'üéØ', title: 'First Workout' },
                    '10_workouts': { icon: 'üí™', title: '10 Workouts' },
                    '50_workouts': { icon: 'üî•', title: '50 Workouts' },
                    '100_workouts': { icon: 'üèÜ', title: 'Century Club' },
                    '7_day_streak': { icon: '‚ö°', title: '7 Day Streak' },
                    '30_day_streak': { icon: 'üåü', title: '30 Day Streak' },
                    'first_pr': { icon: 'ü•á', title: 'First PR' },
                    '10_prs': { icon: 'üéñÔ∏è', title: 'PR Machine' },
                    'first_photo': { icon: 'üì∏', title: 'Progress Tracker' },
                    '100kg_squat': { icon: 'üèãÔ∏è', title: '100kg Squat' },
                    '100kg_bench': { icon: 'üí™', title: '100kg Bench' },
                    '140kg_deadlift': { icon: '‚ö°', title: '140kg Deadlift' }
                };

                const data = achievementData[achievement.id];
                if (!data) return;

                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--gradient);
                    color: white;
                    padding: 20px 24px;
                    border-radius: 16px;
                    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
                    z-index: 10000;
                    max-width: 300px;
                    text-align: center;
                    animation: slideDown 0.5s ease;
                `;

                notification.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 8px;">${data.icon}</div>
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">Achievement Unlocked!</div>
                    <div style="font-size: 16px;">${data.title}</div>
                `;

                document.body.appendChild(notification);

                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200, 100, 200]);
                }

                setTimeout(() => {
                    notification.style.animation = 'slideUp 0.5s ease';
                    setTimeout(() => notification.remove(), 500);
                }, 3000);
            },

            // Search Functionality
            showSearch() {
                document.getElementById('searchModal').classList.add('active');
                document.getElementById('globalSearch').focus();
                this.performSearch();
            },

            closeSearch() {
                document.getElementById('searchModal').classList.remove('active');
            },

            performSearch() {
                const query = document.getElementById('globalSearch').value.toLowerCase();
                
                if (!query) {
                    document.getElementById('searchResults').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üîç</div>
                            <div class="empty-text">Start typing to search your workouts</div>
                        </div>
                    `;
                    return;
                }
                
                // Search through workouts
                const results = this.workouts.filter(w => {
                    const exerciseMatch = w.exercise.toLowerCase().includes(query);
                    const dateMatch = w.date.includes(query);
                    const notesMatch = this.workoutNotes[w.id]?.toLowerCase().includes(query);
                    return exerciseMatch || dateMatch || notesMatch;
                }).sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (results.length === 0) {
                    document.getElementById('searchResults').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üòï</div>
                            <div class="empty-text">No results for "${query}"</div>
                        </div>
                    `;
                    return;
                }
                
                const html = `
                    <div style="margin-bottom: 12px; color: var(--text-secondary); font-size: 14px;">
                        ${results.length} result${results.length !== 1 ? 's' : ''} found
                    </div>
                    ${results.slice(0, 50).map(workout => {
                        const notes = this.workoutNotes[workout.id];
                        return `
                            <div class="card" onclick="app.closeSearch()">
                                <div class="card-title">${workout.exercise}</div>
                                <div class="card-subtitle">${this.formatDate(workout.date)} ‚Ä¢ ${workout.sets.length} sets</div>
                                ${notes ? `<div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px; font-style: italic;">üí≠ ${notes}</div>` : ''}
                                <div style="margin-top: 8px;">
                                    ${workout.sets.map((s, i) => `<span style="font-size: 13px; color: var(--text-secondary); margin-right: 8px;">Set ${i+1}: ${s.weight}kg √ó ${s.reps}</span>`).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                    ${results.length > 50 ? `<div style="text-align: center; color: var(--text-secondary); margin-top: 12px;">Showing first 50 results</div>` : ''}
                `;
                
                document.getElementById('searchResults').innerHTML = html;
            },

            // Trend Analysis
            addTrendAnalysis() {
                // Add to analytics tab
                const trends = this.analyzeTrends();
                
                if (!trends || trends.length === 0) return '';
                
                return `
                    <div class="card">
                        <div class="card-title" style="margin-bottom: 12px;">üìà Trends & Insights</div>
                        ${trends.map(trend => `
                            <div style="padding: 12px; background: var(--background); border-radius: 8px; margin-bottom: 8px;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${trend.icon} ${trend.title}</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">${trend.description}</div>
                                ${trend.change ? `<div style="font-size: 14px; font-weight: 600; margin-top: 4px; color: ${trend.change > 0 ? 'var(--success)' : 'var(--danger)'};">${trend.change > 0 ? '+' : ''}${trend.change}%</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            analyzeTrends() {
                const trends = [];
                
                if (this.workouts.length < 10) return trends;
                
                // Volume trend
                const last30Days = this.getWorkoutsInDays(30);
                const prev30Days = this.getWorkoutsInDays(60, 30);
                
                const currentVolume = last30Days.reduce((sum, w) => 
                    sum + w.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                );
                const previousVolume = prev30Days.reduce((sum, w) => 
                    sum + w.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                );
                
                if (previousVolume > 0) {
                    const volumeChange = Math.round(((currentVolume - previousVolume) / previousVolume) * 100);
                    if (Math.abs(volumeChange) > 10) {
                        trends.push({
                            icon: volumeChange > 0 ? 'üìà' : 'üìâ',
                            title: `Volume ${volumeChange > 0 ? 'Increasing' : 'Decreasing'}`,
                            description: `Your total training volume is ${volumeChange > 0 ? 'up' : 'down'} compared to last month`,
                            change: volumeChange
                        });
                    }
                }
                
                // Frequency trend
                const currentWorkouts = [...new Set(last30Days.map(w => w.date))].length;
                const previousWorkouts = [...new Set(prev30Days.map(w => w.date))].length;
                
                if (previousWorkouts > 0) {
                    const freqChange = Math.round(((currentWorkouts - previousWorkouts) / previousWorkouts) * 100);
                    if (Math.abs(freqChange) > 15) {
                        trends.push({
                            icon: freqChange > 0 ? 'üí™' : '‚ö†Ô∏è',
                            title: `Workout Frequency ${freqChange > 0 ? 'Up' : 'Down'}`,
                            description: `You're training ${currentWorkouts} days/month vs ${previousWorkouts} last month`,
                            change: freqChange
                        });
                    }
                }
                
                // Strength progression
                const strengthGains = this.calculateStrengthGains();
                if (strengthGains.length > 0) {
                    const topGain = strengthGains[0];
                    trends.push({
                        icon: 'üí™',
                        title: `${topGain.exercise} Progressing Well`,
                        description: `Up ${topGain.change}kg over last month`,
                        change: Math.round((topGain.change / topGain.previous) * 100)
                    });
                }
                
                // RPE trend
                const avgRPE = this.getAverageRPELastWeek();
                if (avgRPE > 8.5) {
                    trends.push({
                        icon: 'üò∞',
                        title: 'High Training Intensity',
                        description: `Average RPE of ${avgRPE.toFixed(1)}/10. Consider a deload week for recovery.`
                    });
                } else if (avgRPE > 0 && avgRPE < 6) {
                    trends.push({
                        icon: 'üí§',
                        title: 'Low Training Intensity',
                        description: `Average RPE of ${avgRPE.toFixed(1)}/10. You might be able to push harder.`
                    });
                }
                
                return trends;
            },

            getWorkoutsInDays(days, offset = 0) {
                const now = new Date();
                const startDate = new Date(now.getTime() - (days + offset) * 24 * 60 * 60 * 1000);
                const endDate = offset > 0 ? new Date(now.getTime() - offset * 24 * 60 * 60 * 1000) : now;
                
                return this.workouts.filter(w => {
                    const workoutDate = new Date(w.date);
                    return workoutDate >= startDate && workoutDate <= endDate;
                });
            },

            calculateStrengthGains() {
                const gains = [];
                const exercises = [...new Set(this.workouts.map(w => w.exercise))];
                
                exercises.forEach(exercise => {
                    const last30 = this.getWorkoutsInDays(30).filter(w => w.exercise === exercise);
                    const prev30 = this.getWorkoutsInDays(60, 30).filter(w => w.exercise === exercise);
                    
                    if (last30.length > 0 && prev30.length > 0) {
                        const currentMax = Math.max(...last30.flatMap(w => w.sets.map(s => s.weight)));
                        const previousMax = Math.max(...prev30.flatMap(w => w.sets.map(s => s.weight)));
                        
                        if (currentMax > previousMax) {
                            gains.push({
                                exercise,
                                change: currentMax - previousMax,
                                previous: previousMax,
                                current: currentMax
                            });
                        }
                    }
                });
                
                return gains.sort((a, b) => b.change - a.change);
            },

            // Workout Session System
            startWorkoutSession() {
                this.currentSession = {
                    id: Date.now().toString(),
                    exercises: [],
                    startTime: new Date().toISOString(),
                    date: new Date().toLocaleDateString(),
                    notes: ''
                };
                this.sessionStartTime = Date.now();
                
                this.renderActiveWorkout();
                document.getElementById('activeWorkoutModal').classList.add('active');
                
                // Update header button
                document.getElementById('startWorkoutBtn').textContent = '‚è∏Ô∏è In Progress';
                document.getElementById('startWorkoutBtn').style.background = 'var(--success)';
            },

            renderActiveWorkout() {
                if (!this.currentSession) return;
                
                const elapsedTime = this.getElapsedTime();
                const totalSets = this.currentSession.exercises.reduce((sum, ex) => sum + ex.sets.length, 0);
                const totalVolume = this.currentSession.exercises.reduce((sum, ex) => 
                    sum + ex.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                );
                
                let html = `
                    <div class="card" style="background: var(--gradient); color: white; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 13px; opacity: 0.9;">Duration</div>
                                <div style="font-size: 32px; font-weight: 700;" id="sessionTimer">${elapsedTime}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 13px; opacity: 0.9;">Volume</div>
                                <div style="font-size: 24px; font-weight: 600;">${this.formatNumber(totalVolume)}kg</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 20px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.2);">
                            <div>
                                <span style="opacity: 0.9;">Exercises:</span> <strong>${this.currentSession.exercises.length}</strong>
                            </div>
                            <div>
                                <span style="opacity: 0.9;">Sets:</span> <strong>${totalSets}</strong>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="app.addExerciseToSession()" style="margin-bottom: 16px;">
                        ‚ûï Add Exercise
                    </button>

                    ${this.currentSession.exercises.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-icon">üí™</div>
                            <div class="empty-text">No exercises yet<br>Add an exercise to begin!</div>
                        </div>
                    ` : ''}

                    ${this.currentSession.exercises.map((exercise, exIndex) => {
                        const lastWorkout = this.getLastWorkoutForExercise(exercise.name);
                        return `
                            <div class="card" style="margin-bottom: 12px;">
                                <div class="card-header">
                                    <div class="card-title">${exercise.name}</div>
                                    <button class="icon-btn danger" onclick="app.removeExerciseFromSession(${exIndex})">üóëÔ∏è</button>
                                </div>
                                
                                ${lastWorkout ? `
                                    <div class="last-workout" style="margin-bottom: 12px;">
                                        <div class="last-workout-title">Last Time</div>
                                        <div class="last-workout-data">${lastWorkout.sets.map(s => `${s.weight}kg √ó ${s.reps}`).join(', ')}</div>
                                    </div>
                                ` : ''}

                                ${exercise.sets.map((set, setIndex) => `
                                    <div class="set-item" style="margin-bottom: 8px;">
                                        <div class="set-number">Set ${setIndex + 1}</div>
                                        <div class="set-input">
                                            <div class="input-group">
                                                <label class="input-label">Weight</label>
                                                <input type="number" value="${set.weight || ''}" 
                                                    onchange="app.updateSessionSet(${exIndex}, ${setIndex}, 'weight', this.value)"
                                                    placeholder="${lastWorkout?.sets[setIndex]?.weight || '0'}" 
                                                    style="width: 70px;">
                                            </div>
                                            <div class="input-group">
                                                <label class="input-label">Reps</label>
                                                <input type="number" value="${set.reps || ''}" 
                                                    onchange="app.updateSessionSet(${exIndex}, ${setIndex}, 'reps', this.value)"
                                                    placeholder="${lastWorkout?.sets[setIndex]?.reps || '0'}" 
                                                    style="width: 70px;">
                                            </div>
                                            <div class="input-group" style="flex: 0.5;">
                                                <label class="input-label">RPE</label>
                                                <input type="number" min="1" max="10" value="${set.rpe || ''}" 
                                                    onchange="app.updateSessionSet(${exIndex}, ${setIndex}, 'rpe', this.value)"
                                                    placeholder="1-10" 
                                                    style="width: 50px; text-align: center;">
                                            </div>
                                        </div>
                                        ${setIndex > 0 ? `<button class="delete-set" onclick="app.removeSetFromSession(${exIndex}, ${setIndex})">‚àí</button>` : ''}
                                    </div>
                                `).join('')}
                                
                                <button class="btn btn-secondary" onclick="app.addSetToSessionExercise(${exIndex})" style="margin-top: 8px;">
                                    + Add Set
                                </button>
                            </div>
                        `;
                    }).join('')}

                    ${this.currentSession.exercises.length > 0 ? `
                        <div class="metric-input-group" style="margin-top: 20px;">
                            <label class="metric-label">Workout Notes (Optional)</label>
                            <textarea id="sessionNotes" class="metric-input" rows="3" placeholder="How was the workout? Any observations?">${this.currentSession.notes || ''}</textarea>
                        </div>

                        <button class="btn btn-success" onclick="app.finishWorkoutSession()" style="margin-top: 12px;">
                            ‚úì Finish Workout
                        </button>
                        <button class="btn btn-danger" onclick="app.cancelWorkoutSession()" style="margin-top: 8px;">
                            Cancel Workout
                        </button>
                    ` : ''}
                `;
                
                document.getElementById('activeWorkoutContent').innerHTML = html;
                
                // Update timer every second
                if (this.sessionTimerInterval) clearInterval(this.sessionTimerInterval);
                this.sessionTimerInterval = setInterval(() => {
                    const timer = document.getElementById('sessionTimer');
                    if (timer && this.currentSession) {
                        timer.textContent = this.getElapsedTime();
                    }
                }, 1000);
            },

            getElapsedTime() {
                if (!this.sessionStartTime) return '0:00';
                const elapsed = Math.floor((Date.now() - this.sessionStartTime) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                
                if (hours > 0) {
                    return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            },

            addExerciseToSession() {
                this.showExerciseModal('session');
            },

            showExerciseModal(mode = 'single') {
                this.exerciseModalMode = mode;
                document.getElementById('exerciseModal').classList.add('active');
                document.getElementById('exerciseSearch').value = '';
                this.renderModalExercises();
            },

            renderModalExercises(filter = '') {
                const allExercises = this.allExercises || [...this.exercises, ...this.customExercises];
                const filtered = allExercises.filter(e => 
                    e.name.toLowerCase().includes(filter.toLowerCase())
                );

                const categories = [...new Set(filtered.map(e => e.category))];
                const html = `
                    <button class="btn btn-secondary" onclick="app.showAddCustomExercise()" style="margin-bottom: 16px;">
                        ‚ûï Create Custom Exercise
                    </button>
                    ${categories.map(cat => `
                        <div class="exercise-category">
                            <div class="category-title">${cat}</div>
                            ${filtered.filter(e => e.category === cat).map(ex => `
                                <div class="exercise-item" onclick="app.selectExerciseFromModal('${ex.name.replace(/'/g, "\\'")}')">
                                    <div>
                                        <div class="exercise-name">${ex.name}${ex.custom ? ' ‚≠ê' : ''}</div>
                                        <div class="exercise-muscle">${ex.muscle}</div>
                                    </div>
                                    <div class="chevron">+</div>
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                `;

                document.getElementById('modalExerciseList').innerHTML = html;
            },

            selectExerciseFromModal(exerciseName) {
                this.closeExerciseModal();
                
                if (this.exerciseModalMode === 'session') {
                    this.currentSession.exercises.push({
                        name: exerciseName,
                        sets: [{ weight: '', reps: '', rpe: '' }]
                    });
                    this.renderActiveWorkout();
                } else {
                    this.startWorkout(exerciseName);
                }
            },

            closeExerciseModal() {
                document.getElementById('exerciseModal').classList.remove('active');
            },

            updateSessionSet(exIndex, setIndex, field, value) {
                this.currentSession.exercises[exIndex].sets[setIndex][field] = parseFloat(value) || '';
            },

            addSetToSessionExercise(exIndex) {
                this.currentSession.exercises[exIndex].sets.push({ weight: '', reps: '', rpe: '' });
                this.renderActiveWorkout();
            },

            removeSetFromSession(exIndex, setIndex) {
                this.currentSession.exercises[exIndex].sets.splice(setIndex, 1);
                this.renderActiveWorkout();
            },

            removeExerciseFromSession(exIndex) {
                if (!confirm('Remove this exercise from the workout?')) return;
                this.currentSession.exercises.splice(exIndex, 1);
                this.renderActiveWorkout();
            },

            getLastWorkoutForExercise(exerciseName) {
                const previous = this.workouts
                    .filter(w => w.exercise === exerciseName)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                return previous;
            },

            async finishWorkoutSession() {
                if (!this.currentSession) return;
                
                // Validate at least one exercise with sets
                const hasValidExercises = this.currentSession.exercises.some(ex => 
                    ex.sets.some(s => s.weight && s.reps)
                );
                
                if (!hasValidExercises) {
                    alert('Please complete at least one set before finishing the workout');
                    return;
                }
                
                // Get notes
                const notes = document.getElementById('sessionNotes')?.value || '';
                this.currentSession.notes = notes;
                
                // Calculate duration
                this.currentSession.endTime = new Date().toISOString();
                this.currentSession.duration = Math.floor((Date.now() - this.sessionStartTime) / 1000);
                
                // Process each exercise and add to old workouts array for compatibility
                this.currentSession.exercises.forEach(exercise => {
                    const validSets = exercise.sets.filter(s => s.weight && s.reps);
                    if (validSets.length > 0) {
                        this.workouts.push({
                            id: Date.now().toString() + Math.random(),
                            exercise: exercise.name,
                            date: this.currentSession.date,
                            sets: validSets,
                            sessionId: this.currentSession.id
                        });
                    }
                });
                
                // Save session
                this.workoutSessions.push(this.currentSession);
                await this.saveWorkoutSessions();
                await this.saveWorkouts();
                
                // Check achievements
                this.checkAchievements();
                
                // Clear session
                clearInterval(this.sessionTimerInterval);
                this.currentSession = null;
                this.sessionStartTime = null;
                
                // Close modal
                document.getElementById('activeWorkoutModal').classList.remove('active');
                
                // Reset header button
                document.getElementById('startWorkoutBtn').textContent = '‚ñ∂Ô∏è Start Workout';
                document.getElementById('startWorkoutBtn').style.background = 'var(--primary)';
                
                // Refresh views
                this.renderToday();
                this.renderAnalytics();
                
                // Show completion message
                alert('üéâ Workout completed!');
            },

            cancelWorkoutSession() {
                if (!confirm('Cancel this workout? All progress will be lost.')) return;
                
                clearInterval(this.sessionTimerInterval);
                this.currentSession = null;
                this.sessionStartTime = null;
                
                document.getElementById('activeWorkoutModal').classList.remove('active');
                document.getElementById('startWorkoutBtn').textContent = '‚ñ∂Ô∏è Start Workout';
                document.getElementById('startWorkoutBtn').style.background = 'var(--primary)';
            },

            // Custom Exercise Creator
            showAddCustomExercise() {
                const html = `
                    <div class="metric-input-group">
                        <label class="metric-label">Exercise Name</label>
                        <input type="text" id="customExName" class="metric-input" placeholder="e.g., Cable Crossover">
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">Category</label>
                        <select id="customExCategory" class="metric-input">
                            <option value="Chest">Chest</option>
                            <option value="Back">Back</option>
                            <option value="Legs">Legs</option>
                            <option value="Shoulders">Shoulders</option>
                            <option value="Arms">Arms</option>
                            <option value="Core">Core</option>
                            <option value="Cardio">Cardio</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">Target Muscles</label>
                        <input type="text" id="customExMuscle" class="metric-input" placeholder="e.g., Chest, Front Delts">
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">Muscle Groups (for volume tracking)</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">
                            ${['Chest', 'Back', 'Quads', 'Hamstrings', 'Glutes', 'Shoulders', 'Biceps', 'Triceps', 'Core', 'Calves'].map(muscle => `
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" value="${muscle}" class="custom-muscle-checkbox">
                                    <span>${muscle}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="app.saveCustomExercise()">üíæ Save Exercise</button>
                `;

                document.getElementById('addCustomExerciseContent').innerHTML = html;
                document.getElementById('addCustomExerciseModal').classList.add('active');
            },

            closeAddCustomExercise() {
                document.getElementById('addCustomExerciseModal').classList.remove('active');
            },

            async saveCustomExercise() {
                const name = document.getElementById('customExName').value.trim();
                const category = document.getElementById('customExCategory').value;
                const muscle = document.getElementById('customExMuscle').value.trim();
                
                if (!name || !muscle) {
                    alert('Please fill in exercise name and target muscles');
                    return;
                }
                
                // Check if exercise already exists
                const allExercises = [...this.exercises, ...this.customExercises];
                if (allExercises.some(ex => ex.name.toLowerCase() === name.toLowerCase())) {
                    alert('An exercise with this name already exists');
                    return;
                }
                
                // Get selected muscle groups
                const checkboxes = document.querySelectorAll('.custom-muscle-checkbox:checked');
                const muscleGroups = Array.from(checkboxes).map(cb => cb.value);
                
                const customExercise = {
                    name,
                    category,
                    muscle,
                    custom: true
                };
                
                this.customExercises.push(customExercise);
                
                // Add to muscle group map
                if (muscleGroups.length > 0) {
                    this.muscleGroupMap[name] = muscleGroups;
                }
                
                // Update allExercises
                this.allExercises = [...this.exercises, ...this.customExercises];
                
                await this.saveCustomExercises();
                
                this.closeAddCustomExercise();
                this.renderModalExercises();
                
                alert(`‚úì "${name}" added to your exercise library!`);
            },

            // Health Dashboard System
            renderHealth() {
                const today = new Date().toLocaleDateString();
                const todayLog = this.dailyLogs[today] || null;
                const readiness = todayLog ? this.calculateReadinessScore(todayLog) : null;
                
                let html = `
                    <div class="section-header">
                        <div class="section-title">Health <span style="font-size: 10px; color: var(--text-secondary);">v3.1</span></div>
                        <div class="section-action" onclick="app.logDailyHealth()">+ Log</div>
                    </div>
                `;
                
                // Readiness Ring (Whoop-style)
                if (todayLog && readiness) {
                    const circumference = 2 * Math.PI * 90;
                    const offset = circumference - (readiness.score / 100) * circumference;
                    
                    let ringColor = '#00D4AA';
                    if (readiness.score < 40) ringColor = '#FF3B47';
                    else if (readiness.score < 70) ringColor = '#FFB800';
                    
                    html += `
                        <div class="premium-stat-card" style="background: var(--surface); margin-bottom: 20px;">
                            <div class="readiness-ring">
                                <svg width="200" height="200">
                                    <circle class="readiness-ring-bg" cx="100" cy="100" r="90"/>
                                    <circle class="readiness-ring-progress" 
                                        cx="100" cy="100" r="90"
                                        stroke="${ringColor}"
                                        stroke-dasharray="${circumference}"
                                        stroke-dashoffset="${offset}"/>
                                </svg>
                                <div class="readiness-score-text">
                                    <div class="readiness-score-number">${readiness.score}</div>
                                    <div class="readiness-score-label">READINESS</div>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 20px;">
                                <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                    ${readiness.status}
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
                                    ${readiness.recommendation}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="premium-stat-card" style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üí§</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                                No Data Today
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px;">
                                Log your health metrics to see your readiness score
                            </div>
                            <button class="btn btn-primary" onclick="app.logDailyHealth()">Log Today's Data</button>
                        </div>
                    `;
                }
                
                // Today's Metrics (Clean rows)
                if (todayLog) {
                    html += `
                        <div class="premium-stat-card">
                            <div class="premium-stat-header">Today's Metrics</div>
                            ${todayLog.sleep ? `
                                <div class="metric-row">
                                    <div>
                                        <div class="metric-label-small">Sleep</div>
                                        <div class="metric-value-large">${todayLog.sleep}h</div>
                                    </div>
                                    ${todayLog.sleepQuality ? `<div class="metric-value-small">${todayLog.sleepQuality}/10 quality</div>` : ''}
                                </div>
                            ` : ''}
                            ${todayLog.rhr ? `
                                <div class="metric-row">
                                    <div class="metric-label-small">Resting Heart Rate</div>
                                    <div class="metric-value-large">${todayLog.rhr} <span style="font-size: 16px; font-weight: 500;">bpm</span></div>
                                </div>
                            ` : ''}
                            ${todayLog.hrv ? `
                                <div class="metric-row">
                                    <div class="metric-label-small">HRV</div>
                                    <div class="metric-value-large">${todayLog.hrv} <span style="font-size: 16px; font-weight: 500;">ms</span></div>
                                </div>
                            ` : ''}
                            ${todayLog.energy ? `
                                <div class="metric-row">
                                    <div class="metric-label-small">Energy Level</div>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div class="metric-value-small">${todayLog.energy}/10</div>
                                        <div class="mini-chart" style="width: 100px;">
                                            ${Array.from({length: 10}, (_, i) => `
                                                <div class="mini-chart-bar ${i < todayLog.energy ? 'active' : ''}" style="height: ${(i + 1) * 4}px;"></div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            ${todayLog.soreness ? `
                                <div class="metric-row">
                                    <div class="metric-label-small">Muscle Soreness</div>
                                    <div class="metric-value-small">${todayLog.soreness}/10</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // Nutrition (Premium cards)
                if (todayLog && (todayLog.caloriesIn || todayLog.protein)) {
                    html += `
                        <div class="premium-stat-card">
                            <div class="premium-stat-header">Nutrition</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                                ${todayLog.caloriesIn ? `
                                    <div>
                                        <div class="metric-label-small">Calories</div>
                                        <div class="metric-value-large">${todayLog.caloriesIn}</div>
                                    </div>
                                ` : ''}
                                ${todayLog.protein ? `
                                    <div>
                                        <div class="metric-label-small">Protein</div>
                                        <div class="metric-value-large">${todayLog.protein}g</div>
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                ${todayLog.carbs ? `
                                    <div>
                                        <div class="metric-label-small">Carbs</div>
                                        <div class="metric-value-small">${todayLog.carbs}g</div>
                                    </div>
                                ` : ''}
                                ${todayLog.fats ? `
                                    <div>
                                        <div class="metric-label-small">Fats</div>
                                        <div class="metric-value-small">${todayLog.fats}g</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // Weekly Trends
                const weeklyData = this.getWeeklyHealthData();
                if (weeklyData.length > 1) {
                    const avgSleep = this.calculateAverage(weeklyData.map(d => d.sleep).filter(Boolean));
                    const avgRHR = this.calculateAverage(weeklyData.map(d => d.rhr).filter(Boolean));
                    const avgProtein = this.calculateAverage(weeklyData.map(d => d.protein).filter(Boolean));
                    
                    // Calculate trends
                    const last3Days = weeklyData.slice(-3);
                    const first3Days = weeklyData.slice(0, 3);
                    const recentSleep = this.calculateAverage(last3Days.map(d => d.sleep).filter(Boolean));
                    const earlierSleep = this.calculateAverage(first3Days.map(d => d.sleep).filter(Boolean));
                    const sleepTrend = earlierSleep ? ((recentSleep - earlierSleep) / earlierSleep * 100).toFixed(0) : 0;
                    
                    html += `
                        <div class="premium-stat-card">
                            <div class="premium-stat-header">7-Day Trends</div>
                            ${avgSleep ? `
                                <div class="metric-row">
                                    <div>
                                        <div class="metric-label-small">Average Sleep</div>
                                        <div class="metric-value-large">${avgSleep.toFixed(1)}h</div>
                                    </div>
                                    ${sleepTrend != 0 ? `<div class="metric-change ${sleepTrend > 0 ? 'positive' : 'negative'}">${sleepTrend > 0 ? '+' : ''}${sleepTrend}%</div>` : ''}
                                </div>
                            ` : ''}
                            ${avgRHR ? `
                                <div class="metric-row">
                                    <div class="metric-label-small">Average RHR</div>
                                    <div class="metric-value-large">${Math.round(avgRHR)} <span style="font-size: 16px; font-weight: 500;">bpm</span></div>
                                </div>
                            ` : ''}
                            ${avgProtein ? `
                                <div class="metric-row">
                                    <div class="metric-label-small">Average Protein</div>
                                    <div class="metric-value-large">${Math.round(avgProtein)}g</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // Insights & Correlations
                html += this.renderHealthCorrelations();
                
                document.getElementById('healthContent').innerHTML = html;
            },

            showHealthDashboard() {
                const today = new Date().toLocaleDateString();
                const todayLog = this.dailyLogs[today] || null;
                const readiness = todayLog ? this.calculateReadinessScore(todayLog) : null;
                
                let html = `
                    <div class="section-header">
                        <div class="section-title">Health Dashboard</div>
                        <div class="section-action" onclick="app.logDailyHealth()">+ Log Today</div>
                    </div>
                `;
                
                // Today's Stats
                if (todayLog) {
                    html += `
                        <div class="card" style="background: var(--gradient); color: white; margin-bottom: 16px;">
                            <div style="text-align: center; margin-bottom: 16px;">
                                <div style="font-size: 64px; font-weight: 700;">${readiness.score}</div>
                                <div style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">Readiness Score</div>
                                <div style="font-size: 14px; opacity: 0.9;">${readiness.status}</div>
                            </div>
                            <div style="padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.2);">
                                <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">${readiness.recommendation}</div>
                            </div>
                        </div>

                        <div class="stats-grid">
                            ${todayLog.sleep ? `
                                <div class="stat-card">
                                    <div class="stat-value">${todayLog.sleep}h</div>
                                    <div class="stat-label">Sleep</div>
                                </div>
                            ` : ''}
                            ${todayLog.rhr ? `
                                <div class="stat-card">
                                    <div class="stat-value">${todayLog.rhr}</div>
                                    <div class="stat-label">RHR (bpm)</div>
                                </div>
                            ` : ''}
                            ${todayLog.energy ? `
                                <div class="stat-card">
                                    <div class="stat-value">${todayLog.energy}/10</div>
                                    <div class="stat-label">Energy</div>
                                </div>
                            ` : ''}
                            ${todayLog.soreness ? `
                                <div class="stat-card">
                                    <div class="stat-value">${todayLog.soreness}/10</div>
                                    <div class="stat-label">Soreness</div>
                                </div>
                            ` : ''}
                        </div>

                        ${todayLog.caloriesIn || todayLog.protein ? `
                            <div class="card" style="margin-top: 16px;">
                                <div class="card-title" style="margin-bottom: 12px;">üçé Today's Nutrition</div>
                                <div class="stats-grid">
                                    ${todayLog.caloriesIn ? `
                                        <div class="stat-card">
                                            <div class="stat-value">${todayLog.caloriesIn}</div>
                                            <div class="stat-label">Calories</div>
                                        </div>
                                    ` : ''}
                                    ${todayLog.protein ? `
                                        <div class="stat-card">
                                            <div class="stat-value">${todayLog.protein}g</div>
                                            <div class="stat-label">Protein</div>
                                        </div>
                                    ` : ''}
                                    ${todayLog.carbs ? `
                                        <div class="stat-card">
                                            <div class="stat-value">${todayLog.carbs}g</div>
                                            <div class="stat-label">Carbs</div>
                                        </div>
                                    ` : ''}
                                    ${todayLog.fats ? `
                                        <div class="stat-card">
                                            <div class="stat-value">${todayLog.fats}g</div>
                                            <div class="stat-label">Fats</div>
                                        </div>
                                    ` : ''}
                                </div>
                                ${todayLog.eatingQuality ? `
                                    <div style="margin-top: 12px; padding: 12px; background: var(--background); border-radius: 8px;">
                                        <div style="font-size: 13px; color: var(--text-secondary);">Eating Quality</div>
                                        <div style="font-size: 20px; font-weight: 600;">${todayLog.eatingQuality}/10</div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    `;
                } else {
                    html += `
                        <div class="empty-state">
                            <div class="empty-icon">‚ù§Ô∏è</div>
                            <div class="empty-text">No health data logged today<br>Tap "+ Log Today" to track your health</div>
                        </div>
                    `;
                }
                
                // Weekly Trends
                const weeklyData = this.getWeeklyHealthData();
                if (weeklyData.length > 0) {
                    const avgSleep = this.calculateAverage(weeklyData.map(d => d.sleep).filter(Boolean));
                    const avgRHR = this.calculateAverage(weeklyData.map(d => d.rhr).filter(Boolean));
                    const avgEnergy = this.calculateAverage(weeklyData.map(d => d.energy).filter(Boolean));
                    const avgCalories = this.calculateAverage(weeklyData.map(d => d.caloriesIn).filter(Boolean));
                    const avgProtein = this.calculateAverage(weeklyData.map(d => d.protein).filter(Boolean));
                    
                    html += `
                        <div class="card">
                            <div class="card-title" style="margin-bottom: 12px;">üìä 7-Day Averages</div>
                            <div class="stats-grid">
                                ${avgSleep ? `
                                    <div class="stat-card">
                                        <div class="stat-value">${avgSleep.toFixed(1)}h</div>
                                        <div class="stat-label">Avg Sleep</div>
                                    </div>
                                ` : ''}
                                ${avgRHR ? `
                                    <div class="stat-card">
                                        <div class="stat-value">${Math.round(avgRHR)}</div>
                                        <div class="stat-label">Avg RHR</div>
                                    </div>
                                ` : ''}
                                ${avgEnergy ? `
                                    <div class="stat-card">
                                        <div class="stat-value">${avgEnergy.toFixed(1)}/10</div>
                                        <div class="stat-label">Avg Energy</div>
                                    </div>
                                ` : ''}
                                ${avgCalories ? `
                                    <div class="stat-card">
                                        <div class="stat-value">${Math.round(avgCalories)}</div>
                                        <div class="stat-label">Avg Calories</div>
                                    </div>
                                ` : ''}
                            </div>
                            ${avgProtein ? `
                                <div style="margin-top: 12px; padding: 12px; background: var(--background); border-radius: 8px;">
                                    <div style="font-size: 13px; color: var(--text-secondary);">Average Protein</div>
                                    <div style="font-size: 20px; font-weight: 600;">${Math.round(avgProtein)}g/day</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    // Sleep trend chart
                    html += this.renderHealthChart(weeklyData, 'sleep', 'Sleep (hours)');
                    
                    // Protein chart if available
                    if (avgProtein) {
                        html += this.renderHealthChart(weeklyData, 'protein', 'Protein (grams)');
                    }
                    
                    // Correlations
                    html += this.renderHealthCorrelations();
                }
                
                // Recent logs
                const recentLogs = Object.entries(this.dailyLogs)
                    .sort((a, b) => new Date(b[0]) - new Date(a[0]))
                    .slice(0, 7);
                
                if (recentLogs.length > 0) {
                    html += `
                        <div class="card">
                            <div class="card-title" style="margin-bottom: 12px;">Recent Logs</div>
                            ${recentLogs.map(([date, log]) => `
                                <div class="history-item">
                                    <div>
                                        <div class="history-date">${this.formatDate(date)}</div>
                                        <div class="history-sets">
                                            ${log.sleep ? `üò¥ ${log.sleep}h` : ''} 
                                            ${log.rhr ? `‚ù§Ô∏è ${log.rhr}bpm` : ''} 
                                            ${log.energy ? `‚ö° ${log.energy}/10` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                const modalContent = `
                    <div class="modal active" id="healthModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">Health Dashboard</h2>
                                <button class="close-btn" onclick="document.getElementById('healthModal').remove()">√ó</button>
                            </div>
                            ${html}
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalContent);
            },

            logDailyHealth() {
                const today = new Date().toLocaleDateString();
                const existing = this.dailyLogs[today] || {};
                
                const html = `
                    <div style="margin-bottom: 16px; padding: 12px; background: var(--background); border-radius: 8px;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">Morning Check-In</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">Log your daily health metrics</div>
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">üí§ Hours Slept</label>
                        <input type="number" step="0.5" id="healthSleep" class="metric-input" placeholder="7.5" value="${existing.sleep || ''}">
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">üò¥ Sleep Quality (1-10)</label>
                        <input type="number" min="1" max="10" id="healthSleepQuality" class="metric-input" placeholder="8" value="${existing.sleepQuality || ''}">
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">‚ù§Ô∏è Resting Heart Rate (bpm)</label>
                        <input type="number" id="healthRHR" class="metric-input" placeholder="55" value="${existing.rhr || ''}">
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">üìä HRV (ms)</label>
                        <input type="number" id="healthHRV" class="metric-input" placeholder="85" value="${existing.hrv || ''}">
                        <div class="metric-history">Optional - if you track it</div>
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">‚ö° Energy Level (1-10)</label>
                        <input type="number" min="1" max="10" id="healthEnergy" class="metric-input" placeholder="7" value="${existing.energy || ''}">
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">üò∞ Stress Level (1-10)</label>
                        <input type="number" min="1" max="10" id="healthStress" class="metric-input" placeholder="4" value="${existing.stress || ''}">
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">üí™ Muscle Soreness (1-10)</label>
                        <input type="number" min="1" max="10" id="healthSoreness" class="metric-input" placeholder="3" value="${existing.soreness || ''}">
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">üö∂ Steps</label>
                        <input type="number" id="healthSteps" class="metric-input" placeholder="10000" value="${existing.steps || ''}">
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">üî• Calories Burned</label>
                        <input type="number" id="healthCalories" class="metric-input" placeholder="2500" value="${existing.calories || ''}">
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">üíß Water Intake (glasses)</label>
                        <input type="number" id="healthWater" class="metric-input" placeholder="8" value="${existing.water || ''}">
                    </div>

                    <div style="margin: 20px 0; padding: 12px; background: var(--background); border-radius: 8px;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">üçé Nutrition</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">Track your daily intake</div>
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">üî• Calories Consumed</label>
                        <input type="number" id="healthCaloriesIn" class="metric-input" placeholder="2500" value="${existing.caloriesIn || ''}">
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">ü•© Protein (grams)</label>
                        <input type="number" id="healthProtein" class="metric-input" placeholder="150" value="${existing.protein || ''}">
                        <div class="metric-history">Target: ~0.8-1g per lb body weight</div>
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">üçö Carbs (grams)</label>
                        <input type="number" id="healthCarbs" class="metric-input" placeholder="250" value="${existing.carbs || ''}">
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">ü•ë Fats (grams)</label>
                        <input type="number" id="healthFats" class="metric-input" placeholder="70" value="${existing.fats || ''}">
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">üåü Eating Quality (1-10)</label>
                        <input type="number" min="1" max="10" id="healthEatingQuality" class="metric-input" placeholder="7" value="${existing.eatingQuality || ''}">
                        <div class="metric-history">How clean/healthy was your eating?</div>
                    </div>

                    <div class="metric-input-group">
                        <label class="metric-label">üìù Notes</label>
                        <textarea id="healthNotes" class="metric-input" rows="2" placeholder="Any observations...">${existing.notes || ''}</textarea>
                    </div>

                    <button class="btn btn-primary" onclick="app.saveDailyHealth()">üíæ Save Health Log</button>
                `;

                const modalContent = `
                    <div class="modal active" id="logHealthModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">Daily Health Log</h2>
                                <button class="close-btn" onclick="document.getElementById('logHealthModal').remove()">√ó</button>
                            </div>
                            ${html}
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalContent);
            },

            async saveDailyHealth() {
                const today = new Date().toLocaleDateString();
                
                const log = {
                    date: today,
                    sleep: parseFloat(document.getElementById('healthSleep').value) || null,
                    sleepQuality: parseInt(document.getElementById('healthSleepQuality').value) || null,
                    rhr: parseInt(document.getElementById('healthRHR').value) || null,
                    hrv: parseInt(document.getElementById('healthHRV').value) || null,
                    energy: parseInt(document.getElementById('healthEnergy').value) || null,
                    stress: parseInt(document.getElementById('healthStress').value) || null,
                    soreness: parseInt(document.getElementById('healthSoreness').value) || null,
                    steps: parseInt(document.getElementById('healthSteps').value) || null,
                    calories: parseInt(document.getElementById('healthCalories').value) || null,
                    water: parseInt(document.getElementById('healthWater').value) || null,
                    notes: document.getElementById('healthNotes').value || '',
                    // Nutrition
                    caloriesIn: parseInt(document.getElementById('healthCaloriesIn')?.value) || null,
                    protein: parseInt(document.getElementById('healthProtein')?.value) || null,
                    carbs: parseInt(document.getElementById('healthCarbs')?.value) || null,
                    fats: parseInt(document.getElementById('healthFats')?.value) || null,
                    eatingQuality: parseInt(document.getElementById('healthEatingQuality')?.value) || null
                };
                
                this.dailyLogs[today] = log;
                await this.saveDailyLogs();
                
                document.getElementById('logHealthModal').remove();
                document.getElementById('healthModal')?.remove();
                
                this.showHealthDashboard();
            },

            calculateReadinessScore(log) {
                let score = 50; // Base score
                let factors = [];
                
                // Sleep (30 points max)
                if (log.sleep) {
                    if (log.sleep >= 8) {
                        score += 30;
                        factors.push('Great sleep');
                    } else if (log.sleep >= 7) {
                        score += 20;
                        factors.push('Good sleep');
                    } else if (log.sleep >= 6) {
                        score += 10;
                        factors.push('Adequate sleep');
                    } else {
                        factors.push('Low sleep');
                    }
                }
                
                // Energy (20 points max)
                if (log.energy) {
                    score += (log.energy - 5) * 4;
                    if (log.energy >= 8) factors.push('High energy');
                    else if (log.energy <= 4) factors.push('Low energy');
                }
                
                // Soreness (reduce score)
                if (log.soreness) {
                    score -= (log.soreness - 3) * 3;
                    if (log.soreness >= 7) factors.push('Very sore');
                }
                
                // Stress (reduce score)
                if (log.stress) {
                    score -= (log.stress - 4) * 2;
                    if (log.stress >= 7) factors.push('High stress');
                }
                
                // RHR (if available)
                if (log.rhr) {
                    const avgRHR = this.calculateAverage(
                        Object.values(this.dailyLogs).map(l => l.rhr).filter(Boolean)
                    );
                    if (avgRHR && log.rhr < avgRHR - 3) {
                        score += 10;
                        factors.push('Low RHR (well rested)');
                    } else if (avgRHR && log.rhr > avgRHR + 5) {
                        score -= 10;
                        factors.push('Elevated RHR');
                    }
                }
                
                // Cap between 0-100
                score = Math.max(0, Math.min(100, score));
                
                let status, recommendation;
                if (score >= 85) {
                    status = 'Excellent - Peak Performance';
                    recommendation = 'üí™ Perfect day for PRs and heavy lifting!';
                } else if (score >= 70) {
                    status = 'Good - Ready to Train';
                    recommendation = '‚úÖ Good to train hard. Push yourself!';
                } else if (score >= 55) {
                    status = 'Moderate - Train Smart';
                    recommendation = '‚ö†Ô∏è Train but listen to your body. Avoid PRs.';
                } else if (score >= 40) {
                    status = 'Low - Light Training';
                    recommendation = 'üü° Consider light workout or active recovery.';
                } else {
                    status = 'Poor - Rest Day';
                    recommendation = 'üõë Strong rest day candidate. Prioritize recovery.';
                }
                
                return { score: Math.round(score), status, recommendation, factors };
            },

            getWeeklyHealthData() {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                return Object.entries(this.dailyLogs)
                    .filter(([date]) => new Date(date) >= weekAgo)
                    .map(([date, log]) => ({ date, ...log }))
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
            },

            calculateAverage(arr) {
                const filtered = arr.filter(x => x != null && !isNaN(x));
                if (filtered.length === 0) return null;
                return filtered.reduce((sum, val) => sum + val, 0) / filtered.length;
            },

            renderHealthChart(data, metric, label) {
                const values = data.map(d => d[metric]).filter(Boolean);
                if (values.length === 0) return '';
                
                const maxValue = Math.max(...values);
                const minValue = Math.min(...values);
                const range = maxValue - minValue || 1;
                
                return `
                    <div class="chart-container">
                        <div class="chart-title">${label}</div>
                        <div class="simple-chart">
                            ${data.map(d => {
                                if (!d[metric]) return '';
                                const height = ((d[metric] - minValue) / range) * 100 || 50;
                                const dateObj = new Date(d.date);
                                return `
                                    <div class="chart-bar" style="height: ${height}%">
                                        <div class="chart-bar-value">${d[metric]}</div>
                                        <div class="chart-bar-label">${dateObj.getDate()}/${dateObj.getMonth() + 1}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            },

            renderHealthCorrelations() {
                // Find correlations between health metrics and workout performance
                const workoutsWithHealth = this.workouts.filter(w => {
                    return this.dailyLogs[w.date];
                }).map(w => ({
                    ...w,
                    health: this.dailyLogs[w.date],
                    volume: w.sets.reduce((sum, s) => sum + (s.weight * s.reps), 0)
                }));
                
                if (workoutsWithHealth.length < 3) return '';
                
                // Calculate correlations
                const insights = [];
                
                // Sleep vs Performance
                const goodSleep = workoutsWithHealth.filter(w => w.health.sleep >= 7.5);
                const badSleep = workoutsWithHealth.filter(w => w.health.sleep < 6.5);
                
                if (goodSleep.length > 0 && badSleep.length > 0) {
                    const avgVolumeGoodSleep = this.calculateAverage(goodSleep.map(w => w.volume));
                    const avgVolumeBadSleep = this.calculateAverage(badSleep.map(w => w.volume));
                    const diff = ((avgVolumeGoodSleep - avgVolumeBadSleep) / avgVolumeBadSleep * 100);
                    
                    if (Math.abs(diff) > 10) {
                        insights.push({
                            icon: 'üò¥',
                            title: `Sleep Impact: ${diff > 0 ? '+' : ''}${diff.toFixed(0)}%`,
                            description: `You lift ${Math.abs(diff).toFixed(0)}% ${diff > 0 ? 'more' : 'less'} volume on 7.5+ hours sleep`
                        });
                    }
                }
                
                // Protein vs Performance
                const highProtein = workoutsWithHealth.filter(w => w.health.protein >= 140);
                const lowProtein = workoutsWithHealth.filter(w => w.health.protein > 0 && w.health.protein < 100);
                
                if (highProtein.length > 0 && lowProtein.length > 0) {
                    const avgVolumeHighProtein = this.calculateAverage(highProtein.map(w => w.volume));
                    const avgVolumeLowProtein = this.calculateAverage(lowProtein.map(w => w.volume));
                    const diff = ((avgVolumeHighProtein - avgVolumeLowProtein) / avgVolumeLowProtein * 100);
                    
                    if (Math.abs(diff) > 8) {
                        insights.push({
                            icon: 'ü•©',
                            title: `Protein Impact: ${diff > 0 ? '+' : ''}${diff.toFixed(0)}%`,
                            description: `You lift ${Math.abs(diff).toFixed(0)}% ${diff > 0 ? 'more' : 'less'} volume on 140g+ protein days`
                        });
                    }
                }
                
                // Calories vs Performance
                const highCal = workoutsWithHealth.filter(w => w.health.caloriesIn >= 2500);
                const lowCal = workoutsWithHealth.filter(w => w.health.caloriesIn > 0 && w.health.caloriesIn < 2000);
                
                if (highCal.length > 0 && lowCal.length > 0) {
                    const avgVolumeHighCal = this.calculateAverage(highCal.map(w => w.volume));
                    const avgVolumeLowCal = this.calculateAverage(lowCal.map(w => w.volume));
                    const diff = ((avgVolumeHighCal - avgVolumeLowCal) / avgVolumeLowCal * 100);
                    
                    if (Math.abs(diff) > 10) {
                        insights.push({
                            icon: 'üî•',
                            title: `Calorie Impact: ${diff > 0 ? '+' : ''}${diff.toFixed(0)}%`,
                            description: `You lift ${Math.abs(diff).toFixed(0)}% ${diff > 0 ? 'more' : 'less'} volume on 2500+ calorie days`
                        });
                    }
                }
                
                // Energy vs Performance
                const highEnergy = workoutsWithHealth.filter(w => w.health.energy >= 8);
                const lowEnergy = workoutsWithHealth.filter(w => w.health.energy <= 5);
                
                if (highEnergy.length > 0 && lowEnergy.length > 0) {
                    const avgVolumeHighEnergy = this.calculateAverage(highEnergy.map(w => w.volume));
                    const avgVolumeLowEnergy = this.calculateAverage(lowEnergy.map(w => w.volume));
                    const diff = ((avgVolumeHighEnergy - avgVolumeLowEnergy) / avgVolumeLowEnergy * 100);
                    
                    if (Math.abs(diff) > 12) {
                        insights.push({
                            icon: '‚ö°',
                            title: `Energy Level Impact: ${diff > 0 ? '+' : ''}${diff.toFixed(0)}%`,
                            description: `You lift ${Math.abs(diff).toFixed(0)}% ${diff > 0 ? 'more' : 'less'} volume when energy is 8+/10`
                        });
                    }
                }
                
                // Nutrition quality analysis
                const avgProteinIntake = this.calculateAverage(
                    Object.values(this.dailyLogs).map(l => l.protein).filter(Boolean)
                );
                
                if (avgProteinIntake && avgProteinIntake < 120) {
                    insights.push({
                        icon: '‚ö†Ô∏è',
                        title: 'Low Protein Intake',
                        description: `Average ${Math.round(avgProteinIntake)}g/day. Consider targeting 140-180g for muscle growth.`
                    });
                }
                
                if (insights.length === 0) return '';
                
                return `
                    <div class="card">
                        <div class="card-title" style="margin-bottom: 12px;">üî¨ Insights & Correlations</div>
                        ${insights.map(insight => `
                            <div style="padding: 12px; background: var(--background); border-radius: 8px; margin-bottom: 8px;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${insight.icon} ${insight.title}</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">${insight.description}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

        };

        // Initialize app
        window.addEventListener('load', () => app.init());
    </script>
</body>
</html>
